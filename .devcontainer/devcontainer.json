// For format details, see https://containers.dev/implementors/json_reference/.
// For config options, see the README at: https://github.com/devcontainers/templates/tree/main/src/ruby
{
  "name": "AIDP Development Container",
  "dockerComposeFile": "compose.yaml",
  "service": "aidp",
  "workspaceFolder": "/workspaces/${localWorkspaceFolderBasename}",

  // Use base image 'vscode' user for compatibility with devcontainer features
  "remoteUser": "vscode",

  // Container configuration
  "capAdd": ["NET_ADMIN", "NET_RAW"],

  // Features to add to the dev container. More info: https://containers.dev/features.
  "features": {
    // GitHub CLI
    "ghcr.io/devcontainers/features/github-cli:1": {},
    "ghcr.io/rails/devcontainer/features/activestorage": {},
    "ghcr.io/devcontainers/features/docker-outside-of-docker:1": {"moby":false},
    "ghcr.io/rails/devcontainer/features/sqlite3": {}
  },

  "containerEnv": {
    "TZ": "${localEnv:TZ:UTC}",
    "AIDP_ENV": "development",
    "BUNDLE_PATH": "/workspaces/aidp/vendor/bundle"
  },

  // Use 'forwardPorts' to make a list of ports inside the container available locally.
  "forwardPorts": [],

  // Configure tool-specific properties.
  // "customizations": {},

  // (Use root only for troubleshooting: set "remoteUser": "root" if needed.)


  // Post-create command - install dependencies
  // Post-create: mandatory bundle install; optional tools below (uncomment to enable)
  "postCreateCommand": {
    "bundle-install": "bundle check || bundle install --jobs 4 --retry 3"
    // OPTIONAL TOOLS (uncomment any you want):
    // "git-curate": "gem install git-curate --no-document || true",
    // "claude-code": "npm install -g @anthropic-ai/claude-code || true",
    // "gemini-cli": "npm install -g @google/gemini-cli || true",
    // "github-copilot-cli": "npm install -g @githubnext/github-copilot-cli || true",
    // "codex-cli": "npm install -g openai-cli || true"
  },

  // Post-start command - initialize firewall
  "postStartCommand": {
    "init-firewall": "sudo /usr/local/bin/init-firewall.sh",
    "ensure-bundle": "bundle check || bundle install --jobs 4 --retry 3"
  },
  "waitFor": "postStartCommand",

  // VS Code customizations
  "customizations": {
    "vscode": {
      // Install useful extensions
      "extensions": [
        // Ruby development
        "Shopify.ruby-lsp",
        "testdouble.vscode-standard-ruby",
        "kaiwood.endwise",

        // Git
        "eamodio.gitlens",
        "mhutchie.git-graph",

        // YAML/config files
        "redhat.vscode-yaml",

        // General development
        "streetsidesoftware.code-spell-checker",
        "EditorConfig.EditorConfig"
      ],

      // VS Code settings
      "settings": {
        // Ruby
        "ruby.lsp.enabled": true,
        "ruby.format": "standard",
        "editor.formatOnSave": true,
        "[ruby]": {
          "editor.defaultFormatter": "Shopify.ruby-lsp",
          "editor.formatOnSave": true,
          "editor.tabSize": 2
        },

        // YAML
        "[yaml]": {
          "editor.defaultFormatter": "redhat.vscode-yaml",
          "editor.tabSize": 2
        },

        // Terminal
        "terminal.integrated.defaultProfile.linux": "zsh",
        "terminal.integrated.profiles.linux": {
          "zsh": {
            "path": "/bin/zsh"
          },
          "bash": {
            "path": "/bin/bash"
          }
        }
      }
    }
  },

  // Mount volumes for persistence
  "mounts": [
    // Persist bash history
    "source=aidp-bashhistory,target=/commandhistory,type=volume",
    // Persist .aidp configuration for vscode user
    "source=aidp-config,target=/home/vscode/.aidp,type=volume",
    // Persist bundler cache
    "source=aidp-bundle,target=/workspace/vendor/bundle,type=volume"
  ]

  // Optional: uncomment to keep container running
  // "overrideCommand": true
}

// For format details, see https://containers.dev/implementors/json_reference/.
// For config options, see the README at: https://github.com/devcontainers/templates/tree/main/src/ruby
{
  "$schema": "https://raw.githubusercontent.com/microsoft/vscode/main/extensions/configuration-editing/schemas/devContainer.vscode.schema.json",
  "name": "AIDP Development Container",
  "dockerComposeFile": "compose.yaml",
  "runServices": [
    "qdrant",
    "aidp"
  ],
  "service": "aidp",
  "workspaceFolder": "/workspaces/${localWorkspaceFolderBasename}",
  // Use base image 'vscode' user for compatibility with devcontainer features
  "remoteUser": "vscode",
  // Container configuration
  "capAdd": [
    "NET_ADMIN",
    "NET_RAW"
  ],
  // Features to add to the dev container. More info: https://containers.dev/features.
  "features": {
    // GitHub CLI
    "ghcr.io/devcontainers/features/github-cli:1": {},
    "ghcr.io/rails/devcontainer/features/activestorage": {},
    "ghcr.io/devcontainers/features/docker-outside-of-docker:1": {
      "moby": false
    },
    "ghcr.io/rails/devcontainer/features/sqlite3": {},
    "ghcr.io/devcontainers/features/node:1": {
      "version": "lts"
    },
    "ghcr.io/devcontainers-extra/features/mise:1": {}
  },
  // containerEnv is set when the container is built
  // put environment variables that won't change in here
  "containerEnv": {
    "TZ": "${localEnv:TZ:UTC}",
    "AIDP_ENV": "development",
    "BUNDLE_PATH": "/workspaces/aidp/vendor/bundle",
    "AIDP_FIREWALL_LOG": "1",
    "TREE_SITTER_PARSERS": "/workspaces/aidp/.aidp/parsers",
    // LLM CLI tools - dangerous/auto-approve mode (container only)
    "CODEX_APPROVAL_POLICY": "never",
    "CODEX_SANDBOX_MODE": "danger-full-access"
  },
  // remoteEnv is set when the container is started
  // put environment variables that may change in here
  "remoteEnv": {
    "GEMINI_API": "${localEnv:GEMINI_API}"
  },
  // Use 'forwardPorts' to make a list of ports inside the container available locally.
  "forwardPorts": [
    6333,
    6334
  ],
  // Configure tool-specific properties.
  // "customizations": {},
  // (Use root only for troubleshooting: set "remoteUser": "root" if needed.)
  // Post-create command - install dependencies
  // Post-create: mandatory bundle install; optional tools below (uncomment to enable)
  "postCreateCommand": {
    "markdownlint": "npm install -g markdownlint-cli",
    // OPTIONAL TOOLS (uncomment any you want):
    "git-curate": "gem install git_curate",
    "claude-code": "npm install -g @anthropic-ai/claude-code",
    "cursor-agent": "curl https://cursor.com/install -fsS | bash",
    "codex": "npm install -g @openai/codex",
    "gemini-cli": "npm install -g @google/gemini-cli",
    "github-copilot-cli": "npm install -g @github/copilot",
    "opencode": "npm i -g opencode-ai@latest",
    "kilocode": "npm i -g @kilocode/cli",
    "aider": "curl -fsSL https://aider.chat/install.sh | bash",
    // Configure LLM tools for auto-approve mode (devcontainer only)
    "configure-llm-tools": "/workspaces/aidp/.devcontainer/configure-llm-tools.sh",
    // Generate firewall configuration from provider requirements
    "generate-firewall-config": "bundle exec ruby bin/update-firewall-config"
  },
  // Post-start command - initialize firewall, then ensure bundle
  "postStartCommand": {
    "init-firewall": "sudo /usr/local/bin/init-firewall.sh",
    "ensure-bundle": "bundle check || bundle install --jobs 4 --retry 3",
    "fix-aidp-permissions": "sudo chown -R vscode:vscode /home/vscode/.aidp"
  },
  "waitFor": "postStartCommand",
  // VS Code customizations
  "customizations": {
    "vscode": {
      // Install useful extensions
      "extensions": [
        "Shopify.ruby-lsp",
        "testdouble.vscode-standard-ruby",
        "eamodio.gitlens",
        "mhutchie.git-graph",
        "redhat.vscode-yaml",
        "EditorConfig.EditorConfig",
        "GitHub.copilot",
        "GitHub.copilot-chat",
        "Anthropic.claude-code",
        "openai.chatgpt",
        "DavidAnson.vscode-markdownlint",
        "sst-dev.opencode",
        "google.gemini-cli-vscode-ide-companion",
        "noku.rails-run-spec-vscode",
        "sporto.rails-go-to-spec",
        "Tyriar.sort-lines",
        "ryu1kn.partial-diff",
        "bierner.markdown-mermaid",
        "GitHub.vscode-codeql",
        "heyimfuzz.banner-comments",
        "kilocode.Kilo-Code"
      ],
      // VS Code settings
      "settings": {
        // Ruby
        "ruby.lsp.enabled": true,
        "ruby.format": "standard",
        "editor.formatOnSave": true,
        "[ruby]": {
          "editor.defaultFormatter": "Shopify.ruby-lsp",
          "editor.formatOnSave": true,
          "editor.tabSize": 2
        },
        // YAML
        "[yaml]": {
          "editor.defaultFormatter": "redhat.vscode-yaml",
          "editor.tabSize": 2
        },
        // Terminal
        "terminal.integrated.defaultProfile.linux": "zsh",
        "terminal.integrated.profiles.linux": {
          "zsh": {
            "path": "/bin/zsh"
          },
          "bash": {
            "path": "/bin/bash"
          }
        },
        // Remote ports
        "remote.autoForwardPorts": true,
        "remote.portsAttributes": {
          "*": {
            "requireLocalPort": true
          } // prefer same-number local port
        },
        // LLM CLI Extensions - Dangerous/Auto-approve mode (devcontainer only)
        // NOTE: These settings only apply inside the devcontainer, not on host
        "claude-code.dangerouslySkipPermissions": true,
        "claude-code.useTerminal": false
      }
    }
  },
  // Mount volumes for persistence
  "mounts": [
    // Persist bash history
    "source=aidp-bashhistory,target=/commandhistory,type=volume",
    // Persist .aidp configuration for vscode user
    "source=aidp-config,target=/home/vscode/.aidp,type=volume",
    // Persist bundler cache
    "source=aidp-bundle,target=/workspace/vendor/bundle,type=volume",
    // LLM CLI Authentication - Claude (stores in ~/.claude)
    "source=${localEnv:HOME}/.claude,target=/home/vscode/.claude,type=bind,consistency=cached",
    // LLM CLI Authentication - Other tools in ~/.config (Gemini, GitHub CLI config, opencode, etc.)
    "source=${localEnv:HOME}/.config,target=/home/vscode/.config,type=bind",
    // GitHub CLI Extensions - Share extensions between host and container
    "source=${localEnv:HOME}/.local/share/gh,target=/home/vscode/.local/share/gh,type=bind,consistency=cached",
    // opencode Extensions - Share extensions between host and container
    "source=${localEnv:HOME}/.local/share/opencode,target=/home/vscode/.local/share/opencode,type=bind,consistency=cached",
    // GitHub Copilot CLI - Share config and session data between host and container
    "source=${localEnv:HOME}/.copilot,target=/home/vscode/.copilot,type=bind,consistency=cached",
    // LLM CLI Authentication - Cursor
    "source=${localEnv:HOME}/.cursor,target=/home/vscode/.cursor,type=bind,consistency=cached",
    // LLM CLI Authentication - Codex CLI (OpenAI)
    "source=${localEnv:HOME}/.codex,target=/home/vscode/.codex,type=bind,consistency=cached",
    // LLM CLI Authentication - Kilocode
    "source=${localEnv:HOME}/.kilocode,target=/home/vscode/.kilocode,type=bind,consistency=cached",
    // LLM CLI Authentication - Aider
    "source=${localEnv:HOME}/.aider,target=/home/vscode/.aider,type=bind,consistency=cached"
  ]
  // Optional: uncomment to keep container running
  // "overrideCommand": true
}
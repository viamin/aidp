{
  "name": "AIDP Development Container",
  "build": {
    "dockerfile": "Dockerfile",
    "args": {
      "RUBY_VERSION": "3.4.5",
      "TZ": "${localEnv:TZ:UTC}",
      "DELTA_VERSION": "0.18.2",
      "ZSH_IN_DOCKER_VERSION": "1.2.0"
    }
  },

  // Container configuration
  "capAdd": ["NET_ADMIN", "NET_RAW"],
  "runArgs": ["--init"],

  // Set environment variables
  "containerEnv": {
    "TZ": "${localEnv:TZ:UTC}",
    "AIDP_ENV": "development",
    "BUNDLE_PATH": "/workspace/vendor/bundle"
  },

  // Mount volumes for persistence
  "mounts": [
    // Persist bash history
    "source=aidp-bashhistory,target=/commandhistory,type=volume",
    // Persist .aidp configuration
    "source=aidp-config,target=/home/aidp/.aidp,type=volume",
    // Persist bundler cache
    "source=aidp-bundle,target=/workspace/vendor/bundle,type=volume"
  ],

  // VS Code customizations
  "customizations": {
    "vscode": {
      // Install useful extensions
      "extensions": [
        // Ruby development
        "Shopify.ruby-lsp",
        "testdouble.vscode-standard-ruby",
        "kaiwood.endwise",

        // Git
        "eamodio.gitlens",
        "mhutchie.git-graph",

        // YAML/config files
        "redhat.vscode-yaml",

        // General development
        "streetsidesoftware.code-spell-checker",
        "EditorConfig.EditorConfig"
      ],

      // VS Code settings
      "settings": {
        // Ruby
        "ruby.lsp.enabled": true,
        "ruby.format": "standard",
        "editor.formatOnSave": true,
        "[ruby]": {
          "editor.defaultFormatter": "Shopify.ruby-lsp",
          "editor.formatOnSave": true,
          "editor.tabSize": 2
        },

        // YAML
        "[yaml]": {
          "editor.defaultFormatter": "redhat.vscode-yaml",
          "editor.tabSize": 2
        },

        // Terminal
        "terminal.integrated.defaultProfile.linux": "zsh",
        "terminal.integrated.profiles.linux": {
          "zsh": {
            "path": "/bin/zsh"
          },
          "bash": {
            "path": "/bin/bash"
          }
        }
      }
    }
  },

  // Container user
  "remoteUser": "aidp",

  // Working directory
  "workspaceFolder": "/workspace",

  // Post-create command - install dependencies
  "postCreateCommand": {
    "gem-dependencies": "gem install bundler git-curate || true",
    "install-claude": "npm install -g @anthropic-ai/claude-code || true",
    "install-markdownlint": "npm install -g markdownlint-cli || true"
  },

  // Post-start command - initialize firewall
  "postStartCommand": {
    "init-firewall": "sudo /usr/local/bin/init-firewall.sh",
    "ensure-bundle": "bundle check || bundle install --jobs 4 --retry 3"
  },
  "waitFor": "postStartCommand",

  // Features to install
  "features": {
    // GitHub CLI
    "ghcr.io/devcontainers/features/github-cli:1": {},
    // Docker-in-Docker (for testing)
    "ghcr.io/devcontainers/features/docker-in-docker:2": {
      // Debian trixie dropped moby packages; use Docker CE instead
      "moby": false
    }
  },

  // Port forwarding - none needed by default
  "forwardPorts": [],

  // Optional: uncomment to keep container running
  // "overrideCommand": true
}

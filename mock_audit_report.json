{
  "total_files": 194,
  "files_with_violations": 73,
  "files_clean": 110,
  "files_need_review": 11,
  "violations_by_file": [
    {
      "file": "spec/aidp/analyze/runner_spec.rb",
      "violations": [
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::Runner",
          "line_num": 9,
          "line": "let(:harness_runner) { instance_double(\"Aidp::Harness::Runner\") }",
          "pattern": "instance_double",
          "target": "Aidp::Harness::Runner"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::Runner",
          "line_num": 9,
          "line": "let(:harness_runner) { instance_double(\"Aidp::Harness::Runner\") }",
          "pattern": "double",
          "target": "Aidp::Harness::Runner"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): YAML",
          "line_num": 19,
          "line": "allow(YAML).to receive(:load_file).and_return({})",
          "pattern": "allow().to receive",
          "target": "YAML"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: runner.progress",
          "line_num": 56,
          "line": "allow(runner.progress).to receive(:step_completed?).and_return(false)",
          "pattern": "allow().to receive",
          "target": "runner.progress"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: runner.progress",
          "line_num": 63,
          "line": "allow(runner.progress).to receive(:step_completed?).and_return(true)",
          "pattern": "allow().to receive",
          "target": "runner.progress"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: runner.progress",
          "line_num": 104,
          "line": "allow(runner.progress).to receive(:completed_steps).and_return([\"01_REPOSITORY_ANALYSIS\"])",
          "pattern": "allow().to receive",
          "target": "runner.progress"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: runner.progress",
          "line_num": 105,
          "line": "allow(runner.progress).to receive(:current_step).and_return(\"02_ARCHITECTURE_ANALYSIS\")",
          "pattern": "allow().to receive",
          "target": "runner.progress"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: runner.progress",
          "line_num": 106,
          "line": "allow(runner.progress).to receive(:started_at).and_return(Time.now - 3600)",
          "pattern": "allow().to receive",
          "target": "runner.progress"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: runner.progress",
          "line_num": 107,
          "line": "allow(runner.progress).to receive(:step_completed?).and_return(false)",
          "pattern": "allow().to receive",
          "target": "runner.progress"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: runner.progress",
          "line_num": 108,
          "line": "allow(runner.progress).to receive(:step_completed?).with(\"01_REPOSITORY_ANALYSIS\").and_return(true)",
          "pattern": "allow().to receive",
          "target": "runner.progress"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): ProviderManager",
          "line_num": 144,
          "line": "allow(harness_runner).to receive(:provider_manager).and_return(instance_double(\"ProviderManager\"))",
          "pattern": "instance_double",
          "target": "ProviderManager"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): ProviderManager",
          "line_num": 152,
          "line": "provider_manager = instance_double(\"ProviderManager\")",
          "pattern": "instance_double",
          "target": "ProviderManager"
        }
      ]
    },
    {
      "file": "spec/aidp/analyze/tree_sitter_scan_spec.rb",
      "violations": [
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 211,
          "line": "scanner.instance_variable_set(:@symbols, [",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 214,
          "line": "scanner.instance_variable_set(:@imports, [",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 217,
          "line": "scanner.instance_variable_set(:@calls, [])",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 218,
          "line": "scanner.instance_variable_set(:@metrics, [])",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 219,
          "line": "scanner.instance_variable_set(:@seams, [])",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 220,
          "line": "scanner.instance_variable_set(:@hotspots, [])",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 221,
          "line": "scanner.instance_variable_set(:@tests, [])",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 222,
          "line": "scanner.instance_variable_set(:@cycles, [])",
          "pattern": "instance_variable manipulation"
        }
      ]
    },
    {
      "file": "spec/aidp/auto_update/bundler_adapter_spec.rb",
      "violations": [
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Aidp",
          "line_num": 54,
          "line": "expect(Aidp).to receive(:log_debug).with(\"bundler_adapter\", \"checking_gem_version\", gem: gem_name)",
          "pattern": "expect().to receive",
          "target": "Aidp"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Aidp",
          "line_num": 55,
          "line": "expect(Aidp).to receive(:log_debug).with(\"bundler_adapter\", \"bundle_outdated_failed\",",
          "pattern": "expect().to receive",
          "target": "Aidp"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Aidp",
          "line_num": 69,
          "line": "expect(Aidp).to receive(:log_debug).with(\"bundler_adapter\", \"checking_gem_version\", gem: gem_name)",
          "pattern": "expect().to receive",
          "target": "Aidp"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Aidp",
          "line_num": 70,
          "line": "expect(Aidp).to receive(:log_error).with(\"bundler_adapter\", \"version_check_failed\",",
          "pattern": "expect().to receive",
          "target": "Aidp"
        }
      ]
    },
    {
      "file": "spec/aidp/cli/enhanced_input_spec.rb",
      "violations": [
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Reline",
          "line_num": 78,
          "line": "allow(Reline).to receive(:readline).and_return(\"reline answer\")",
          "pattern": "allow().to receive",
          "target": "Reline"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Reline",
          "line_num": 79,
          "line": "allow(Reline).to receive(:output=)",
          "pattern": "allow().to receive",
          "target": "Reline"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Reline",
          "line_num": 80,
          "line": "allow(Reline).to receive(:input=)",
          "pattern": "allow().to receive",
          "target": "Reline"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Reline",
          "line_num": 81,
          "line": "allow(Reline).to receive(:completion_append_character=)",
          "pattern": "allow().to receive",
          "target": "Reline"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Reline",
          "line_num": 100,
          "line": "allow(Reline).to receive(:readline).and_return(\"user input\")",
          "pattern": "allow().to receive",
          "target": "Reline"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Reline",
          "line_num": 101,
          "line": "allow(Reline).to receive(:output=)",
          "pattern": "allow().to receive",
          "target": "Reline"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Reline",
          "line_num": 102,
          "line": "allow(Reline).to receive(:input=)",
          "pattern": "allow().to receive",
          "target": "Reline"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Reline",
          "line_num": 103,
          "line": "allow(Reline).to receive(:completion_append_character=)",
          "pattern": "allow().to receive",
          "target": "Reline"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Reline",
          "line_num": 112,
          "line": "allow(Reline).to receive(:readline).and_return(\"\")",
          "pattern": "allow().to receive",
          "target": "Reline"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Reline",
          "line_num": 113,
          "line": "allow(Reline).to receive(:output=)",
          "pattern": "allow().to receive",
          "target": "Reline"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Reline",
          "line_num": 114,
          "line": "allow(Reline).to receive(:input=)",
          "pattern": "allow().to receive",
          "target": "Reline"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Reline",
          "line_num": 115,
          "line": "allow(Reline).to receive(:completion_append_character=)",
          "pattern": "allow().to receive",
          "target": "Reline"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Reline",
          "line_num": 124,
          "line": "allow(Reline).to receive(:readline).and_return(\"  answer with spaces  \")",
          "pattern": "allow().to receive",
          "target": "Reline"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Reline",
          "line_num": 125,
          "line": "allow(Reline).to receive(:output=)",
          "pattern": "allow().to receive",
          "target": "Reline"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Reline",
          "line_num": 126,
          "line": "allow(Reline).to receive(:input=)",
          "pattern": "allow().to receive",
          "target": "Reline"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Reline",
          "line_num": 127,
          "line": "allow(Reline).to receive(:completion_append_character=)",
          "pattern": "allow().to receive",
          "target": "Reline"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Reline",
          "line_num": 136,
          "line": "allow(Reline).to receive(:readline).and_return(\"\", \"  \", \"valid answer\")",
          "pattern": "allow().to receive",
          "target": "Reline"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Reline",
          "line_num": 137,
          "line": "allow(Reline).to receive(:output=)",
          "pattern": "allow().to receive",
          "target": "Reline"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Reline",
          "line_num": 138,
          "line": "allow(Reline).to receive(:input=)",
          "pattern": "allow().to receive",
          "target": "Reline"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Reline",
          "line_num": 139,
          "line": "allow(Reline).to receive(:completion_append_character=)",
          "pattern": "allow().to receive",
          "target": "Reline"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Reline",
          "line_num": 148,
          "line": "allow(Reline).to receive(:readline).and_return(nil)",
          "pattern": "allow().to receive",
          "target": "Reline"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Reline",
          "line_num": 149,
          "line": "allow(Reline).to receive(:output=)",
          "pattern": "allow().to receive",
          "target": "Reline"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Reline",
          "line_num": 150,
          "line": "allow(Reline).to receive(:input=)",
          "pattern": "allow().to receive",
          "target": "Reline"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Reline",
          "line_num": 151,
          "line": "allow(Reline).to receive(:completion_append_character=)",
          "pattern": "allow().to receive",
          "target": "Reline"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Reline",
          "line_num": 162,
          "line": "allow(Reline).to receive(:readline).and_return(\"answer\")",
          "pattern": "allow().to receive",
          "target": "Reline"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Reline",
          "line_num": 163,
          "line": "allow(Reline).to receive(:output=)",
          "pattern": "allow().to receive",
          "target": "Reline"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Reline",
          "line_num": 164,
          "line": "allow(Reline).to receive(:input=)",
          "pattern": "allow().to receive",
          "target": "Reline"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Reline",
          "line_num": 165,
          "line": "allow(Reline).to receive(:completion_append_character=)",
          "pattern": "allow().to receive",
          "target": "Reline"
        }
      ]
    },
    {
      "file": "spec/aidp/cli/models_command_spec.rb",
      "violations": [
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Config",
          "line_num": 220,
          "line": "allow(Aidp::Config).to receive(:config_exists?).with(temp_dir).and_return(true)",
          "pattern": "allow().to receive",
          "target": "Aidp::Config"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Providers::Anthropic",
          "line_num": 223,
          "line": "provider_class = class_double(\"Aidp::Providers::Anthropic\")",
          "pattern": "class_double",
          "target": "Aidp::Providers::Anthropic"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Providers::Anthropic",
          "line_num": 223,
          "line": "provider_class = class_double(\"Aidp::Providers::Anthropic\")",
          "pattern": "double",
          "target": "Aidp::Providers::Anthropic"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Config",
          "line_num": 259,
          "line": "allow(Aidp::Config).to receive(:config_exists?).with(temp_dir).and_return(true)",
          "pattern": "allow().to receive",
          "target": "Aidp::Config"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Providers::Anthropic",
          "line_num": 261,
          "line": "provider_class = class_double(\"Aidp::Providers::Anthropic\")",
          "pattern": "class_double",
          "target": "Aidp::Providers::Anthropic"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Providers::Anthropic",
          "line_num": 261,
          "line": "provider_class = class_double(\"Aidp::Providers::Anthropic\")",
          "pattern": "double",
          "target": "Aidp::Providers::Anthropic"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Config",
          "line_num": 280,
          "line": "allow(Aidp::Config).to receive(:config_exists?).with(temp_dir).and_return(false)",
          "pattern": "allow().to receive",
          "target": "Aidp::Config"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Config",
          "line_num": 293,
          "line": "allow(Aidp::Config).to receive(:config_exists?).and_raise(StandardError.new(\"Validation error\"))",
          "pattern": "allow().to receive",
          "target": "Aidp::Config"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Providers::Anthropic",
          "line_num": 365,
          "line": "provider_class = class_double(\"Aidp::Providers::Anthropic\")",
          "pattern": "class_double",
          "target": "Aidp::Providers::Anthropic"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Providers::Anthropic",
          "line_num": 365,
          "line": "provider_class = class_double(\"Aidp::Providers::Anthropic\")",
          "pattern": "double",
          "target": "Aidp::Providers::Anthropic"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Providers::Anthropic",
          "line_num": 378,
          "line": "provider_class = class_double(\"Aidp::Providers::Anthropic\")",
          "pattern": "class_double",
          "target": "Aidp::Providers::Anthropic"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Providers::Anthropic",
          "line_num": 378,
          "line": "provider_class = class_double(\"Aidp::Providers::Anthropic\")",
          "pattern": "double",
          "target": "Aidp::Providers::Anthropic"
        }
      ]
    },
    {
      "file": "spec/aidp/cli_spec.rb",
      "violations": [
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::UI::EnhancedTUI",
          "line_num": 25,
          "line": "allow(Aidp::Harness::UI::EnhancedTUI).to receive(:new).and_return(mock_tui)",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::UI::EnhancedTUI"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::UI::EnhancedWorkflowSelector",
          "line_num": 26,
          "line": "allow(Aidp::Harness::UI::EnhancedWorkflowSelector).to receive(:new).and_return(mock_workflow_selector)",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::UI::EnhancedWorkflowSelector"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::EnhancedRunner",
          "line_num": 27,
          "line": "allow(Aidp::Harness::EnhancedRunner).to receive(:new).and_return(mock_harness_runner)",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::EnhancedRunner"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::Runner",
          "line_num": 111,
          "line": "allow(Aidp::Harness::Runner).to receive(:new).and_return(mock_harness_runner)",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::Runner"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::Runner",
          "line_num": 155,
          "line": "allow(Aidp::Harness::Runner).to receive(:new).and_return(mock_harness_runner)",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::Runner"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 156,
          "line": "allow(mock_harness_runner).to receive(:instance_variable_get).with(:@state_manager).and_return(mock_state_manager)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::CLI",
          "line_num": 194,
          "line": "allow(Aidp::CLI).to receive(:create_prompt).and_return(test_prompt)",
          "pattern": "allow().to receive",
          "target": "Aidp::CLI"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Setup::Wizard",
          "line_num": 195,
          "line": "expect(Aidp::Setup::Wizard).to receive(:new)",
          "pattern": "expect().to receive",
          "target": "Aidp::Setup::Wizard"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::CLI::FirstRunWizard",
          "line_num": 232,
          "line": "allow(Aidp::CLI::FirstRunWizard).to receive(:ensure_config).and_return(true)",
          "pattern": "allow().to receive",
          "target": "Aidp::CLI::FirstRunWizard"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::UI::EnhancedTUI",
          "line_num": 233,
          "line": "allow(Aidp::Harness::UI::EnhancedTUI).to receive(:new).and_return(double(\"TUI\",",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::UI::EnhancedTUI"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::UI::EnhancedWorkflowSelector",
          "line_num": 237,
          "line": "allow(Aidp::Harness::UI::EnhancedWorkflowSelector).to receive(:new).and_return(double(\"Selector\",",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::UI::EnhancedWorkflowSelector"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::CLI::FirstRunWizard",
          "line_num": 246,
          "line": "allow(Aidp::CLI::FirstRunWizard).to receive(:ensure_config).and_return(false)",
          "pattern": "allow().to receive",
          "target": "Aidp::CLI::FirstRunWizard"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::CLI::FirstRunWizard",
          "line_num": 257,
          "line": "allow(Aidp::CLI::FirstRunWizard).to receive(:setup_config).and_return(true)",
          "pattern": "allow().to receive",
          "target": "Aidp::CLI::FirstRunWizard"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::CLI::FirstRunWizard",
          "line_num": 258,
          "line": "allow(Aidp::CLI::FirstRunWizard).to receive(:ensure_config).and_return(true)",
          "pattern": "allow().to receive",
          "target": "Aidp::CLI::FirstRunWizard"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::CLI::FirstRunWizard",
          "line_num": 270,
          "line": "expect(Aidp::CLI::FirstRunWizard).to receive(:setup_config)",
          "pattern": "expect().to receive",
          "target": "Aidp::CLI::FirstRunWizard"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::CLI::FirstRunWizard",
          "line_num": 276,
          "line": "allow(Aidp::CLI::FirstRunWizard).to receive(:setup_config).and_return(false)",
          "pattern": "allow().to receive",
          "target": "Aidp::CLI::FirstRunWizard"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::CLI::FirstRunWizard",
          "line_num": 285,
          "line": "allow(Aidp::CLI::FirstRunWizard).to receive(:ensure_config).and_return(true)",
          "pattern": "allow().to receive",
          "target": "Aidp::CLI::FirstRunWizard"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Aidp",
          "line_num": 286,
          "line": "allow(Aidp).to receive(:setup_logger)",
          "pattern": "allow().to receive",
          "target": "Aidp"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Aidp",
          "line_num": 287,
          "line": "allow(Aidp).to receive(:logger).and_return(double(\"Logger\", info: nil, warn: nil, level: \"info\"))",
          "pattern": "allow().to receive",
          "target": "Aidp"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::UI::EnhancedTUI",
          "line_num": 291,
          "line": "expect(Aidp::Harness::UI::EnhancedTUI).to receive(:new).and_return(mock_tui)",
          "pattern": "expect().to receive",
          "target": "Aidp::Harness::UI::EnhancedTUI"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::UI::EnhancedWorkflowSelector",
          "line_num": 292,
          "line": "expect(Aidp::Harness::UI::EnhancedWorkflowSelector).to receive(:new).and_return(mock_workflow_selector)",
          "pattern": "expect().to receive",
          "target": "Aidp::Harness::UI::EnhancedWorkflowSelector"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::EnhancedRunner",
          "line_num": 328,
          "line": "expect(Aidp::Harness::EnhancedRunner).to receive(:new).with(",
          "pattern": "expect().to receive",
          "target": "Aidp::Harness::EnhancedRunner"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 367,
          "line": "allow(described_class).to receive(:log_rescue)",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 377,
          "line": "allow(described_class).to receive(:log_rescue)",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 400,
          "line": "allow(described_class).to receive(:display_message) do |msg, type:|",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 414,
          "line": "allow(described_class).to receive(:log_rescue) # avoid dependency on mixin",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 416,
          "line": "allow(described_class).to receive(:display_message) do |msg, type:|",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Aidp",
          "line_num": 560,
          "line": "allow(Aidp).to receive(:setup_logger)",
          "pattern": "allow().to receive",
          "target": "Aidp"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Aidp",
          "line_num": 561,
          "line": "allow(Aidp).to receive(:logger).and_return(double(\"Logger\", info: nil, warn: nil, level: \"info\"))",
          "pattern": "allow().to receive",
          "target": "Aidp"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Aidp",
          "line_num": 571,
          "line": "expect(Aidp).to receive(:setup_logger).with(temp_project_dir, {level: \"debug\", output: \"file\"})",
          "pattern": "expect().to receive",
          "target": "Aidp"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Aidp",
          "line_num": 577,
          "line": "expect(Aidp).to receive(:setup_logger).with(temp_project_dir, {})",
          "pattern": "expect().to receive",
          "target": "Aidp"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 586,
          "line": "allow(described_class).to receive(:log_rescue)",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Aidp",
          "line_num": 588,
          "line": "expect(Aidp).to receive(:setup_logger).once",
          "pattern": "expect().to receive",
          "target": "Aidp"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Aidp",
          "line_num": 596,
          "line": "expect(Aidp).to receive(:setup_logger).with(temp_project_dir, {})",
          "pattern": "expect().to receive",
          "target": "Aidp"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Aidp",
          "line_num": 603,
          "line": "allow(Aidp).to receive(:logger).and_return(logger)",
          "pattern": "allow().to receive",
          "target": "Aidp"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Aidp",
          "line_num": 613,
          "line": "allow(Aidp).to receive(:logger).and_return(logger)",
          "pattern": "allow().to receive",
          "target": "Aidp"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 615,
          "line": "allow(described_class).to receive(:log_rescue)",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 625,
          "line": "expect(described_class).to receive(:run_status_command)",
          "pattern": "expect().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 630,
          "line": "expect(described_class).to receive(:run_jobs_command).with([\"list\"])",
          "pattern": "expect().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 635,
          "line": "expect(described_class).to receive(:run_kb_command).with([\"show\", \"topic\"])",
          "pattern": "expect().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 640,
          "line": "expect(described_class).to receive(:run_harness_command).with([\"status\"])",
          "pattern": "expect().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 645,
          "line": "expect(described_class).to receive(:run_providers_command).with([\"info\", \"claude\"])",
          "pattern": "expect().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 650,
          "line": "expect(described_class).to receive(:run_checkpoint_command).with([\"summary\"])",
          "pattern": "expect().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 655,
          "line": "expect(described_class).to receive(:run_mcp_command).with([\"dashboard\"])",
          "pattern": "expect().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 660,
          "line": "expect(described_class).to receive(:run_issue_command).with([\"import\", \"123\"])",
          "pattern": "expect().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 665,
          "line": "expect(described_class).to receive(:run_config_command).with([\"--interactive\"])",
          "pattern": "expect().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 670,
          "line": "expect(described_class).to receive(:run_init_command).with([\"--dry-run\"])",
          "pattern": "expect().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 675,
          "line": "expect(described_class).to receive(:run_watch_command).with([\"https://example.com/issues\"])",
          "pattern": "expect().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 680,
          "line": "expect(described_class).to receive(:run_ws_command).with([\"list\"])",
          "pattern": "expect().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 685,
          "line": "expect(described_class).to receive(:run_work_command).with([\"--workstream\", \"slug\"])",
          "pattern": "expect().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 690,
          "line": "expect(described_class).to receive(:run_skill_command).with([\"list\"])",
          "pattern": "expect().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 695,
          "line": "allow(described_class).to receive(:run_status_command)",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 701,
          "line": "allow(described_class).to receive(:display_message)",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Execute::Checkpoint",
          "line_num": 717,
          "line": "allow(Aidp::Execute::Checkpoint).to receive(:new).and_return(checkpoint)",
          "pattern": "allow().to receive",
          "target": "Aidp::Execute::Checkpoint"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Execute::CheckpointDisplay",
          "line_num": 718,
          "line": "allow(Aidp::Execute::CheckpointDisplay).to receive(:new).and_return(display)",
          "pattern": "allow().to receive",
          "target": "Aidp::Execute::CheckpointDisplay"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 719,
          "line": "allow(described_class).to receive(:display_message)",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::ConfigManager",
          "line_num": 765,
          "line": "allow(Aidp::Harness::ConfigManager).to receive(:new).and_return(config_manager)",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::ConfigManager"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::ProviderManager",
          "line_num": 766,
          "line": "allow(Aidp::Harness::ProviderManager).to receive(:new).and_return(provider_manager)",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::ProviderManager"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 768,
          "line": "allow(described_class).to receive(:display_message)",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::CLI::ProvidersCommand",
          "line_num": 784,
          "line": "expect(Aidp::CLI::ProvidersCommand).to receive(:new).and_return(command_double)",
          "pattern": "expect().to receive",
          "target": "Aidp::CLI::ProvidersCommand"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::ConfigManager",
          "line_num": 791,
          "line": "allow(Aidp::Harness::ConfigManager).to receive(:new).and_return(config_manager)",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::ConfigManager"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::CLI::ProvidersCommand",
          "line_num": 793,
          "line": "expect(Aidp::CLI::ProvidersCommand).to receive(:new).and_return(command_double)",
          "pattern": "expect().to receive",
          "target": "Aidp::CLI::ProvidersCommand"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Aidp.logger",
          "line_num": 825,
          "line": "allow(Aidp.logger).to receive(:warn)",
          "pattern": "allow().to receive",
          "target": "Aidp.logger"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::CLI::JobsCommand",
          "line_num": 838,
          "line": "allow(Aidp::CLI::JobsCommand).to receive(:new).and_return(jobs_cmd)",
          "pattern": "allow().to receive",
          "target": "Aidp::CLI::JobsCommand"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 855,
          "line": "allow(described_class).to receive(:display_message)",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 898,
          "line": "allow(described_class).to receive(:display_message) # suppress output collection unless needed",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Jobs::BackgroundRunner",
          "line_num": 921,
          "line": "allow(Aidp::Jobs::BackgroundRunner).to receive(:new).and_return(bg_runner)",
          "pattern": "allow().to receive",
          "target": "Aidp::Jobs::BackgroundRunner"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 925,
          "line": "allow(bg_runner).to receive(:instance_variable_get).with(:@jobs_dir).and_return(jobs_dir)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Concurrency::Wait",
          "line_num": 939,
          "line": "allow(Aidp::Concurrency::Wait).to receive(:for_file)",
          "pattern": "allow().to receive",
          "target": "Aidp::Concurrency::Wait"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Concurrency::Wait",
          "line_num": 948,
          "line": "allow(Aidp::Concurrency::Wait).to receive(:for_file).with(log_file, timeout: 10, interval: 0.2)",
          "pattern": "allow().to receive",
          "target": "Aidp::Concurrency::Wait"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Concurrency::Wait",
          "line_num": 956,
          "line": "allow(Aidp::Concurrency::Wait).to receive(:for_file).and_raise(Aidp::Concurrency::TimeoutError.new(\"timeout\"))",
          "pattern": "allow().to receive",
          "target": "Aidp::Concurrency::Wait"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 958,
          "line": "allow(described_class).to receive(:display_message) do |msg, type:|",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 970,
          "line": "allow(described_class).to receive(:display_message) do |msg, type:|",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 981,
          "line": "allow(described_class).to receive(:display_message) do |msg, type:|",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 991,
          "line": "allow(described_class).to receive(:display_message) # generic stub; specific examples capture separately when needed",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 996,
          "line": "allow(described_class).to receive(:display_message) do |msg, type:|",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Worktree",
          "line_num": 1004,
          "line": "allow(Aidp::Worktree).to receive(:info).and_return(nil)",
          "pattern": "allow().to receive",
          "target": "Aidp::Worktree"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 1006,
          "line": "allow(described_class).to receive(:display_message) do |msg, type:|",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Worktree",
          "line_num": 1018,
          "line": "allow(Aidp::Worktree).to receive(:info).and_return(ws_info)",
          "pattern": "allow().to receive",
          "target": "Aidp::Worktree"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Jobs::BackgroundRunner",
          "line_num": 1019,
          "line": "allow(Aidp::Jobs::BackgroundRunner).to receive(:new).and_return(bg_runner)",
          "pattern": "allow().to receive",
          "target": "Aidp::Jobs::BackgroundRunner"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Worktree",
          "line_num": 1042,
          "line": "allow(Aidp::Worktree).to receive(:info).and_return(ws_info)",
          "pattern": "allow().to receive",
          "target": "Aidp::Worktree"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::StateManager",
          "line_num": 1043,
          "line": "allow(Aidp::Harness::StateManager).to receive(:new).and_return(state_manager)",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::StateManager"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::UI::EnhancedTUI",
          "line_num": 1044,
          "line": "allow(Aidp::Harness::UI::EnhancedTUI).to receive(:new).and_return(tui)",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::UI::EnhancedTUI"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::UI::EnhancedWorkflowSelector",
          "line_num": 1045,
          "line": "allow(Aidp::Harness::UI::EnhancedWorkflowSelector).to receive(:new).and_return(selector)",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::UI::EnhancedWorkflowSelector"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::EnhancedRunner",
          "line_num": 1052,
          "line": "allow(Aidp::Harness::EnhancedRunner).to receive(:new).and_return(runner)",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::EnhancedRunner"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 1077,
          "line": "allow(described_class).to receive(:display_message) do |msg, type:|",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Worktree",
          "line_num": 1087,
          "line": "allow(Aidp::Worktree).to receive(:info).and_return({slug: \"ws-x\", path: \"/tmp/ws-x\", branch: \"ws-x\", created_at: Time.now.iso8601, active: true})",
          "pattern": "allow().to receive",
          "target": "Aidp::Worktree"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 1089,
          "line": "allow(described_class).to receive(:display_message) do |msg, type:|",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 1099,
          "line": "allow(described_class).to receive(:display_message) # general stub; per test may override",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Skills::Registry",
          "line_num": 1105,
          "line": "allow(Aidp::Skills::Registry).to receive(:new).and_return(registry)",
          "pattern": "allow().to receive",
          "target": "Aidp::Skills::Registry"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 1110,
          "line": "allow(described_class).to receive(:display_message)",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Skills::Registry",
          "line_num": 1154,
          "line": "allow(Aidp::Skills::Registry).to receive(:new).and_return(registry)",
          "pattern": "allow().to receive",
          "target": "Aidp::Skills::Registry"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 1157,
          "line": "allow(described_class).to receive(:display_message)",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Skills::Registry",
          "line_num": 1175,
          "line": "allow(Aidp::Skills::Registry).to receive(:new).and_return(registry)",
          "pattern": "allow().to receive",
          "target": "Aidp::Skills::Registry"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 1177,
          "line": "allow(described_class).to receive(:display_message)",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Skills::Registry",
          "line_num": 1201,
          "line": "allow(Aidp::Skills::Registry).to receive(:new).and_return(registry)",
          "pattern": "allow().to receive",
          "target": "Aidp::Skills::Registry"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Skills::Wizard::Builder",
          "line_num": 1205,
          "line": "allow(Aidp::Skills::Wizard::Builder).to receive(:new).and_return(builder)",
          "pattern": "allow().to receive",
          "target": "Aidp::Skills::Wizard::Builder"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Skills::Wizard::TemplateLibrary",
          "line_num": 1206,
          "line": "allow(Aidp::Skills::Wizard::TemplateLibrary).to receive(:new).and_return(template_library)",
          "pattern": "allow().to receive",
          "target": "Aidp::Skills::Wizard::TemplateLibrary"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 1207,
          "line": "allow(described_class).to receive(:display_message)",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 1239,
          "line": "allow(described_class).to receive(:display_message)",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Skills::Registry",
          "line_num": 1240,
          "line": "allow(Aidp::Skills::Registry).to receive(:new).and_return(registry)",
          "pattern": "allow().to receive",
          "target": "Aidp::Skills::Registry"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Skills::Registry",
          "line_num": 1255,
          "line": "allow(Aidp::Skills::Registry).to receive(:new).and_return(registry)",
          "pattern": "allow().to receive",
          "target": "Aidp::Skills::Registry"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 1259,
          "line": "allow(described_class).to receive(:display_message)",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 1261,
          "line": "allow(described_class).to receive(:create_prompt).and_return(TestPrompt.new(responses: {yes?: true}))",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 1279,
          "line": "allow(described_class).to receive(:display_message)",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Skills::Wizard::Controller",
          "line_num": 1281,
          "line": "allow(Aidp::Skills::Wizard::Controller).to receive(:new).and_return(controller)",
          "pattern": "allow().to receive",
          "target": "Aidp::Skills::Wizard::Controller"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 1299,
          "line": "allow(described_class).to receive(:display_message)",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Skills::Registry",
          "line_num": 1300,
          "line": "allow(Aidp::Skills::Registry).to receive(:new).and_return(registry)",
          "pattern": "allow().to receive",
          "target": "Aidp::Skills::Registry"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Skills::Wizard::TemplateLibrary",
          "line_num": 1304,
          "line": "allow(Aidp::Skills::Wizard::TemplateLibrary).to receive(:new).and_return(template_library)",
          "pattern": "allow().to receive",
          "target": "Aidp::Skills::Wizard::TemplateLibrary"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Skills::Wizard::Differ",
          "line_num": 1305,
          "line": "allow(Aidp::Skills::Wizard::Differ).to receive(:new).and_return(differ)",
          "pattern": "allow().to receive",
          "target": "Aidp::Skills::Wizard::Differ"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 1355,
          "line": "allow(described_class).to receive(:display_message)",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Skills::Registry",
          "line_num": 1356,
          "line": "allow(Aidp::Skills::Registry).to receive(:new).and_return(registry)",
          "pattern": "allow().to receive",
          "target": "Aidp::Skills::Registry"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Skills::Wizard::Controller",
          "line_num": 1359,
          "line": "allow(Aidp::Skills::Wizard::Controller).to receive(:new).and_return(controller)",
          "pattern": "allow().to receive",
          "target": "Aidp::Skills::Wizard::Controller"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 1410,
          "line": "allow(described_class).to receive(:display_message)",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Skills::Loader",
          "line_num": 1416,
          "line": "allow(Aidp::Skills::Loader).to receive(:load_from_file).with(skill_path)",
          "pattern": "allow().to receive",
          "target": "Aidp::Skills::Loader"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Skills::Loader",
          "line_num": 1425,
          "line": "allow(Aidp::Skills::Loader).to receive(:load_from_file).with(skill_path).and_raise(Aidp::Errors::ValidationError.new(\"Invalid format\"))",
          "pattern": "allow().to receive",
          "target": "Aidp::Skills::Loader"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 1437,
          "line": "allow(described_class).to receive(:display_message)",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Skills::Wizard::Controller",
          "line_num": 1439,
          "line": "allow(Aidp::Skills::Wizard::Controller).to receive(:new).and_return(controller)",
          "pattern": "allow().to receive",
          "target": "Aidp::Skills::Wizard::Controller"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 1492,
          "line": "allow(described_class).to receive(:display_message)",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::CLI",
          "line_num": 1504,
          "line": "allow(Aidp::CLI).to receive(:create_prompt).and_return(prompt_instance)",
          "pattern": "allow().to receive",
          "target": "Aidp::CLI"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Init::Runner",
          "line_num": 1505,
          "line": "allow(Aidp::Init::Runner).to receive(:new).and_return(runner)",
          "pattern": "allow().to receive",
          "target": "Aidp::Init::Runner"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 1512,
          "line": "allow(described_class).to receive(:display_message) do |msg, type:|",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 1522,
          "line": "allow(described_class).to receive(:display_message)",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Watch::Runner",
          "line_num": 1533,
          "line": "allow(Aidp::Watch::Runner).to receive(:new).and_return(watch_runner)",
          "pattern": "allow().to receive",
          "target": "Aidp::Watch::Runner"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Watch::Runner",
          "line_num": 1539,
          "line": "allow(Aidp::Watch::Runner).to receive(:new).and_return(watch_runner)",
          "pattern": "allow().to receive",
          "target": "Aidp::Watch::Runner"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Watch::Runner",
          "line_num": 1545,
          "line": "allow(Aidp::Watch::Runner).to receive(:new).and_raise(ArgumentError.new(\"bad interval\"))",
          "pattern": "allow().to receive",
          "target": "Aidp::Watch::Runner"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 1546,
          "line": "allow(described_class).to receive(:log_rescue)",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Execute::Checkpoint",
          "line_num": 1556,
          "line": "allow(Aidp::Execute::Checkpoint).to receive(:new).and_return(checkpoint)",
          "pattern": "allow().to receive",
          "target": "Aidp::Execute::Checkpoint"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Execute::CheckpointDisplay",
          "line_num": 1557,
          "line": "allow(Aidp::Execute::CheckpointDisplay).to receive(:new).and_return(display)",
          "pattern": "allow().to receive",
          "target": "Aidp::Execute::CheckpointDisplay"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 1558,
          "line": "allow(described_class).to receive(:display_message)",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 1604,
          "line": "allow(described_class).to receive(:display_message)",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::ProviderInfo",
          "line_num": 1609,
          "line": "allow(Aidp::Harness::ProviderInfo).to receive(:new).and_return(mock_provider_info)",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::ProviderInfo"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::ConfigManager",
          "line_num": 1614,
          "line": "allow(Aidp::Harness::ConfigManager).to receive(:new).and_return(config_manager)",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::ConfigManager"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::CLI::ProvidersCommand",
          "line_num": 1616,
          "line": "allow(Aidp::CLI::ProvidersCommand).to receive(:new).and_return(command_double)",
          "pattern": "allow().to receive",
          "target": "Aidp::CLI::ProvidersCommand"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::ConfigManager",
          "line_num": 1627,
          "line": "allow(Aidp::Harness::ConfigManager).to receive(:new).and_return(config_manager)",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::ConfigManager"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::ProviderManager",
          "line_num": 1628,
          "line": "allow(Aidp::Harness::ProviderManager).to receive(:new).and_return(pm)",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::ProviderManager"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 1631,
          "line": "allow(described_class).to receive(:display_message)",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::CLI::McpDashboard",
          "line_num": 1657,
          "line": "allow(Aidp::CLI::McpDashboard).to receive(:new).and_return(dashboard)",
          "pattern": "allow().to receive",
          "target": "Aidp::CLI::McpDashboard"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 1658,
          "line": "allow(described_class).to receive(:display_message)",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 1688,
          "line": "allow(described_class).to receive(:display_message)",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Worktree",
          "line_num": 1689,
          "line": "allow(Aidp::Worktree).to receive(:list).and_return([",
          "pattern": "allow().to receive",
          "target": "Aidp::Worktree"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::WorkstreamState",
          "line_num": 1693,
          "line": "allow(Aidp::WorkstreamState).to receive(:read).and_return({status: \"active\"})",
          "pattern": "allow().to receive",
          "target": "Aidp::WorkstreamState"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::WorkstreamState",
          "line_num": 1694,
          "line": "allow(Aidp::WorkstreamState).to receive(:pause).and_return({})",
          "pattern": "allow().to receive",
          "target": "Aidp::WorkstreamState"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::WorkstreamState",
          "line_num": 1695,
          "line": "allow(Aidp::WorkstreamState).to receive(:resume).and_return({})",
          "pattern": "allow().to receive",
          "target": "Aidp::WorkstreamState"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::WorkstreamState",
          "line_num": 1696,
          "line": "allow(Aidp::WorkstreamState).to receive(:complete).and_return({})",
          "pattern": "allow().to receive",
          "target": "Aidp::WorkstreamState"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::WorkstreamState",
          "line_num": 1705,
          "line": "allow(Aidp::WorkstreamState).to receive(:read).and_return({status: \"paused\"})",
          "pattern": "allow().to receive",
          "target": "Aidp::WorkstreamState"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::WorkstreamExecutor",
          "line_num": 1718,
          "line": "allow(Aidp::WorkstreamExecutor).to receive(:new).and_return(executor)",
          "pattern": "allow().to receive",
          "target": "Aidp::WorkstreamExecutor"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Execute::Checkpoint",
          "line_num": 1795,
          "line": "allow(Aidp::Execute::Checkpoint).to receive(:new).and_return(checkpoint)",
          "pattern": "allow().to receive",
          "target": "Aidp::Execute::Checkpoint"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Execute::CheckpointDisplay",
          "line_num": 1796,
          "line": "allow(Aidp::Execute::CheckpointDisplay).to receive(:new).and_return(display)",
          "pattern": "allow().to receive",
          "target": "Aidp::Execute::CheckpointDisplay"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 1801,
          "line": "allow(described_class).to receive(:display_message) do |msg, type:|",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 1805,
          "line": "allow(described_class).to receive(:print)",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 1827,
          "line": "allow(described_class).to receive(:display_message)",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 1837,
          "line": "allow(described_class).to receive(:display_message)",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::IssueImporter",
          "line_num": 1849,
          "line": "allow(Aidp::IssueImporter).to receive(:new).and_return(importer)",
          "pattern": "allow().to receive",
          "target": "Aidp::IssueImporter"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 1868,
          "line": "allow(described_class).to receive(:display_message)",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::CLI",
          "line_num": 1869,
          "line": "allow(Aidp::CLI).to receive(:create_prompt).and_return(test_prompt)",
          "pattern": "allow().to receive",
          "target": "Aidp::CLI"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Setup::Wizard",
          "line_num": 1884,
          "line": "expect(Aidp::Setup::Wizard).to receive(:new).with(Dir.pwd, prompt: test_prompt, dry_run: false).and_return(wizard)",
          "pattern": "expect().to receive",
          "target": "Aidp::Setup::Wizard"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 1891,
          "line": "allow(described_class).to receive(:display_message)",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Worktree",
          "line_num": 1897,
          "line": "allow(Aidp::Worktree).to receive(:list).and_return([])",
          "pattern": "allow().to receive",
          "target": "Aidp::Worktree"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Worktree",
          "line_num": 1914,
          "line": "allow(Aidp::Worktree).to receive(:create).and_return(result)",
          "pattern": "allow().to receive",
          "target": "Aidp::Worktree"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Worktree",
          "line_num": 1920,
          "line": "allow(Aidp::Worktree).to receive(:create).and_raise(Aidp::Worktree::Error.new(\"failed\"))",
          "pattern": "allow().to receive",
          "target": "Aidp::Worktree"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Worktree",
          "line_num": 1926,
          "line": "allow(Aidp::Worktree).to receive(:remove)",
          "pattern": "allow().to receive",
          "target": "Aidp::Worktree"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 1928,
          "line": "allow(described_class).to receive(:create_prompt).and_return(prompt)",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Worktree",
          "line_num": 1934,
          "line": "allow(Aidp::Worktree).to receive(:remove)",
          "pattern": "allow().to receive",
          "target": "Aidp::Worktree"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Worktree",
          "line_num": 1946,
          "line": "allow(Aidp::Worktree).to receive(:info).and_return(nil)",
          "pattern": "allow().to receive",
          "target": "Aidp::Worktree"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Worktree",
          "line_num": 1958,
          "line": "allow(Aidp::Worktree).to receive(:list).and_return([{slug: \"ws-a\", branch: \"ws-a\", created_at: Time.now.iso8601, active: true}])",
          "pattern": "allow().to receive",
          "target": "Aidp::Worktree"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::WorkstreamExecutor",
          "line_num": 1960,
          "line": "allow(Aidp::WorkstreamExecutor).to receive(:new).and_return(executor)",
          "pattern": "allow().to receive",
          "target": "Aidp::WorkstreamExecutor"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Worktree",
          "line_num": 1973,
          "line": "allow(Aidp::Worktree).to receive(:info).and_return(ws_info)",
          "pattern": "allow().to receive",
          "target": "Aidp::Worktree"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::WorkstreamState",
          "line_num": 1974,
          "line": "allow(Aidp::WorkstreamState).to receive(:read).and_return({status: \"active\", iterations: 0, elapsed: 0, events: []})",
          "pattern": "allow().to receive",
          "target": "Aidp::WorkstreamState"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 1977,
          "line": "allow(described_class).to receive(:system)",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 1987,
          "line": "before { allow(described_class).to receive(:display_message) }",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 1997,
          "line": "allow(described_class).to receive(:display_message) { |m, type:| messages << {m: m, type: type} }",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 2005,
          "line": "allow(described_class).to receive(:display_message) { |m, type:| messages << {m: m, type: type} }",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Aidp",
          "line_num": 2019,
          "line": "allow(Aidp).to receive(:logger).and_return(logger)",
          "pattern": "allow().to receive",
          "target": "Aidp"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Aidp",
          "line_num": 2021,
          "line": "allow(Aidp).to receive(:setup_logger) do",
          "pattern": "allow().to receive",
          "target": "Aidp"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 2025,
          "line": "allow(described_class).to receive(:log_rescue)",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 2062,
          "line": "allow(described_class).to receive(:display_message) do |m, type:|",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 2097,
          "line": "allow(described_class).to receive(:display_message)",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 2123,
          "line": "allow(described_class).to receive(:display_message)",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::UI::EnhancedWorkflowSelector",
          "line_num": 2173,
          "line": "workflow_selector_double = instance_double(\"Aidp::Harness::UI::EnhancedWorkflowSelector\")",
          "pattern": "instance_double",
          "target": "Aidp::Harness::UI::EnhancedWorkflowSelector"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::UI::EnhancedWorkflowSelector",
          "line_num": 2173,
          "line": "workflow_selector_double = instance_double(\"Aidp::Harness::UI::EnhancedWorkflowSelector\")",
          "pattern": "double",
          "target": "Aidp::Harness::UI::EnhancedWorkflowSelector"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::UI::EnhancedWorkflowSelector",
          "line_num": 2174,
          "line": "allow(Aidp::Harness::UI::EnhancedWorkflowSelector).to receive(:new).and_return(workflow_selector_double)",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::UI::EnhancedWorkflowSelector"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::UI::EnhancedTUI",
          "line_num": 2178,
          "line": "tui_double = instance_double(\"Aidp::Harness::UI::EnhancedTUI\")",
          "pattern": "instance_double",
          "target": "Aidp::Harness::UI::EnhancedTUI"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::UI::EnhancedTUI",
          "line_num": 2178,
          "line": "tui_double = instance_double(\"Aidp::Harness::UI::EnhancedTUI\")",
          "pattern": "double",
          "target": "Aidp::Harness::UI::EnhancedTUI"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::UI::EnhancedTUI",
          "line_num": 2179,
          "line": "allow(Aidp::Harness::UI::EnhancedTUI).to receive(:new).and_return(tui_double)",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::UI::EnhancedTUI"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Logger",
          "line_num": 2184,
          "line": "mock_logger = instance_double(\"Aidp::Logger\")",
          "pattern": "instance_double",
          "target": "Aidp::Logger"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Logger",
          "line_num": 2184,
          "line": "mock_logger = instance_double(\"Aidp::Logger\")",
          "pattern": "double",
          "target": "Aidp::Logger"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Aidp",
          "line_num": 2189,
          "line": "allow(Aidp).to receive(:setup_logger)",
          "pattern": "allow().to receive",
          "target": "Aidp"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Aidp",
          "line_num": 2190,
          "line": "allow(Aidp).to receive(:logger).and_return(mock_logger)",
          "pattern": "allow().to receive",
          "target": "Aidp"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::ProviderInfo",
          "line_num": 2207,
          "line": "allow(Aidp::Harness::ProviderInfo).to receive(:new).with(provider_name, anything).and_return(info_object)",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::ProviderInfo"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::CLI",
          "line_num": 2312,
          "line": "allow(Aidp::CLI).to receive(:subcommand?).and_return(false)",
          "pattern": "allow().to receive",
          "target": "Aidp::CLI"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::CLI",
          "line_num": 2313,
          "line": "allow(Aidp::CLI).to receive(:parse_options).and_return({})",
          "pattern": "allow().to receive",
          "target": "Aidp::CLI"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::CLI",
          "line_num": 2314,
          "line": "allow(Aidp::CLI).to receive(:create_prompt).and_return(double(\"Prompt\"))",
          "pattern": "allow().to receive",
          "target": "Aidp::CLI"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::CLI::FirstRunWizard",
          "line_num": 2316,
          "line": "stub_wizard = class_double(\"Aidp::CLI::FirstRunWizard\").as_stubbed_const",
          "pattern": "class_double",
          "target": "Aidp::CLI::FirstRunWizard"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::CLI::FirstRunWizard",
          "line_num": 2316,
          "line": "stub_wizard = class_double(\"Aidp::CLI::FirstRunWizard\").as_stubbed_const",
          "pattern": "double",
          "target": "Aidp::CLI::FirstRunWizard"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::UI::EnhancedTUI",
          "line_num": 2323,
          "line": "allow(Aidp::Harness::UI::EnhancedTUI).to receive(:new).and_return(tui_double)",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::UI::EnhancedTUI"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::UI::EnhancedWorkflowSelector",
          "line_num": 2324,
          "line": "allow(Aidp::Harness::UI::EnhancedWorkflowSelector).to receive(:new).and_return(selector_double)",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::UI::EnhancedWorkflowSelector"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::EnhancedRunner",
          "line_num": 2326,
          "line": "allow(Aidp::Harness::EnhancedRunner).to receive(:new).and_return(runner_double)",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::EnhancedRunner"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::ConfigManager",
          "line_num": 2352,
          "line": "allow(Aidp::Harness::ConfigManager).to receive(:new).and_return(config_manager_double)",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::ConfigManager"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::ProviderManager",
          "line_num": 2373,
          "line": "allow(Aidp::Harness::ProviderManager).to receive(:new).and_return(provider_manager_double)",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::ProviderManager"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::ProviderManager",
          "line_num": 2384,
          "line": "allow(Aidp::Harness::ProviderManager).to receive(:new).and_return(provider_manager_double)",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::ProviderManager"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 2387,
          "line": "allow(described_class).to receive(:log_rescue)",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::CLI",
          "line_num": 2692,
          "line": "allow(Aidp::CLI).to receive(:create_prompt).and_return(test_prompt)",
          "pattern": "allow().to receive",
          "target": "Aidp::CLI"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::CLI",
          "line_num": 2719,
          "line": "allow(Aidp::CLI).to receive(:create_prompt).and_return(test_prompt)",
          "pattern": "allow().to receive",
          "target": "Aidp::CLI"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::CLI",
          "line_num": 2737,
          "line": "allow(Aidp::CLI).to receive(:create_prompt).and_return(test_prompt)",
          "pattern": "allow().to receive",
          "target": "Aidp::CLI"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::CLI",
          "line_num": 2758,
          "line": "allow(Aidp::CLI).to receive(:create_prompt).and_return(test_prompt)",
          "pattern": "allow().to receive",
          "target": "Aidp::CLI"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::CLI",
          "line_num": 2783,
          "line": "allow(Aidp::CLI).to receive(:create_prompt).and_return(test_prompt_decline)",
          "pattern": "allow().to receive",
          "target": "Aidp::CLI"
        }
      ]
    },
    {
      "file": "spec/aidp/concurrency/exec_spec.rb",
      "violations": [
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 6,
          "line": "described_class.instance_variable_set(:@pools, nil)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 7,
          "line": "described_class.instance_variable_set(:@default_pool, nil)",
          "pattern": "instance_variable manipulation"
        }
      ]
    },
    {
      "file": "spec/aidp/daemon/runner_spec.rb",
      "violations": [
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Aidp",
          "line_num": 56,
          "line": "allow(Aidp).to receive(:logger).and_return(logger)",
          "pattern": "allow().to receive",
          "target": "Aidp"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Process",
          "line_num": 110,
          "line": "allow(Process).to receive(:daemon)",
          "pattern": "allow().to receive",
          "target": "Process"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Process",
          "line_num": 112,
          "line": "allow(Process).to receive(:detach)",
          "pattern": "allow().to receive",
          "target": "Process"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Concurrency::Wait",
          "line_num": 113,
          "line": "allow(Aidp::Concurrency::Wait).to receive(:until).and_return(true)",
          "pattern": "allow().to receive",
          "target": "Aidp::Concurrency::Wait"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Process",
          "line_num": 125,
          "line": "allow(Process).to receive(:daemon)",
          "pattern": "allow().to receive",
          "target": "Process"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Process",
          "line_num": 127,
          "line": "allow(Process).to receive(:detach)",
          "pattern": "allow().to receive",
          "target": "Process"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Concurrency::Wait",
          "line_num": 128,
          "line": "allow(Aidp::Concurrency::Wait).to receive(:until).and_raise(Aidp::Concurrency::TimeoutError)",
          "pattern": "allow().to receive",
          "target": "Aidp::Concurrency::Wait"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Signal",
          "line_num": 162,
          "line": "allow(Signal).to receive(:trap).and_return(true)",
          "pattern": "allow().to receive",
          "target": "Signal"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 163,
          "line": "runner.instance_variable_set(:@running, true)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Signal",
          "line_num": 165,
          "line": "expect(Signal).to receive(:trap).with(\"TERM\").and_yield",
          "pattern": "expect().to receive",
          "target": "Signal"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Signal",
          "line_num": 166,
          "line": "expect(Signal).to receive(:trap).with(\"INT\").and_yield",
          "pattern": "expect().to receive",
          "target": "Signal"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 169,
          "line": "expect(runner.instance_variable_get(:@running)).to be false",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Client",
          "line_num": 179,
          "line": "client = instance_double(\"Client\", gets: nil, close: nil)",
          "pattern": "instance_double",
          "target": "Client"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): UNIXServer",
          "line_num": 180,
          "line": "allow(UNIXServer).to receive(:new).and_return(server)",
          "pattern": "allow().to receive",
          "target": "UNIXServer"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 182,
          "line": "runner.instance_variable_set(:@running, false)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Thread",
          "line_num": 185,
          "line": "allow(Thread).to receive(:new).and_yield",
          "pattern": "allow().to receive",
          "target": "Thread"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 188,
          "line": "runner.instance_variable_set(:@running, true)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): UNIXServer",
          "line_num": 196,
          "line": "allow(UNIXServer).to receive(:new).and_raise(StandardError, \"boom\")",
          "pattern": "allow().to receive",
          "target": "UNIXServer"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 207,
          "line": "runner.instance_variable_set(:@watch_runner, double(\"WatchRunner\"))",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 214,
          "line": "runner.instance_variable_set(:@running, true)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 216,
          "line": "expect(runner.instance_variable_get(:@running)).to be false",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 228,
          "line": "runner.instance_variable_set(:@watch_runner, double(\"Watch\"))",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Client",
          "line_num": 243,
          "line": "client = instance_double(\"Client\", gets: \"status\\n\", close: nil)",
          "pattern": "instance_double",
          "target": "Client"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): WorkLoopRunner",
          "line_num": 259,
          "line": "work_loop_runner = instance_double(\"WorkLoopRunner\", cancel: nil)",
          "pattern": "instance_double",
          "target": "WorkLoopRunner"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): UNIXServer",
          "line_num": 260,
          "line": "ipc_server = instance_double(\"UNIXServer\", close: nil)",
          "pattern": "instance_double",
          "target": "UNIXServer"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 261,
          "line": "runner.instance_variable_set(:@work_loop_runner, work_loop_runner)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 262,
          "line": "runner.instance_variable_set(:@ipc_server, ipc_server)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 278,
          "line": "runner.instance_variable_set(:@running, false)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 280,
          "line": "runner.instance_variable_set(:@running, true)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Watch::Runner",
          "line_num": 290,
          "line": "allow(Aidp::Watch::Runner).to receive(:new).and_return(watch_runner)",
          "pattern": "allow().to receive",
          "target": "Aidp::Watch::Runner"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 296,
          "line": "runner.instance_variable_set(:@running, false)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 299,
          "line": "runner.instance_variable_set(:@running, false)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 301,
          "line": "runner.instance_variable_set(:@running, true)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 311,
          "line": "runner.instance_variable_set(:@running, false)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 316,
          "line": "runner.instance_variable_set(:@running, false)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 318,
          "line": "runner.instance_variable_set(:@running, true)",
          "pattern": "instance_variable manipulation"
        }
      ]
    },
    {
      "file": "spec/aidp/debug_mixin_spec.rb",
      "violations": [
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::DebugMixin",
          "line_num": 16,
          "line": "allow(Aidp::DebugMixin).to receive(:shared_logger).and_return(logger)",
          "pattern": "allow().to receive",
          "target": "Aidp::DebugMixin"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): TTY::Command",
          "line_num": 378,
          "line": "expect(TTY::Command).to receive(:new).with(printer: :null).and_call_original",
          "pattern": "expect().to receive",
          "target": "TTY::Command"
        }
      ]
    },
    {
      "file": "spec/aidp/execute/async_work_loop_runner_spec.rb",
      "violations": [
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 223,
          "line": "runner.state.instance_variable_set(:@current_state, :cancelled)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Checkpoint",
          "line_num": 241,
          "line": "checkpoint = instance_double(\"Checkpoint\")",
          "pattern": "instance_double",
          "target": "Checkpoint"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 242,
          "line": "allow(sync_runner).to receive(:instance_variable_get).with(:@checkpoint).and_return(checkpoint)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 354,
          "line": "runner.state.instance_variable_set(:@current_state, :unexpected)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Checkpoint",
          "line_num": 363,
          "line": "let(:checkpoint) { instance_double(\"Checkpoint\") }",
          "pattern": "instance_double",
          "target": "Checkpoint"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 366,
          "line": "runner.instance_variable_set(:@sync_runner, sync_runner)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 367,
          "line": "allow(sync_runner).to receive(:instance_variable_get).with(:@checkpoint).and_return(checkpoint)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 380,
          "line": "runner.instance_variable_set(:@sync_runner, sync_runner)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 381,
          "line": "allow(sync_runner).to receive(:instance_variable_get).with(:@checkpoint).and_return(nil)",
          "pattern": "instance_variable manipulation"
        }
      ]
    },
    {
      "file": "spec/aidp/execute/interactive_repl_spec.rb",
      "violations": [
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: async_runner.state",
          "line_num": 40,
          "line": "allow(async_runner.state).to receive(:request_guard_update)",
          "pattern": "allow().to receive",
          "target": "async_runner.state"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: async_runner.state",
          "line_num": 41,
          "line": "allow(async_runner.state).to receive(:request_config_reload)",
          "pattern": "allow().to receive",
          "target": "async_runner.state"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 58,
          "line": "repl.instance_variable_set(:@async_runner, async_runner)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 75,
          "line": "repl.instance_variable_set(:@async_runner, async_runner)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: repl.instance_variable_get(:@repl_macros)",
          "line_num": 77,
          "line": "allow(repl.instance_variable_get(:@repl_macros)).to receive(:execute).with(\"/pause\").and_return(macro_result)",
          "pattern": "allow().to receive",
          "target": "repl.instance_variable_get(:@repl_macros)"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 77,
          "line": "allow(repl.instance_variable_get(:@repl_macros)).to receive(:execute).with(\"/pause\").and_return(macro_result)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 84,
          "line": "repl.instance_variable_set(:@async_runner, async_runner)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: repl.instance_variable_get(:@repl_macros)",
          "line_num": 86,
          "line": "allow(repl.instance_variable_get(:@repl_macros)).to receive(:execute).with(\"/resume\").and_return(macro_result)",
          "pattern": "allow().to receive",
          "target": "repl.instance_variable_get(:@repl_macros)"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 86,
          "line": "allow(repl.instance_variable_get(:@repl_macros)).to receive(:execute).with(\"/resume\").and_return(macro_result)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 93,
          "line": "repl.instance_variable_set(:@async_runner, async_runner)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: repl.instance_variable_get(:@repl_macros)",
          "line_num": 95,
          "line": "allow(repl.instance_variable_get(:@repl_macros)).to receive(:execute).with(\"/cancel\").and_return(macro_result)",
          "pattern": "allow().to receive",
          "target": "repl.instance_variable_get(:@repl_macros)"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 95,
          "line": "allow(repl.instance_variable_get(:@repl_macros)).to receive(:execute).with(\"/cancel\").and_return(macro_result)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 102,
          "line": "repl.instance_variable_set(:@async_runner, async_runner)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: repl.instance_variable_get(:@repl_macros)",
          "line_num": 104,
          "line": "allow(repl.instance_variable_get(:@repl_macros)).to receive(:execute).with(\"/inject Do it\").and_return(macro_result)",
          "pattern": "allow().to receive",
          "target": "repl.instance_variable_get(:@repl_macros)"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 104,
          "line": "allow(repl.instance_variable_get(:@repl_macros)).to receive(:execute).with(\"/inject Do it\").and_return(macro_result)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 110,
          "line": "repl.instance_variable_set(:@async_runner, async_runner)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: repl.instance_variable_get(:@repl_macros)",
          "line_num": 112,
          "line": "allow(repl.instance_variable_get(:@repl_macros)).to receive(:execute).with(\"/update guard max_tokens=1000\").and_return(macro_result)",
          "pattern": "allow().to receive",
          "target": "repl.instance_variable_get(:@repl_macros)"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 112,
          "line": "allow(repl.instance_variable_get(:@repl_macros)).to receive(:execute).with(\"/update guard max_tokens=1000\").and_return(macro_result)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 119,
          "line": "repl.instance_variable_set(:@async_runner, async_runner)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: repl.instance_variable_get(:@repl_macros)",
          "line_num": 121,
          "line": "allow(repl.instance_variable_get(:@repl_macros)).to receive(:execute).with(\"/reload config\").and_return(macro_result)",
          "pattern": "allow().to receive",
          "target": "repl.instance_variable_get(:@repl_macros)"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 121,
          "line": "allow(repl.instance_variable_get(:@repl_macros)).to receive(:execute).with(\"/reload config\").and_return(macro_result)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 150,
          "line": "repl.instance_variable_set(:@async_runner, async_runner)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: repl.instance_variable_get(:@repl_macros)",
          "line_num": 152,
          "line": "allow(repl.instance_variable_get(:@repl_macros)).to receive(:execute).and_return(macro_result)",
          "pattern": "allow().to receive",
          "target": "repl.instance_variable_get(:@repl_macros)"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 152,
          "line": "allow(repl.instance_variable_get(:@repl_macros)).to receive(:execute).and_return(macro_result)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 162,
          "line": "expect(repl.instance_variable_get(:@prompt)).to eq(prompt)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 167,
          "line": "expect(repl.instance_variable_get(:@prompt)).to eq(prompt)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 172,
          "line": "expect(repl.instance_variable_get(:@repl_macros)).to be_a(Aidp::Execute::ReplMacros)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 210,
          "line": "repl.instance_variable_set(:@async_runner, async_runner)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: async_runner.state",
          "line_num": 212,
          "line": "allow(async_runner.state).to receive(:paused?).and_return(false)",
          "pattern": "allow().to receive",
          "target": "async_runner.state"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 221,
          "line": "repl.instance_variable_set(:@async_runner, async_runner)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: async_runner.state",
          "line_num": 223,
          "line": "allow(async_runner.state).to receive(:paused?).and_return(true)",
          "pattern": "allow().to receive",
          "target": "async_runner.state"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 234,
          "line": "repl.instance_variable_set(:@async_runner, async_runner)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 240,
          "line": "expect(repl.instance_variable_get(:@running)).to be false",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 245,
          "line": "repl.instance_variable_set(:@async_runner, async_runner)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 255,
          "line": "repl.instance_variable_set(:@async_runner, async_runner)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Reline",
          "line_num": 276,
          "line": "allow(Reline).to receive(:readline).and_return(nil)",
          "pattern": "allow().to receive",
          "target": "Reline"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Reline",
          "line_num": 284,
          "line": "allow(Reline).to receive(:readline).and_raise(StandardError.new(\"Test error\"))",
          "pattern": "allow().to receive",
          "target": "Reline"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 301,
          "line": "expect(repl.instance_variable_get(:@completion_setup_needed)).to be false",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 308,
          "line": "repl.instance_variable_set(:@async_runner, async_runner)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 316,
          "line": "repl.instance_variable_set(:@async_runner, async_runner)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 324,
          "line": "repl.instance_variable_set(:@async_runner, async_runner)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 351,
          "line": "repl.instance_variable_set(:@async_runner, async_runner)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 354,
          "line": "thread = repl.instance_variable_get(:@output_display_thread)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 364,
          "line": "repl.instance_variable_set(:@async_runner, async_runner)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 368,
          "line": "thread = repl.instance_variable_get(:@output_display_thread)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 374,
          "line": "repl.instance_variable_set(:@async_runner, async_runner)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 384,
          "line": "repl.instance_variable_set(:@async_runner, async_runner)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: async_runner.state",
          "line_num": 386,
          "line": "allow(async_runner.state).to receive(:paused?).and_return(false)",
          "pattern": "allow().to receive",
          "target": "async_runner.state"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 394,
          "line": "repl.instance_variable_set(:@async_runner, async_runner)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: async_runner.state",
          "line_num": 396,
          "line": "allow(async_runner.state).to receive(:paused?).and_return(false)",
          "pattern": "allow().to receive",
          "target": "async_runner.state"
        }
      ]
    },
    {
      "file": "spec/aidp/execute/repl_macros_spec.rb",
      "violations": [
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 22,
          "line": "macros.instance_variable_set(:@current_skill, \"repo-analyst\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Skills::Registry",
          "line_num": 23,
          "line": "allow(Aidp::Skills::Registry).to receive(:new).and_raise(StandardError, \"boom\")",
          "pattern": "allow().to receive",
          "target": "Aidp::Skills::Registry"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Aidp",
          "line_num": 24,
          "line": "allow(Aidp).to receive(:log_error)",
          "pattern": "allow().to receive",
          "target": "Aidp"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 112,
          "line": "macros.instance_variable_get(:@pinned_files) << \"lib/example.rb\"",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 611,
          "line": "skill_repl.instance_variable_set(:@current_skill, \"nonexistent\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Worktree",
          "line_num": 1868,
          "line": "allow(Aidp::Worktree).to receive(:info).and_raise(Aidp::Worktree::Error, \"boom\")",
          "pattern": "allow().to receive",
          "target": "Aidp::Worktree"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::WorkstreamState",
          "line_num": 1883,
          "line": "allow(Aidp::WorkstreamState).to receive(:pause).and_return({error: \"cannot pause\"})",
          "pattern": "allow().to receive",
          "target": "Aidp::WorkstreamState"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::WorkstreamState",
          "line_num": 1890,
          "line": "allow(Aidp::WorkstreamState).to receive(:pause).and_return({})",
          "pattern": "allow().to receive",
          "target": "Aidp::WorkstreamState"
        }
      ]
    },
    {
      "file": "spec/aidp/execute/runner_spec.rb",
      "violations": [
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::Runner",
          "line_num": 9,
          "line": "let(:harness_runner) { instance_double(\"Aidp::Harness::Runner\") }",
          "pattern": "instance_double",
          "target": "Aidp::Harness::Runner"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::Runner",
          "line_num": 9,
          "line": "let(:harness_runner) { instance_double(\"Aidp::Harness::Runner\") }",
          "pattern": "double",
          "target": "Aidp::Harness::Runner"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): YAML",
          "line_num": 19,
          "line": "allow(YAML).to receive(:load_file).and_return({})",
          "pattern": "allow().to receive",
          "target": "YAML"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: runner.progress",
          "line_num": 97,
          "line": "allow(runner.progress).to receive(:step_completed?).and_return(false)",
          "pattern": "allow().to receive",
          "target": "runner.progress"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: runner.progress",
          "line_num": 104,
          "line": "allow(runner.progress).to receive(:step_completed?).and_return(true)",
          "pattern": "allow().to receive",
          "target": "runner.progress"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: runner.progress",
          "line_num": 111,
          "line": "allow(runner.progress).to receive(:step_completed?).and_return(true)",
          "pattern": "allow().to receive",
          "target": "runner.progress"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: runner.progress",
          "line_num": 117,
          "line": "allow(runner.progress).to receive(:step_completed?).with(\"00_PRD\").and_return(true)",
          "pattern": "allow().to receive",
          "target": "runner.progress"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: runner.progress",
          "line_num": 123,
          "line": "allow(runner.progress).to receive(:mark_step_completed).with(\"00_PRD\")",
          "pattern": "allow().to receive",
          "target": "runner.progress"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: runner.progress",
          "line_num": 131,
          "line": "allow(runner.progress).to receive(:mark_step_in_progress).with(\"00_PRD\")",
          "pattern": "allow().to receive",
          "target": "runner.progress"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: runner.progress",
          "line_num": 177,
          "line": "allow(runner.progress).to receive(:completed_steps).and_return([\"00_LLM_STYLE_GUIDE\"])",
          "pattern": "allow().to receive",
          "target": "runner.progress"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: runner.progress",
          "line_num": 178,
          "line": "allow(runner.progress).to receive(:current_step).and_return(\"00_PRD\")",
          "pattern": "allow().to receive",
          "target": "runner.progress"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: runner.progress",
          "line_num": 179,
          "line": "allow(runner.progress).to receive(:started_at).and_return(Time.now - 3600)",
          "pattern": "allow().to receive",
          "target": "runner.progress"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: runner.progress",
          "line_num": 180,
          "line": "allow(runner.progress).to receive(:step_completed?).and_return(false)",
          "pattern": "allow().to receive",
          "target": "runner.progress"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: runner.progress",
          "line_num": 181,
          "line": "allow(runner.progress).to receive(:step_completed?).with(\"00_LLM_STYLE_GUIDE\").and_return(true)",
          "pattern": "allow().to receive",
          "target": "runner.progress"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: runner.progress",
          "line_num": 208,
          "line": "allow(runner.progress).to receive(:completed_steps).and_return([\"00_PRD\", \"01_NFRS\"])",
          "pattern": "allow().to receive",
          "target": "runner.progress"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: runner.progress",
          "line_num": 217,
          "line": "allow(runner.progress).to receive(:step_completed?).and_return(true)",
          "pattern": "allow().to receive",
          "target": "runner.progress"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): ProviderManager",
          "line_num": 234,
          "line": "allow(harness_runner).to receive(:provider_manager).and_return(instance_double(\"ProviderManager\"))",
          "pattern": "instance_double",
          "target": "ProviderManager"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): ProviderManager",
          "line_num": 242,
          "line": "provider_manager = instance_double(\"ProviderManager\")",
          "pattern": "instance_double",
          "target": "ProviderManager"
        }
      ]
    },
    {
      "file": "spec/aidp/execute/work_loop_header_spec.rb",
      "violations": [
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): CapabilityRegistry",
          "line_num": 25,
          "line": "instance_double(\"CapabilityRegistry\",",
          "pattern": "instance_double",
          "target": "CapabilityRegistry"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::ThinkingDepthManager",
          "line_num": 35,
          "line": "instance_double(\"Aidp::Harness::ThinkingDepthManager\",",
          "pattern": "instance_double",
          "target": "Aidp::Harness::ThinkingDepthManager"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::ThinkingDepthManager",
          "line_num": 35,
          "line": "instance_double(\"Aidp::Harness::ThinkingDepthManager\",",
          "pattern": "double",
          "target": "Aidp::Harness::ThinkingDepthManager"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 64,
          "line": "runner.instance_variable_set(:@step_name, \"16_IMPLEMENTATION\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 65,
          "line": "runner.instance_variable_set(:@iteration_count, 3)",
          "pattern": "instance_variable manipulation"
        }
      ]
    },
    {
      "file": "spec/aidp/execute/work_loop_runner_spec.rb",
      "violations": [
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): ProviderManager",
          "line_num": 9,
          "line": "instance_double(\"ProviderManager\", current_provider: \"anthropic\")",
          "pattern": "instance_double",
          "target": "ProviderManager"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): CapabilityRegistry",
          "line_num": 49,
          "line": "instance_double(\"CapabilityRegistry\",",
          "pattern": "instance_double",
          "target": "CapabilityRegistry"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Logger",
          "line_num": 70,
          "line": "mock_logger = instance_double(\"Aidp::Logger\")",
          "pattern": "instance_double",
          "target": "Aidp::Logger"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Logger",
          "line_num": 70,
          "line": "mock_logger = instance_double(\"Aidp::Logger\")",
          "pattern": "double",
          "target": "Aidp::Logger"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Aidp",
          "line_num": 75,
          "line": "allow(Aidp).to receive(:logger).and_return(mock_logger)",
          "pattern": "allow().to receive",
          "target": "Aidp"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::CapabilityRegistry",
          "line_num": 87,
          "line": "allow(Aidp::Harness::CapabilityRegistry).to receive(:new).and_return(mock_registry)",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::CapabilityRegistry"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 133,
          "line": "state_history = runner.instance_variable_get(:@state_history)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): PromptManager",
          "line_num": 141,
          "line": "let(:prompt_manager) { instance_double(\"PromptManager\") }",
          "pattern": "instance_double",
          "target": "PromptManager"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::TestRunner",
          "line_num": 142,
          "line": "let(:test_runner) { instance_double(\"Aidp::Harness::TestRunner\") }",
          "pattern": "instance_double",
          "target": "Aidp::Harness::TestRunner"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::TestRunner",
          "line_num": 142,
          "line": "let(:test_runner) { instance_double(\"Aidp::Harness::TestRunner\") }",
          "pattern": "double",
          "target": "Aidp::Harness::TestRunner"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Checkpoint",
          "line_num": 143,
          "line": "let(:checkpoint) { instance_double(\"Checkpoint\") }",
          "pattern": "instance_double",
          "target": "Checkpoint"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): CheckpointDisplay",
          "line_num": 144,
          "line": "let(:checkpoint_display) { instance_double(\"CheckpointDisplay\") }",
          "pattern": "instance_double",
          "target": "CheckpointDisplay"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): GuardPolicy",
          "line_num": 145,
          "line": "let(:guard_policy) { instance_double(\"GuardPolicy\") }",
          "pattern": "instance_double",
          "target": "GuardPolicy"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): DeterministicUnits::Runner",
          "line_num": 146,
          "line": "let(:deterministic_runner) { instance_double(\"DeterministicUnits::Runner\") }",
          "pattern": "instance_double",
          "target": "DeterministicUnits::Runner"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): DeterministicUnits::Runner",
          "line_num": 146,
          "line": "let(:deterministic_runner) { instance_double(\"DeterministicUnits::Runner\") }",
          "pattern": "double",
          "target": "DeterministicUnits::Runner"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): WorkLoopUnitScheduler",
          "line_num": 147,
          "line": "let(:unit_scheduler) { instance_double(\"WorkLoopUnitScheduler\") }",
          "pattern": "instance_double",
          "target": "WorkLoopUnitScheduler"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Execute::PromptManager",
          "line_num": 150,
          "line": "allow(Aidp::Execute::PromptManager).to receive(:new).and_return(prompt_manager)",
          "pattern": "allow().to receive",
          "target": "Aidp::Execute::PromptManager"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::TestRunner",
          "line_num": 151,
          "line": "allow(Aidp::Harness::TestRunner).to receive(:new).and_return(test_runner)",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::TestRunner"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Execute::Checkpoint",
          "line_num": 152,
          "line": "allow(Aidp::Execute::Checkpoint).to receive(:new).and_return(checkpoint)",
          "pattern": "allow().to receive",
          "target": "Aidp::Execute::Checkpoint"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Execute::CheckpointDisplay",
          "line_num": 153,
          "line": "allow(Aidp::Execute::CheckpointDisplay).to receive(:new).and_return(checkpoint_display)",
          "pattern": "allow().to receive",
          "target": "Aidp::Execute::CheckpointDisplay"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Execute::GuardPolicy",
          "line_num": 154,
          "line": "allow(Aidp::Execute::GuardPolicy).to receive(:new).and_return(guard_policy)",
          "pattern": "allow().to receive",
          "target": "Aidp::Execute::GuardPolicy"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Execute::DeterministicUnits::Runner",
          "line_num": 155,
          "line": "allow(Aidp::Execute::DeterministicUnits::Runner).to receive(:new).and_return(deterministic_runner)",
          "pattern": "allow().to receive",
          "target": "Aidp::Execute::DeterministicUnits::Runner"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Execute::WorkLoopUnitScheduler",
          "line_num": 156,
          "line": "allow(Aidp::Execute::WorkLoopUnitScheduler).to receive(:new).and_return(unit_scheduler)",
          "pattern": "allow().to receive",
          "target": "Aidp::Execute::WorkLoopUnitScheduler"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Logger",
          "line_num": 236,
          "line": "mock_logger = instance_double(\"Aidp::Logger\")",
          "pattern": "instance_double",
          "target": "Aidp::Logger"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Logger",
          "line_num": 236,
          "line": "mock_logger = instance_double(\"Aidp::Logger\")",
          "pattern": "double",
          "target": "Aidp::Logger"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Aidp",
          "line_num": 237,
          "line": "allow(Aidp).to receive(:logger).and_return(mock_logger)",
          "pattern": "allow().to receive",
          "target": "Aidp"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 456,
          "line": "state_history = runner.instance_variable_get(:@state_history)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): PromptManager",
          "line_num": 523,
          "line": "let(:prompt_manager) { instance_double(\"PromptManager\") }",
          "pattern": "instance_double",
          "target": "PromptManager"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::TestRunner",
          "line_num": 524,
          "line": "let(:test_runner) { instance_double(\"Aidp::Harness::TestRunner\") }",
          "pattern": "instance_double",
          "target": "Aidp::Harness::TestRunner"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::TestRunner",
          "line_num": 524,
          "line": "let(:test_runner) { instance_double(\"Aidp::Harness::TestRunner\") }",
          "pattern": "double",
          "target": "Aidp::Harness::TestRunner"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Checkpoint",
          "line_num": 525,
          "line": "let(:checkpoint) { instance_double(\"Checkpoint\") }",
          "pattern": "instance_double",
          "target": "Checkpoint"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): CheckpointDisplay",
          "line_num": 526,
          "line": "let(:checkpoint_display) { instance_double(\"CheckpointDisplay\") }",
          "pattern": "instance_double",
          "target": "CheckpointDisplay"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Execute::PromptManager",
          "line_num": 529,
          "line": "allow(Aidp::Execute::PromptManager).to receive(:new).and_return(prompt_manager)",
          "pattern": "allow().to receive",
          "target": "Aidp::Execute::PromptManager"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::TestRunner",
          "line_num": 530,
          "line": "allow(Aidp::Harness::TestRunner).to receive(:new).and_return(test_runner)",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::TestRunner"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Execute::Checkpoint",
          "line_num": 531,
          "line": "allow(Aidp::Execute::Checkpoint).to receive(:new).and_return(checkpoint)",
          "pattern": "allow().to receive",
          "target": "Aidp::Execute::Checkpoint"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Execute::CheckpointDisplay",
          "line_num": 532,
          "line": "allow(Aidp::Execute::CheckpointDisplay).to receive(:new).and_return(checkpoint_display)",
          "pattern": "allow().to receive",
          "target": "Aidp::Execute::CheckpointDisplay"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 641,
          "line": "state_history = runner.instance_variable_get(:@state_history)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 687,
          "line": "state_history = runner.instance_variable_get(:@state_history)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::TestRunner",
          "line_num": 696,
          "line": "let(:test_runner) { instance_double(\"Aidp::Harness::TestRunner\") }",
          "pattern": "instance_double",
          "target": "Aidp::Harness::TestRunner"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::TestRunner",
          "line_num": 696,
          "line": "let(:test_runner) { instance_double(\"Aidp::Harness::TestRunner\") }",
          "pattern": "double",
          "target": "Aidp::Harness::TestRunner"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::TestRunner",
          "line_num": 699,
          "line": "allow(Aidp::Harness::TestRunner).to receive(:new).and_return(test_runner)",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::TestRunner"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): PromptManager",
          "line_num": 755,
          "line": "let(:prompt_manager) { instance_double(\"PromptManager\") }",
          "pattern": "instance_double",
          "target": "PromptManager"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Execute::PromptManager",
          "line_num": 758,
          "line": "allow(Aidp::Execute::PromptManager).to receive(:new).and_return(prompt_manager)",
          "pattern": "allow().to receive",
          "target": "Aidp::Execute::PromptManager"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 760,
          "line": "runner.instance_variable_set(:@iteration_count, 1)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 839,
          "line": "runner.instance_variable_set(:@iteration_count, 3)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 840,
          "line": "runner.instance_variable_set(:@state_history, [",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 862,
          "line": "runner.instance_variable_set(:@iteration_count, 1)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 867,
          "line": "runner.instance_variable_set(:@iteration_count, 3)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 872,
          "line": "runner.instance_variable_set(:@iteration_count, 5)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 877,
          "line": "runner.instance_variable_set(:@iteration_count, 10)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 882,
          "line": "runner.instance_variable_set(:@iteration_count, 15)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 889,
          "line": "runner.instance_variable_set(:@iteration_count, 5)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 890,
          "line": "runner.instance_variable_set(:@step_name, \"test_step\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): PromptManager",
          "line_num": 933,
          "line": "let(:prompt_manager) { instance_double(\"PromptManager\") }",
          "pattern": "instance_double",
          "target": "PromptManager"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Execute::PromptManager",
          "line_num": 936,
          "line": "allow(Aidp::Execute::PromptManager).to receive(:new).and_return(prompt_manager)",
          "pattern": "allow().to receive",
          "target": "Aidp::Execute::PromptManager"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 938,
          "line": "runner.instance_variable_set(:@iteration_count, 5)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 960,
          "line": "runner.instance_variable_set(:@iteration_count, 3)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 990,
          "line": "prompt_manager = runner_instance.instance_variable_get(:@prompt_manager)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): PersistentTasklist",
          "line_num": 1015,
          "line": "let(:tasklist) { instance_double(\"PersistentTasklist\", pending: pending_tasks, create: created_task) }",
          "pattern": "instance_double",
          "target": "PersistentTasklist"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1020,
          "line": "runner.instance_variable_set(:@guard_policy, guard_policy)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1021,
          "line": "runner.instance_variable_set(:@persistent_tasklist, tasklist)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Aidp",
          "line_num": 1025,
          "line": "allow(Aidp).to receive(:log_info)",
          "pattern": "allow().to receive",
          "target": "Aidp"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1065,
          "line": "runner.instance_variable_set(:@step_name, \"Implement feature\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1066,
          "line": "runner.instance_variable_set(:@iteration_count, 2)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Execute::AgentSignalParser",
          "line_num": 1067,
          "line": "allow(Aidp::Execute::AgentSignalParser).to receive(:parse_task_filing).and_return([",
          "pattern": "allow().to receive",
          "target": "Aidp::Execute::AgentSignalParser"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1108,
          "line": "runner.instance_variable_set(:@options, {automated: true})",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1114,
          "line": "runner.instance_variable_set(:@options, {})",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1124,
          "line": "let(:test_runner) { runner.instance_variable_get(:@test_runner) }",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1125,
          "line": "let(:prompt_manager) { runner.instance_variable_get(:@prompt_manager) }",
          "pattern": "instance_variable manipulation"
        }
      ]
    },
    {
      "file": "spec/aidp/execute/workflow_selector_spec.rb",
      "violations": [
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 175,
          "line": "user_input = selector.instance_variable_get(:@user_input)",
          "pattern": "instance_variable manipulation"
        }
      ]
    },
    {
      "file": "spec/aidp/harness/ai_decision_engine_spec.rb",
      "violations": [
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::ThinkingDepthManager",
          "line_num": 22,
          "line": "allow(Aidp::Harness::ThinkingDepthManager).to receive(:new)",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::ThinkingDepthManager"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Aidp",
          "line_num": 31,
          "line": "allow(Aidp).to receive(:log_debug)",
          "pattern": "allow().to receive",
          "target": "Aidp"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Aidp",
          "line_num": 32,
          "line": "allow(Aidp).to receive(:log_error)",
          "pattern": "allow().to receive",
          "target": "Aidp"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Aidp",
          "line_num": 103,
          "line": "expect(Aidp).to receive(:log_debug).with(",
          "pattern": "expect().to receive",
          "target": "Aidp"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Aidp",
          "line_num": 213,
          "line": "expect(Aidp).to receive(:log_debug).with(",
          "pattern": "expect().to receive",
          "target": "Aidp"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Aidp",
          "line_num": 317,
          "line": "expect(Aidp).to receive(:log_error).with(",
          "pattern": "expect().to receive",
          "target": "Aidp"
        }
      ]
    },
    {
      "file": "spec/aidp/harness/capability_registry_spec.rb",
      "violations": [
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 436,
          "line": "expect(registry.instance_variable_get(:@catalog_data)).to be_nil",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 438,
          "line": "expect(registry.instance_variable_get(:@catalog_data)).not_to be_nil",
          "pattern": "instance_variable manipulation"
        }
      ]
    },
    {
      "file": "spec/aidp/harness/condition_detector_spec.rb",
      "violations": [
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 11,
          "line": "expect(detector.instance_variable_get(:@rate_limit_patterns)).to have_key(:common)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 12,
          "line": "expect(detector.instance_variable_get(:@rate_limit_patterns)).to have_key(:anthropic)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 13,
          "line": "expect(detector.instance_variable_get(:@rate_limit_patterns)).to have_key(:openai)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 14,
          "line": "expect(detector.instance_variable_get(:@rate_limit_patterns)).to have_key(:google)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 15,
          "line": "expect(detector.instance_variable_get(:@rate_limit_patterns)).to have_key(:cursor)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 19,
          "line": "patterns = detector.instance_variable_get(:@user_feedback_patterns)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 26,
          "line": "patterns = detector.instance_variable_get(:@question_patterns)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 32,
          "line": "patterns = detector.instance_variable_get(:@reset_time_patterns)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 349,
          "line": "expect(patterns).to eq(detector.instance_variable_get(:@rate_limit_patterns)[:common])",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 354,
          "line": "common_patterns = detector.instance_variable_get(:@rate_limit_patterns)[:common]",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 355,
          "line": "anthropic_patterns = detector.instance_variable_get(:@rate_limit_patterns)[:anthropic]",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 362,
          "line": "expect(patterns).to eq(detector.instance_variable_get(:@rate_limit_patterns)[:common])",
          "pattern": "instance_variable manipulation"
        }
      ]
    },
    {
      "file": "spec/aidp/harness/config_loader_spec.rb",
      "violations": [
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: loader.instance_variable_get(:@validator)",
          "line_num": 467,
          "line": "allow(loader.instance_variable_get(:@validator)).to receive(:load_and_validate).and_return({",
          "pattern": "allow().to receive",
          "target": "loader.instance_variable_get(:@validator)"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 467,
          "line": "allow(loader.instance_variable_get(:@validator)).to receive(:load_and_validate).and_return({",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: loader.instance_variable_get(:@validator)",
          "line_num": 472,
          "line": "allow(loader.instance_variable_get(:@validator)).to receive(:validated_config).and_return(valid_config)",
          "pattern": "allow().to receive",
          "target": "loader.instance_variable_get(:@validator)"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 472,
          "line": "allow(loader.instance_variable_get(:@validator)).to receive(:validated_config).and_return(valid_config)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: loader.instance_variable_get(:@validator)",
          "line_num": 493,
          "line": "allow(loader.instance_variable_get(:@validator)).to receive(:fix_common_issues).and_return(true)",
          "pattern": "allow().to receive",
          "target": "loader.instance_variable_get(:@validator)"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 493,
          "line": "allow(loader.instance_variable_get(:@validator)).to receive(:fix_common_issues).and_return(true)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: loader.instance_variable_get(:@validator)",
          "line_num": 515,
          "line": "allow(loader.instance_variable_get(:@validator)).to receive(:fix_common_issues).and_return(false)",
          "pattern": "allow().to receive",
          "target": "loader.instance_variable_get(:@validator)"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 515,
          "line": "allow(loader.instance_variable_get(:@validator)).to receive(:fix_common_issues).and_return(false)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: loader.instance_variable_get(:@validator)",
          "line_num": 528,
          "line": "allow(loader.instance_variable_get(:@validator)).to receive(:validate_existing).and_return({",
          "pattern": "allow().to receive",
          "target": "loader.instance_variable_get(:@validator)"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 528,
          "line": "allow(loader.instance_variable_get(:@validator)).to receive(:validate_existing).and_return({",
          "pattern": "instance_variable manipulation"
        }
      ]
    },
    {
      "file": "spec/aidp/harness/configuration_spec.rb",
      "violations": [
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Config",
          "line_num": 12,
          "line": "allow(Aidp::Config).to receive(:load_harness_config).with(project_dir).and_return(mock_config)",
          "pattern": "allow().to receive",
          "target": "Aidp::Config"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Config",
          "line_num": 13,
          "line": "allow(Aidp::Config).to receive(:validate_harness_config).with(mock_config, project_dir).and_return([])",
          "pattern": "allow().to receive",
          "target": "Aidp::Config"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::ConfigValidator",
          "line_num": 17,
          "line": "allow(Aidp::Harness::ConfigValidator).to receive(:new).with(project_dir).and_return(mock_validator)",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::ConfigValidator"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Config",
          "line_num": 163,
          "line": "expect(Aidp::Config).to receive(:validate_harness_config).with(mock_config, project_dir)",
          "pattern": "expect().to receive",
          "target": "Aidp::Config"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Config",
          "line_num": 168,
          "line": "allow(Aidp::Config).to receive(:validate_harness_config).and_return([\"Invalid config\"])",
          "pattern": "allow().to receive",
          "target": "Aidp::Config"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Config",
          "line_num": 572,
          "line": "expect(Aidp::Config).to receive(:config_exists?).with(project_dir)",
          "pattern": "expect().to receive",
          "target": "Aidp::Config"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Config",
          "line_num": 577,
          "line": "expect(Aidp::Config).to receive(:create_example_config).with(project_dir)",
          "pattern": "expect().to receive",
          "target": "Aidp::Config"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Config",
          "line_num": 592,
          "line": "allow(Aidp::Config).to receive(:load_harness_config).and_return(invalid_config)",
          "pattern": "allow().to receive",
          "target": "Aidp::Config"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Config",
          "line_num": 593,
          "line": "allow(Aidp::Config).to receive(:validate_harness_config).and_return([])",
          "pattern": "allow().to receive",
          "target": "Aidp::Config"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Config",
          "line_num": 603,
          "line": "allow(Aidp::Config).to receive(:load_harness_config).and_return(invalid_config)",
          "pattern": "allow().to receive",
          "target": "Aidp::Config"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Config",
          "line_num": 604,
          "line": "allow(Aidp::Config).to receive(:validate_harness_config).and_return([])",
          "pattern": "allow().to receive",
          "target": "Aidp::Config"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Config",
          "line_num": 614,
          "line": "allow(Aidp::Config).to receive(:load_harness_config).and_return(invalid_config)",
          "pattern": "allow().to receive",
          "target": "Aidp::Config"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Config",
          "line_num": 615,
          "line": "allow(Aidp::Config).to receive(:validate_harness_config).and_return([])",
          "pattern": "allow().to receive",
          "target": "Aidp::Config"
        }
      ]
    },
    {
      "file": "spec/aidp/harness/enhanced_runner_spec.rb",
      "violations": [
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 23,
          "line": "allow(tui).to receive(:instance_variable_set)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 24,
          "line": "allow(tui).to receive(:instance_variable_get).with(:@jobs).and_return({\"main_workflow\" => {}})",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Aidp.logger",
          "line_num": 54,
          "line": "allow(Aidp.logger).to receive(:info)",
          "pattern": "allow().to receive",
          "target": "Aidp.logger"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Aidp.logger",
          "line_num": 55,
          "line": "allow(Aidp.logger).to receive(:error)",
          "pattern": "allow().to receive",
          "target": "Aidp.logger"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::UI",
          "line_num": 56,
          "line": "allow(Aidp::Harness::UI).to receive(:with_processing_spinner).and_yield",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::UI"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 127,
          "line": "instance.instance_variable_set(:@current_provider, \"test_provider\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 146,
          "line": "instance.instance_variable_set(:@current_step, \"step1\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 159,
          "line": "instance.instance_variable_set(:@user_input, {key: \"value\"})",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 172,
          "line": "instance.instance_variable_set(:@execution_log, [\"step1\", \"step2\"])",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 223,
          "line": "instance.instance_variable_set(:@completion_checker, completion_checker)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 228,
          "line": "instance.instance_variable_set(:@workflow_controller, workflow_controller)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 237,
          "line": "expect(instance.instance_variable_get(:@state)).to eq(\"completed\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 238,
          "line": "expect(instance.instance_variable_get(:@start_time)).to eq(freeze_time)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 275,
          "line": "instance.instance_variable_set(:@completion_checker, completion_checker)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 360,
          "line": "paused_instance.instance_variable_set(:@completion_checker, completion_checker)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 365,
          "line": "paused_instance.instance_variable_set(:@workflow_controller, workflow_controller)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 386,
          "line": "paused_instance.instance_variable_set(:@state, \"paused\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 407,
          "line": "paused_instance.instance_variable_set(:@state, \"waiting_for_user\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 421,
          "line": "paused_instance.instance_variable_set(:@state, \"waiting_for_rate_limit\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 451,
          "line": "thread_tracking_instance.instance_variable_set(:@completion_checker, completion_checker)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 456,
          "line": "thread_tracking_instance.instance_variable_set(:@workflow_controller, workflow_controller)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 476,
          "line": "allow(mock_tui).to receive(:instance_variable_get).with(:@jobs).and_return(jobs)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 512,
          "line": "instance.instance_variable_set(:@error_handler, mock_error_handler)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 513,
          "line": "instance.instance_variable_set(:@condition_detector, mock_condition_detector)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Thread",
          "line_num": 523,
          "line": "allow(Thread).to receive(:new).and_yield",
          "pattern": "allow().to receive",
          "target": "Thread"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 635,
          "line": "instance.instance_variable_set(:@project_dir, project_dir)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Thread",
          "line_num": 675,
          "line": "expect(Thread).to receive(:new).once",
          "pattern": "expect().to receive",
          "target": "Thread"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 689,
          "line": "instance.instance_variable_set(:@condition_detector, mock_condition_detector)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 690,
          "line": "instance.instance_variable_set(:@workflow_controller, mock_workflow_controller)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 691,
          "line": "instance.instance_variable_set(:@state_manager, mock_state_manager)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 692,
          "line": "instance.instance_variable_set(:@user_input, {})",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 715,
          "line": "expect(instance.instance_variable_get(:@state)).to eq(\"running\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 792,
          "line": "expect(instance.instance_variable_get(:@state)).to eq(\"running\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 821,
          "line": "instance.instance_variable_set(:@workflow_type, \"test_workflow\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 822,
          "line": "instance.instance_variable_set(:@selected_steps, %w[step1 step2])",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 840,
          "line": "instance.instance_variable_set(:@selected_steps, nil)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 862,
          "line": "instance.instance_variable_set(:@current_provider, \"test_provider\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 880,
          "line": "instance.instance_variable_set(:@current_provider, nil)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 923,
          "line": "instance.instance_variable_set(:@workflow_controller, mock_workflow_controller)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 931,
          "line": "expect(instance.instance_variable_get(:@state)).to eq(\"stopped\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 955,
          "line": "instance.instance_variable_set(:@state, \"running\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 956,
          "line": "instance.instance_variable_set(:@mode, \"test\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 957,
          "line": "instance.instance_variable_set(:@current_step, \"step1\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 958,
          "line": "instance.instance_variable_set(:@current_provider, \"test_provider\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 959,
          "line": "instance.instance_variable_set(:@start_time, start_time)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 960,
          "line": "instance.instance_variable_set(:@user_input, {key1: \"value1\", key2: \"value2\"})",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 961,
          "line": "instance.instance_variable_set(:@execution_log, [\"event1\", \"event2\", \"event3\"])",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 964,
          "line": "allow(mock_tui).to receive(:instance_variable_get).with(:@jobs).and_return({\"job1\" => {}, \"job2\" => {}})",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 984,
          "line": "instance.instance_variable_set(:@start_time, nil)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::UI",
          "line_num": 998,
          "line": "expect(Aidp::Harness::UI).to receive(:with_processing_spinner).with(\"Test message\").and_yield",
          "pattern": "expect().to receive",
          "target": "Aidp::Harness::UI"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1008,
          "line": "instance.instance_variable_set(:@mode, :analyze)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1009,
          "line": "instance.instance_variable_set(:@project_dir, \"/test/project\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Analyze::Runner",
          "line_num": 1011,
          "line": "expect(Aidp::Analyze::Runner).to receive(:new).with(\"/test/project\", instance, prompt: be_a(TTY::Prompt))",
          "pattern": "expect().to receive",
          "target": "Aidp::Analyze::Runner"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1017,
          "line": "instance.instance_variable_set(:@mode, :execute)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1018,
          "line": "instance.instance_variable_set(:@project_dir, \"/test/project\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Execute::Runner",
          "line_num": 1020,
          "line": "expect(Aidp::Execute::Runner).to receive(:new).with(\"/test/project\", instance, prompt: be_a(TTY::Prompt))",
          "pattern": "expect().to receive",
          "target": "Aidp::Execute::Runner"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1026,
          "line": "instance.instance_variable_set(:@mode, :unsupported)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1046,
          "line": "instance.instance_variable_set(:@state, \"stopped\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1051,
          "line": "instance.instance_variable_set(:@state, \"completed\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1056,
          "line": "instance.instance_variable_set(:@state, \"error\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1061,
          "line": "instance.instance_variable_set(:@state, \"running\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1068,
          "line": "instance.instance_variable_set(:@state, \"paused\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1073,
          "line": "instance.instance_variable_set(:@state, \"waiting_for_user\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1078,
          "line": "instance.instance_variable_set(:@state, \"waiting_for_rate_limit\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1083,
          "line": "instance.instance_variable_set(:@state, \"running\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1090,
          "line": "instance.instance_variable_set(:@state, \"paused\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1091,
          "line": "sleeper = instance.instance_variable_get(:@sleeper)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1098,
          "line": "instance.instance_variable_set(:@state, \"waiting_for_user\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1106,
          "line": "instance.instance_variable_set(:@state, \"waiting_for_rate_limit\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1166,
          "line": "instance.instance_variable_set(:@state_manager, mock_state_manager)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1167,
          "line": "instance.instance_variable_set(:@state, \"running\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1168,
          "line": "instance.instance_variable_set(:@current_step, \"step1\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1169,
          "line": "instance.instance_variable_set(:@current_provider, \"test_provider\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1170,
          "line": "instance.instance_variable_set(:@user_input, {key: \"value\"})",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1196,
          "line": "instance.instance_variable_set(:@state_manager, mock_state_manager)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1197,
          "line": "instance.instance_variable_set(:@user_input, {})",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1241,
          "line": "instance.instance_variable_set(:@state_manager, mock_state_manager)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1242,
          "line": "instance.instance_variable_set(:@state, \"completed\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1243,
          "line": "instance.instance_variable_set(:@current_step, \"final_step\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1244,
          "line": "instance.instance_variable_set(:@current_provider, \"test_provider\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1245,
          "line": "instance.instance_variable_set(:@user_input, {key: \"value\"})",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1276,
          "line": "instance.instance_variable_set(:@mode, :analyze)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1285,
          "line": "instance.instance_variable_set(:@mode, :execute)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1299,
          "line": "instance.instance_variable_set(:@execution_log, [])",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1357,
          "line": "instance.instance_variable_set(:@workflow_controller, mock_workflow_controller)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1386,
          "line": "expect(instance.instance_variable_get(:@state)).to eq(\"completed\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1403,
          "line": "expect(instance.instance_variable_get(:@state)).to eq(\"error\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1414,
          "line": "instance.instance_variable_set(:@current_provider, \"current_provider\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1427,
          "line": "expect(instance.instance_variable_get(:@state)).to eq(\"running\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1456,
          "line": "expect(instance.instance_variable_get(:@current_provider)).to eq(\"new_provider\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1457,
          "line": "expect(instance.instance_variable_get(:@state)).to eq(\"running\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1502,
          "line": "expect(instance.instance_variable_get(:@state)).to eq(\"running\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1514,
          "line": "expect(instance.instance_variable_get(:@state)).to eq(\"error\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1525,
          "line": "instance.instance_variable_set(:@state, \"waiting_for_rate_limit\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1535,
          "line": "sleeper = instance.instance_variable_get(:@sleeper)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1548,
          "line": "allow(mock_tui).to receive(:instance_variable_get).with(:@jobs).and_return(jobs)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1565,
          "line": "instance.instance_variable_set(:@state, \"completed\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1570,
          "line": "instance.instance_variable_set(:@state, \"stopped\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1575,
          "line": "instance.instance_variable_set(:@state, \"error\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1580,
          "line": "instance.instance_variable_set(:@state, \"unknown\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): ModeRunner",
          "line_num": 1587,
          "line": "let(:mock_runner) { instance_double(\"ModeRunner\") }",
          "pattern": "instance_double",
          "target": "ModeRunner"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1599,
          "line": "allow(mock_tui).to receive(:instance_variable_get).with(:@jobs).and_return({})",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Thread",
          "line_num": 1609,
          "line": "allow(Thread).to receive(:new).and_yield",
          "pattern": "allow().to receive",
          "target": "Thread"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1612,
          "line": "instance.instance_variable_set(:@error_handler, mock_error_handler)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1757,
          "line": "expect(instance.instance_variable_get(:@current_provider)).to eq(\"openai\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Configuration",
          "line_num": 1763,
          "line": "let(:mock_configuration) { instance_double(\"Configuration\") }",
          "pattern": "instance_double",
          "target": "Configuration"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1766,
          "line": "instance.instance_variable_set(:@configuration, mock_configuration)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1876,
          "line": "mock_condition_detector = instance.instance_variable_get(:@condition_detector)",
          "pattern": "instance_variable manipulation"
        }
      ]
    },
    {
      "file": "spec/aidp/harness/error_handler_spec.rb",
      "violations": [
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::ProviderManager",
          "line_num": 6,
          "line": "let(:provider_manager) { instance_double(\"Aidp::Harness::ProviderManager\") }",
          "pattern": "instance_double",
          "target": "Aidp::Harness::ProviderManager"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::ProviderManager",
          "line_num": 6,
          "line": "let(:provider_manager) { instance_double(\"Aidp::Harness::ProviderManager\") }",
          "pattern": "double",
          "target": "Aidp::Harness::ProviderManager"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::Configuration",
          "line_num": 7,
          "line": "let(:configuration) { instance_double(\"Aidp::Harness::Configuration\") }",
          "pattern": "instance_double",
          "target": "Aidp::Harness::Configuration"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::Configuration",
          "line_num": 7,
          "line": "let(:configuration) { instance_double(\"Aidp::Harness::Configuration\") }",
          "pattern": "double",
          "target": "Aidp::Harness::Configuration"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::MetricsManager",
          "line_num": 8,
          "line": "let(:metrics_manager) { instance_double(\"Aidp::Harness::MetricsManager\") }",
          "pattern": "instance_double",
          "target": "Aidp::Harness::MetricsManager"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::MetricsManager",
          "line_num": 8,
          "line": "let(:metrics_manager) { instance_double(\"Aidp::Harness::MetricsManager\") }",
          "pattern": "double",
          "target": "Aidp::Harness::MetricsManager"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 31,
          "line": "strategies = error_handler.instance_variable_get(:@retry_strategies)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 45,
          "line": "expect(error_handler.instance_variable_get(:@backoff_calculator)).to be_a(described_class::BackoffCalculator)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 46,
          "line": "expect(error_handler.instance_variable_get(:@error_classifier)).to be_a(described_class::ErrorClassifier)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 47,
          "line": "expect(error_handler.instance_variable_get(:@recovery_planner)).to be_a(described_class::RecoveryPlanner)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: error_handler.instance_variable_get(:@error_classifier)",
          "line_num": 65,
          "line": "allow(error_handler.instance_variable_get(:@error_classifier)).to receive(:classify_error).and_return({",
          "pattern": "allow().to receive",
          "target": "error_handler.instance_variable_get(:@error_classifier)"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 65,
          "line": "allow(error_handler.instance_variable_get(:@error_classifier)).to receive(:classify_error).and_return({",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: error_handler.instance_variable_get(:@error_classifier)",
          "line_num": 83,
          "line": "allow(error_handler.instance_variable_get(:@error_classifier)).to receive(:classify_error).and_return({",
          "pattern": "allow().to receive",
          "target": "error_handler.instance_variable_get(:@error_classifier)"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 83,
          "line": "allow(error_handler.instance_variable_get(:@error_classifier)).to receive(:classify_error).and_return({",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: error_handler.instance_variable_get(:@error_classifier)",
          "line_num": 104,
          "line": "allow(error_handler.instance_variable_get(:@error_classifier)).to receive(:classify_error).and_return({",
          "pattern": "allow().to receive",
          "target": "error_handler.instance_variable_get(:@error_classifier)"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 104,
          "line": "allow(error_handler.instance_variable_get(:@error_classifier)).to receive(:classify_error).and_return({",
          "pattern": "instance_variable manipulation"
        }
      ]
    },
    {
      "file": "spec/aidp/harness/model_discovery_service_spec.rb",
      "violations": [
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Providers::Anthropic",
          "line_num": 35,
          "line": "allow(Aidp::Providers::Anthropic).to receive(:available?).and_return(true)",
          "pattern": "allow().to receive",
          "target": "Aidp::Providers::Anthropic"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Providers::Anthropic",
          "line_num": 36,
          "line": "allow(Aidp::Providers::Anthropic).to receive(:discover_models).and_return(sample_models)",
          "pattern": "allow().to receive",
          "target": "Aidp::Providers::Anthropic"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Providers::Anthropic",
          "line_num": 82,
          "line": "allow(Aidp::Providers::Anthropic).to receive(:available?).and_return(false)",
          "pattern": "allow().to receive",
          "target": "Aidp::Providers::Anthropic"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Providers::Anthropic",
          "line_num": 95,
          "line": "allow(Aidp::Providers::Anthropic).to receive(:discover_models).and_raise(StandardError, \"Discovery failed\")",
          "pattern": "allow().to receive",
          "target": "Aidp::Providers::Anthropic"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Providers::Anthropic",
          "line_num": 107,
          "line": "allow(Aidp::Providers::Anthropic).to receive(:available?).and_return(true)",
          "pattern": "allow().to receive",
          "target": "Aidp::Providers::Anthropic"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Providers::Cursor",
          "line_num": 108,
          "line": "allow(Aidp::Providers::Cursor).to receive(:available?).and_return(true)",
          "pattern": "allow().to receive",
          "target": "Aidp::Providers::Cursor"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Providers::Gemini",
          "line_num": 109,
          "line": "allow(Aidp::Providers::Gemini).to receive(:available?).and_return(true)",
          "pattern": "allow().to receive",
          "target": "Aidp::Providers::Gemini"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Providers::Anthropic",
          "line_num": 110,
          "line": "allow(Aidp::Providers::Anthropic).to receive(:discover_models).and_return(sample_models)",
          "pattern": "allow().to receive",
          "target": "Aidp::Providers::Anthropic"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Providers::Cursor",
          "line_num": 111,
          "line": "allow(Aidp::Providers::Cursor).to receive(:discover_models).and_return([])",
          "pattern": "allow().to receive",
          "target": "Aidp::Providers::Cursor"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Providers::Gemini",
          "line_num": 112,
          "line": "allow(Aidp::Providers::Gemini).to receive(:discover_models).and_return([])",
          "pattern": "allow().to receive",
          "target": "Aidp::Providers::Gemini"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Providers::Anthropic",
          "line_num": 133,
          "line": "allow(Aidp::Providers::Anthropic).to receive(:supports_model_family?).with(\"claude-3-5-sonnet\").and_return(true)",
          "pattern": "allow().to receive",
          "target": "Aidp::Providers::Anthropic"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Providers::Cursor",
          "line_num": 134,
          "line": "allow(Aidp::Providers::Cursor).to receive(:supports_model_family?).with(\"claude-3-5-sonnet\").and_return(true)",
          "pattern": "allow().to receive",
          "target": "Aidp::Providers::Cursor"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Providers::Gemini",
          "line_num": 135,
          "line": "allow(Aidp::Providers::Gemini).to receive(:supports_model_family?).with(\"claude-3-5-sonnet\").and_return(false)",
          "pattern": "allow().to receive",
          "target": "Aidp::Providers::Gemini"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Providers::Anthropic",
          "line_num": 148,
          "line": "allow(Aidp::Providers::Anthropic).to receive(:available?).and_return(true)",
          "pattern": "allow().to receive",
          "target": "Aidp::Providers::Anthropic"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Providers::Anthropic",
          "line_num": 149,
          "line": "allow(Aidp::Providers::Anthropic).to receive(:discover_models).and_return(sample_models)",
          "pattern": "allow().to receive",
          "target": "Aidp::Providers::Anthropic"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Providers::Anthropic",
          "line_num": 163,
          "line": "allow(Aidp::Providers::Anthropic).to receive(:available?).and_return(true)",
          "pattern": "allow().to receive",
          "target": "Aidp::Providers::Anthropic"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Providers::Cursor",
          "line_num": 164,
          "line": "allow(Aidp::Providers::Cursor).to receive(:available?).and_return(false)",
          "pattern": "allow().to receive",
          "target": "Aidp::Providers::Cursor"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Providers::Gemini",
          "line_num": 165,
          "line": "allow(Aidp::Providers::Gemini).to receive(:available?).and_return(false)",
          "pattern": "allow().to receive",
          "target": "Aidp::Providers::Gemini"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Providers::Anthropic",
          "line_num": 166,
          "line": "allow(Aidp::Providers::Anthropic).to receive(:discover_models).and_return(sample_models)",
          "pattern": "allow().to receive",
          "target": "Aidp::Providers::Anthropic"
        }
      ]
    },
    {
      "file": "spec/aidp/harness/performance_simple_spec.rb",
      "violations": [
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 57,
          "line": "error_handler.instance_variable_get(:@retry_strategies)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 113,
          "line": "error_handler.instance_variable_get(:@error_classifier).classify_error(",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 253,
          "line": "provider_manager = harness_runner.instance_variable_get(:@provider_manager)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 319,
          "line": "error_handler.instance_variable_get(:@error_classifier).classify_error(",
          "pattern": "instance_variable manipulation"
        }
      ]
    },
    {
      "file": "spec/aidp/harness/provider_config_spec.rb",
      "violations": [
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 591,
          "line": "expect(factory.instance_variable_get(:@provider_instances)).to be_empty",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 592,
          "line": "expect(factory.instance_variable_get(:@provider_configs)).to be_empty",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 598,
          "line": "expect(factory.instance_variable_get(:@provider_instances)).to be_empty",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 599,
          "line": "expect(factory.instance_variable_get(:@provider_configs)).to be_empty",
          "pattern": "instance_variable manipulation"
        }
      ]
    },
    {
      "file": "spec/aidp/harness/provider_failure_exhausted_spec.rb",
      "violations": [
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 52,
          "line": "health_after = provider_manager.instance_variable_get(:@provider_health)[start_provider]",
          "pattern": "instance_variable manipulation"
        }
      ]
    },
    {
      "file": "spec/aidp/harness/provider_info_spec.rb",
      "violations": [
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Util",
          "line_num": 606,
          "line": "allow(Aidp::Util).to receive(:which).and_return(\"/usr/bin/test-binary\")",
          "pattern": "allow().to receive",
          "target": "Aidp::Util"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Process",
          "line_num": 607,
          "line": "allow(Process).to receive(:spawn).and_raise(StandardError.new(\"Spawn error\"))",
          "pattern": "allow().to receive",
          "target": "Process"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Util",
          "line_num": 619,
          "line": "allow(Aidp::Util).to receive(:which).and_return(\"/usr/bin/test-binary\")",
          "pattern": "allow().to receive",
          "target": "Aidp::Util"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Process",
          "line_num": 620,
          "line": "allow(Process).to receive(:spawn).and_return(99_999)",
          "pattern": "allow().to receive",
          "target": "Process"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Process",
          "line_num": 621,
          "line": "allow(Process).to receive(:waitpid2).and_return(nil) # Timeout",
          "pattern": "allow().to receive",
          "target": "Process"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Process",
          "line_num": 622,
          "line": "allow(Process).to receive(:kill).and_raise(StandardError.new(\"Kill error\"))",
          "pattern": "allow().to receive",
          "target": "Process"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Concurrency::Wait",
          "line_num": 624,
          "line": "allow(Aidp::Concurrency::Wait).to receive(:for_process_exit).and_raise(Aidp::Concurrency::TimeoutError.new(\"Mocked timeout\"))",
          "pattern": "allow().to receive",
          "target": "Aidp::Concurrency::Wait"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Util",
          "line_num": 636,
          "line": "allow(Aidp::Util).to receive(:which).and_raise(StandardError.new(\"Which error\"))",
          "pattern": "allow().to receive",
          "target": "Aidp::Util"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Util",
          "line_num": 729,
          "line": "allow(Aidp::Util).to receive(:which).and_return(nil)",
          "pattern": "allow().to receive",
          "target": "Aidp::Util"
        }
      ]
    },
    {
      "file": "spec/aidp/harness/provider_manager_model_spec.rb",
      "violations": [
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::ProviderMetrics",
          "line_num": 23,
          "line": "allow(Aidp::Harness::ProviderMetrics).to receive(:new).and_return(mock_metrics_persistence)",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::ProviderMetrics"
        }
      ]
    },
    {
      "file": "spec/aidp/harness/provider_manager_spec.rb",
      "violations": [
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::ProviderMetrics",
          "line_num": 29,
          "line": "allow(Aidp::Harness::ProviderMetrics).to receive(:new).and_return(mock_metrics_persistence)",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::ProviderMetrics"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 666,
          "line": "manager.instance_variable_set(:@current_model, \"claude-3-opus\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 679,
          "line": "manager.instance_variable_set(:@current_model, \"claude-3-sonnet\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1113,
          "line": "manager.instance_variable_set(:@sticky_sessions, {})",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1125,
          "line": "manager.instance_variable_set(:@sticky_sessions, {})",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1158,
          "line": "cache = manager.instance_variable_get(:@binary_check_cache)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): IO",
          "line_num": 1193,
          "line": "allow(IO).to receive(:pipe).and_return([r, w])",
          "pattern": "allow().to receive",
          "target": "IO"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Process",
          "line_num": 1194,
          "line": "allow(Process).to receive(:spawn).with(\"claude\", \"--version\", out: w, err: w).and_return(fake_pid)",
          "pattern": "allow().to receive",
          "target": "Process"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Concurrency::Wait",
          "line_num": 1197,
          "line": "allow(Aidp::Concurrency::Wait).to receive(:for_process_exit).with(fake_pid, timeout: 3, interval: 0.05).and_raise(Aidp::Concurrency::TimeoutError)",
          "pattern": "allow().to receive",
          "target": "Aidp::Concurrency::Wait"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Concurrency::Wait",
          "line_num": 1200,
          "line": "allow(Aidp::Concurrency::Wait).to receive(:for_process_exit).with(fake_pid, timeout: 0.1, interval: 0.02).and_raise(Aidp::Concurrency::TimeoutError)",
          "pattern": "allow().to receive",
          "target": "Aidp::Concurrency::Wait"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Process",
          "line_num": 1203,
          "line": "expect(Process).to receive(:kill).with(\"TERM\", fake_pid).ordered",
          "pattern": "expect().to receive",
          "target": "Process"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Process",
          "line_num": 1204,
          "line": "expect(Process).to receive(:kill).with(\"KILL\", fake_pid).ordered",
          "pattern": "expect().to receive",
          "target": "Process"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1207,
          "line": "cache = manager.instance_variable_get(:@binary_check_cache)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1223,
          "line": "cache = manager.instance_variable_get(:@binary_check_cache)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1237,
          "line": "cache = manager.instance_variable_get(:@binary_check_cache)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1250,
          "line": "ttl = manager.instance_variable_get(:@binary_check_ttl)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): IO",
          "line_num": 1258,
          "line": "allow(IO).to receive(:pipe).and_return([r, w])",
          "pattern": "allow().to receive",
          "target": "IO"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Process",
          "line_num": 1260,
          "line": "allow(Process).to receive(:spawn).with(\"claude\", \"--version\", out: w, err: w).and_return(fake_pid)",
          "pattern": "allow().to receive",
          "target": "Process"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Concurrency::Wait",
          "line_num": 1261,
          "line": "allow(Aidp::Concurrency::Wait).to receive(:for_process_exit).with(fake_pid, timeout: 3, interval: 0.05).and_return(true)",
          "pattern": "allow().to receive",
          "target": "Aidp::Concurrency::Wait"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1451,
          "line": "metrics = manager.instance_variable_get(:@provider_metrics)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1487,
          "line": "rate_info = manager.instance_variable_get(:@rate_limit_info)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1527,
          "line": "health = manager.instance_variable_get(:@provider_health)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1542,
          "line": "manager.instance_variable_set(:@provider_health, {})",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1543,
          "line": "manager.instance_variable_set(:@provider_metrics, {})",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1544,
          "line": "manager.instance_variable_set(:@rate_limit_info, {})",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1558,
          "line": "manager.instance_variable_get(:@provider_health).delete(\"anthropic\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1677,
          "line": "initial_sessions = manager.instance_variable_get(:@sticky_sessions).dup",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1681,
          "line": "expect(manager.instance_variable_get(:@sticky_sessions)).to eq(initial_sessions)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 2176,
          "line": "@large_manager.instance_variable_set(:@load_balancing_enabled, true)",
          "pattern": "instance_variable manipulation"
        }
      ]
    },
    {
      "file": "spec/aidp/harness/provider_metrics_spec.rb",
      "violations": [
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): YAML",
          "line_num": 229,
          "line": "allow(YAML).to receive(:safe_load_file).and_raise(Errno::EACCES)",
          "pattern": "allow().to receive",
          "target": "YAML"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): YAML",
          "line_num": 412,
          "line": "allow(YAML).to receive(:safe_load_file).and_raise(StandardError.new(\"read error\"))",
          "pattern": "allow().to receive",
          "target": "YAML"
        }
      ]
    },
    {
      "file": "spec/aidp/harness/runner_spec.rb",
      "violations": [
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 65,
          "line": "expect(runner.instance_variable_get(:@mode)).to eq(:analyze)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 66,
          "line": "expect(runner.instance_variable_get(:@project_dir)).to eq(temp_dir)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 71,
          "line": "expect(execute_runner.instance_variable_get(:@mode)).to eq(:execute)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 75,
          "line": "expect(runner.instance_variable_get(:@configuration)).to be_a(Aidp::Harness::Configuration)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 76,
          "line": "expect(runner.instance_variable_get(:@state_manager)).to be_a(Aidp::Harness::StateManager)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 77,
          "line": "expect(runner.instance_variable_get(:@condition_detector)).to be_a(Aidp::Harness::ZfcConditionDetector)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 78,
          "line": "expect(runner.instance_variable_get(:@provider_manager)).to be_a(Aidp::Harness::ProviderManager)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 79,
          "line": "expect(runner.instance_variable_get(:@user_interface)).to be_a(Aidp::Harness::SimpleUserInterface)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 80,
          "line": "expect(runner.instance_variable_get(:@error_handler)).to be_a(Aidp::Harness::ErrorHandler)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 81,
          "line": "expect(runner.instance_variable_get(:@status_display)).to be_a(Aidp::Harness::StatusDisplay)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 85,
          "line": "expect(runner.instance_variable_get(:@state)).to eq(\"idle\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 126,
          "line": "runner.instance_variable_set(:@state, \"running\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 128,
          "line": "expect(runner.instance_variable_get(:@state)).to eq(\"paused\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 132,
          "line": "runner.instance_variable_set(:@state, \"idle\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 134,
          "line": "expect(runner.instance_variable_get(:@state)).to eq(\"idle\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 140,
          "line": "runner.instance_variable_set(:@state, \"paused\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 142,
          "line": "expect(runner.instance_variable_get(:@state)).to eq(\"running\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 146,
          "line": "runner.instance_variable_set(:@state, \"idle\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 148,
          "line": "expect(runner.instance_variable_get(:@state)).to eq(\"idle\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 154,
          "line": "runner.instance_variable_set(:@state, \"running\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 156,
          "line": "expect(runner.instance_variable_get(:@state)).to eq(\"stopped\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 173,
          "line": "runner.instance_variable_set(:@mode, :invalid)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 187,
          "line": "runner.instance_variable_set(:@state_manager, state_manager)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 188,
          "line": "runner.instance_variable_set(:@status_display, status_display)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 189,
          "line": "runner.instance_variable_set(:@provider_manager, provider_manager)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 190,
          "line": "runner.instance_variable_set(:@error_handler, error_handler)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 191,
          "line": "runner.instance_variable_set(:@condition_detector, condition_detector)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 211,
          "line": "runner.instance_variable_set(:@condition_detector, condition_detector)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 212,
          "line": "runner.instance_variable_set(:@user_interface, user_interface)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 213,
          "line": "runner.instance_variable_set(:@state_manager, state_manager)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 228,
          "line": "expect(runner.instance_variable_get(:@user_input)[\"question_1\"]).to eq(\"answer\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 238,
          "line": "runner.instance_variable_set(:@provider_manager, provider_manager)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 239,
          "line": "runner.instance_variable_set(:@condition_detector, condition_detector)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 240,
          "line": "runner.instance_variable_set(:@current_provider, \"cursor\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 254,
          "line": "expect(runner.instance_variable_get(:@current_provider)).to eq(\"claude\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 255,
          "line": "expect(runner.instance_variable_get(:@state)).to eq(\"running\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 275,
          "line": "runner.instance_variable_set(:@current_provider, \"anthropic\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 285,
          "line": "expect(runner.instance_variable_get(:@current_provider)).to eq(\"codex\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 286,
          "line": "expect(runner.instance_variable_get(:@state)).to eq(\"running\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 311,
          "line": "runner.instance_variable_set(:@state_manager, state_manager)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 315,
          "line": "expect(runner.instance_variable_get(:@current_step)).to eq(\"test_step\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 316,
          "line": "expect(runner.instance_variable_get(:@current_provider)).to eq(\"cursor\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 317,
          "line": "expect(runner.instance_variable_get(:@user_input)[\"question_1\"]).to eq(\"answer\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 323,
          "line": "runner.instance_variable_set(:@state_manager, state_manager)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 324,
          "line": "runner.instance_variable_set(:@state, \"running\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 325,
          "line": "runner.instance_variable_set(:@current_step, \"test_step\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 326,
          "line": "runner.instance_variable_set(:@current_provider, \"cursor\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 327,
          "line": "runner.instance_variable_set(:@user_input, {\"test\" => \"data\"})",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 345,
          "line": "runner.instance_variable_set(:@error_handler, error_handler)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 354,
          "line": "state_manager = runner.instance_variable_get(:@state_manager)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 374,
          "line": "state_manager = runner.instance_variable_get(:@state_manager)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 394,
          "line": "state_manager = runner.instance_variable_get(:@state_manager)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 404,
          "line": "expect(runner.instance_variable_get(:@last_error)).to eq(save_error)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 414,
          "line": "runner.instance_variable_set(:@error_handler, error_handler)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 422,
          "line": "runner.instance_variable_set(:@provider_manager, provider_manager)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 431,
          "line": "runner.instance_variable_set(:@status_display, status_display)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 437,
          "line": "runner.instance_variable_set(:@condition_detector, condition_detector)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 448,
          "line": "runner.instance_variable_set(:@completion_checker, completion_checker)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 466,
          "line": "runner.instance_variable_set(:@completion_checker, completion_checker)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 471,
          "line": "runner.instance_variable_set(:@user_interface, ui)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 488,
          "line": "runner.instance_variable_set(:@completion_checker, completion_checker)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 492,
          "line": "runner.instance_variable_set(:@user_interface, ui)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 509,
          "line": "runner.instance_variable_set(:@completion_checker, completion_checker)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 512,
          "line": "runner.instance_variable_set(:@user_interface, ui)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 513,
          "line": "runner.instance_variable_set(:@workflow_type, :watch_mode)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 514,
          "line": "runner.instance_variable_set(:@non_interactive, true)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 535,
          "line": "runner.instance_variable_set(:@condition_detector, condition_detector)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 536,
          "line": "provider_manager = runner.instance_variable_get(:@provider_manager)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 539,
          "line": "allow(runner).to receive(:sleep_until_reset) { runner.instance_variable_set(:@state, \"running\") }",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 565,
          "line": "execute_runner.instance_variable_set(:@completion_checker, completion_checker)",
          "pattern": "instance_variable manipulation"
        }
      ]
    },
    {
      "file": "spec/aidp/harness/state/metrics_spec.rb",
      "violations": [
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Persistence",
          "line_num": 7,
          "line": "let(:persistence) { instance_double(\"Persistence\") }",
          "pattern": "instance_double",
          "target": "Persistence"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): WorkflowState",
          "line_num": 8,
          "line": "let(:workflow_state) { instance_double(\"WorkflowState\") }",
          "pattern": "instance_double",
          "target": "WorkflowState"
        }
      ]
    },
    {
      "file": "spec/aidp/harness/state/persistence_spec.rb",
      "violations": [
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 26,
          "line": "expect(persistence.instance_variable_get(:@state_file)).to eq(state_file)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 31,
          "line": "expect(persistence.instance_variable_get(:@lock_file)).to eq(lock_file)",
          "pattern": "instance_variable manipulation"
        }
      ]
    },
    {
      "file": "spec/aidp/harness/state/provider_state_spec.rb",
      "violations": [
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Persistence",
          "line_num": 7,
          "line": "let(:persistence) { instance_double(\"Persistence\") }",
          "pattern": "instance_double",
          "target": "Persistence"
        }
      ]
    },
    {
      "file": "spec/aidp/harness/state/ui_state_spec.rb",
      "violations": [
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Persistence",
          "line_num": 7,
          "line": "let(:persistence) { instance_double(\"Persistence\") }",
          "pattern": "instance_double",
          "target": "Persistence"
        }
      ]
    },
    {
      "file": "spec/aidp/harness/state/workflow_state_spec.rb",
      "violations": [
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Persistence",
          "line_num": 7,
          "line": "let(:persistence) { instance_double(\"Persistence\") }",
          "pattern": "instance_double",
          "target": "Persistence"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): ProgressTracker",
          "line_num": 10,
          "line": "let(:progress_tracker) { instance_double(\"ProgressTracker\") }",
          "pattern": "instance_double",
          "target": "ProgressTracker"
        }
      ]
    },
    {
      "file": "spec/aidp/harness/state_manager_spec.rb",
      "violations": [
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 23,
          "line": "expect(state_manager.instance_variable_get(:@project_dir)).to eq(project_dir)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 24,
          "line": "expect(state_manager.instance_variable_get(:@mode)).to eq(mode)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: state_manager.progress_tracker",
          "line_num": 43,
          "line": "allow(state_manager.progress_tracker).to receive(:completed_steps).and_return([\"01_REPOSITORY_ANALYSIS\"])",
          "pattern": "allow().to receive",
          "target": "state_manager.progress_tracker"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: state_manager.progress_tracker",
          "line_num": 49,
          "line": "allow(state_manager.progress_tracker).to receive(:current_step).and_return(\"02_ARCHITECTURE_ANALYSIS\")",
          "pattern": "allow().to receive",
          "target": "state_manager.progress_tracker"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: state_manager.progress_tracker",
          "line_num": 55,
          "line": "allow(state_manager.progress_tracker).to receive(:mark_step_completed).with(\"01_REPOSITORY_ANALYSIS\")",
          "pattern": "allow().to receive",
          "target": "state_manager.progress_tracker"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: state_manager.progress_tracker",
          "line_num": 64,
          "line": "allow(state_manager.progress_tracker).to receive(:mark_step_in_progress).with(\"01_REPOSITORY_ANALYSIS\")",
          "pattern": "allow().to receive",
          "target": "state_manager.progress_tracker"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: state_manager.progress_tracker",
          "line_num": 89,
          "line": "allow(state_manager.progress_tracker).to receive(:started_at).and_return(start_time)",
          "pattern": "allow().to receive",
          "target": "state_manager.progress_tracker"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: state_manager.progress_tracker",
          "line_num": 95,
          "line": "allow(state_manager.progress_tracker).to receive(:started_at).and_return(nil)",
          "pattern": "allow().to receive",
          "target": "state_manager.progress_tracker"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: state_manager.progress_tracker",
          "line_num": 343,
          "line": "allow(state_manager.progress_tracker).to receive(:started_at).and_return(Time.now - 3600)",
          "pattern": "allow().to receive",
          "target": "state_manager.progress_tracker"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Concurrency::Backoff",
          "line_num": 392,
          "line": "allow(Aidp::Concurrency::Backoff).to receive(:retry).and_raise(Aidp::Concurrency::MaxAttemptsError, \"Max attempts exceeded\")",
          "pattern": "allow().to receive",
          "target": "Aidp::Concurrency::Backoff"
        }
      ]
    },
    {
      "file": "spec/aidp/harness/status_display_spec.rb",
      "violations": [
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::ProviderManager",
          "line_num": 8,
          "line": "let(:provider_manager) { instance_double(\"Aidp::Harness::ProviderManager\") }",
          "pattern": "instance_double",
          "target": "Aidp::Harness::ProviderManager"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::ProviderManager",
          "line_num": 8,
          "line": "let(:provider_manager) { instance_double(\"Aidp::Harness::ProviderManager\") }",
          "pattern": "double",
          "target": "Aidp::Harness::ProviderManager"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::MetricsManager",
          "line_num": 9,
          "line": "let(:metrics_manager) { instance_double(\"Aidp::Harness::MetricsManager\") }",
          "pattern": "instance_double",
          "target": "Aidp::Harness::MetricsManager"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::MetricsManager",
          "line_num": 9,
          "line": "let(:metrics_manager) { instance_double(\"Aidp::Harness::MetricsManager\") }",
          "pattern": "double",
          "target": "Aidp::Harness::MetricsManager"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::CircuitBreakerManager",
          "line_num": 10,
          "line": "let(:circuit_breaker_manager) { instance_double(\"Aidp::Harness::CircuitBreakerManager\") }",
          "pattern": "instance_double",
          "target": "Aidp::Harness::CircuitBreakerManager"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::CircuitBreakerManager",
          "line_num": 10,
          "line": "let(:circuit_breaker_manager) { instance_double(\"Aidp::Harness::CircuitBreakerManager\") }",
          "pattern": "double",
          "target": "Aidp::Harness::CircuitBreakerManager"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 35,
          "line": "status_display.instance_variable_set(:@error_summary, {",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 46,
          "line": "config = status_display.instance_variable_get(:@display_config)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 61,
          "line": "expect(status_display.instance_variable_get(:@status_formatter)).to be_a(described_class::StatusFormatter)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 62,
          "line": "expect(status_display.instance_variable_get(:@metrics_calculator)).to be_a(described_class::MetricsCalculator)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 63,
          "line": "expect(status_display.instance_variable_get(:@alert_manager)).to be_a(described_class::AlertManager)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 64,
          "line": "expect(status_display.instance_variable_get(:@display_animator)).to be_a(described_class::DisplayAnimator)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 72,
          "line": "expect(status_display.instance_variable_get(:@current_step)).to eq(\"Test Step\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 73,
          "line": "expect(status_display.instance_variable_get(:@status_data)[:current_step]).to eq(\"Test Step\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 79,
          "line": "expect(status_display.instance_variable_get(:@current_provider)).to eq(\"claude\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 80,
          "line": "expect(status_display.instance_variable_get(:@status_data)[:current_provider]).to eq(\"claude\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 86,
          "line": "expect(status_display.instance_variable_get(:@current_model)).to eq(\"model1\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 87,
          "line": "expect(status_display.instance_variable_get(:@status_data)[:current_model]).to eq(\"model1\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 93,
          "line": "token_usage = status_display.instance_variable_get(:@token_usage)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 108,
          "line": "rate_limit_status = status_display.instance_variable_get(:@rate_limit_status)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 116,
          "line": "recovery_status = status_display.instance_variable_get(:@recovery_status)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 124,
          "line": "user_feedback_status = status_display.instance_variable_get(:@user_feedback_status)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 138,
          "line": "work_completion_status = status_display.instance_variable_get(:@work_completion_status)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 147,
          "line": "performance_metrics = status_display.instance_variable_get(:@performance_metrics)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 156,
          "line": "error_summary_data = status_display.instance_variable_get(:@error_summary)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 166,
          "line": "expect(status_display.instance_variable_get(:@display_mode)).to eq(:detailed)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 172,
          "line": "expect(status_display.instance_variable_get(:@update_interval)).to eq(5)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 179,
          "line": "display_config = status_display.instance_variable_get(:@display_config)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 189,
          "line": "provider_status = status_display.instance_variable_get(:@provider_status)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 197,
          "line": "circuit_breaker_status = status_display.instance_variable_get(:@circuit_breaker_status)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 204,
          "line": "performance_metrics = status_display.instance_variable_get(:@performance_metrics)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 212,
          "line": "error_summary = status_display.instance_variable_get(:@error_summary)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 217,
          "line": "status_display.instance_variable_set(:@start_time, Time.now - 60)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 220,
          "line": "performance_metrics = status_display.instance_variable_get(:@performance_metrics)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 227,
          "line": "status_display.instance_variable_set(:@start_time, Time.now - 30)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 228,
          "line": "status_display.instance_variable_set(:@current_step, \"Test Step\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 229,
          "line": "status_display.instance_variable_set(:@current_provider, \"claude\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 230,
          "line": "status_display.instance_variable_set(:@current_model, \"model1\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 231,
          "line": "status_display.instance_variable_set(:@running, true)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 257,
          "line": "status_display.instance_variable_set(:@start_time, Time.now - 60)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 258,
          "line": "status_display.instance_variable_set(:@current_step, \"Test Step\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 259,
          "line": "status_display.instance_variable_set(:@current_provider, \"claude\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 260,
          "line": "status_display.instance_variable_set(:@current_model, \"model1\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 269,
          "line": "status_display.instance_variable_set(:@provider_status, {",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 279,
          "line": "status_display.instance_variable_set(:@performance_metrics, {",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 291,
          "line": "status_display.instance_variable_set(:@error_summary, {",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 305,
          "line": "status_display.instance_variable_set(:@circuit_breaker_status, {",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 315,
          "line": "status_display.instance_variable_set(:@token_usage, {",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 326,
          "line": "status_display.instance_variable_set(:@rate_limit_status, {",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 343,
          "line": "status_display.instance_variable_set(:@recovery_status, {",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 352,
          "line": "status_display.instance_variable_set(:@user_feedback_status, {",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 361,
          "line": "status_display.instance_variable_set(:@work_completion_status, {",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 372,
          "line": "alert_manager = status_display.instance_variable_get(:@alert_manager)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 384,
          "line": "status_display.instance_variable_set(:@performance_metrics, {error_rate: 0.15})",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 390,
          "line": "status_display.instance_variable_set(:@circuit_breaker_status, {",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 398,
          "line": "status_display.instance_variable_set(:@rate_limit_status, {",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 410,
          "line": "status_display.instance_variable_set(:@start_time, Time.now - 60)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 411,
          "line": "status_display.instance_variable_set(:@current_step, \"Test Step\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 412,
          "line": "status_display.instance_variable_set(:@current_provider, \"claude\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 413,
          "line": "status_display.instance_variable_set(:@current_model, \"model1\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 548,
          "line": "status_display.instance_variable_get(:@running) == true",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 551,
          "line": "expect(status_display.instance_variable_get(:@running)).to be true",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 559,
          "line": "status_display.instance_variable_get(:@running) == true",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 564,
          "line": "expect(status_display.instance_variable_get(:@running)).to be false",
          "pattern": "instance_variable manipulation"
        }
      ]
    },
    {
      "file": "spec/aidp/harness/test_runner_spec.rb",
      "violations": [
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::ToolingDetector",
          "line_num": 47,
          "line": "allow(Aidp::ToolingDetector).to receive(:detect).and_return(",
          "pattern": "allow().to receive",
          "target": "Aidp::ToolingDetector"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::ToolingDetector",
          "line_num": 142,
          "line": "allow(Aidp::ToolingDetector).to receive(:detect).and_return(",
          "pattern": "allow().to receive",
          "target": "Aidp::ToolingDetector"
        }
      ]
    },
    {
      "file": "spec/aidp/harness/thinking_depth_manager_spec.rb",
      "violations": [
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::ModelCache",
          "line_num": 560,
          "line": "allow(Aidp::Harness::ModelCache).to receive(:new).and_return(cache)",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::ModelCache"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Aidp",
          "line_num": 592,
          "line": "allow(Aidp).to receive(:display_message)",
          "pattern": "allow().to receive",
          "target": "Aidp"
        }
      ]
    },
    {
      "file": "spec/aidp/harness/ui/enhanced_tui_spec.rb",
      "violations": [
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): TTY::Screen",
          "line_num": 21,
          "line": "allow(TTY::Screen).to receive(:height).and_return(24)",
          "pattern": "allow().to receive",
          "target": "TTY::Screen"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): TTY::Screen",
          "line_num": 22,
          "line": "allow(TTY::Screen).to receive(:width).and_return(80)",
          "pattern": "allow().to receive",
          "target": "TTY::Screen"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 88,
          "line": "jobs = tui.instance_variable_get(:@jobs)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 101,
          "line": "jobs = tui.instance_variable_get(:@jobs)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 114,
          "line": "jobs = tui.instance_variable_get(:@jobs)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 131,
          "line": "jobs = tui.instance_variable_get(:@jobs)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 171,
          "line": "expect(tui.instance_variable_get(:@current_mode)).to eq(:analyze)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 178,
          "line": "expect(tui.instance_variable_get(:@workflow_active)).to be true",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 179,
          "line": "expect(tui.instance_variable_get(:@current_step)).to eq(\"00_PRD_initial_planning\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 186,
          "line": "expect(tui.instance_variable_get(:@current_step)).to eq(\"some_other_step\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 288,
          "line": "expect(instance.instance_variable_get(:@headless)).to be false",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 293,
          "line": "expect(instance.instance_variable_get(:@headless)).to be true",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 297,
          "line": "expect(tui.instance_variable_get(:@jobs)).to eq({})",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 362,
          "line": "expect(tui.instance_variable_get(:@jobs)[\"job-123\"]).to include(",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 374,
          "line": "expect(tui.instance_variable_get(:@jobs)[\"job-456\"][:name]).to eq(\"job-456\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 379,
          "line": "expect(tui.instance_variable_get(:@jobs)[\"job-789\"][:status]).to eq(:pending)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 384,
          "line": "expect(tui.instance_variable_get(:@jobs)[\"job-000\"][:progress]).to eq(0)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 392,
          "line": "expect(tui.instance_variable_get(:@jobs)[\"job-123\"]).to include(",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 407,
          "line": "headless_tui.instance_variable_set(:@headless, false)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 426,
          "line": "headless_tui.instance_variable_set(:@headless, true)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 427,
          "line": "headless_tui.instance_variable_set(:@current_mode, :analyze)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 438,
          "line": "headless_tui.instance_variable_set(:@headless, true)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 450,
          "line": "headless_tui.instance_variable_set(:@headless, true)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 462,
          "line": "headless_tui.instance_variable_set(:@headless, true)",
          "pattern": "instance_variable manipulation"
        }
      ]
    },
    {
      "file": "spec/aidp/harness/ui/enhanced_workflow_selector_spec.rb",
      "violations": [
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::UI::EnhancedTUI",
          "line_num": 18,
          "line": "instance_double(\"Aidp::Harness::UI::EnhancedTUI\").tap do |tui|",
          "pattern": "instance_double",
          "target": "Aidp::Harness::UI::EnhancedTUI"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::UI::EnhancedTUI",
          "line_num": 18,
          "line": "instance_double(\"Aidp::Harness::UI::EnhancedTUI\").tap do |tui|",
          "pattern": "double",
          "target": "Aidp::Harness::UI::EnhancedTUI"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Workflows::Selector",
          "line_num": 27,
          "line": "instance_double(\"Aidp::Workflows::Selector\").tap do |selector|",
          "pattern": "instance_double",
          "target": "Aidp::Workflows::Selector"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Workflows::Selector",
          "line_num": 27,
          "line": "instance_double(\"Aidp::Workflows::Selector\").tap do |selector|",
          "pattern": "double",
          "target": "Aidp::Workflows::Selector"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Workflows::GuidedAgent",
          "line_num": 37,
          "line": "instance_double(\"Aidp::Workflows::GuidedAgent\").tap do |agent|",
          "pattern": "instance_double",
          "target": "Aidp::Workflows::GuidedAgent"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Workflows::GuidedAgent",
          "line_num": 37,
          "line": "instance_double(\"Aidp::Workflows::GuidedAgent\").tap do |agent|",
          "pattern": "double",
          "target": "Aidp::Workflows::GuidedAgent"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 53,
          "line": "selector.instance_variable_set(:@workflow_selector, mock_workflow_selector)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Workflows::GuidedAgent",
          "line_num": 54,
          "line": "allow(Aidp::Workflows::GuidedAgent).to receive(:new).and_return(mock_guided_agent)",
          "pattern": "allow().to receive",
          "target": "Aidp::Workflows::GuidedAgent"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 65,
          "line": "expect(selector.instance_variable_get(:@tui)).to eq(mock_tui)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 66,
          "line": "expect(selector.instance_variable_get(:@project_dir)).to eq(project_dir)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 67,
          "line": "expect(selector.instance_variable_get(:@user_input)).to eq({})",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 68,
          "line": "expect(selector.instance_variable_get(:@workflow_selector)).to be_a(Aidp::Workflows::Selector)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::UI::EnhancedTUI",
          "line_num": 73,
          "line": "mock_default_tui = instance_double(\"Aidp::Harness::UI::EnhancedTUI\")",
          "pattern": "instance_double",
          "target": "Aidp::Harness::UI::EnhancedTUI"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::UI::EnhancedTUI",
          "line_num": 73,
          "line": "mock_default_tui = instance_double(\"Aidp::Harness::UI::EnhancedTUI\")",
          "pattern": "double",
          "target": "Aidp::Harness::UI::EnhancedTUI"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::UI::EnhancedTUI",
          "line_num": 74,
          "line": "allow(Aidp::Harness::UI::EnhancedTUI).to receive(:new).and_return(mock_default_tui)",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::UI::EnhancedTUI"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 78,
          "line": "expect(selector.instance_variable_get(:@tui)).to eq(mock_default_tui)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 86,
          "line": "expect(selector.instance_variable_get(:@project_dir)).to eq(\"/current/dir\")",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Mocking the instance under test (subject)",
          "line_num": 140,
          "line": "allow(subject).to receive(:collect_project_info_interactive)",
          "pattern": "allow().to receive",
          "target": "subject"
        },
        {
          "type": "violation",
          "reason": "Mocking the instance under test (subject)",
          "line_num": 176,
          "line": "expect(subject).to receive(:collect_project_info_interactive)",
          "pattern": "expect().to receive",
          "target": "subject"
        },
        {
          "type": "violation",
          "reason": "Mocking the instance under test (subject)",
          "line_num": 190,
          "line": "allow(subject).to receive(:collect_project_info_interactive)",
          "pattern": "allow().to receive",
          "target": "subject"
        },
        {
          "type": "violation",
          "reason": "Mocking the instance under test (subject)",
          "line_num": 191,
          "line": "allow(subject).to receive(:choose_workflow_type_interactive).and_return(:exploration)",
          "pattern": "allow().to receive",
          "target": "subject"
        },
        {
          "type": "violation",
          "reason": "Mocking the instance under test (subject)",
          "line_num": 192,
          "line": "allow(subject).to receive(:generate_workflow_steps_interactive).with(:exploration).and_return([\"00_PRD\", \"16_IMPLEMENTATION\"])",
          "pattern": "allow().to receive",
          "target": "subject"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 217,
          "line": "user_input = real_subject.instance_variable_get(:@user_input)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 255,
          "line": "user_input = real_subject.instance_variable_get(:@user_input)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 376,
          "line": "user_input = subject.instance_variable_get(:@user_input)",
          "pattern": "instance_variable manipulation"
        }
      ]
    },
    {
      "file": "spec/aidp/harness/ui/error_handler_spec.rb",
      "violations": [
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 30,
          "line": "logger = handler.instance_variable_get(:@logger)",
          "pattern": "instance_variable manipulation"
        }
      ]
    },
    {
      "file": "spec/aidp/harness/ui/job_monitor_spec.rb",
      "violations": [
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 191,
          "line": "expect(job_monitor.instance_variable_get(:@monitor_thread)).to be_a(Thread)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 199,
          "line": "original_thread = job_monitor.instance_variable_get(:@monitor_thread)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 202,
          "line": "expect(job_monitor.instance_variable_get(:@monitor_thread)).to eq(original_thread)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 220,
          "line": "expect(job_monitor.instance_variable_get(:@monitor_thread)).to be_nil",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 239,
          "line": "expect(job_monitor.instance_variable_get(:@update_callbacks)).to include(callback)",
          "pattern": "instance_variable manipulation"
        }
      ]
    },
    {
      "file": "spec/aidp/harness/ui/navigation/submenu_spec.rb",
      "violations": [
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 99,
          "line": "submenu.instance_variable_set(:@current_level, 2)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 104,
          "line": "submenu.instance_variable_set(:@current_level, 5)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 156,
          "line": "submenu.instance_variable_set(:@current_level, 5)",
          "pattern": "instance_variable manipulation"
        }
      ]
    },
    {
      "file": "spec/aidp/harness/ui/navigation/workflow_selector_spec.rb",
      "violations": [
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): StateManager",
          "line_num": 9,
          "line": "let(:state_manager) { instance_double(\"StateManager\") }",
          "pattern": "instance_double",
          "target": "StateManager"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 29,
          "line": "expect(selector.instance_variable_get(:@prompt)).to be_a(TTY::Prompt)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 135,
          "line": "expect(formatter.instance_variable_get(:@pastel)).not_to be_nil",
          "pattern": "instance_variable manipulation"
        }
      ]
    },
    {
      "file": "spec/aidp/harness/ui/spinner_helper_spec.rb",
      "violations": [
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 71,
          "line": "expect(helper.instance_variable_get(:@active_spinners)).not_to include(spinner_double)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 172,
          "line": "helper.instance_variable_set(:@active_spinners, [spinner_double])",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 184,
          "line": "helper.instance_variable_set(:@active_spinners, [spinner_double, spinner_double])",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 193,
          "line": "helper.instance_variable_set(:@active_spinners, [spinner_double])",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 198,
          "line": "expect(helper.instance_variable_get(:@active_spinners)).to be_empty",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 203,
          "line": "helper.instance_variable_set(:@active_spinners, [spinner_double])",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::UI::SPINNER",
          "line_num": 214,
          "line": "allow(Aidp::Harness::UI::SPINNER).to receive(:with_spinner).and_call_original",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::UI::SPINNER"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::UI::SPINNER",
          "line_num": 215,
          "line": "allow(Aidp::Harness::UI::SPINNER).to receive(:with_loading_spinner).and_call_original",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::UI::SPINNER"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::UI::SPINNER",
          "line_num": 216,
          "line": "allow(Aidp::Harness::UI::SPINNER).to receive(:with_processing_spinner).and_call_original",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::UI::SPINNER"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::UI::SPINNER",
          "line_num": 217,
          "line": "allow(Aidp::Harness::UI::SPINNER).to receive(:with_saving_spinner).and_call_original",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::UI::SPINNER"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::UI::SPINNER",
          "line_num": 218,
          "line": "allow(Aidp::Harness::UI::SPINNER).to receive(:with_analyzing_spinner).and_call_original",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::UI::SPINNER"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::UI::SPINNER",
          "line_num": 219,
          "line": "allow(Aidp::Harness::UI::SPINNER).to receive(:with_building_spinner).and_call_original",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::UI::SPINNER"
        }
      ]
    },
    {
      "file": "spec/aidp/harness/ui/workflow_controller_spec.rb",
      "violations": [
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 51,
          "line": "workflow_controller.instance_variable_set(:@pause_time, Time.now - 60)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 220,
          "line": "expect(workflow_controller.instance_variable_get(:@control_thread)).to be_a(Thread)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 228,
          "line": "original_thread = workflow_controller.instance_variable_get(:@control_thread)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 231,
          "line": "expect(workflow_controller.instance_variable_get(:@control_thread)).to eq(original_thread)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 243,
          "line": "expect(workflow_controller.instance_variable_get(:@control_thread)).to be_nil",
          "pattern": "instance_variable manipulation"
        }
      ]
    },
    {
      "file": "spec/aidp/harness/user_interface_spec.rb",
      "violations": [
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 344,
          "line": "expect(ui.instance_variable_get(:@auto_confirm_defaults)).to be true",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 345,
          "line": "expect(ui.instance_variable_get(:@show_help_automatically)).to be false",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 346,
          "line": "expect(ui.instance_variable_get(:@verbose_mode)).to be false",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 347,
          "line": "expect(ui.instance_variable_get(:@file_selection_enabled)).to be true",
          "pattern": "instance_variable manipulation"
        }
      ]
    },
    {
      "file": "spec/aidp/harness/zfc_condition_detector_spec.rb",
      "violations": [
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::ThinkingDepthManager",
          "line_num": 25,
          "line": "allow(Aidp::Harness::ThinkingDepthManager).to receive(:new).and_return(",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::ThinkingDepthManager"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Aidp",
          "line_num": 32,
          "line": "allow(Aidp).to receive(:log_debug)",
          "pattern": "allow().to receive",
          "target": "Aidp"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Aidp",
          "line_num": 33,
          "line": "allow(Aidp).to receive(:log_error)",
          "pattern": "allow().to receive",
          "target": "Aidp"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: detector.legacy_detector",
          "line_num": 61,
          "line": "expect(detector.legacy_detector).to receive(:is_rate_limited?).with(result, \"anthropic\")",
          "pattern": "expect().to receive",
          "target": "detector.legacy_detector"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: detector.legacy_detector",
          "line_num": 67,
          "line": "allow(detector.legacy_detector).to receive(:is_rate_limited?).and_return(true)",
          "pattern": "allow().to receive",
          "target": "detector.legacy_detector"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: detector.ai_engine",
          "line_num": 93,
          "line": "expect(detector.ai_engine).to receive(:decide).with(",
          "pattern": "expect().to receive",
          "target": "detector.ai_engine"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: detector.legacy_detector",
          "line_num": 136,
          "line": "allow(detector.legacy_detector).to receive(:is_rate_limited?).and_return(true)",
          "pattern": "allow().to receive",
          "target": "detector.legacy_detector"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Aidp",
          "line_num": 138,
          "line": "expect(Aidp).to receive(:log_error).with(",
          "pattern": "expect().to receive",
          "target": "Aidp"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: detector.legacy_detector",
          "line_num": 166,
          "line": "allow(detector.legacy_detector).to receive(:is_rate_limited?).and_return(true)",
          "pattern": "allow().to receive",
          "target": "detector.legacy_detector"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: detector.legacy_detector",
          "line_num": 175,
          "line": "allow(detector.legacy_detector).to receive(:is_rate_limited?).and_return(false)",
          "pattern": "allow().to receive",
          "target": "detector.legacy_detector"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Aidp",
          "line_num": 177,
          "line": "expect(Aidp).to receive(:log_debug).with(",
          "pattern": "expect().to receive",
          "target": "Aidp"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: detector.legacy_detector",
          "line_num": 200,
          "line": "expect(detector.legacy_detector).to receive(:needs_user_feedback?).with(result)",
          "pattern": "expect().to receive",
          "target": "detector.legacy_detector"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: detector.legacy_detector",
          "line_num": 256,
          "line": "expect(detector.legacy_detector).to receive(:is_work_complete?).with(result, progress)",
          "pattern": "expect().to receive",
          "target": "detector.legacy_detector"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: detector.ai_engine",
          "line_num": 280,
          "line": "expect(detector.ai_engine).to receive(:decide).with(",
          "pattern": "expect().to receive",
          "target": "detector.ai_engine"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: detector.legacy_detector",
          "line_num": 318,
          "line": "allow(detector.legacy_detector).to receive(:is_work_complete?).and_return(true)",
          "pattern": "allow().to receive",
          "target": "detector.legacy_detector"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Aidp",
          "line_num": 320,
          "line": "expect(Aidp).to receive(:log_error).with(",
          "pattern": "expect().to receive",
          "target": "Aidp"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: detector.legacy_detector",
          "line_num": 338,
          "line": "expect(detector.legacy_detector).to receive(:extract_questions).with(result)",
          "pattern": "expect().to receive",
          "target": "detector.legacy_detector"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: detector.legacy_detector",
          "line_num": 348,
          "line": "expect(detector.legacy_detector).to receive(:extract_rate_limit_info).with(result, \"anthropic\")",
          "pattern": "expect().to receive",
          "target": "detector.legacy_detector"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: detector.legacy_detector",
          "line_num": 391,
          "line": "allow(detector.legacy_detector).to receive(:is_rate_limited?).and_return(true, true, false)",
          "pattern": "allow().to receive",
          "target": "detector.legacy_detector"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: detector.legacy_detector",
          "line_num": 450,
          "line": "expect(detector.legacy_detector).to receive(:classify_error).with(test_error)",
          "pattern": "expect().to receive",
          "target": "detector.legacy_detector"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: detector.ai_engine",
          "line_num": 476,
          "line": "expect(detector.ai_engine).to receive(:decide).with(",
          "pattern": "expect().to receive",
          "target": "detector.ai_engine"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: detector.legacy_detector",
          "line_num": 498,
          "line": "allow(detector.legacy_detector).to receive(:classify_error).and_return({error_type: :timeout})",
          "pattern": "allow().to receive",
          "target": "detector.legacy_detector"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: detector.legacy_detector",
          "line_num": 513,
          "line": "allow(detector.legacy_detector).to receive(:classify_error).and_return({error_type: :rate_limit})",
          "pattern": "allow().to receive",
          "target": "detector.legacy_detector"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Aidp",
          "line_num": 515,
          "line": "expect(Aidp).to receive(:log_error).with(",
          "pattern": "expect().to receive",
          "target": "Aidp"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: detector.legacy_detector",
          "line_num": 543,
          "line": "allow(detector.legacy_detector).to receive(:classify_error).and_return({error_type: :rate_limit})",
          "pattern": "allow().to receive",
          "target": "detector.legacy_detector"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: detector.legacy_detector",
          "line_num": 552,
          "line": "allow(detector.legacy_detector).to receive(:classify_error).and_return({error_type: :timeout})",
          "pattern": "allow().to receive",
          "target": "detector.legacy_detector"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Aidp",
          "line_num": 554,
          "line": "expect(Aidp).to receive(:log_debug).with(",
          "pattern": "expect().to receive",
          "target": "Aidp"
        }
      ]
    },
    {
      "file": "spec/aidp/jobs/background_runner_spec.rb",
      "violations": [
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Process",
          "line_num": 32,
          "line": "allow(Process).to receive(:daemon)",
          "pattern": "allow().to receive",
          "target": "Process"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Process",
          "line_num": 33,
          "line": "allow(Process).to receive(:detach)",
          "pattern": "allow().to receive",
          "target": "Process"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::Runner",
          "line_num": 35,
          "line": "allow(Aidp::Harness::Runner).to receive(:new).and_return(double(run: {status: \"completed\"}))",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::Runner"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Concurrency::Wait",
          "line_num": 40,
          "line": "allow(Aidp::Concurrency::Wait).to receive(:for_file).and_return(true)",
          "pattern": "allow().to receive",
          "target": "Aidp::Concurrency::Wait"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Process",
          "line_num": 66,
          "line": "allow(Process).to receive(:daemon)",
          "pattern": "allow().to receive",
          "target": "Process"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Process",
          "line_num": 67,
          "line": "allow(Process).to receive(:detach)",
          "pattern": "allow().to receive",
          "target": "Process"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::Runner",
          "line_num": 69,
          "line": "allow(Aidp::Harness::Runner).to receive(:new).and_return(double(run: {status: \"completed\"}))",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::Runner"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Concurrency::Wait",
          "line_num": 73,
          "line": "allow(Aidp::Concurrency::Wait).to receive(:for_file).and_return(true)",
          "pattern": "allow().to receive",
          "target": "Aidp::Concurrency::Wait"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Process",
          "line_num": 93,
          "line": "allow(Process).to receive(:daemon)",
          "pattern": "allow().to receive",
          "target": "Process"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Process",
          "line_num": 94,
          "line": "allow(Process).to receive(:detach)",
          "pattern": "allow().to receive",
          "target": "Process"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::Runner",
          "line_num": 96,
          "line": "allow(Aidp::Harness::Runner).to receive(:new).and_return(double(run: {status: \"completed\"}))",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::Runner"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Concurrency::Wait",
          "line_num": 100,
          "line": "allow(Aidp::Concurrency::Wait).to receive(:for_file).and_return(true)",
          "pattern": "allow().to receive",
          "target": "Aidp::Concurrency::Wait"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Process",
          "line_num": 116,
          "line": "allow(Process).to receive(:kill)",
          "pattern": "allow().to receive",
          "target": "Process"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Process",
          "line_num": 132,
          "line": "allow(Process).to receive(:daemon)",
          "pattern": "allow().to receive",
          "target": "Process"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Process",
          "line_num": 133,
          "line": "allow(Process).to receive(:detach)",
          "pattern": "allow().to receive",
          "target": "Process"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::Runner",
          "line_num": 135,
          "line": "allow(Aidp::Harness::Runner).to receive(:new).and_return(double(run: {status: \"completed\"}))",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::Runner"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Concurrency::Wait",
          "line_num": 139,
          "line": "allow(Aidp::Concurrency::Wait).to receive(:for_file).and_return(true)",
          "pattern": "allow().to receive",
          "target": "Aidp::Concurrency::Wait"
        }
      ]
    },
    {
      "file": "spec/aidp/logger_sanitization_spec.rb",
      "violations": [
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Kernel",
          "line_num": 36,
          "line": "allow(Kernel).to receive(:warn) do |msg|",
          "pattern": "allow().to receive",
          "target": "Kernel"
        }
      ]
    },
    {
      "file": "spec/aidp/logger_spec.rb",
      "violations": [
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Kernel",
          "line_num": 302,
          "line": "expect(Kernel).to receive(:warn).with(/Failed to create log file/)",
          "pattern": "expect().to receive",
          "target": "Kernel"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Kernel",
          "line_num": 318,
          "line": "allow(Kernel).to receive(:warn) do |msg|",
          "pattern": "allow().to receive",
          "target": "Kernel"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 435,
          "line": "Aidp.instance_variable_set(:@logger, nil)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 439,
          "line": "Aidp.logger.close if Aidp.instance_variable_get(:@logger)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 440,
          "line": "Aidp.instance_variable_set(:@logger, nil)",
          "pattern": "instance_variable manipulation"
        }
      ]
    },
    {
      "file": "spec/aidp/provider_manager_spec.rb",
      "violations": [
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 8,
          "line": "described_class.instance_variable_set(:@harness_factory, nil)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 52,
          "line": "allow(described_class).to receive(:get_harness_factory).and_return(factory)",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 105,
          "line": "allow(described_class).to receive(:get_harness_factory).and_return(factory)",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 126,
          "line": "allow(described_class).to receive(:get_harness_factory).and_return(nil)",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 139,
          "line": "allow(described_class).to receive(:get_harness_factory).and_return(nil)",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 148,
          "line": "allow(described_class).to receive(:get_harness_factory).and_return(factory)",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 158,
          "line": "allow(described_class).to receive(:get_harness_factory).and_return(nil)",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 167,
          "line": "allow(described_class).to receive(:get_harness_factory).and_return(factory)",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 177,
          "line": "allow(described_class).to receive(:get_harness_factory).and_return(nil)",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 187,
          "line": "allow(described_class).to receive(:get_harness_factory).and_return(factory)",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 198,
          "line": "allow(described_class).to receive(:get_harness_factory).and_return(nil)",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 206,
          "line": "allow(described_class).to receive(:get_harness_factory).and_return(factory)",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 216,
          "line": "allow(described_class).to receive(:get_harness_factory).and_return(factory)",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 226,
          "line": "allow(described_class).to receive(:get_harness_factory).and_return(nil)",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 234,
          "line": "allow(described_class).to receive(:get_harness_factory).and_return(factory)",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 244,
          "line": "allow(described_class).to receive(:get_harness_factory).and_return(nil)",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 253,
          "line": "allow(described_class).to receive(:get_harness_factory).and_return(factory)",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 263,
          "line": "allow(described_class).to receive(:get_harness_factory).and_return(nil)",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 271,
          "line": "allow(described_class).to receive(:get_harness_factory).and_return(factory)",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 281,
          "line": "allow(described_class).to receive(:get_harness_factory).and_return(nil)",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 290,
          "line": "allow(described_class).to receive(:get_harness_factory).and_return(factory)",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 300,
          "line": "allow(described_class).to receive(:get_harness_factory).and_return(nil)",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 309,
          "line": "allow(described_class).to receive(:get_harness_factory).and_return(factory)",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 319,
          "line": "allow(described_class).to receive(:get_harness_factory).and_return(nil)",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 328,
          "line": "allow(described_class).to receive(:get_harness_factory).and_return(factory)",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 341,
          "line": "described_class.instance_variable_set(:@harness_factory, factory)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 349,
          "line": "described_class.instance_variable_set(:@harness_factory, nil)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 359,
          "line": "described_class.instance_variable_set(:@harness_factory, factory)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 367,
          "line": "described_class.instance_variable_set(:@harness_factory, nil)",
          "pattern": "instance_variable manipulation"
        }
      ]
    },
    {
      "file": "spec/aidp/providers/anthropic_spec.rb",
      "violations": [
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Util",
          "line_num": 10,
          "line": "allow(Aidp::Util).to receive(:which).with(\"claude\").and_return(\"/usr/local/bin/claude\")",
          "pattern": "allow().to receive",
          "target": "Aidp::Util"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Util",
          "line_num": 16,
          "line": "allow(Aidp::Util).to receive(:which).with(\"claude\").and_return(nil)",
          "pattern": "allow().to receive",
          "target": "Aidp::Util"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Util",
          "line_num": 47,
          "line": "allow(Aidp::Util).to receive(:which).with(\"claude\").and_return(\"/usr/local/bin/claude\")",
          "pattern": "allow().to receive",
          "target": "Aidp::Util"
        },
        {
          "type": "violation",
          "reason": "Mocking the class under test (described_class)",
          "line_num": 161,
          "line": "allow(described_class).to receive(:available?).and_return(false)",
          "pattern": "allow().to receive",
          "target": "described_class"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Util",
          "line_num": 310,
          "line": "allow(Aidp::Util).to receive(:which).with(\"claude\").and_return(\"/usr/local/bin/claude\")",
          "pattern": "allow().to receive",
          "target": "Aidp::Util"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Util",
          "line_num": 318,
          "line": "allow(Aidp::Util).to receive(:which).with(\"claude\").and_return(nil)",
          "pattern": "allow().to receive",
          "target": "Aidp::Util"
        }
      ]
    },
    {
      "file": "spec/aidp/providers/capability_registry_spec.rb",
      "violations": [
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Aidp",
          "line_num": 46,
          "line": "expect(Aidp).to receive(:log_debug).with(",
          "pattern": "expect().to receive",
          "target": "Aidp"
        }
      ]
    },
    {
      "file": "spec/aidp/providers/codex_spec.rb",
      "violations": [
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Util",
          "line_num": 14,
          "line": "allow(Aidp::Util).to receive(:which).with(\"codex\").and_return(\"/usr/local/bin/codex\")",
          "pattern": "allow().to receive",
          "target": "Aidp::Util"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Util",
          "line_num": 24,
          "line": "allow(Aidp::Util).to receive(:which).with(\"codex\").and_return(nil)",
          "pattern": "allow().to receive",
          "target": "Aidp::Util"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Util",
          "line_num": 42,
          "line": "allow(Aidp::Util).to receive(:which).with(\"codex\").and_return(\"/usr/local/bin/codex\")",
          "pattern": "allow().to receive",
          "target": "Aidp::Util"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Util",
          "line_num": 44,
          "line": "allow(Aidp::Util).to receive(:execute_command)",
          "pattern": "allow().to receive",
          "target": "Aidp::Util"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Util",
          "line_num": 56,
          "line": "allow(Aidp::Util).to receive(:which).with(\"codex\").and_return(nil)",
          "pattern": "allow().to receive",
          "target": "Aidp::Util"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Util",
          "line_num": 72,
          "line": "allow(Aidp::Util).to receive(:which).with(\"codex\").and_return(\"/usr/local/bin/codex\")",
          "pattern": "allow().to receive",
          "target": "Aidp::Util"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Util",
          "line_num": 89,
          "line": "allow(Aidp::Util).to receive(:which).with(\"codex\").and_return(nil)",
          "pattern": "allow().to receive",
          "target": "Aidp::Util"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Thread",
          "line_num": 105,
          "line": "allow(Thread).to receive(:new).and_return(thread_mock)",
          "pattern": "allow().to receive",
          "target": "Thread"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Thread",
          "line_num": 129,
          "line": "allow(Thread).to receive(:new).and_return(thread_mock)",
          "pattern": "allow().to receive",
          "target": "Thread"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Thread",
          "line_num": 157,
          "line": "allow(Thread).to receive(:new).and_return(thread_mock)",
          "pattern": "allow().to receive",
          "target": "Thread"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 285,
          "line": "provider.instance_variable_set(:@adaptive_timeout, nil)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Util",
          "line_num": 312,
          "line": "allow(Aidp::Util).to receive(:execute_command).and_raise(StandardError.new(\"Command failed\"))",
          "pattern": "allow().to receive",
          "target": "Aidp::Util"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Util",
          "line_num": 323,
          "line": "allow(Aidp::Util).to receive(:execute_command)",
          "pattern": "allow().to receive",
          "target": "Aidp::Util"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Util",
          "line_num": 337,
          "line": "allow(Aidp::Util).to receive(:which).with(\"codex\").and_return(nil)",
          "pattern": "allow().to receive",
          "target": "Aidp::Util"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Util",
          "line_num": 347,
          "line": "allow(Aidp::Util).to receive(:which).with(\"codex\").and_return(\"/usr/local/bin/codex\")",
          "pattern": "allow().to receive",
          "target": "Aidp::Util"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Util",
          "line_num": 348,
          "line": "allow(Aidp::Util).to receive(:execute_command).and_raise(StandardError.new(\"Command failed\"))",
          "pattern": "allow().to receive",
          "target": "Aidp::Util"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Util",
          "line_num": 358,
          "line": "allow(Aidp::Util).to receive(:which).with(\"codex\").and_return(\"/usr/local/bin/codex\")",
          "pattern": "allow().to receive",
          "target": "Aidp::Util"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Util",
          "line_num": 360,
          "line": "allow(Aidp::Util).to receive(:execute_command)",
          "pattern": "allow().to receive",
          "target": "Aidp::Util"
        }
      ]
    },
    {
      "file": "spec/aidp/providers/cursor_spec.rb",
      "violations": [
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Util",
          "line_num": 9,
          "line": "allow(Aidp::Util).to receive(:which).with(\"cursor-agent\").and_return(\"/usr/local/bin/cursor-agent\")",
          "pattern": "allow().to receive",
          "target": "Aidp::Util"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Util",
          "line_num": 14,
          "line": "allow(Aidp::Util).to receive(:which).with(\"cursor-agent\").and_return(\"/usr/local/bin/cursor-agent\")",
          "pattern": "allow().to receive",
          "target": "Aidp::Util"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Util",
          "line_num": 19,
          "line": "allow(Aidp::Util).to receive(:which).with(\"cursor-agent\").and_return(nil)",
          "pattern": "allow().to receive",
          "target": "Aidp::Util"
        }
      ]
    },
    {
      "file": "spec/aidp/providers/gemini_spec.rb",
      "violations": [
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Util",
          "line_num": 11,
          "line": "allow(Aidp::Util).to receive(:which).with(\"gemini\").and_return(\"/usr/local/bin/gemini\")",
          "pattern": "allow().to receive",
          "target": "Aidp::Util"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Util",
          "line_num": 17,
          "line": "allow(Aidp::Util).to receive(:which).with(\"gemini\").and_return(nil)",
          "pattern": "allow().to receive",
          "target": "Aidp::Util"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Util",
          "line_num": 39,
          "line": "allow(Aidp::Util).to receive(:which).with(\"gemini\").and_return(\"/usr/local/bin/gemini\")",
          "pattern": "allow().to receive",
          "target": "Aidp::Util"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Util",
          "line_num": 105,
          "line": "allow(Aidp::Util).to receive(:which).with(\"gemini\").and_return(nil)",
          "pattern": "allow().to receive",
          "target": "Aidp::Util"
        }
      ]
    },
    {
      "file": "spec/aidp/providers/github_copilot_spec.rb",
      "violations": [
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Util",
          "line_num": 14,
          "line": "allow(Aidp::Util).to receive(:which).with(\"copilot\").and_return(\"/usr/local/bin/copilot\")",
          "pattern": "allow().to receive",
          "target": "Aidp::Util"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Util",
          "line_num": 24,
          "line": "allow(Aidp::Util).to receive(:which).with(\"copilot\").and_return(nil)",
          "pattern": "allow().to receive",
          "target": "Aidp::Util"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Util",
          "line_num": 42,
          "line": "allow(Aidp::Util).to receive(:which).with(\"copilot\").and_return(\"/usr/local/bin/copilot\")",
          "pattern": "allow().to receive",
          "target": "Aidp::Util"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Util",
          "line_num": 44,
          "line": "allow(Aidp::Util).to receive(:execute_command)",
          "pattern": "allow().to receive",
          "target": "Aidp::Util"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Util",
          "line_num": 56,
          "line": "allow(Aidp::Util).to receive(:which).with(\"copilot\").and_return(nil)",
          "pattern": "allow().to receive",
          "target": "Aidp::Util"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Util",
          "line_num": 72,
          "line": "allow(Aidp::Util).to receive(:which).with(\"copilot\").and_return(\"/usr/local/bin/copilot\")",
          "pattern": "allow().to receive",
          "target": "Aidp::Util"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Util",
          "line_num": 89,
          "line": "allow(Aidp::Util).to receive(:which).with(\"copilot\").and_return(nil)",
          "pattern": "allow().to receive",
          "target": "Aidp::Util"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Thread",
          "line_num": 105,
          "line": "allow(Thread).to receive(:new).and_return(thread_mock)",
          "pattern": "allow().to receive",
          "target": "Thread"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Thread",
          "line_num": 129,
          "line": "allow(Thread).to receive(:new).and_return(thread_mock)",
          "pattern": "allow().to receive",
          "target": "Thread"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Thread",
          "line_num": 157,
          "line": "allow(Thread).to receive(:new).and_return(thread_mock)",
          "pattern": "allow().to receive",
          "target": "Thread"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 283,
          "line": "provider.instance_variable_set(:@adaptive_timeout, nil)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Util",
          "line_num": 310,
          "line": "allow(Aidp::Util).to receive(:execute_command).and_raise(StandardError.new(\"Command failed\"))",
          "pattern": "allow().to receive",
          "target": "Aidp::Util"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Util",
          "line_num": 321,
          "line": "allow(Aidp::Util).to receive(:execute_command)",
          "pattern": "allow().to receive",
          "target": "Aidp::Util"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Util",
          "line_num": 335,
          "line": "allow(Aidp::Util).to receive(:which).with(\"copilot\").and_return(nil)",
          "pattern": "allow().to receive",
          "target": "Aidp::Util"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Util",
          "line_num": 345,
          "line": "allow(Aidp::Util).to receive(:which).with(\"copilot\").and_return(\"/usr/local/bin/copilot\")",
          "pattern": "allow().to receive",
          "target": "Aidp::Util"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Util",
          "line_num": 346,
          "line": "allow(Aidp::Util).to receive(:execute_command).and_raise(StandardError.new(\"Command failed\"))",
          "pattern": "allow().to receive",
          "target": "Aidp::Util"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Util",
          "line_num": 356,
          "line": "allow(Aidp::Util).to receive(:which).with(\"copilot\").and_return(\"/usr/local/bin/copilot\")",
          "pattern": "allow().to receive",
          "target": "Aidp::Util"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Util",
          "line_num": 358,
          "line": "allow(Aidp::Util).to receive(:execute_command)",
          "pattern": "allow().to receive",
          "target": "Aidp::Util"
        }
      ]
    },
    {
      "file": "spec/aidp/providers/kilocode_spec.rb",
      "violations": [
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Util",
          "line_num": 11,
          "line": "allow(Aidp::Util).to receive(:which).with(\"kilocode\").and_return(nil)",
          "pattern": "allow().to receive",
          "target": "Aidp::Util"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Util",
          "line_num": 16,
          "line": "allow(Aidp::Util).to receive(:which).with(\"kilocode\").and_return(\"/usr/local/bin/kilocode\")",
          "pattern": "allow().to receive",
          "target": "Aidp::Util"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 96,
          "line": "expect(provider.instance_variable_get(:@activity_state)).to eq(:completed)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 103,
          "line": "expect(provider.instance_variable_get(:@activity_state)).to eq(:failed)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Util",
          "line_num": 137,
          "line": "allow(Aidp::Util).to receive(:which).with(\"kilocode\").and_return(\"/usr/local/bin/kilocode\")",
          "pattern": "allow().to receive",
          "target": "Aidp::Util"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Util",
          "line_num": 167,
          "line": "allow(Aidp::Util).to receive(:which).with(\"kilocode\").and_return(nil)",
          "pattern": "allow().to receive",
          "target": "Aidp::Util"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 254,
          "line": "expect(provider.instance_variable_get(:@activity_state)).to eq(:failed)",
          "pattern": "instance_variable manipulation"
        }
      ]
    },
    {
      "file": "spec/aidp/providers/opencode_spec.rb",
      "violations": [
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Util",
          "line_num": 11,
          "line": "allow(Aidp::Util).to receive(:which).with(\"opencode\").and_return(nil)",
          "pattern": "allow().to receive",
          "target": "Aidp::Util"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Util",
          "line_num": 16,
          "line": "allow(Aidp::Util).to receive(:which).with(\"opencode\").and_return(\"/usr/local/bin/opencode\")",
          "pattern": "allow().to receive",
          "target": "Aidp::Util"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 96,
          "line": "expect(provider.instance_variable_get(:@activity_state)).to eq(:completed)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 103,
          "line": "expect(provider.instance_variable_get(:@activity_state)).to eq(:failed)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Util",
          "line_num": 137,
          "line": "allow(Aidp::Util).to receive(:which).with(\"opencode\").and_return(\"/usr/local/bin/opencode\")",
          "pattern": "allow().to receive",
          "target": "Aidp::Util"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Util",
          "line_num": 167,
          "line": "allow(Aidp::Util).to receive(:which).with(\"opencode\").and_return(nil)",
          "pattern": "allow().to receive",
          "target": "Aidp::Util"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 221,
          "line": "expect(provider.instance_variable_get(:@activity_state)).to eq(:failed)",
          "pattern": "instance_variable manipulation"
        }
      ]
    },
    {
      "file": "spec/aidp/rescue_logging_spec.rb",
      "violations": [
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 28,
          "line": "Aidp.instance_variable_set(:@logger, logger)",
          "pattern": "instance_variable manipulation"
        }
      ]
    },
    {
      "file": "spec/aidp/safe_directory_spec.rb",
      "violations": [
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Kernel",
          "line_num": 87,
          "line": "expect(Kernel).to receive(:warn).with(/TestComponent/).at_least(:once)",
          "pattern": "expect().to receive",
          "target": "Kernel"
        }
      ]
    },
    {
      "file": "spec/aidp/setup/wizard_spec.rb",
      "violations": [
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 34,
          "line": "threads = wizard.instance_variable_get(:@discovery_threads)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Util",
          "line_num": 54,
          "line": "allow(Aidp::Util).to receive(:which).and_return(\"/usr/bin/fake\")",
          "pattern": "allow().to receive",
          "target": "Aidp::Util"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Util",
          "line_num": 379,
          "line": "allow(Aidp::Util).to receive(:which).and_return(nil)",
          "pattern": "allow().to receive",
          "target": "Aidp::Util"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 382,
          "line": "expect(wizard.instance_variable_get(:@warnings)).to include(/Command 'nonexistent-command' not found/)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 388,
          "line": "expect(wizard.instance_variable_get(:@warnings)).to be_empty",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 394,
          "line": "expect(wizard.instance_variable_get(:@warnings)).to be_empty",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 400,
          "line": "expect(wizard.instance_variable_get(:@warnings)).to be_empty",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Util",
          "line_num": 404,
          "line": "allow(Aidp::Util).to receive(:which).and_return(\"/usr/bin/found\")",
          "pattern": "allow().to receive",
          "target": "Aidp::Util"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 407,
          "line": "expect(wizard.instance_variable_get(:@warnings)).to be_empty",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 550,
          "line": "expect(wizard.instance_variable_get(:@warnings)).not_to be_empty",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 551,
          "line": "expect(wizard.instance_variable_get(:@existing_config)).to eq({})",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 572,
          "line": "wizard.instance_variable_get(:@config)[:providers] = {",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 579,
          "line": "providers = wizard.instance_variable_get(:@config)[:providers]",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 585,
          "line": "wizard.instance_variable_get(:@config)[:providers] = {",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 589,
          "line": "providers = wizard.instance_variable_get(:@config)[:providers]",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 595,
          "line": "wizard.instance_variable_get(:@config)[:providers] = {",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 600,
          "line": "providers = wizard.instance_variable_get(:@config)[:providers]",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 630,
          "line": "providers = wizard.instance_variable_get(:@config)[:providers]",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 665,
          "line": "providers = wizard.instance_variable_get(:@config)[:providers]",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 709,
          "line": "providers = wizard.instance_variable_get(:@config)[:providers]",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 782,
          "line": "providers = wizard.instance_variable_get(:@config)[:providers]",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 831,
          "line": "providers = wizard.instance_variable_get(:@config)[:providers]",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 867,
          "line": "providers = wizard.instance_variable_get(:@config)[:providers]",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 903,
          "line": "harness_config = wizard.instance_variable_get(:@config)[:harness]",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 940,
          "line": "harness_config = wizard.instance_variable_get(:@config)[:harness]",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 975,
          "line": "harness_config = wizard.instance_variable_get(:@config)[:harness]",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1005,
          "line": "harness_config = wizard.instance_variable_get(:@config)[:harness]",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1075,
          "line": "wizard.instance_variable_get(:@config)[:providers] = {",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1079,
          "line": "providers = wizard.instance_variable_get(:@config)[:providers]",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1085,
          "line": "wizard.instance_variable_get(:@config)[:providers] = {",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1090,
          "line": "providers = wizard.instance_variable_get(:@config)[:providers]",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1097,
          "line": "wizard.instance_variable_get(:@config)[:providers] = {",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1101,
          "line": "providers = wizard.instance_variable_get(:@config)[:providers]",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1141,
          "line": "threads = wizard.instance_variable_get(:@discovery_threads)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1156,
          "line": "threads = wizard.instance_variable_get(:@discovery_threads)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1165,
          "line": "threads = wizard.instance_variable_get(:@discovery_threads)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1170,
          "line": "threads = wizard.instance_variable_get(:@discovery_threads)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1183,
          "line": "wizard.instance_variable_set(:@discovery_threads, [{thread: thread, provider: \"anthropic\"}])",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::ModelCache",
          "line_num": 1187,
          "line": "allow(Aidp::Harness::ModelCache).to receive(:new).and_return(cache)",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::ModelCache"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1200,
          "line": "threads = wizard.instance_variable_get(:@discovery_threads)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1209,
          "line": "wizard.instance_variable_set(:@discovery_threads, [{thread: thread, provider: \"anthropic\"}])",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1214,
          "line": "threads = wizard.instance_variable_get(:@discovery_threads)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1242,
          "line": "threads = wizard.instance_variable_get(:@discovery_threads)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1249,
          "line": "wizard.instance_variable_set(:@discovery_threads, nil)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1258,
          "line": "wizard.instance_variable_set(:@discovery_threads, [{thread: thread, provider: \"anthropic\"}])",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::ModelCache",
          "line_num": 1261,
          "line": "allow(Aidp::Harness::ModelCache).to receive(:new).and_raise(StandardError.new(\"Cache error\"))",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::ModelCache"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Providers::Anthropic",
          "line_num": 1275,
          "line": "provider_class = class_double(\"Aidp::Providers::Anthropic\")",
          "pattern": "class_double",
          "target": "Aidp::Providers::Anthropic"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Providers::Anthropic",
          "line_num": 1275,
          "line": "provider_class = class_double(\"Aidp::Providers::Anthropic\")",
          "pattern": "double",
          "target": "Aidp::Providers::Anthropic"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Providers::Cursor",
          "line_num": 1286,
          "line": "provider_class = class_double(\"Aidp::Providers::Cursor\")",
          "pattern": "class_double",
          "target": "Aidp::Providers::Cursor"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Providers::Cursor",
          "line_num": 1286,
          "line": "provider_class = class_double(\"Aidp::Providers::Cursor\")",
          "pattern": "double",
          "target": "Aidp::Providers::Cursor"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::ModelDiscoveryService",
          "line_num": 1309,
          "line": "allow(Aidp::Harness::ModelDiscoveryService).to receive(:new).and_return(discovery_service)",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::ModelDiscoveryService"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::ModelDiscoveryService",
          "line_num": 1317,
          "line": "allow(Aidp::Harness::ModelDiscoveryService).to receive(:new).and_return(discovery_service)",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::ModelDiscoveryService"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::ModelDiscoveryService",
          "line_num": 1325,
          "line": "allow(Aidp::Harness::ModelDiscoveryService).to receive(:new).and_return(discovery_service)",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::ModelDiscoveryService"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::ModelDiscoveryService",
          "line_num": 1333,
          "line": "allow(Aidp::Harness::ModelDiscoveryService).to receive(:new).and_return(discovery_service)",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::ModelDiscoveryService"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::ModelDiscoveryService",
          "line_num": 1342,
          "line": "allow(Aidp::Harness::ModelDiscoveryService).to receive(:new).and_return(discovery_service)",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::ModelDiscoveryService"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Aidp",
          "line_num": 1345,
          "line": "expect(Aidp).to receive(:log_debug).with(\"setup_wizard\", \"background discovery failed\",",
          "pattern": "expect().to receive",
          "target": "Aidp"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::ModelDiscoveryService",
          "line_num": 1354,
          "line": "allow(Aidp::Harness::ModelDiscoveryService).to receive(:new).and_return(discovery_service)",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::ModelDiscoveryService"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::ModelDiscoveryService",
          "line_num": 1364,
          "line": "allow(Aidp::Harness::ModelDiscoveryService).to receive(:new).and_return(discovery_service)",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::ModelDiscoveryService"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Aidp",
          "line_num": 1367,
          "line": "expect(Aidp).to receive(:log_info).with(\"setup_wizard\", \"discovered models in background\",",
          "pattern": "expect().to receive",
          "target": "Aidp"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1403,
          "line": "config = wizard.instance_variable_get(:@config)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1415,
          "line": "config = wizard.instance_variable_get(:@config)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1457,
          "line": "config = wizard.instance_variable_get(:@config)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1469,
          "line": "config = wizard.instance_variable_get(:@config)",
          "pattern": "instance_variable manipulation"
        }
      ]
    },
    {
      "file": "spec/aidp/skills/wizard/controller_spec.rb",
      "violations": [
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: controller.prompter",
          "line_num": 46,
          "line": "allow(controller.prompter).to receive(:gather_responses).and_raise(Interrupt)",
          "pattern": "allow().to receive",
          "target": "controller.prompter"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: controller.prompter",
          "line_num": 51,
          "line": "allow(controller.prompter).to receive(:gather_responses).and_raise(StandardError, \"test error\")",
          "pattern": "allow().to receive",
          "target": "controller.prompter"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: controller.prompter",
          "line_num": 68,
          "line": "allow(controller.prompter).to receive(:gather_responses).and_return(responses)",
          "pattern": "allow().to receive",
          "target": "controller.prompter"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: mini_controller.prompter",
          "line_num": 86,
          "line": "allow(mini_controller.prompter).to receive(:gather_responses).and_return(responses)",
          "pattern": "allow().to receive",
          "target": "mini_controller.prompter"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: yes_controller.prompter",
          "line_num": 97,
          "line": "allow(yes_controller.prompter).to receive(:gather_responses).and_return(responses)",
          "pattern": "allow().to receive",
          "target": "yes_controller.prompter"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: overwrite_controller.prompter",
          "line_num": 107,
          "line": "allow(overwrite_controller.prompter).to receive(:gather_responses).and_return(responses)",
          "pattern": "allow().to receive",
          "target": "overwrite_controller.prompter"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: overwrite_controller.writer",
          "line_num": 112,
          "line": "allow(overwrite_controller.writer).to receive(:exists?).with(\"exists\").and_return(true)",
          "pattern": "allow().to receive",
          "target": "overwrite_controller.writer"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: dry_controller.prompter",
          "line_num": 120,
          "line": "allow(dry_controller.prompter).to receive(:gather_responses).and_return(responses)",
          "pattern": "allow().to receive",
          "target": "dry_controller.prompter"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: dry_controller.writer",
          "line_num": 125,
          "line": "expect(dry_controller.writer).to receive(:write).with(instance_of(Aidp::Skills::Skill), hash_including(content: /Dry/, dry_run: true, backup: true)).and_call_original",
          "pattern": "expect().to receive",
          "target": "dry_controller.writer"
        }
      ]
    },
    {
      "file": "spec/aidp/skills/wizard/prompter_spec.rb",
      "violations": [
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 24,
          "line": "expect(prompter.instance_variable_get(:@prompt)).to be_a(TTY::Prompt)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: prompter.prompt",
          "line_num": 70,
          "line": "allow(prompter.prompt).to receive(:ask).and_return(\"Test\", \"test\", \"Description\", \"1.0.0\")",
          "pattern": "allow().to receive",
          "target": "prompter.prompt"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: prompter.prompt",
          "line_num": 102,
          "line": "allow(prompter.prompt).to receive(:say)",
          "pattern": "allow().to receive",
          "target": "prompter.prompt"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: prompter.prompt",
          "line_num": 103,
          "line": "allow(prompter.prompt).to receive(:select).and_return(:from_scratch)",
          "pattern": "allow().to receive",
          "target": "prompter.prompt"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: prompter.prompt",
          "line_num": 111,
          "line": "allow(prompter.prompt).to receive(:say)",
          "pattern": "allow().to receive",
          "target": "prompter.prompt"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: prompter.prompt",
          "line_num": 112,
          "line": "allow(prompter.prompt).to receive(:select).and_return(:inherit)",
          "pattern": "allow().to receive",
          "target": "prompter.prompt"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: prompter.prompt",
          "line_num": 124,
          "line": "allow(prompter.prompt).to receive(:warn)",
          "pattern": "allow().to receive",
          "target": "prompter.prompt"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: prompter.prompt",
          "line_num": 136,
          "line": "allow(prompter.prompt).to receive(:select).and_return(\"skill1\")",
          "pattern": "allow().to receive",
          "target": "prompter.prompt"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: prompter.prompt",
          "line_num": 146,
          "line": "allow(prompter.prompt).to receive(:ask).and_return(\"Test Skill\", \"test_skill\", \"A test\", \"1.0.0\")",
          "pattern": "allow().to receive",
          "target": "prompter.prompt"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: prompter.prompt",
          "line_num": 159,
          "line": "allow(prompter.prompt).to receive(:say)",
          "pattern": "allow().to receive",
          "target": "prompter.prompt"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: prompter.prompt",
          "line_num": 160,
          "line": "allow(prompter.prompt).to receive(:ask).and_return(\"Ruby\", \"\", \"rails, testing\")",
          "pattern": "allow().to receive",
          "target": "prompter.prompt"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: prompter.prompt",
          "line_num": 171,
          "line": "allow(prompter.prompt).to receive(:say)",
          "pattern": "allow().to receive",
          "target": "prompter.prompt"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: prompter.prompt",
          "line_num": 172,
          "line": "allow(prompter.prompt).to receive(:ask).and_return(\"Building APIs\", \"\", \"Simple scripts\", \"\")",
          "pattern": "allow().to receive",
          "target": "prompter.prompt"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: prompter.prompt",
          "line_num": 255,
          "line": "allow(prompter.prompt).to receive(:say)",
          "pattern": "allow().to receive",
          "target": "prompter.prompt"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: prompter.prompt",
          "line_num": 256,
          "line": "allow(prompter.prompt).to receive(:yes?).and_return(false)",
          "pattern": "allow().to receive",
          "target": "prompter.prompt"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: prompter.prompt",
          "line_num": 262,
          "line": "allow(prompter.prompt).to receive(:say)",
          "pattern": "allow().to receive",
          "target": "prompter.prompt"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: prompter.prompt",
          "line_num": 263,
          "line": "allow(prompter.prompt).to receive(:yes?).and_return(true)",
          "pattern": "allow().to receive",
          "target": "prompter.prompt"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: prompter.prompt",
          "line_num": 273,
          "line": "allow(prompter.prompt).to receive(:say)",
          "pattern": "allow().to receive",
          "target": "prompter.prompt"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: prompter.prompt",
          "line_num": 274,
          "line": "allow(prompter.prompt).to receive(:multiline).and_return([\"Line 1\", \"Line 2\"])",
          "pattern": "allow().to receive",
          "target": "prompter.prompt"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: prompter.prompt",
          "line_num": 280,
          "line": "allow(prompter.prompt).to receive(:say)",
          "pattern": "allow().to receive",
          "target": "prompter.prompt"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: prompter.prompt",
          "line_num": 281,
          "line": "allow(prompter.prompt).to receive(:multiline).and_return([])",
          "pattern": "allow().to receive",
          "target": "prompter.prompt"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: prompter.prompt",
          "line_num": 290,
          "line": "allow(prompter.prompt).to receive(:select).and_return([])",
          "pattern": "allow().to receive",
          "target": "prompter.prompt"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: prompter.prompt",
          "line_num": 296,
          "line": "allow(prompter.prompt).to receive(:select).and_return([\"anthropic\"])",
          "pattern": "allow().to receive",
          "target": "prompter.prompt"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: prompter.prompt",
          "line_num": 302,
          "line": "allow(prompter.prompt).to receive(:select).and_return(:custom)",
          "pattern": "allow().to receive",
          "target": "prompter.prompt"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: prompter.prompt",
          "line_num": 303,
          "line": "allow(prompter.prompt).to receive(:multi_select).and_return([\"anthropic\", \"openai\"])",
          "pattern": "allow().to receive",
          "target": "prompter.prompt"
        }
      ]
    },
    {
      "file": "spec/aidp/watch/build_processor_spec.rb",
      "violations": [
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 184,
          "line": "processor.instance_variable_set(:@config, nil) # Force config reload",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Worktree",
          "line_num": 269,
          "line": "allow(Aidp::Worktree).to receive(:info).and_return(nil)",
          "pattern": "allow().to receive",
          "target": "Aidp::Worktree"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Worktree",
          "line_num": 270,
          "line": "expect(Aidp::Worktree).to receive(:create).with(",
          "pattern": "expect().to receive",
          "target": "Aidp::Worktree"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Worktree",
          "line_num": 293,
          "line": "allow(Aidp::Worktree).to receive(:info).and_return(existing_ws)",
          "pattern": "allow().to receive",
          "target": "Aidp::Worktree"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Worktree",
          "line_num": 317,
          "line": "allow(Aidp::Worktree).to receive(:info).and_return(nil)",
          "pattern": "allow().to receive",
          "target": "Aidp::Worktree"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Worktree",
          "line_num": 318,
          "line": "allow(Aidp::Worktree).to receive(:create).and_return({path: \"#{tmp_dir}/.worktrees/issue-77-implement-search\"})",
          "pattern": "allow().to receive",
          "target": "Aidp::Worktree"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Worktree",
          "line_num": 330,
          "line": "allow(Aidp::Worktree).to receive(:info).and_return(nil)",
          "pattern": "allow().to receive",
          "target": "Aidp::Worktree"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Worktree",
          "line_num": 331,
          "line": "allow(Aidp::Worktree).to receive(:create).and_return({path: \"#{tmp_dir}/.worktrees/issue-77-implement-search\"})",
          "pattern": "allow().to receive",
          "target": "Aidp::Worktree"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Worktree",
          "line_num": 343,
          "line": "allow(Aidp::Worktree).to receive(:info).and_return(nil)",
          "pattern": "allow().to receive",
          "target": "Aidp::Worktree"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Worktree",
          "line_num": 344,
          "line": "allow(Aidp::Worktree).to receive(:create).and_return({path: \"#{tmp_dir}/.worktrees/issue-77-implement-search\"})",
          "pattern": "allow().to receive",
          "target": "Aidp::Worktree"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Worktree",
          "line_num": 357,
          "line": "allow(Aidp::Worktree).to receive(:info).and_return(nil)",
          "pattern": "allow().to receive",
          "target": "Aidp::Worktree"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Worktree",
          "line_num": 358,
          "line": "allow(Aidp::Worktree).to receive(:create).and_return({path: \"#{tmp_dir}/.worktrees/issue-77-implement-search\"})",
          "pattern": "allow().to receive",
          "target": "Aidp::Worktree"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Worktree",
          "line_num": 373,
          "line": "allow(Aidp::Worktree).to receive(:info).and_return(nil)",
          "pattern": "allow().to receive",
          "target": "Aidp::Worktree"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Worktree",
          "line_num": 374,
          "line": "allow(Aidp::Worktree).to receive(:create).and_return({path: worktree_path})",
          "pattern": "allow().to receive",
          "target": "Aidp::Worktree"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Worktree",
          "line_num": 387,
          "line": "allow(Aidp::Worktree).to receive(:info).and_return(nil)",
          "pattern": "allow().to receive",
          "target": "Aidp::Worktree"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Worktree",
          "line_num": 388,
          "line": "allow(Aidp::Worktree).to receive(:create).and_return({path: workstream_path})",
          "pattern": "allow().to receive",
          "target": "Aidp::Worktree"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Worktree",
          "line_num": 439,
          "line": "allow(Aidp::Worktree).to receive(:info).and_return(nil)",
          "pattern": "allow().to receive",
          "target": "Aidp::Worktree"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Worktree",
          "line_num": 440,
          "line": "allow(Aidp::Worktree).to receive(:create).and_return({path: workstream_path})",
          "pattern": "allow().to receive",
          "target": "Aidp::Worktree"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::Runner",
          "line_num": 466,
          "line": "allow(Aidp::Harness::Runner).to receive(:new).and_return(runner)",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::Runner"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Aidp",
          "line_num": 477,
          "line": "expect(Aidp).to receive(:log_error).with(",
          "pattern": "expect().to receive",
          "target": "Aidp"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Aidp",
          "line_num": 485,
          "line": "expect(Aidp).to receive(:log_error).with(",
          "pattern": "expect().to receive",
          "target": "Aidp"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Aidp",
          "line_num": 504,
          "line": "expect(Aidp).to receive(:log_error).with(",
          "pattern": "expect().to receive",
          "target": "Aidp"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Aidp",
          "line_num": 513,
          "line": "expect(Aidp).to receive(:log_error).with(",
          "pattern": "expect().to receive",
          "target": "Aidp"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::Runner",
          "line_num": 586,
          "line": "allow(Aidp::Harness::Runner).to receive(:new).and_return(runner)",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::Runner"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Aidp",
          "line_num": 595,
          "line": "allow(Aidp).to receive(:log_error)",
          "pattern": "allow().to receive",
          "target": "Aidp"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::StateManager",
          "line_num": 654,
          "line": "allow(Aidp::Harness::StateManager).to receive(:new).and_return(state_manager)",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::StateManager"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Execute::Progress",
          "line_num": 657,
          "line": "allow(Aidp::Execute::Progress).to receive(:new).and_return(progress)",
          "pattern": "allow().to receive",
          "target": "Aidp::Execute::Progress"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::Runner",
          "line_num": 660,
          "line": "allow(Aidp::Harness::Runner).to receive(:new).and_return(runner)",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::Runner"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::Runner",
          "line_num": 688,
          "line": "allow(Aidp::Harness::Runner).to receive(:new).and_return(runner)",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::Runner"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 914,
          "line": "processor.instance_variable_set(:@config, nil)",
          "pattern": "instance_variable manipulation"
        }
      ]
    },
    {
      "file": "spec/aidp/watch/build_processor_vcs_spec.rb",
      "violations": [
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 41,
          "line": "processor.instance_variable_set(:@config, nil)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 53,
          "line": "processor.instance_variable_set(:@config, nil)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 65,
          "line": "processor.instance_variable_set(:@config, nil)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 77,
          "line": "processor.instance_variable_set(:@config, nil)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 89,
          "line": "processor.instance_variable_set(:@config, nil)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 102,
          "line": "processor.instance_variable_set(:@config, nil)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 114,
          "line": "processor.instance_variable_set(:@config, nil)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 159,
          "line": "processor.instance_variable_set(:@config, nil)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 196,
          "line": "processor.instance_variable_set(:@config, nil)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 219,
          "line": "processor.instance_variable_set(:@config, nil)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 241,
          "line": "processor.instance_variable_set(:@config, nil)",
          "pattern": "instance_variable manipulation"
        }
      ]
    },
    {
      "file": "spec/aidp/watch/change_request_processor_spec.rb",
      "violations": [
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::ConfigManager",
          "line_num": 425,
          "line": "allow(Aidp::Harness::ConfigManager).to receive(:new).and_return(failing_config_manager)",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::ConfigManager"
        }
      ]
    },
    {
      "file": "spec/aidp/watch/ci_fix_processor_spec.rb",
      "violations": [
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::ProviderManager",
          "line_num": 84,
          "line": "allow(Aidp::ProviderManager).to receive(:get_provider).and_return(provider)",
          "pattern": "allow().to receive",
          "target": "Aidp::ProviderManager"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::ProviderManager",
          "line_num": 119,
          "line": "allow(Aidp::ProviderManager).to receive(:get_provider).and_return(provider)",
          "pattern": "allow().to receive",
          "target": "Aidp::ProviderManager"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::ProviderManager",
          "line_num": 280,
          "line": "allow(Aidp::ProviderManager).to receive(:get_provider).and_return(provider)",
          "pattern": "allow().to receive",
          "target": "Aidp::ProviderManager"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::ProviderManager",
          "line_num": 294,
          "line": "allow(Aidp::ProviderManager).to receive(:get_provider).and_return(provider)",
          "pattern": "allow().to receive",
          "target": "Aidp::ProviderManager"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Aidp",
          "line_num": 296,
          "line": "allow(Aidp).to receive(:log_error)",
          "pattern": "allow().to receive",
          "target": "Aidp"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::ProviderManager",
          "line_num": 305,
          "line": "allow(Aidp::ProviderManager).to receive(:get_provider).and_raise(StandardError.new(\"Provider error\"))",
          "pattern": "allow().to receive",
          "target": "Aidp::ProviderManager"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Aidp",
          "line_num": 306,
          "line": "allow(Aidp).to receive(:log_error)",
          "pattern": "allow().to receive",
          "target": "Aidp"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::ProviderManager",
          "line_num": 316,
          "line": "allow(Aidp::ProviderManager).to receive(:get_provider).and_return(provider)",
          "pattern": "allow().to receive",
          "target": "Aidp::ProviderManager"
        }
      ]
    },
    {
      "file": "spec/aidp/watch/plan_generator_spec.rb",
      "violations": [
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: provider1",
          "line_num": 139,
          "line": "allow(provider1).to receive(:send_message).and_raise(Timeout::Error, \"Timeout\")",
          "pattern": "allow().to receive",
          "target": "provider1"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: provider2",
          "line_num": 140,
          "line": "allow(provider2).to receive(:send_message).and_return(provider_response)",
          "pattern": "allow().to receive",
          "target": "provider2"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: provider2",
          "line_num": 151,
          "line": "allow(provider2).to receive(:send_message).and_return(provider_response)",
          "pattern": "allow().to receive",
          "target": "provider2"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::ProviderManager",
          "line_num": 180,
          "line": "allow(Aidp::ProviderManager).to receive(:get_provider).and_return(mock_provider)",
          "pattern": "allow().to receive",
          "target": "Aidp::ProviderManager"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::ProviderManager",
          "line_num": 189,
          "line": "allow(Aidp::ProviderManager).to receive(:get_provider).and_return(mock_provider)",
          "pattern": "allow().to receive",
          "target": "Aidp::ProviderManager"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::ProviderManager",
          "line_num": 197,
          "line": "allow(Aidp::ProviderManager).to receive(:get_provider).and_raise(StandardError, \"Provider error\")",
          "pattern": "allow().to receive",
          "target": "Aidp::ProviderManager"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::ConfigManager",
          "line_num": 208,
          "line": "allow(Aidp::Harness::ConfigManager).to receive(:new).and_return(mock_config)",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::ConfigManager"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::ConfigManager",
          "line_num": 216,
          "line": "allow(Aidp::Harness::ConfigManager).to receive(:new).and_return(mock_config)",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::ConfigManager"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::ConfigManager",
          "line_num": 223,
          "line": "allow(Aidp::Harness::ConfigManager).to receive(:new).and_raise(StandardError)",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::ConfigManager"
        }
      ]
    },
    {
      "file": "spec/aidp/watch/reviewers/base_reviewer_spec.rb",
      "violations": [
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::ProviderManager",
          "line_num": 23,
          "line": "allow(Aidp::ProviderManager).to receive(:get_provider).and_return(provider)",
          "pattern": "allow().to receive",
          "target": "Aidp::ProviderManager"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Aidp",
          "line_num": 201,
          "line": "allow(Aidp).to receive(:log_error)",
          "pattern": "allow().to receive",
          "target": "Aidp"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Aidp",
          "line_num": 215,
          "line": "allow(Aidp).to receive(:log_error)",
          "pattern": "allow().to receive",
          "target": "Aidp"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::ConfigManager",
          "line_num": 240,
          "line": "allow(Aidp::Harness::ConfigManager).to receive(:new).and_return(config_manager)",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::ConfigManager"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::ConfigManager",
          "line_num": 249,
          "line": "allow(Aidp::Harness::ConfigManager).to receive(:new).and_raise(StandardError)",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::ConfigManager"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::ConfigManager",
          "line_num": 258,
          "line": "allow(Aidp::Harness::ConfigManager).to receive(:new).and_return(config_manager)",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::ConfigManager"
        }
      ]
    },
    {
      "file": "spec/aidp/watch/reviewers/performance_reviewer_spec.rb",
      "violations": [
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::ProviderManager",
          "line_num": 11,
          "line": "allow(Aidp::ProviderManager).to receive(:get_provider).and_return(provider)",
          "pattern": "allow().to receive",
          "target": "Aidp::ProviderManager"
        }
      ]
    },
    {
      "file": "spec/aidp/watch/reviewers/security_reviewer_spec.rb",
      "violations": [
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::ProviderManager",
          "line_num": 11,
          "line": "allow(Aidp::ProviderManager).to receive(:get_provider).and_return(provider)",
          "pattern": "allow().to receive",
          "target": "Aidp::ProviderManager"
        }
      ]
    },
    {
      "file": "spec/aidp/watch/reviewers/senior_dev_reviewer_spec.rb",
      "violations": [
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::ProviderManager",
          "line_num": 24,
          "line": "allow(Aidp::ProviderManager).to receive(:get_provider).and_return(provider)",
          "pattern": "allow().to receive",
          "target": "Aidp::ProviderManager"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Aidp",
          "line_num": 84,
          "line": "allow(Aidp).to receive(:log_error)",
          "pattern": "allow().to receive",
          "target": "Aidp"
        }
      ]
    },
    {
      "file": "spec/aidp/watch/runner_spec.rb",
      "violations": [
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Aidp",
          "line_num": 20,
          "line": "allow(Aidp).to receive(:log_info)",
          "pattern": "allow().to receive",
          "target": "Aidp"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Aidp",
          "line_num": 21,
          "line": "allow(Aidp).to receive(:log_debug)",
          "pattern": "allow().to receive",
          "target": "Aidp"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Watch::RepositoryClient",
          "line_num": 22,
          "line": "allow(Aidp::Watch::RepositoryClient).to receive(:parse_issues_url).and_return([\"owner\", \"repo\"])",
          "pattern": "allow().to receive",
          "target": "Aidp::Watch::RepositoryClient"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Watch::RepositoryClient",
          "line_num": 23,
          "line": "allow(Aidp::Watch::RepositoryClient).to receive(:new).and_return(repository_client)",
          "pattern": "allow().to receive",
          "target": "Aidp::Watch::RepositoryClient"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Watch::RepositorySafetyChecker",
          "line_num": 24,
          "line": "allow(Aidp::Watch::RepositorySafetyChecker).to receive(:new).and_return(safety_checker)",
          "pattern": "allow().to receive",
          "target": "Aidp::Watch::RepositorySafetyChecker"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Watch::StateStore",
          "line_num": 25,
          "line": "allow(Aidp::Watch::StateStore).to receive(:new).and_return(state_store)",
          "pattern": "allow().to receive",
          "target": "Aidp::Watch::StateStore"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Watch::PlanProcessor",
          "line_num": 26,
          "line": "allow(Aidp::Watch::PlanProcessor).to receive(:new).and_return(plan_processor)",
          "pattern": "allow().to receive",
          "target": "Aidp::Watch::PlanProcessor"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Watch::BuildProcessor",
          "line_num": 27,
          "line": "allow(Aidp::Watch::BuildProcessor).to receive(:new).and_return(build_processor)",
          "pattern": "allow().to receive",
          "target": "Aidp::Watch::BuildProcessor"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 37,
          "line": "expect(runner.instance_variable_get(:@interval)).to eq(30)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 42,
          "line": "expect(runner.instance_variable_get(:@interval)).to eq(60)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 47,
          "line": "expect(runner.instance_variable_get(:@once)).to be true",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Watch::RepositoryClient",
          "line_num": 51,
          "line": "expect(Aidp::Watch::RepositoryClient).to receive(:parse_issues_url).with(issues_url)",
          "pattern": "expect().to receive",
          "target": "Aidp::Watch::RepositoryClient"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Watch::RepositoryClient",
          "line_num": 56,
          "line": "expect(Aidp::Watch::RepositoryClient).to receive(:new).with(",
          "pattern": "expect().to receive",
          "target": "Aidp::Watch::RepositoryClient"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Watch::ChangeRequestProcessor",
          "line_num": 302,
          "line": "allow(Aidp::Watch::ChangeRequestProcessor).to receive(:new).and_return(change_request_processor)",
          "pattern": "allow().to receive",
          "target": "Aidp::Watch::ChangeRequestProcessor"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Aidp",
          "line_num": 370,
          "line": "allow(Aidp).to receive(:log_warn)",
          "pattern": "allow().to receive",
          "target": "Aidp"
        }
      ]
    },
    {
      "file": "spec/aidp/workflows/guided_agent_spec.rb",
      "violations": [
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::ConfigManager",
          "line_num": 27,
          "line": "allow(Aidp::Harness::ConfigManager).to receive(:new).with(project_dir).and_return(config_manager)",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::ConfigManager"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::ProviderManager",
          "line_num": 28,
          "line": "allow(Aidp::Harness::ProviderManager).to receive(:new)",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::ProviderManager"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::ProviderFactory",
          "line_num": 33,
          "line": "allow(Aidp::Harness::ProviderFactory).to receive(:new).with(config_manager).and_return(provider_factory)",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::ProviderFactory"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 53,
          "line": "expect(agent.instance_variable_get(:@project_dir)).to eq(project_dir)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 57,
          "line": "expect(agent.instance_variable_get(:@conversation_history)).to eq([])",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 58,
          "line": "expect(agent.instance_variable_get(:@user_input)).to eq({})",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::CLI::EnhancedInput",
          "line_num": 62,
          "line": "enhanced_prompt = instance_double(\"Aidp::CLI::EnhancedInput\")",
          "pattern": "instance_double",
          "target": "Aidp::CLI::EnhancedInput"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::CLI::EnhancedInput",
          "line_num": 62,
          "line": "enhanced_prompt = instance_double(\"Aidp::CLI::EnhancedInput\")",
          "pattern": "double",
          "target": "Aidp::CLI::EnhancedInput"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::CLI::EnhancedInput",
          "line_num": 63,
          "line": "allow(Aidp::CLI::EnhancedInput).to receive(:new).and_return(enhanced_prompt)",
          "pattern": "allow().to receive",
          "target": "Aidp::CLI::EnhancedInput"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::ProviderManager",
          "line_num": 66,
          "line": "enhanced_provider_manager = instance_double(\"Aidp::Harness::ProviderManager\")",
          "pattern": "instance_double",
          "target": "Aidp::Harness::ProviderManager"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::ProviderManager",
          "line_num": 66,
          "line": "enhanced_provider_manager = instance_double(\"Aidp::Harness::ProviderManager\")",
          "pattern": "double",
          "target": "Aidp::Harness::ProviderManager"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::ProviderManager",
          "line_num": 67,
          "line": "allow(Aidp::Harness::ProviderManager).to receive(:new)",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::ProviderManager"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 76,
          "line": "expect(agent_with_enhanced.instance_variable_get(:@prompt)).to eq(enhanced_prompt)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Logger",
          "line_num": 329,
          "line": "logger_double = instance_double(\"Aidp::Logger\")",
          "pattern": "instance_double",
          "target": "Aidp::Logger"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Logger",
          "line_num": 329,
          "line": "logger_double = instance_double(\"Aidp::Logger\")",
          "pattern": "double",
          "target": "Aidp::Logger"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Aidp",
          "line_num": 330,
          "line": "allow(Aidp).to receive(:logger).and_return(logger_double)",
          "pattern": "allow().to receive",
          "target": "Aidp"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::ProviderFactory",
          "line_num": 958,
          "line": "allow(Aidp::Harness::ProviderFactory).to receive(:new).with(mock_config_manager).and_return(mock_provider_factory)",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::ProviderFactory"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::ProviderFactory",
          "line_num": 1013,
          "line": "allow(Aidp::Harness::ProviderFactory).to receive(:new).with(mock_config_manager).and_return(tracking_provider_factory)",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::ProviderFactory"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::ProviderFactory",
          "line_num": 1076,
          "line": "allow(Aidp::Harness::ProviderFactory).to receive(:new).with(single_provider_config_manager).and_return(single_provider_factory)",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::ProviderFactory"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::ProviderFactory",
          "line_num": 1174,
          "line": "allow(Aidp::Harness::ProviderFactory).to receive(:new).with(resource_exhaustion_config_manager).and_return(resource_exhaustion_provider_factory)",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::ProviderFactory"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::ProviderFactory",
          "line_num": 1238,
          "line": "allow(Aidp::Harness::ProviderFactory).to receive(:new).with(retry_failure_config_manager).and_return(retry_failure_provider_factory)",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::ProviderFactory"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): ProviderManager",
          "line_num": 1288,
          "line": "let(:provider_manager) { instance_double(\"ProviderManager\", current_provider: \"cursor\") }",
          "pattern": "instance_double",
          "target": "ProviderManager"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::ConfigManager",
          "line_num": 1289,
          "line": "let(:config_manager) { instance_double(\"Aidp::Harness::ConfigManager\") }",
          "pattern": "instance_double",
          "target": "Aidp::Harness::ConfigManager"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::ConfigManager",
          "line_num": 1289,
          "line": "let(:config_manager) { instance_double(\"Aidp::Harness::ConfigManager\") }",
          "pattern": "double",
          "target": "Aidp::Harness::ConfigManager"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::ProviderFactory",
          "line_num": 1292,
          "line": "let(:provider_factory) { instance_double(\"Aidp::Harness::ProviderFactory\") }",
          "pattern": "instance_double",
          "target": "Aidp::Harness::ProviderFactory"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::ProviderFactory",
          "line_num": 1292,
          "line": "let(:provider_factory) { instance_double(\"Aidp::Harness::ProviderFactory\") }",
          "pattern": "double",
          "target": "Aidp::Harness::ProviderFactory"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Provider",
          "line_num": 1293,
          "line": "let(:provider) { instance_double(\"Provider\", send_message: nil) }",
          "pattern": "instance_double",
          "target": "Provider"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::ProviderFactory",
          "line_num": 1296,
          "line": "allow(Aidp::Harness::ProviderFactory).to receive(:new).and_return(provider_factory)",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::ProviderFactory"
        },
        {
          "type": "needs_review",
          "reason": "Mocking method call or complex expression: agent.instance_variable_get(:@config_manager)",
          "line_num": 1299,
          "line": "allow(agent.instance_variable_get(:@config_manager)).to receive(:respond_to?).and_return(false)",
          "pattern": "allow().to receive",
          "target": "agent.instance_variable_get(:@config_manager)"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1299,
          "line": "allow(agent.instance_variable_get(:@config_manager)).to receive(:respond_to?).and_return(false)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 1300,
          "line": "agent.instance_variable_set(:@provider_manager, provider_manager)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Logger",
          "line_num": 1306,
          "line": "mock_logger = instance_double(\"Aidp::Logger\")",
          "pattern": "instance_double",
          "target": "Aidp::Logger"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Logger",
          "line_num": 1306,
          "line": "mock_logger = instance_double(\"Aidp::Logger\")",
          "pattern": "double",
          "target": "Aidp::Logger"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Aidp",
          "line_num": 1311,
          "line": "allow(Aidp).to receive(:logger).and_return(mock_logger)",
          "pattern": "allow().to receive",
          "target": "Aidp"
        },
        {
          "type": "needs_review",
          "reason": "Mocking unknown class (might be internal): Aidp.logger",
          "line_num": 1324,
          "line": "expect(Aidp.logger).to receive(:debug).with(\"guided_agent\", \"provider_switch_noop\", hash_including(provider: \"cursor\", reason: \"resource_exhausted\"))",
          "pattern": "expect().to receive",
          "target": "Aidp.logger"
        }
      ]
    },
    {
      "file": "spec/aidp/workstream_executor_spec.rb",
      "violations": [
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 31,
          "line": "expect(executor.instance_variable_get(:@project_dir)).to eq(project_dir)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 32,
          "line": "expect(executor.instance_variable_get(:@max_concurrent)).to eq(2)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 37,
          "line": "expect(default_executor.instance_variable_get(:@max_concurrent)).to eq(3)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 41,
          "line": "results = executor.instance_variable_get(:@results)",
          "pattern": "instance_variable manipulation"
        },
        {
          "type": "violation",
          "reason": "Direct instance variable manipulation (code smell)",
          "line_num": 42,
          "line": "start_times = executor.instance_variable_get(:@start_times)",
          "pattern": "instance_variable manipulation"
        }
      ]
    },
    {
      "file": "spec/integration/issue_command_integration_spec.rb",
      "violations": [
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::IssueImporter",
          "line_num": 54,
          "line": "allow(Aidp::IssueImporter).to receive(:new).and_return(mock_importer)",
          "pattern": "allow().to receive",
          "target": "Aidp::IssueImporter"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::CLI",
          "line_num": 116,
          "line": "allow(Aidp::CLI).to receive(:display_message) do |message, **_options|",
          "pattern": "allow().to receive",
          "target": "Aidp::CLI"
        }
      ]
    },
    {
      "file": "spec/integration/jobs_command_integration_spec.rb",
      "violations": [
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Jobs::BackgroundRunner",
          "line_num": 14,
          "line": "allow(Aidp::Jobs::BackgroundRunner).to receive(:new).and_return(background_runner)",
          "pattern": "allow().to receive",
          "target": "Aidp::Jobs::BackgroundRunner"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Jobs::BackgroundRunner",
          "line_num": 28,
          "line": "allow(Aidp::Jobs::BackgroundRunner).to receive(:new).and_return(background_runner)",
          "pattern": "allow().to receive",
          "target": "Aidp::Jobs::BackgroundRunner"
        }
      ]
    },
    {
      "file": "spec/system/analyze_mode_workflow_spec.rb",
      "violations": [
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::CLI",
          "line_num": 20,
          "line": "allow(Aidp::CLI).to receive(:new).and_return(mock_cli)",
          "pattern": "allow().to receive",
          "target": "Aidp::CLI"
        }
      ]
    },
    {
      "file": "spec/system/guided_workflow_golden_path_spec.rb",
      "violations": [
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::ProviderFactory",
          "line_num": 92,
          "line": "allow(Aidp::Harness::ProviderFactory).to receive(:new).with(system_test_config_manager).and_return(system_test_provider_factory)",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::ProviderFactory"
        },
        {
          "type": "violation",
          "reason": "Mocking internal AIDP class: Aidp::Harness::ProviderFactory",
          "line_num": 193,
          "line": "allow(Aidp::Harness::ProviderFactory).to receive(:new).with(system_test_config_manager).and_return(recovery_provider_factory)",
          "pattern": "allow().to receive",
          "target": "Aidp::Harness::ProviderFactory"
        }
      ]
    }
  ]
}
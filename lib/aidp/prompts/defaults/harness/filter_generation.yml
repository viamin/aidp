# Filter Generation Prompt Template
# Used by AIFilterFactory to generate filter definitions for tool output
name: Filter Generation
description: >
  AI-Generated Determinism (AGD) pattern prompt for analyzing tool output
  and generating regex patterns for filtering. Runs once during configuration.
version: "1.0.0"
category: harness
tier: standard
cache_ttl: null

prompt: |
  Analyze the following tool output and generate regex patterns for filtering.
  The goal is to extract ONLY the important information (failures, errors, locations)
  and filter out noise, so that AI assistants receive concise, actionable output.

  Tool: {{tool_name}}
  Command: {{tool_command}}

  Sample output:
  ```
  {{sample_output}}
  ```

  Generate a filter definition with these components:

  1. summary_patterns: Regex patterns that match summary/result lines (e.g., "5 passed, 2 failed")
  2. failure_section_start: Regex pattern marking where failures section begins (if applicable)
  3. failure_section_end: Regex pattern marking where failures section ends (if applicable)
  4. error_section_start: Regex pattern for errors section start (if different from failures)
  5. error_section_end: Regex pattern for errors section end
  6. error_patterns: Regex patterns that identify error/failure indicator lines
  7. location_patterns: Regex patterns to extract file:line locations from output
  8. noise_patterns: Regex patterns for lines that should be filtered out (timestamps, progress bars, etc.)
  9. important_patterns: Regex patterns for lines that should ALWAYS be kept

  Important guidelines for patterns:
  - Use simple, portable regex syntax
  - Escape special characters properly (dots, brackets, etc.)
  - Make patterns case-insensitive where appropriate
  - For location patterns, use capture groups to extract the file:line portion
  - Leave fields as null/empty if not applicable to this tool

  Respond with ONLY valid JSON matching this structure:
  {
    "tool_name": "string",
    "summary_patterns": ["pattern1", "pattern2"],
    "failure_section_start": "pattern or null",
    "failure_section_end": "pattern or null",
    "error_section_start": "pattern or null",
    "error_section_end": "pattern or null",
    "error_patterns": ["pattern1"],
    "location_patterns": ["pattern with (capture) group"],
    "noise_patterns": ["pattern1"],
    "important_patterns": ["pattern1"]
  }

schema:
  type: object
  properties:
    tool_name:
      type: string
    summary_patterns:
      type: array
      items:
        type: string
    failure_section_start:
      type:
        - string
        - "null"
    failure_section_end:
      type:
        - string
        - "null"
    error_section_start:
      type:
        - string
        - "null"
    error_section_end:
      type:
        - string
        - "null"
    error_patterns:
      type: array
      items:
        type: string
    location_patterns:
      type: array
      items:
        type: string
    noise_patterns:
      type: array
      items:
        type: string
    important_patterns:
      type: array
      items:
        type: string
  required:
    - tool_name
    - summary_patterns

variables:
  - tool_name
  - tool_command
  - sample_output

# Work Loop Alignment PRD

## Summary

- Bring the implemented work-loop behavior in line with the published expectations in `docs/WORK_LOOPS_GUIDE.md`.
- Guarantee that watch mode always routes through the fix-forward agent, never posting failure comments unless humans must intervene.
- Expose the entire work-loop prompt surface (including the `decide_whats_next` pass) through templates so teams can customize flows without code changes.

## Goals

1. **Parity**: Close the behavior/documentation gap for deterministic ↔ agentic handoffs, error handling, and provider usage.
2. **Observability**: Ensure every prompt is archived (already in place) and extend context so operators can audit why the loop chose a next step.
3. **Resilience**: When tests fail or no changes exist, invoke an agentic “what now?” step instead of failing the build.
4. **Configurability**: Expose work-loop units and templates in `.aidp/aidp.yml` + `templates/work_loop/` so repos can tailor flows.

## Non-Goals

- Rewriting the entire work-loop scheduler.
- Handling provider authentication issues beyond existing rate-limit handling.
- Implementing UI affordances (CLI/TUI) outside the execution flow.

## Current State

- `docs/WORK_LOOPS_GUIDE.md` promises `decide_whats_next` templates and unit catalogs, but the code builds the decider prompt inline and ships with disabled deterministic units.
- `.aidp/aidp.yml` generated by the wizard contains no `work_loop.units`, so repositories rely solely on default code paths.
- Watch mode failures due to cached progress still post public GitHub comments even when an agent could continue.
- Deterministic failure output reaches `PROMPT.md`, but there is no extra agent hop to reassess the next step in “no changes” scenarios.

## Proposed Plan

### Roadmap Checkboxes

- [x] Document current vs desired behavior and capture the plan (this change).
- [x] Externalize the `decide_whats_next` prompt to a template and add loader plumbing (this change).
- [x] Define the canonical unit catalog in `.aidp/aidp.yml` and wire deterministic → agentic flows that match the guide.
- [x] Teach the “no changes” path to enqueue a decider agent instead of concluding with a warning.
- [x] Extend deterministic unit results so failures can request diagnosis templates automatically.
- [x] Update watch-mode completion/comment rules: only post when the agent reports a blocker, otherwise loop silently.
- [x] Refresh docs (`WORK_LOOPS_GUIDE.md`, `CONFIGURATION.md`) with actual filenames, template placeholders, and troubleshooting steps.

### Work Breakdown

1. **Gap Analysis**
   - Extract discrepancies between the guide and the code (files: `lib/aidp/execute/work_loop_runner.rb`, `lib/aidp/watch/build_processor.rb`, `.aidp/aidp.yml`).
2. **Template + Unit Scaffolding**
   - Add `templates/work_loop/*.md` files with placeholder tokens.
   - Update config loader + wizard defaults to surface those templates.
3. **Agentic Recovery Hooks**
   - Route “no changes” and repeated deterministic failures through an agentic decision step instead of returning `status: error`.
4. **Watch-Mode UX**
   - Remove user-facing error comments unless the agent explicitly says it is blocked.
   - Leave detailed logs in `.aidp/logs/aidp.log` + prompt archive for operator debugging.
5. **Documentation**
   - Align `WORK_LOOPS_GUIDE.md` and `docs/CONFIGURATION.md` with the new scaffolding and provide examples of extending the unit catalog.

## Risks

- Longer execution time in watch mode if additional agent hops run after every failure; mitigate with scheduler cooldowns.
- Customized repositories may already rely on default/inline prompts; we must keep fallbacks so the new template system is opt-in.
- Work-loop unit changes could break older aidp.yml files if validation becomes stricter; need migration notes.

## Success Metrics

- Watch-mode issues no longer receive “Harness encountered an error” comments unless human action is required.
- Prompt archive shows a `decide_whats_next` prompt for every loop that exits tests without commits.
- Template-driven unit catalog documented and referenced in `aidp.yml`, verified via tests for `WorkLoopRunner`.

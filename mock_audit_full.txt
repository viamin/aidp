================================================================================
AIDP Mock Usage Audit Report
================================================================================

Summary:
  Total spec files: 194
  Files with violations: 87
  Files needing review: 11
  Clean files: 96

--------------------------------------------------------------------------------
File: spec/aidp/analyze/json_file_storage_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (2):
    Line 17: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(storage.instance_variable_get(:@project_dir)).to eq(temp_dir)

    Line 22: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(custom_storage.instance_variable_get(:@storage_dir)).to eq(File.join(temp_dir, "custom_storage"))

--------------------------------------------------------------------------------
File: spec/aidp/analyze/kb_inspector_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (4):
    Line 24: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(inspector.instance_variable_get(:@kb_dir)).to eq(kb_dir)

    Line 28: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(inspector.instance_variable_get(:@data)).to be_a(Hash)

    Line 206: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: inspector.instance_variable_set(:@data, {seams: []})

    Line 230: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: inspector.instance_variable_set(:@data, {hotspots: []})

--------------------------------------------------------------------------------
File: spec/aidp/analyze/ruby_maat_integration_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (1):
    Line 15: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(integration.instance_variable_get(:@prompt)).to eq(test_prompt)

--------------------------------------------------------------------------------
File: spec/aidp/analyze/runner_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (2):
    Line 9: Mocking internal AIDP class: Aidp::Harness::Runner
      Pattern: instance_double
      Code: let(:harness_runner) { instance_double("Aidp::Harness::Runner") }

    Line 9: Mocking internal AIDP class: Aidp::Harness::Runner
      Pattern: double
      Code: let(:harness_runner) { instance_double("Aidp::Harness::Runner") }


  NEEDS REVIEW (10):
    Line 19: Mocking unknown class (might be internal): YAML
      Pattern: allow().to receive
      Code: allow(YAML).to receive(:load_file).and_return({})

    Line 56: Mocking method call or complex expression: runner.progress
      Pattern: allow().to receive
      Code: allow(runner.progress).to receive(:step_completed?).and_return(false)

    Line 63: Mocking method call or complex expression: runner.progress
      Pattern: allow().to receive
      Code: allow(runner.progress).to receive(:step_completed?).and_return(true)

    Line 104: Mocking method call or complex expression: runner.progress
      Pattern: allow().to receive
      Code: allow(runner.progress).to receive(:completed_steps).and_return(["01_REPOSITORY_ANALYSIS"])

    Line 105: Mocking method call or complex expression: runner.progress
      Pattern: allow().to receive
      Code: allow(runner.progress).to receive(:current_step).and_return("02_ARCHITECTURE_ANALYSIS")

    Line 106: Mocking method call or complex expression: runner.progress
      Pattern: allow().to receive
      Code: allow(runner.progress).to receive(:started_at).and_return(Time.now - 3600)

    Line 107: Mocking method call or complex expression: runner.progress
      Pattern: allow().to receive
      Code: allow(runner.progress).to receive(:step_completed?).and_return(false)

    Line 108: Mocking method call or complex expression: runner.progress
      Pattern: allow().to receive
      Code: allow(runner.progress).to receive(:step_completed?).with("01_REPOSITORY_ANALYSIS").and_return(true)

    Line 144: Mocking unknown class (might be internal): ProviderManager
      Pattern: instance_double
      Code: allow(harness_runner).to receive(:provider_manager).and_return(instance_double("ProviderManager"))

    Line 152: Mocking unknown class (might be internal): ProviderManager
      Pattern: instance_double
      Code: provider_manager = instance_double("ProviderManager")

--------------------------------------------------------------------------------
File: spec/aidp/analyze/tree_sitter_grammar_loader_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (3):
    Line 21: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(loader.instance_variable_get(:@project_dir)).to eq(temp_dir)

    Line 25: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: grammars_dir = loader.instance_variable_get(:@grammars_dir)

    Line 30: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: loaded = loader.instance_variable_get(:@loaded_grammars)

--------------------------------------------------------------------------------
File: spec/aidp/analyze/tree_sitter_scan_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (16):
    Line 24: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(scanner.instance_variable_get(:@root)).to eq(temp_dir)

    Line 25: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(scanner.instance_variable_get(:@kb_dir)).to eq(kb_dir)

    Line 26: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(scanner.instance_variable_get(:@langs)).to eq(%w[ruby])

    Line 30: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(scanner.instance_variable_get(:@symbols)).to eq([])

    Line 31: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(scanner.instance_variable_get(:@imports)).to eq([])

    Line 32: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(scanner.instance_variable_get(:@calls)).to eq([])

    Line 33: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(scanner.instance_variable_get(:@metrics)).to eq([])

    Line 34: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(scanner.instance_variable_get(:@seams)).to eq([])

    Line 227: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: scanner.instance_variable_set(:@symbols, [

    Line 230: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: scanner.instance_variable_set(:@imports, [

    Line 233: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: scanner.instance_variable_set(:@calls, [])

    Line 234: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: scanner.instance_variable_set(:@metrics, [])

    Line 235: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: scanner.instance_variable_set(:@seams, [])

    Line 236: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: scanner.instance_variable_set(:@hotspots, [])

    Line 237: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: scanner.instance_variable_set(:@tests, [])

    Line 238: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: scanner.instance_variable_set(:@cycles, [])

--------------------------------------------------------------------------------
File: spec/aidp/auto_update/bundler_adapter_spec.rb
--------------------------------------------------------------------------------

  NEEDS REVIEW (4):
    Line 54: Mocking unknown class (might be internal): Aidp
      Pattern: expect().to receive
      Code: expect(Aidp).to receive(:log_debug).with("bundler_adapter", "checking_gem_version", gem: gem_name)

    Line 55: Mocking unknown class (might be internal): Aidp
      Pattern: expect().to receive
      Code: expect(Aidp).to receive(:log_debug).with("bundler_adapter", "bundle_outdated_failed",

    Line 69: Mocking unknown class (might be internal): Aidp
      Pattern: expect().to receive
      Code: expect(Aidp).to receive(:log_debug).with("bundler_adapter", "checking_gem_version", gem: gem_name)

    Line 70: Mocking unknown class (might be internal): Aidp
      Pattern: expect().to receive
      Code: expect(Aidp).to receive(:log_error).with("bundler_adapter", "version_check_failed",

--------------------------------------------------------------------------------
File: spec/aidp/cli/enhanced_input_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (5):
    Line 85: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(enhanced_input.instance_variable_get(:@use_reline)).to be true

    Line 90: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(enhanced_input.instance_variable_get(:@show_hints)).to be true

    Line 187: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(enhanced_input.instance_variable_get(:@show_hints)).to be true

    Line 194: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(enhanced_input.instance_variable_get(:@use_reline)).to be false

    Line 201: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(enhanced_input.instance_variable_get(:@use_reline)).to be true


  NEEDS REVIEW (28):
    Line 78: Mocking unknown class (might be internal): Reline
      Pattern: allow().to receive
      Code: allow(Reline).to receive(:readline).and_return("reline answer")

    Line 79: Mocking unknown class (might be internal): Reline
      Pattern: allow().to receive
      Code: allow(Reline).to receive(:output=)

    Line 80: Mocking unknown class (might be internal): Reline
      Pattern: allow().to receive
      Code: allow(Reline).to receive(:input=)

    Line 81: Mocking unknown class (might be internal): Reline
      Pattern: allow().to receive
      Code: allow(Reline).to receive(:completion_append_character=)

    Line 100: Mocking unknown class (might be internal): Reline
      Pattern: allow().to receive
      Code: allow(Reline).to receive(:readline).and_return("user input")

    Line 101: Mocking unknown class (might be internal): Reline
      Pattern: allow().to receive
      Code: allow(Reline).to receive(:output=)

    Line 102: Mocking unknown class (might be internal): Reline
      Pattern: allow().to receive
      Code: allow(Reline).to receive(:input=)

    Line 103: Mocking unknown class (might be internal): Reline
      Pattern: allow().to receive
      Code: allow(Reline).to receive(:completion_append_character=)

    Line 112: Mocking unknown class (might be internal): Reline
      Pattern: allow().to receive
      Code: allow(Reline).to receive(:readline).and_return("")

    Line 113: Mocking unknown class (might be internal): Reline
      Pattern: allow().to receive
      Code: allow(Reline).to receive(:output=)

    Line 114: Mocking unknown class (might be internal): Reline
      Pattern: allow().to receive
      Code: allow(Reline).to receive(:input=)

    Line 115: Mocking unknown class (might be internal): Reline
      Pattern: allow().to receive
      Code: allow(Reline).to receive(:completion_append_character=)

    Line 124: Mocking unknown class (might be internal): Reline
      Pattern: allow().to receive
      Code: allow(Reline).to receive(:readline).and_return("  answer with spaces  ")

    Line 125: Mocking unknown class (might be internal): Reline
      Pattern: allow().to receive
      Code: allow(Reline).to receive(:output=)

    Line 126: Mocking unknown class (might be internal): Reline
      Pattern: allow().to receive
      Code: allow(Reline).to receive(:input=)

    Line 127: Mocking unknown class (might be internal): Reline
      Pattern: allow().to receive
      Code: allow(Reline).to receive(:completion_append_character=)

    Line 136: Mocking unknown class (might be internal): Reline
      Pattern: allow().to receive
      Code: allow(Reline).to receive(:readline).and_return("", "  ", "valid answer")

    Line 137: Mocking unknown class (might be internal): Reline
      Pattern: allow().to receive
      Code: allow(Reline).to receive(:output=)

    Line 138: Mocking unknown class (might be internal): Reline
      Pattern: allow().to receive
      Code: allow(Reline).to receive(:input=)

    Line 139: Mocking unknown class (might be internal): Reline
      Pattern: allow().to receive
      Code: allow(Reline).to receive(:completion_append_character=)

    Line 148: Mocking unknown class (might be internal): Reline
      Pattern: allow().to receive
      Code: allow(Reline).to receive(:readline).and_return(nil)

    Line 149: Mocking unknown class (might be internal): Reline
      Pattern: allow().to receive
      Code: allow(Reline).to receive(:output=)

    Line 150: Mocking unknown class (might be internal): Reline
      Pattern: allow().to receive
      Code: allow(Reline).to receive(:input=)

    Line 151: Mocking unknown class (might be internal): Reline
      Pattern: allow().to receive
      Code: allow(Reline).to receive(:completion_append_character=)

    Line 162: Mocking unknown class (might be internal): Reline
      Pattern: allow().to receive
      Code: allow(Reline).to receive(:readline).and_return("answer")

    Line 163: Mocking unknown class (might be internal): Reline
      Pattern: allow().to receive
      Code: allow(Reline).to receive(:output=)

    Line 164: Mocking unknown class (might be internal): Reline
      Pattern: allow().to receive
      Code: allow(Reline).to receive(:input=)

    Line 165: Mocking unknown class (might be internal): Reline
      Pattern: allow().to receive
      Code: allow(Reline).to receive(:completion_append_character=)

--------------------------------------------------------------------------------
File: spec/aidp/cli/first_run_wizard_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (2):
    Line 39: Mocking internal AIDP class: Aidp::Setup::Wizard
      Pattern: expect().to receive
      Code: expect(Aidp::Setup::Wizard).to receive(:new)

    Line 52: Mocking internal AIDP class: Aidp::Setup::Wizard
      Pattern: expect().to receive
      Code: expect(Aidp::Setup::Wizard).to receive(:new)

--------------------------------------------------------------------------------
File: spec/aidp/cli/issue_importer_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (1):
    Line 32: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect([true, false]).to include(importer_with_detection.instance_variable_get(:@gh_available))

--------------------------------------------------------------------------------
File: spec/aidp/cli/jobs_command_simple_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (2):
    Line 16: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: cmd.instance_variable_set(:@file_manager, file_manager)

    Line 17: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: cmd.instance_variable_set(:@background_runner, background_runner)

--------------------------------------------------------------------------------
File: spec/aidp/cli/mcp_dashboard_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (8):
    Line 23: Mocking internal AIDP class: Aidp::Harness::Configuration
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::Configuration).to receive(:new).and_return(mock_config)

    Line 44: Mocking internal AIDP class: Aidp::Harness::ProviderInfo
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::ProviderInfo).to receive(:new).and_return(mock_provider_info)

    Line 49: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(dashboard.instance_variable_get(:@root_dir)).to eq(temp_dir)

    Line 54: Mocking internal AIDP class: Aidp::Harness::Configuration
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::Configuration).to receive(:new).and_return(mock_config)

    Line 56: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(dashboard.instance_variable_get(:@root_dir)).to eq(Dir.pwd)

    Line 60: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(dashboard.instance_variable_get(:@configuration)).not_to be_nil

    Line 117: Mocking internal AIDP class: Aidp::Harness::ProviderInfo
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::ProviderInfo).to receive(:new).and_return(mock_provider_info)

    Line 141: Mocking internal AIDP class: Aidp::Harness::ProviderInfo
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::ProviderInfo).to receive(:new).and_return(mock_provider_info)

--------------------------------------------------------------------------------
File: spec/aidp/cli/models_command_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (14):
    Line 17: Mocking internal AIDP class: Aidp::Harness::ModelRegistry
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::ModelRegistry).to receive(:new).and_return(mock_registry)

    Line 18: Mocking internal AIDP class: Aidp::Harness::ModelDiscoveryService
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::ModelDiscoveryService).to receive(:new).and_return(mock_discovery)

    Line 222: Mocking internal AIDP class: Aidp::Config
      Pattern: allow().to receive
      Code: allow(Aidp::Config).to receive(:config_exists?).with(temp_dir).and_return(true)

    Line 225: Mocking internal AIDP class: Aidp::Providers::Anthropic
      Pattern: class_double
      Code: provider_class = class_double("Aidp::Providers::Anthropic")

    Line 225: Mocking internal AIDP class: Aidp::Providers::Anthropic
      Pattern: double
      Code: provider_class = class_double("Aidp::Providers::Anthropic")

    Line 261: Mocking internal AIDP class: Aidp::Config
      Pattern: allow().to receive
      Code: allow(Aidp::Config).to receive(:config_exists?).with(temp_dir).and_return(true)

    Line 263: Mocking internal AIDP class: Aidp::Providers::Anthropic
      Pattern: class_double
      Code: provider_class = class_double("Aidp::Providers::Anthropic")

    Line 263: Mocking internal AIDP class: Aidp::Providers::Anthropic
      Pattern: double
      Code: provider_class = class_double("Aidp::Providers::Anthropic")

    Line 282: Mocking internal AIDP class: Aidp::Config
      Pattern: allow().to receive
      Code: allow(Aidp::Config).to receive(:config_exists?).with(temp_dir).and_return(false)

    Line 295: Mocking internal AIDP class: Aidp::Config
      Pattern: allow().to receive
      Code: allow(Aidp::Config).to receive(:config_exists?).and_raise(StandardError.new("Validation error"))

    Line 367: Mocking internal AIDP class: Aidp::Providers::Anthropic
      Pattern: class_double
      Code: provider_class = class_double("Aidp::Providers::Anthropic")

    Line 367: Mocking internal AIDP class: Aidp::Providers::Anthropic
      Pattern: double
      Code: provider_class = class_double("Aidp::Providers::Anthropic")

    Line 380: Mocking internal AIDP class: Aidp::Providers::Anthropic
      Pattern: class_double
      Code: provider_class = class_double("Aidp::Providers::Anthropic")

    Line 380: Mocking internal AIDP class: Aidp::Providers::Anthropic
      Pattern: double
      Code: provider_class = class_double("Aidp::Providers::Anthropic")

--------------------------------------------------------------------------------
File: spec/aidp/cli/providers_info_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (23):
    Line 41: Mocking internal AIDP class: Aidp::Harness::ProviderInfo
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::ProviderInfo).to receive(:new).with(provider_name, Dir.pwd).and_return(provider_info_double)

    Line 49: Mocking internal AIDP class: Aidp::CLI
      Pattern: allow().to receive
      Code: allow(Aidp::CLI).to receive(:display_message)

    Line 57: Mocking internal AIDP class: Aidp::CLI
      Pattern: allow().to receive
      Code: allow(Aidp::CLI).to receive(:display_message)

    Line 64: Mocking internal AIDP class: Aidp::CLI
      Pattern: expect().to receive
      Code: expect(Aidp::CLI).to receive(:display_message).with("Provider Information: #{provider_name}", type: :highlight)

    Line 65: Mocking internal AIDP class: Aidp::CLI
      Pattern: expect().to receive
      Code: expect(Aidp::CLI).to receive(:display_message).with("Last Checked: 2025-10-22T10:00:00-07:00", type: :info)

    Line 66: Mocking internal AIDP class: Aidp::CLI
      Pattern: expect().to receive
      Code: expect(Aidp::CLI).to receive(:display_message).with("CLI Available: Yes", type: :success)

    Line 68: Mocking internal AIDP class: Aidp::CLI
      Pattern: allow().to receive
      Code: allow(Aidp::CLI).to receive(:display_message)

    Line 77: Mocking internal AIDP class: Aidp::CLI
      Pattern: expect().to receive
      Code: expect(Aidp::CLI).to receive(:run_providers_models_catalog)

    Line 87: Mocking internal AIDP class: Aidp::Harness::ProviderInfo
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::ProviderInfo).to receive(:new).and_return(provider_info_double)

    Line 93: Mocking internal AIDP class: Aidp::CLI
      Pattern: expect().to receive
      Code: expect(Aidp::CLI).to receive(:display_message).with("Provider Information: #{provider_name}", type: :highlight)

    Line 94: Mocking internal AIDP class: Aidp::CLI
      Pattern: expect().to receive
      Code: expect(Aidp::CLI).to receive(:display_message).with("No information available for provider: #{provider_name}", type: :error)

    Line 96: Mocking internal AIDP class: Aidp::CLI
      Pattern: allow().to receive
      Code: allow(Aidp::CLI).to receive(:display_message)

    Line 124: Mocking internal AIDP class: Aidp::Harness::CapabilityRegistry
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::CapabilityRegistry).to receive(:new).and_return(registry_double)

    Line 131: Mocking internal AIDP class: Aidp::CLI
      Pattern: expect().to receive
      Code: expect(Aidp::CLI).to receive(:display_message).with("Models Catalog - Thinking Depth Tiers", type: :highlight)

    Line 132: Mocking internal AIDP class: Aidp::CLI
      Pattern: expect().to receive
      Code: expect(Aidp::CLI).to receive(:display_message).with(/Provider.*Model.*Tier/, type: :info)

    Line 134: Mocking internal AIDP class: Aidp::CLI
      Pattern: allow().to receive
      Code: allow(Aidp::CLI).to receive(:display_message)

    Line 142: Mocking internal AIDP class: Aidp::CLI
      Pattern: allow().to receive
      Code: allow(Aidp::CLI).to receive(:display_message) do |msg, **_opts|

    Line 160: Mocking internal AIDP class: Aidp::Harness::CapabilityRegistry
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::CapabilityRegistry).to receive(:new).and_return(registry_double)

    Line 166: Mocking internal AIDP class: Aidp::CLI
      Pattern: expect().to receive
      Code: expect(Aidp::CLI).to receive(:display_message).with("No models found in catalog", type: :info)

    Line 167: Mocking internal AIDP class: Aidp::CLI
      Pattern: allow().to receive
      Code: allow(Aidp::CLI).to receive(:display_message)

    Line 177: Mocking internal AIDP class: Aidp::Harness::CapabilityRegistry
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::CapabilityRegistry).to receive(:new).and_return(registry_double)

    Line 182: Mocking internal AIDP class: Aidp::CLI
      Pattern: expect().to receive
      Code: expect(Aidp::CLI).to receive(:display_message).with(/No models catalog found/, type: :error)

    Line 183: Mocking internal AIDP class: Aidp::CLI
      Pattern: allow().to receive
      Code: allow(Aidp::CLI).to receive(:display_message)

--------------------------------------------------------------------------------
File: spec/aidp/cli/terminal_io_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (2):
    Line 14: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(io.instance_variable_get(:@input)).to respond_to(:gets)

    Line 15: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(io.instance_variable_get(:@output)).to respond_to(:write)

--------------------------------------------------------------------------------
File: spec/aidp/cli_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (200):
    Line 25: Mocking internal AIDP class: Aidp::Harness::UI::EnhancedTUI
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::UI::EnhancedTUI).to receive(:new).and_return(mock_tui)

    Line 26: Mocking internal AIDP class: Aidp::Harness::UI::EnhancedWorkflowSelector
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::UI::EnhancedWorkflowSelector).to receive(:new).and_return(mock_workflow_selector)

    Line 27: Mocking internal AIDP class: Aidp::Harness::EnhancedRunner
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::EnhancedRunner).to receive(:new).and_return(mock_harness_runner)

    Line 111: Mocking internal AIDP class: Aidp::Harness::Runner
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::Runner).to receive(:new).and_return(mock_harness_runner)

    Line 155: Mocking internal AIDP class: Aidp::Harness::Runner
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::Runner).to receive(:new).and_return(mock_harness_runner)

    Line 156: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: allow(mock_harness_runner).to receive(:instance_variable_get).with(:@state_manager).and_return(mock_state_manager)

    Line 194: Mocking internal AIDP class: Aidp::CLI
      Pattern: allow().to receive
      Code: allow(Aidp::CLI).to receive(:create_prompt).and_return(test_prompt)

    Line 195: Mocking internal AIDP class: Aidp::Setup::Wizard
      Pattern: expect().to receive
      Code: expect(Aidp::Setup::Wizard).to receive(:new)

    Line 232: Mocking internal AIDP class: Aidp::CLI::FirstRunWizard
      Pattern: allow().to receive
      Code: allow(Aidp::CLI::FirstRunWizard).to receive(:ensure_config).and_return(true)

    Line 233: Mocking internal AIDP class: Aidp::Harness::UI::EnhancedTUI
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::UI::EnhancedTUI).to receive(:new).and_return(double("TUI",

    Line 237: Mocking internal AIDP class: Aidp::Harness::UI::EnhancedWorkflowSelector
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::UI::EnhancedWorkflowSelector).to receive(:new).and_return(double("Selector",

    Line 246: Mocking internal AIDP class: Aidp::CLI::FirstRunWizard
      Pattern: allow().to receive
      Code: allow(Aidp::CLI::FirstRunWizard).to receive(:ensure_config).and_return(false)

    Line 257: Mocking internal AIDP class: Aidp::CLI::FirstRunWizard
      Pattern: allow().to receive
      Code: allow(Aidp::CLI::FirstRunWizard).to receive(:setup_config).and_return(true)

    Line 258: Mocking internal AIDP class: Aidp::CLI::FirstRunWizard
      Pattern: allow().to receive
      Code: allow(Aidp::CLI::FirstRunWizard).to receive(:ensure_config).and_return(true)

    Line 270: Mocking internal AIDP class: Aidp::CLI::FirstRunWizard
      Pattern: expect().to receive
      Code: expect(Aidp::CLI::FirstRunWizard).to receive(:setup_config)

    Line 276: Mocking internal AIDP class: Aidp::CLI::FirstRunWizard
      Pattern: allow().to receive
      Code: allow(Aidp::CLI::FirstRunWizard).to receive(:setup_config).and_return(false)

    Line 285: Mocking internal AIDP class: Aidp::CLI::FirstRunWizard
      Pattern: allow().to receive
      Code: allow(Aidp::CLI::FirstRunWizard).to receive(:ensure_config).and_return(true)

    Line 291: Mocking internal AIDP class: Aidp::Harness::UI::EnhancedTUI
      Pattern: expect().to receive
      Code: expect(Aidp::Harness::UI::EnhancedTUI).to receive(:new).and_return(mock_tui)

    Line 292: Mocking internal AIDP class: Aidp::Harness::UI::EnhancedWorkflowSelector
      Pattern: expect().to receive
      Code: expect(Aidp::Harness::UI::EnhancedWorkflowSelector).to receive(:new).and_return(mock_workflow_selector)

    Line 328: Mocking internal AIDP class: Aidp::Harness::EnhancedRunner
      Pattern: expect().to receive
      Code: expect(Aidp::Harness::EnhancedRunner).to receive(:new).with(

    Line 367: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:log_rescue)

    Line 377: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:log_rescue)

    Line 400: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:display_message) do |msg, type:|

    Line 414: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:log_rescue) # avoid dependency on mixin

    Line 416: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:display_message) do |msg, type:|

    Line 586: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:log_rescue)

    Line 615: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:log_rescue)

    Line 625: Mocking the class under test (described_class)
      Pattern: expect().to receive
      Code: expect(described_class).to receive(:run_status_command)

    Line 630: Mocking the class under test (described_class)
      Pattern: expect().to receive
      Code: expect(described_class).to receive(:run_jobs_command).with(["list"])

    Line 635: Mocking the class under test (described_class)
      Pattern: expect().to receive
      Code: expect(described_class).to receive(:run_kb_command).with(["show", "topic"])

    Line 640: Mocking the class under test (described_class)
      Pattern: expect().to receive
      Code: expect(described_class).to receive(:run_harness_command).with(["status"])

    Line 645: Mocking the class under test (described_class)
      Pattern: expect().to receive
      Code: expect(described_class).to receive(:run_providers_command).with(["info", "claude"])

    Line 650: Mocking the class under test (described_class)
      Pattern: expect().to receive
      Code: expect(described_class).to receive(:run_checkpoint_command).with(["summary"])

    Line 655: Mocking the class under test (described_class)
      Pattern: expect().to receive
      Code: expect(described_class).to receive(:run_mcp_command).with(["dashboard"])

    Line 660: Mocking the class under test (described_class)
      Pattern: expect().to receive
      Code: expect(described_class).to receive(:run_issue_command).with(["import", "123"])

    Line 665: Mocking the class under test (described_class)
      Pattern: expect().to receive
      Code: expect(described_class).to receive(:run_config_command).with(["--interactive"])

    Line 670: Mocking the class under test (described_class)
      Pattern: expect().to receive
      Code: expect(described_class).to receive(:run_init_command).with(["--dry-run"])

    Line 675: Mocking the class under test (described_class)
      Pattern: expect().to receive
      Code: expect(described_class).to receive(:run_watch_command).with(["https://example.com/issues"])

    Line 680: Mocking the class under test (described_class)
      Pattern: expect().to receive
      Code: expect(described_class).to receive(:run_ws_command).with(["list"])

    Line 685: Mocking the class under test (described_class)
      Pattern: expect().to receive
      Code: expect(described_class).to receive(:run_work_command).with(["--workstream", "slug"])

    Line 690: Mocking the class under test (described_class)
      Pattern: expect().to receive
      Code: expect(described_class).to receive(:run_skill_command).with(["list"])

    Line 695: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:run_status_command)

    Line 701: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:display_message)

    Line 717: Mocking internal AIDP class: Aidp::Execute::Checkpoint
      Pattern: allow().to receive
      Code: allow(Aidp::Execute::Checkpoint).to receive(:new).and_return(checkpoint)

    Line 718: Mocking internal AIDP class: Aidp::Execute::CheckpointDisplay
      Pattern: allow().to receive
      Code: allow(Aidp::Execute::CheckpointDisplay).to receive(:new).and_return(display)

    Line 719: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:display_message)

    Line 765: Mocking internal AIDP class: Aidp::Harness::ConfigManager
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::ConfigManager).to receive(:new).and_return(config_manager)

    Line 766: Mocking internal AIDP class: Aidp::Harness::ProviderManager
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::ProviderManager).to receive(:new).and_return(provider_manager)

    Line 768: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:display_message)

    Line 783: Mocking the class under test (described_class)
      Pattern: expect().to receive
      Code: expect(described_class).to receive(:run_providers_info_command).with(["claude"])

    Line 788: Mocking the class under test (described_class)
      Pattern: expect().to receive
      Code: expect(described_class).to receive(:run_providers_refresh_command).with([])

    Line 829: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:display_message)

    Line 837: Mocking internal AIDP class: Aidp::Harness::ProviderInfo
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::ProviderInfo).to receive(:new).with("claude", Dir.pwd).and_return(info_double)

    Line 847: Mocking internal AIDP class: Aidp::Harness::ConfigManager
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::ConfigManager).to receive(:new).and_return(config_manager)

    Line 853: Mocking internal AIDP class: Aidp::Harness::ProviderInfo
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::ProviderInfo).to receive(:new).with("claude", Dir.pwd).and_return(info_double1)

    Line 854: Mocking internal AIDP class: Aidp::Harness::ProviderInfo
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::ProviderInfo).to receive(:new).with("cursor", Dir.pwd).and_return(info_double2)

    Line 868: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:display_message)

    Line 879: Mocking internal AIDP class: Aidp::Harness::ProviderInfo
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::ProviderInfo).to receive(:new).and_return(info_double)

    Line 893: Mocking internal AIDP class: Aidp::Harness::ProviderInfo
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::ProviderInfo).to receive(:new).and_return(info_double)

    Line 907: Mocking internal AIDP class: Aidp::Harness::ProviderInfo
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::ProviderInfo).to receive(:new).and_return(info_double)

    Line 932: Mocking internal AIDP class: Aidp::Harness::ProviderInfo
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::ProviderInfo).to receive(:new).and_return(info_double)

    Line 946: Mocking internal AIDP class: Aidp::CLI::JobsCommand
      Pattern: allow().to receive
      Code: allow(Aidp::CLI::JobsCommand).to receive(:new).and_return(jobs_cmd)

    Line 963: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:display_message)

    Line 1006: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:display_message) # suppress output collection unless needed

    Line 1029: Mocking internal AIDP class: Aidp::Jobs::BackgroundRunner
      Pattern: allow().to receive
      Code: allow(Aidp::Jobs::BackgroundRunner).to receive(:new).and_return(bg_runner)

    Line 1033: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: allow(bg_runner).to receive(:instance_variable_get).with(:@jobs_dir).and_return(jobs_dir)

    Line 1047: Mocking internal AIDP class: Aidp::Concurrency::Wait
      Pattern: allow().to receive
      Code: allow(Aidp::Concurrency::Wait).to receive(:for_file)

    Line 1056: Mocking internal AIDP class: Aidp::Concurrency::Wait
      Pattern: allow().to receive
      Code: allow(Aidp::Concurrency::Wait).to receive(:for_file).with(log_file, timeout: 10, interval: 0.2)

    Line 1064: Mocking internal AIDP class: Aidp::Concurrency::Wait
      Pattern: allow().to receive
      Code: allow(Aidp::Concurrency::Wait).to receive(:for_file).and_raise(Aidp::Concurrency::TimeoutError.new("timeout"))

    Line 1066: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:display_message) do |msg, type:|

    Line 1078: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:display_message) do |msg, type:|

    Line 1089: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:display_message) do |msg, type:|

    Line 1099: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:display_message) # generic stub; specific examples capture separately when needed

    Line 1104: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:display_message) do |msg, type:|

    Line 1112: Mocking internal AIDP class: Aidp::Worktree
      Pattern: allow().to receive
      Code: allow(Aidp::Worktree).to receive(:info).and_return(nil)

    Line 1114: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:display_message) do |msg, type:|

    Line 1126: Mocking internal AIDP class: Aidp::Worktree
      Pattern: allow().to receive
      Code: allow(Aidp::Worktree).to receive(:info).and_return(ws_info)

    Line 1127: Mocking internal AIDP class: Aidp::Jobs::BackgroundRunner
      Pattern: allow().to receive
      Code: allow(Aidp::Jobs::BackgroundRunner).to receive(:new).and_return(bg_runner)

    Line 1150: Mocking internal AIDP class: Aidp::Worktree
      Pattern: allow().to receive
      Code: allow(Aidp::Worktree).to receive(:info).and_return(ws_info)

    Line 1151: Mocking internal AIDP class: Aidp::Harness::StateManager
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::StateManager).to receive(:new).and_return(state_manager)

    Line 1152: Mocking internal AIDP class: Aidp::Harness::UI::EnhancedTUI
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::UI::EnhancedTUI).to receive(:new).and_return(tui)

    Line 1153: Mocking internal AIDP class: Aidp::Harness::UI::EnhancedWorkflowSelector
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::UI::EnhancedWorkflowSelector).to receive(:new).and_return(selector)

    Line 1160: Mocking internal AIDP class: Aidp::Harness::EnhancedRunner
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::EnhancedRunner).to receive(:new).and_return(runner)

    Line 1185: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:display_message) do |msg, type:|

    Line 1195: Mocking internal AIDP class: Aidp::Worktree
      Pattern: allow().to receive
      Code: allow(Aidp::Worktree).to receive(:info).and_return({slug: "ws-x", path: "/tmp/ws-x", branch: "ws-x", created_at: Time.now.iso8601, active: true})

    Line 1197: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:display_message) do |msg, type:|

    Line 1207: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:display_message) # general stub; per test may override

    Line 1213: Mocking internal AIDP class: Aidp::Skills::Registry
      Pattern: allow().to receive
      Code: allow(Aidp::Skills::Registry).to receive(:new).and_return(registry)

    Line 1218: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:display_message)

    Line 1262: Mocking internal AIDP class: Aidp::Skills::Registry
      Pattern: allow().to receive
      Code: allow(Aidp::Skills::Registry).to receive(:new).and_return(registry)

    Line 1265: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:display_message)

    Line 1283: Mocking internal AIDP class: Aidp::Skills::Registry
      Pattern: allow().to receive
      Code: allow(Aidp::Skills::Registry).to receive(:new).and_return(registry)

    Line 1285: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:display_message)

    Line 1309: Mocking internal AIDP class: Aidp::Skills::Registry
      Pattern: allow().to receive
      Code: allow(Aidp::Skills::Registry).to receive(:new).and_return(registry)

    Line 1313: Mocking internal AIDP class: Aidp::Skills::Wizard::Builder
      Pattern: allow().to receive
      Code: allow(Aidp::Skills::Wizard::Builder).to receive(:new).and_return(builder)

    Line 1314: Mocking internal AIDP class: Aidp::Skills::Wizard::TemplateLibrary
      Pattern: allow().to receive
      Code: allow(Aidp::Skills::Wizard::TemplateLibrary).to receive(:new).and_return(template_library)

    Line 1315: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:display_message)

    Line 1347: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:display_message)

    Line 1348: Mocking internal AIDP class: Aidp::Skills::Registry
      Pattern: allow().to receive
      Code: allow(Aidp::Skills::Registry).to receive(:new).and_return(registry)

    Line 1363: Mocking internal AIDP class: Aidp::Skills::Registry
      Pattern: allow().to receive
      Code: allow(Aidp::Skills::Registry).to receive(:new).and_return(registry)

    Line 1367: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:display_message)

    Line 1369: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:create_prompt).and_return(TestPrompt.new(responses: {yes?: true}))

    Line 1387: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:display_message)

    Line 1389: Mocking internal AIDP class: Aidp::Skills::Wizard::Controller
      Pattern: allow().to receive
      Code: allow(Aidp::Skills::Wizard::Controller).to receive(:new).and_return(controller)

    Line 1407: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:display_message)

    Line 1408: Mocking internal AIDP class: Aidp::Skills::Registry
      Pattern: allow().to receive
      Code: allow(Aidp::Skills::Registry).to receive(:new).and_return(registry)

    Line 1412: Mocking internal AIDP class: Aidp::Skills::Wizard::TemplateLibrary
      Pattern: allow().to receive
      Code: allow(Aidp::Skills::Wizard::TemplateLibrary).to receive(:new).and_return(template_library)

    Line 1413: Mocking internal AIDP class: Aidp::Skills::Wizard::Differ
      Pattern: allow().to receive
      Code: allow(Aidp::Skills::Wizard::Differ).to receive(:new).and_return(differ)

    Line 1463: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:display_message)

    Line 1464: Mocking internal AIDP class: Aidp::Skills::Registry
      Pattern: allow().to receive
      Code: allow(Aidp::Skills::Registry).to receive(:new).and_return(registry)

    Line 1467: Mocking internal AIDP class: Aidp::Skills::Wizard::Controller
      Pattern: allow().to receive
      Code: allow(Aidp::Skills::Wizard::Controller).to receive(:new).and_return(controller)

    Line 1518: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:display_message)

    Line 1524: Mocking internal AIDP class: Aidp::Skills::Loader
      Pattern: allow().to receive
      Code: allow(Aidp::Skills::Loader).to receive(:load_from_file).with(skill_path)

    Line 1533: Mocking internal AIDP class: Aidp::Skills::Loader
      Pattern: allow().to receive
      Code: allow(Aidp::Skills::Loader).to receive(:load_from_file).with(skill_path).and_raise(Aidp::Errors::ValidationError.new("Invalid format"))

    Line 1545: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:display_message)

    Line 1547: Mocking internal AIDP class: Aidp::Skills::Wizard::Controller
      Pattern: allow().to receive
      Code: allow(Aidp::Skills::Wizard::Controller).to receive(:new).and_return(controller)

    Line 1600: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:display_message)

    Line 1612: Mocking internal AIDP class: Aidp::CLI
      Pattern: allow().to receive
      Code: allow(Aidp::CLI).to receive(:create_prompt).and_return(prompt_instance)

    Line 1613: Mocking internal AIDP class: Aidp::Init::Runner
      Pattern: allow().to receive
      Code: allow(Aidp::Init::Runner).to receive(:new).and_return(runner)

    Line 1620: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:display_message) do |msg, type:|

    Line 1630: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:display_message)

    Line 1641: Mocking internal AIDP class: Aidp::Watch::Runner
      Pattern: allow().to receive
      Code: allow(Aidp::Watch::Runner).to receive(:new).and_return(watch_runner)

    Line 1647: Mocking internal AIDP class: Aidp::Watch::Runner
      Pattern: allow().to receive
      Code: allow(Aidp::Watch::Runner).to receive(:new).and_return(watch_runner)

    Line 1653: Mocking internal AIDP class: Aidp::Watch::Runner
      Pattern: allow().to receive
      Code: allow(Aidp::Watch::Runner).to receive(:new).and_raise(ArgumentError.new("bad interval"))

    Line 1654: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:log_rescue)

    Line 1664: Mocking internal AIDP class: Aidp::Execute::Checkpoint
      Pattern: allow().to receive
      Code: allow(Aidp::Execute::Checkpoint).to receive(:new).and_return(checkpoint)

    Line 1665: Mocking internal AIDP class: Aidp::Execute::CheckpointDisplay
      Pattern: allow().to receive
      Code: allow(Aidp::Execute::CheckpointDisplay).to receive(:new).and_return(display)

    Line 1666: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:display_message)

    Line 1712: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:display_message)

    Line 1717: Mocking internal AIDP class: Aidp::Harness::ProviderInfo
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::ProviderInfo).to receive(:new).and_return(mock_provider_info)

    Line 1722: Mocking internal AIDP class: Aidp::Harness::ConfigManager
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::ConfigManager).to receive(:new).and_return(config_manager)

    Line 1732: Mocking internal AIDP class: Aidp::Harness::ConfigManager
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::ConfigManager).to receive(:new).and_return(config_manager)

    Line 1733: Mocking internal AIDP class: Aidp::Harness::ProviderManager
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::ProviderManager).to receive(:new).and_return(pm)

    Line 1736: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:display_message)

    Line 1762: Mocking internal AIDP class: Aidp::CLI::McpDashboard
      Pattern: allow().to receive
      Code: allow(Aidp::CLI::McpDashboard).to receive(:new).and_return(dashboard)

    Line 1763: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:display_message)

    Line 1793: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:display_message)

    Line 1794: Mocking internal AIDP class: Aidp::Worktree
      Pattern: allow().to receive
      Code: allow(Aidp::Worktree).to receive(:list).and_return([

    Line 1798: Mocking internal AIDP class: Aidp::WorkstreamState
      Pattern: allow().to receive
      Code: allow(Aidp::WorkstreamState).to receive(:read).and_return({status: "active"})

    Line 1799: Mocking internal AIDP class: Aidp::WorkstreamState
      Pattern: allow().to receive
      Code: allow(Aidp::WorkstreamState).to receive(:pause).and_return({})

    Line 1800: Mocking internal AIDP class: Aidp::WorkstreamState
      Pattern: allow().to receive
      Code: allow(Aidp::WorkstreamState).to receive(:resume).and_return({})

    Line 1801: Mocking internal AIDP class: Aidp::WorkstreamState
      Pattern: allow().to receive
      Code: allow(Aidp::WorkstreamState).to receive(:complete).and_return({})

    Line 1810: Mocking internal AIDP class: Aidp::WorkstreamState
      Pattern: allow().to receive
      Code: allow(Aidp::WorkstreamState).to receive(:read).and_return({status: "paused"})

    Line 1823: Mocking internal AIDP class: Aidp::WorkstreamExecutor
      Pattern: allow().to receive
      Code: allow(Aidp::WorkstreamExecutor).to receive(:new).and_return(executor)

    Line 1900: Mocking internal AIDP class: Aidp::Execute::Checkpoint
      Pattern: allow().to receive
      Code: allow(Aidp::Execute::Checkpoint).to receive(:new).and_return(checkpoint)

    Line 1901: Mocking internal AIDP class: Aidp::Execute::CheckpointDisplay
      Pattern: allow().to receive
      Code: allow(Aidp::Execute::CheckpointDisplay).to receive(:new).and_return(display)

    Line 1906: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:display_message) do |msg, type:|

    Line 1910: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:print)

    Line 1932: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:display_message)

    Line 1942: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:display_message)

    Line 1954: Mocking internal AIDP class: Aidp::IssueImporter
      Pattern: allow().to receive
      Code: allow(Aidp::IssueImporter).to receive(:new).and_return(importer)

    Line 1973: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:display_message)

    Line 1974: Mocking internal AIDP class: Aidp::CLI
      Pattern: allow().to receive
      Code: allow(Aidp::CLI).to receive(:create_prompt).and_return(test_prompt)

    Line 1989: Mocking internal AIDP class: Aidp::Setup::Wizard
      Pattern: expect().to receive
      Code: expect(Aidp::Setup::Wizard).to receive(:new).with(Dir.pwd, prompt: test_prompt, dry_run: false).and_return(wizard)

    Line 1996: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:display_message)

    Line 2002: Mocking internal AIDP class: Aidp::Worktree
      Pattern: allow().to receive
      Code: allow(Aidp::Worktree).to receive(:list).and_return([])

    Line 2019: Mocking internal AIDP class: Aidp::Worktree
      Pattern: allow().to receive
      Code: allow(Aidp::Worktree).to receive(:create).and_return(result)

    Line 2025: Mocking internal AIDP class: Aidp::Worktree
      Pattern: allow().to receive
      Code: allow(Aidp::Worktree).to receive(:create).and_raise(Aidp::Worktree::Error.new("failed"))

    Line 2031: Mocking internal AIDP class: Aidp::Worktree
      Pattern: allow().to receive
      Code: allow(Aidp::Worktree).to receive(:remove)

    Line 2033: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:create_prompt).and_return(prompt)

    Line 2039: Mocking internal AIDP class: Aidp::Worktree
      Pattern: allow().to receive
      Code: allow(Aidp::Worktree).to receive(:remove)

    Line 2051: Mocking internal AIDP class: Aidp::Worktree
      Pattern: allow().to receive
      Code: allow(Aidp::Worktree).to receive(:info).and_return(nil)

    Line 2063: Mocking internal AIDP class: Aidp::Worktree
      Pattern: allow().to receive
      Code: allow(Aidp::Worktree).to receive(:list).and_return([{slug: "ws-a", branch: "ws-a", created_at: Time.now.iso8601, active: true}])

    Line 2065: Mocking internal AIDP class: Aidp::WorkstreamExecutor
      Pattern: allow().to receive
      Code: allow(Aidp::WorkstreamExecutor).to receive(:new).and_return(executor)

    Line 2078: Mocking internal AIDP class: Aidp::Worktree
      Pattern: allow().to receive
      Code: allow(Aidp::Worktree).to receive(:info).and_return(ws_info)

    Line 2079: Mocking internal AIDP class: Aidp::WorkstreamState
      Pattern: allow().to receive
      Code: allow(Aidp::WorkstreamState).to receive(:read).and_return({status: "active", iterations: 0, elapsed: 0, events: []})

    Line 2082: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:system)

    Line 2092: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: before { allow(described_class).to receive(:display_message) }

    Line 2102: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:display_message) { |m, type:| messages << {m: m, type: type} }

    Line 2110: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:display_message) { |m, type:| messages << {m: m, type: type} }

    Line 2130: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:log_rescue)

    Line 2167: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:display_message) do |m, type:|

    Line 2202: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:display_message)

    Line 2228: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:display_message)

    Line 2278: Mocking internal AIDP class: Aidp::Harness::UI::EnhancedWorkflowSelector
      Pattern: instance_double
      Code: workflow_selector_double = instance_double("Aidp::Harness::UI::EnhancedWorkflowSelector")

    Line 2278: Mocking internal AIDP class: Aidp::Harness::UI::EnhancedWorkflowSelector
      Pattern: double
      Code: workflow_selector_double = instance_double("Aidp::Harness::UI::EnhancedWorkflowSelector")

    Line 2279: Mocking internal AIDP class: Aidp::Harness::UI::EnhancedWorkflowSelector
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::UI::EnhancedWorkflowSelector).to receive(:new).and_return(workflow_selector_double)

    Line 2283: Mocking internal AIDP class: Aidp::Harness::UI::EnhancedTUI
      Pattern: instance_double
      Code: tui_double = instance_double("Aidp::Harness::UI::EnhancedTUI")

    Line 2283: Mocking internal AIDP class: Aidp::Harness::UI::EnhancedTUI
      Pattern: double
      Code: tui_double = instance_double("Aidp::Harness::UI::EnhancedTUI")

    Line 2284: Mocking internal AIDP class: Aidp::Harness::UI::EnhancedTUI
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::UI::EnhancedTUI).to receive(:new).and_return(tui_double)

    Line 2289: Mocking internal AIDP class: Aidp::Logger
      Pattern: instance_double
      Code: mock_logger = instance_double("Aidp::Logger")

    Line 2289: Mocking internal AIDP class: Aidp::Logger
      Pattern: double
      Code: mock_logger = instance_double("Aidp::Logger")

    Line 2312: Mocking internal AIDP class: Aidp::Harness::ProviderInfo
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::ProviderInfo).to receive(:new).with(provider_name, anything).and_return(info_object)

    Line 2417: Mocking internal AIDP class: Aidp::CLI
      Pattern: allow().to receive
      Code: allow(Aidp::CLI).to receive(:subcommand?).and_return(false)

    Line 2418: Mocking internal AIDP class: Aidp::CLI
      Pattern: allow().to receive
      Code: allow(Aidp::CLI).to receive(:parse_options).and_return({})

    Line 2419: Mocking internal AIDP class: Aidp::CLI
      Pattern: allow().to receive
      Code: allow(Aidp::CLI).to receive(:create_prompt).and_return(double("Prompt"))

    Line 2421: Mocking internal AIDP class: Aidp::CLI::FirstRunWizard
      Pattern: class_double
      Code: stub_wizard = class_double("Aidp::CLI::FirstRunWizard").as_stubbed_const

    Line 2421: Mocking internal AIDP class: Aidp::CLI::FirstRunWizard
      Pattern: double
      Code: stub_wizard = class_double("Aidp::CLI::FirstRunWizard").as_stubbed_const

    Line 2428: Mocking internal AIDP class: Aidp::Harness::UI::EnhancedTUI
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::UI::EnhancedTUI).to receive(:new).and_return(tui_double)

    Line 2429: Mocking internal AIDP class: Aidp::Harness::UI::EnhancedWorkflowSelector
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::UI::EnhancedWorkflowSelector).to receive(:new).and_return(selector_double)

    Line 2431: Mocking internal AIDP class: Aidp::Harness::EnhancedRunner
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::EnhancedRunner).to receive(:new).and_return(runner_double)

    Line 2457: Mocking internal AIDP class: Aidp::Harness::ConfigManager
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::ConfigManager).to receive(:new).and_return(config_manager_double)

    Line 2478: Mocking internal AIDP class: Aidp::Harness::ProviderManager
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::ProviderManager).to receive(:new).and_return(provider_manager_double)

    Line 2489: Mocking internal AIDP class: Aidp::Harness::ProviderManager
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::ProviderManager).to receive(:new).and_return(provider_manager_double)

    Line 2492: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:log_rescue)

    Line 2797: Mocking internal AIDP class: Aidp::CLI
      Pattern: allow().to receive
      Code: allow(Aidp::CLI).to receive(:create_prompt).and_return(test_prompt)

    Line 2824: Mocking internal AIDP class: Aidp::CLI
      Pattern: allow().to receive
      Code: allow(Aidp::CLI).to receive(:create_prompt).and_return(test_prompt)

    Line 2842: Mocking internal AIDP class: Aidp::CLI
      Pattern: allow().to receive
      Code: allow(Aidp::CLI).to receive(:create_prompt).and_return(test_prompt)

    Line 2863: Mocking internal AIDP class: Aidp::CLI
      Pattern: allow().to receive
      Code: allow(Aidp::CLI).to receive(:create_prompt).and_return(test_prompt)

    Line 2888: Mocking internal AIDP class: Aidp::CLI
      Pattern: allow().to receive
      Code: allow(Aidp::CLI).to receive(:create_prompt).and_return(test_prompt_decline)


  NEEDS REVIEW (17):
    Line 286: Mocking unknown class (might be internal): Aidp
      Pattern: allow().to receive
      Code: allow(Aidp).to receive(:setup_logger)

    Line 287: Mocking unknown class (might be internal): Aidp
      Pattern: allow().to receive
      Code: allow(Aidp).to receive(:logger).and_return(double("Logger", info: nil, warn: nil, level: "info"))

    Line 560: Mocking unknown class (might be internal): Aidp
      Pattern: allow().to receive
      Code: allow(Aidp).to receive(:setup_logger)

    Line 561: Mocking unknown class (might be internal): Aidp
      Pattern: allow().to receive
      Code: allow(Aidp).to receive(:logger).and_return(double("Logger", info: nil, warn: nil, level: "info"))

    Line 571: Mocking unknown class (might be internal): Aidp
      Pattern: expect().to receive
      Code: expect(Aidp).to receive(:setup_logger).with(temp_project_dir, {level: "debug", output: "file"})

    Line 577: Mocking unknown class (might be internal): Aidp
      Pattern: expect().to receive
      Code: expect(Aidp).to receive(:setup_logger).with(temp_project_dir, {})

    Line 588: Mocking unknown class (might be internal): Aidp
      Pattern: expect().to receive
      Code: expect(Aidp).to receive(:setup_logger).once

    Line 596: Mocking unknown class (might be internal): Aidp
      Pattern: expect().to receive
      Code: expect(Aidp).to receive(:setup_logger).with(temp_project_dir, {})

    Line 603: Mocking unknown class (might be internal): Aidp
      Pattern: allow().to receive
      Code: allow(Aidp).to receive(:logger).and_return(logger)

    Line 613: Mocking unknown class (might be internal): Aidp
      Pattern: allow().to receive
      Code: allow(Aidp).to receive(:logger).and_return(logger)

    Line 819: Mocking unknown class (might be internal): Aidp.logger
      Pattern: allow().to receive
      Code: allow(Aidp.logger).to receive(:warn)

    Line 855: Mocking method call or complex expression: info_double1
      Pattern: allow().to receive
      Code: allow(info_double1).to receive(:gather_info).and_return({cli_available: true})

    Line 856: Mocking method call or complex expression: info_double2
      Pattern: allow().to receive
      Code: allow(info_double2).to receive(:gather_info).and_return({cli_available: false})

    Line 2124: Mocking unknown class (might be internal): Aidp
      Pattern: allow().to receive
      Code: allow(Aidp).to receive(:logger).and_return(logger)

    Line 2126: Mocking unknown class (might be internal): Aidp
      Pattern: allow().to receive
      Code: allow(Aidp).to receive(:setup_logger) do

    Line 2294: Mocking unknown class (might be internal): Aidp
      Pattern: allow().to receive
      Code: allow(Aidp).to receive(:setup_logger)

    Line 2295: Mocking unknown class (might be internal): Aidp
      Pattern: allow().to receive
      Code: allow(Aidp).to receive(:logger).and_return(mock_logger)

--------------------------------------------------------------------------------
File: spec/aidp/concurrency/exec_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (2):
    Line 6: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: described_class.instance_variable_set(:@pools, nil)

    Line 7: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: described_class.instance_variable_set(:@default_pool, nil)

--------------------------------------------------------------------------------
File: spec/aidp/daemon/runner_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (22):
    Line 56: Mocking internal AIDP class: Aidp::Daemon::ProcessManager
      Pattern: allow().to receive
      Code: allow(Aidp::Daemon::ProcessManager).to receive(:new).and_return(process_manager)

    Line 114: Mocking internal AIDP class: Aidp::Concurrency::Wait
      Pattern: allow().to receive
      Code: allow(Aidp::Concurrency::Wait).to receive(:until).and_return(true)

    Line 129: Mocking internal AIDP class: Aidp::Concurrency::Wait
      Pattern: allow().to receive
      Code: allow(Aidp::Concurrency::Wait).to receive(:until).and_raise(Aidp::Concurrency::TimeoutError)

    Line 164: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@running, true)

    Line 170: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(runner.instance_variable_get(:@running)).to be false

    Line 183: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@running, false)

    Line 189: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@running, true)

    Line 208: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@watch_runner, double("WatchRunner"))

    Line 215: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@running, true)

    Line 217: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(runner.instance_variable_get(:@running)).to be false

    Line 229: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@watch_runner, double("Watch"))

    Line 262: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@work_loop_runner, work_loop_runner)

    Line 263: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@ipc_server, ipc_server)

    Line 279: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@running, false)

    Line 281: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@running, true)

    Line 291: Mocking internal AIDP class: Aidp::Watch::Runner
      Pattern: allow().to receive
      Code: allow(Aidp::Watch::Runner).to receive(:new).and_return(watch_runner)

    Line 297: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@running, false)

    Line 300: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@running, false)

    Line 302: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@running, true)

    Line 312: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@running, false)

    Line 317: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@running, false)

    Line 319: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@running, true)


  NEEDS REVIEW (15):
    Line 57: Mocking unknown class (might be internal): Aidp
      Pattern: allow().to receive
      Code: allow(Aidp).to receive(:logger).and_return(logger)

    Line 111: Mocking unknown class (might be internal): Process
      Pattern: allow().to receive
      Code: allow(Process).to receive(:daemon)

    Line 113: Mocking unknown class (might be internal): Process
      Pattern: allow().to receive
      Code: allow(Process).to receive(:detach)

    Line 126: Mocking unknown class (might be internal): Process
      Pattern: allow().to receive
      Code: allow(Process).to receive(:daemon)

    Line 128: Mocking unknown class (might be internal): Process
      Pattern: allow().to receive
      Code: allow(Process).to receive(:detach)

    Line 163: Mocking unknown class (might be internal): Signal
      Pattern: allow().to receive
      Code: allow(Signal).to receive(:trap).and_return(true)

    Line 166: Mocking unknown class (might be internal): Signal
      Pattern: expect().to receive
      Code: expect(Signal).to receive(:trap).with("TERM").and_yield

    Line 167: Mocking unknown class (might be internal): Signal
      Pattern: expect().to receive
      Code: expect(Signal).to receive(:trap).with("INT").and_yield

    Line 180: Mocking unknown class (might be internal): Client
      Pattern: instance_double
      Code: client = instance_double("Client", gets: nil, close: nil)

    Line 181: Mocking unknown class (might be internal): UNIXServer
      Pattern: allow().to receive
      Code: allow(UNIXServer).to receive(:new).and_return(server)

    Line 186: Mocking unknown class (might be internal): Thread
      Pattern: allow().to receive
      Code: allow(Thread).to receive(:new).and_yield

    Line 197: Mocking unknown class (might be internal): UNIXServer
      Pattern: allow().to receive
      Code: allow(UNIXServer).to receive(:new).and_raise(StandardError, "boom")

    Line 244: Mocking unknown class (might be internal): Client
      Pattern: instance_double
      Code: client = instance_double("Client", gets: "status\n", close: nil)

    Line 260: Mocking unknown class (might be internal): WorkLoopRunner
      Pattern: instance_double
      Code: work_loop_runner = instance_double("WorkLoopRunner", cancel: nil)

    Line 261: Mocking unknown class (might be internal): UNIXServer
      Pattern: instance_double
      Code: ipc_server = instance_double("UNIXServer", close: nil)

--------------------------------------------------------------------------------
File: spec/aidp/debug_mixin_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (1):
    Line 16: Mocking internal AIDP class: Aidp::DebugMixin
      Pattern: allow().to receive
      Code: allow(Aidp::DebugMixin).to receive(:shared_logger).and_return(logger)


  NEEDS REVIEW (1):
    Line 378: Mocking unknown class (might be internal): TTY::Command
      Pattern: expect().to receive
      Code: expect(TTY::Command).to receive(:new).with(printer: :null).and_call_original

--------------------------------------------------------------------------------
File: spec/aidp/execute/async_work_loop_runner_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (14):
    Line 39: Mocking internal AIDP class: Aidp::Execute::WorkLoopRunner
      Pattern: allow().to receive
      Code: allow(Aidp::Execute::WorkLoopRunner).to receive(:new).and_return(sync_runner)

    Line 84: Mocking internal AIDP class: Aidp::Execute::WorkLoopRunner
      Pattern: allow().to receive
      Code: allow(Aidp::Execute::WorkLoopRunner).to receive(:new).and_return(sync_runner)

    Line 118: Mocking internal AIDP class: Aidp::Execute::WorkLoopRunner
      Pattern: allow().to receive
      Code: allow(Aidp::Execute::WorkLoopRunner).to receive(:new).and_return(sync_runner)

    Line 147: Mocking internal AIDP class: Aidp::Execute::WorkLoopRunner
      Pattern: allow().to receive
      Code: allow(Aidp::Execute::WorkLoopRunner).to receive(:new).and_return(sync_runner)

    Line 180: Mocking internal AIDP class: Aidp::Execute::WorkLoopRunner
      Pattern: allow().to receive
      Code: allow(Aidp::Execute::WorkLoopRunner).to receive(:new).and_return(sync_runner)

    Line 214: Mocking internal AIDP class: Aidp::Execute::WorkLoopRunner
      Pattern: allow().to receive
      Code: allow(Aidp::Execute::WorkLoopRunner).to receive(:new).and_return(sync_runner)

    Line 224: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.state.instance_variable_set(:@current_state, :cancelled)

    Line 243: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: allow(sync_runner).to receive(:instance_variable_get).with(:@checkpoint).and_return(checkpoint)

    Line 305: Mocking internal AIDP class: Aidp::Execute::WorkLoopRunner
      Pattern: allow().to receive
      Code: allow(Aidp::Execute::WorkLoopRunner).to receive(:new).and_return(sync_runner)

    Line 356: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.state.instance_variable_set(:@current_state, :unexpected)

    Line 368: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@sync_runner, sync_runner)

    Line 369: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: allow(sync_runner).to receive(:instance_variable_get).with(:@checkpoint).and_return(checkpoint)

    Line 382: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@sync_runner, sync_runner)

    Line 383: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: allow(sync_runner).to receive(:instance_variable_get).with(:@checkpoint).and_return(nil)


  NEEDS REVIEW (2):
    Line 242: Mocking unknown class (might be internal): Checkpoint
      Pattern: instance_double
      Code: checkpoint = instance_double("Checkpoint")

    Line 365: Mocking unknown class (might be internal): Checkpoint
      Pattern: instance_double
      Code: let(:checkpoint) { instance_double("Checkpoint") }

--------------------------------------------------------------------------------
File: spec/aidp/execute/interactive_repl_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (36):
    Line 34: Mocking internal AIDP class: Aidp::Execute::AsyncWorkLoopRunner
      Pattern: allow().to receive
      Code: allow(Aidp::Execute::AsyncWorkLoopRunner).to receive(:new).and_return(async_runner)

    Line 54: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: repl.instance_variable_set(:@async_runner, async_runner)

    Line 71: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: repl.instance_variable_set(:@async_runner, async_runner)

    Line 73: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: allow(repl.instance_variable_get(:@repl_macros)).to receive(:execute).with("/pause").and_return(macro_result)

    Line 80: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: repl.instance_variable_set(:@async_runner, async_runner)

    Line 82: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: allow(repl.instance_variable_get(:@repl_macros)).to receive(:execute).with("/resume").and_return(macro_result)

    Line 89: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: repl.instance_variable_set(:@async_runner, async_runner)

    Line 91: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: allow(repl.instance_variable_get(:@repl_macros)).to receive(:execute).with("/cancel").and_return(macro_result)

    Line 98: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: repl.instance_variable_set(:@async_runner, async_runner)

    Line 100: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: allow(repl.instance_variable_get(:@repl_macros)).to receive(:execute).with("/inject Do it").and_return(macro_result)

    Line 106: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: repl.instance_variable_set(:@async_runner, async_runner)

    Line 108: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: allow(repl.instance_variable_get(:@repl_macros)).to receive(:execute).with("/update guard max_tokens=1000").and_return(macro_result)

    Line 115: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: repl.instance_variable_set(:@async_runner, async_runner)

    Line 117: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: allow(repl.instance_variable_get(:@repl_macros)).to receive(:execute).with("/reload config").and_return(macro_result)

    Line 146: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: repl.instance_variable_set(:@async_runner, async_runner)

    Line 148: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: allow(repl.instance_variable_get(:@repl_macros)).to receive(:execute).and_return(macro_result)

    Line 158: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(repl.instance_variable_get(:@prompt)).to eq(prompt)

    Line 163: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(repl.instance_variable_get(:@prompt)).to eq(prompt)

    Line 168: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(repl.instance_variable_get(:@repl_macros)).to be_a(Aidp::Execute::ReplMacros)

    Line 206: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: repl.instance_variable_set(:@async_runner, async_runner)

    Line 217: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: repl.instance_variable_set(:@async_runner, async_runner)

    Line 230: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: repl.instance_variable_set(:@async_runner, async_runner)

    Line 236: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(repl.instance_variable_get(:@running)).to be false

    Line 241: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: repl.instance_variable_set(:@async_runner, async_runner)

    Line 251: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: repl.instance_variable_set(:@async_runner, async_runner)

    Line 297: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(repl.instance_variable_get(:@completion_setup_needed)).to be false

    Line 304: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: repl.instance_variable_set(:@async_runner, async_runner)

    Line 312: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: repl.instance_variable_set(:@async_runner, async_runner)

    Line 320: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: repl.instance_variable_set(:@async_runner, async_runner)

    Line 347: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: repl.instance_variable_set(:@async_runner, async_runner)

    Line 350: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: thread = repl.instance_variable_get(:@output_display_thread)

    Line 360: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: repl.instance_variable_set(:@async_runner, async_runner)

    Line 364: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: thread = repl.instance_variable_get(:@output_display_thread)

    Line 370: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: repl.instance_variable_set(:@async_runner, async_runner)

    Line 380: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: repl.instance_variable_set(:@async_runner, async_runner)

    Line 390: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: repl.instance_variable_set(:@async_runner, async_runner)


  NEEDS REVIEW (15):
    Line 36: Mocking method call or complex expression: async_runner.state
      Pattern: allow().to receive
      Code: allow(async_runner.state).to receive(:request_guard_update)

    Line 37: Mocking method call or complex expression: async_runner.state
      Pattern: allow().to receive
      Code: allow(async_runner.state).to receive(:request_config_reload)

    Line 73: Mocking method call or complex expression: repl.instance_variable_get(:@repl_macros)
      Pattern: allow().to receive
      Code: allow(repl.instance_variable_get(:@repl_macros)).to receive(:execute).with("/pause").and_return(macro_result)

    Line 82: Mocking method call or complex expression: repl.instance_variable_get(:@repl_macros)
      Pattern: allow().to receive
      Code: allow(repl.instance_variable_get(:@repl_macros)).to receive(:execute).with("/resume").and_return(macro_result)

    Line 91: Mocking method call or complex expression: repl.instance_variable_get(:@repl_macros)
      Pattern: allow().to receive
      Code: allow(repl.instance_variable_get(:@repl_macros)).to receive(:execute).with("/cancel").and_return(macro_result)

    Line 100: Mocking method call or complex expression: repl.instance_variable_get(:@repl_macros)
      Pattern: allow().to receive
      Code: allow(repl.instance_variable_get(:@repl_macros)).to receive(:execute).with("/inject Do it").and_return(macro_result)

    Line 108: Mocking method call or complex expression: repl.instance_variable_get(:@repl_macros)
      Pattern: allow().to receive
      Code: allow(repl.instance_variable_get(:@repl_macros)).to receive(:execute).with("/update guard max_tokens=1000").and_return(macro_result)

    Line 117: Mocking method call or complex expression: repl.instance_variable_get(:@repl_macros)
      Pattern: allow().to receive
      Code: allow(repl.instance_variable_get(:@repl_macros)).to receive(:execute).with("/reload config").and_return(macro_result)

    Line 148: Mocking method call or complex expression: repl.instance_variable_get(:@repl_macros)
      Pattern: allow().to receive
      Code: allow(repl.instance_variable_get(:@repl_macros)).to receive(:execute).and_return(macro_result)

    Line 208: Mocking method call or complex expression: async_runner.state
      Pattern: allow().to receive
      Code: allow(async_runner.state).to receive(:paused?).and_return(false)

    Line 219: Mocking method call or complex expression: async_runner.state
      Pattern: allow().to receive
      Code: allow(async_runner.state).to receive(:paused?).and_return(true)

    Line 272: Mocking unknown class (might be internal): Reline
      Pattern: allow().to receive
      Code: allow(Reline).to receive(:readline).and_return(nil)

    Line 280: Mocking unknown class (might be internal): Reline
      Pattern: allow().to receive
      Code: allow(Reline).to receive(:readline).and_raise(StandardError.new("Test error"))

    Line 382: Mocking method call or complex expression: async_runner.state
      Pattern: allow().to receive
      Code: allow(async_runner.state).to receive(:paused?).and_return(false)

    Line 392: Mocking method call or complex expression: async_runner.state
      Pattern: allow().to receive
      Code: allow(async_runner.state).to receive(:paused?).and_return(false)

--------------------------------------------------------------------------------
File: spec/aidp/execute/prompt_manager_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (2):
    Line 200: Mocking internal AIDP class: Aidp::PromptOptimization::Optimizer
      Pattern: allow().to receive
      Code: allow(Aidp::PromptOptimization::Optimizer).to receive(:new).and_return(mock_optimizer)

    Line 247: Mocking internal AIDP class: Aidp::PromptOptimization::Optimizer
      Pattern: allow().to receive
      Code: allow(Aidp::PromptOptimization::Optimizer).to receive(:new).and_return(failing_optimizer)

--------------------------------------------------------------------------------
File: spec/aidp/execute/repl_macros_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (7):
    Line 22: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: macros.instance_variable_set(:@current_skill, "repo-analyst")

    Line 23: Mocking internal AIDP class: Aidp::Skills::Registry
      Pattern: allow().to receive
      Code: allow(Aidp::Skills::Registry).to receive(:new).and_raise(StandardError, "boom")

    Line 112: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: macros.instance_variable_get(:@pinned_files) << "lib/example.rb"

    Line 611: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: skill_repl.instance_variable_set(:@current_skill, "nonexistent")

    Line 1868: Mocking internal AIDP class: Aidp::Worktree
      Pattern: allow().to receive
      Code: allow(Aidp::Worktree).to receive(:info).and_raise(Aidp::Worktree::Error, "boom")

    Line 1883: Mocking internal AIDP class: Aidp::WorkstreamState
      Pattern: allow().to receive
      Code: allow(Aidp::WorkstreamState).to receive(:pause).and_return({error: "cannot pause"})

    Line 1890: Mocking internal AIDP class: Aidp::WorkstreamState
      Pattern: allow().to receive
      Code: allow(Aidp::WorkstreamState).to receive(:pause).and_return({})


  NEEDS REVIEW (1):
    Line 24: Mocking unknown class (might be internal): Aidp
      Pattern: allow().to receive
      Code: allow(Aidp).to receive(:log_error)

--------------------------------------------------------------------------------
File: spec/aidp/execute/runner_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (2):
    Line 9: Mocking internal AIDP class: Aidp::Harness::Runner
      Pattern: instance_double
      Code: let(:harness_runner) { instance_double("Aidp::Harness::Runner") }

    Line 9: Mocking internal AIDP class: Aidp::Harness::Runner
      Pattern: double
      Code: let(:harness_runner) { instance_double("Aidp::Harness::Runner") }


  NEEDS REVIEW (16):
    Line 19: Mocking unknown class (might be internal): YAML
      Pattern: allow().to receive
      Code: allow(YAML).to receive(:load_file).and_return({})

    Line 97: Mocking method call or complex expression: runner.progress
      Pattern: allow().to receive
      Code: allow(runner.progress).to receive(:step_completed?).and_return(false)

    Line 104: Mocking method call or complex expression: runner.progress
      Pattern: allow().to receive
      Code: allow(runner.progress).to receive(:step_completed?).and_return(true)

    Line 111: Mocking method call or complex expression: runner.progress
      Pattern: allow().to receive
      Code: allow(runner.progress).to receive(:step_completed?).and_return(true)

    Line 117: Mocking method call or complex expression: runner.progress
      Pattern: allow().to receive
      Code: allow(runner.progress).to receive(:step_completed?).with("00_PRD").and_return(true)

    Line 123: Mocking method call or complex expression: runner.progress
      Pattern: allow().to receive
      Code: allow(runner.progress).to receive(:mark_step_completed).with("00_PRD")

    Line 131: Mocking method call or complex expression: runner.progress
      Pattern: allow().to receive
      Code: allow(runner.progress).to receive(:mark_step_in_progress).with("00_PRD")

    Line 177: Mocking method call or complex expression: runner.progress
      Pattern: allow().to receive
      Code: allow(runner.progress).to receive(:completed_steps).and_return(["00_LLM_STYLE_GUIDE"])

    Line 178: Mocking method call or complex expression: runner.progress
      Pattern: allow().to receive
      Code: allow(runner.progress).to receive(:current_step).and_return("00_PRD")

    Line 179: Mocking method call or complex expression: runner.progress
      Pattern: allow().to receive
      Code: allow(runner.progress).to receive(:started_at).and_return(Time.now - 3600)

    Line 180: Mocking method call or complex expression: runner.progress
      Pattern: allow().to receive
      Code: allow(runner.progress).to receive(:step_completed?).and_return(false)

    Line 181: Mocking method call or complex expression: runner.progress
      Pattern: allow().to receive
      Code: allow(runner.progress).to receive(:step_completed?).with("00_LLM_STYLE_GUIDE").and_return(true)

    Line 208: Mocking method call or complex expression: runner.progress
      Pattern: allow().to receive
      Code: allow(runner.progress).to receive(:completed_steps).and_return(["00_PRD", "01_NFRS"])

    Line 217: Mocking method call or complex expression: runner.progress
      Pattern: allow().to receive
      Code: allow(runner.progress).to receive(:step_completed?).and_return(true)

    Line 234: Mocking unknown class (might be internal): ProviderManager
      Pattern: instance_double
      Code: allow(harness_runner).to receive(:provider_manager).and_return(instance_double("ProviderManager"))

    Line 242: Mocking unknown class (might be internal): ProviderManager
      Pattern: instance_double
      Code: provider_manager = instance_double("ProviderManager")

--------------------------------------------------------------------------------
File: spec/aidp/execute/work_loop_header_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (3):
    Line 44: Mocking internal AIDP class: Aidp::Harness::CapabilityRegistry
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::CapabilityRegistry).to receive(:new).and_return(mock_registry)

    Line 61: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@step_name, "16_IMPLEMENTATION")

    Line 62: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@iteration_count, 3)


  NEEDS REVIEW (1):
    Line 25: Mocking unknown class (might be internal): CapabilityRegistry
      Pattern: instance_double
      Code: instance_double("CapabilityRegistry",

--------------------------------------------------------------------------------
File: spec/aidp/execute/work_loop_runner_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (51):
    Line 70: Mocking internal AIDP class: Aidp::Logger
      Pattern: instance_double
      Code: mock_logger = instance_double("Aidp::Logger")

    Line 70: Mocking internal AIDP class: Aidp::Logger
      Pattern: double
      Code: mock_logger = instance_double("Aidp::Logger")

    Line 87: Mocking internal AIDP class: Aidp::Harness::CapabilityRegistry
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::CapabilityRegistry).to receive(:new).and_return(mock_registry)

    Line 133: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: state_history = runner.instance_variable_get(:@state_history)

    Line 142: Mocking internal AIDP class: Aidp::Harness::TestRunner
      Pattern: instance_double
      Code: let(:test_runner) { instance_double("Aidp::Harness::TestRunner") }

    Line 142: Mocking internal AIDP class: Aidp::Harness::TestRunner
      Pattern: double
      Code: let(:test_runner) { instance_double("Aidp::Harness::TestRunner") }

    Line 150: Mocking internal AIDP class: Aidp::Execute::PromptManager
      Pattern: allow().to receive
      Code: allow(Aidp::Execute::PromptManager).to receive(:new).and_return(prompt_manager)

    Line 151: Mocking internal AIDP class: Aidp::Harness::TestRunner
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::TestRunner).to receive(:new).and_return(test_runner)

    Line 152: Mocking internal AIDP class: Aidp::Execute::Checkpoint
      Pattern: allow().to receive
      Code: allow(Aidp::Execute::Checkpoint).to receive(:new).and_return(checkpoint)

    Line 153: Mocking internal AIDP class: Aidp::Execute::CheckpointDisplay
      Pattern: allow().to receive
      Code: allow(Aidp::Execute::CheckpointDisplay).to receive(:new).and_return(checkpoint_display)

    Line 154: Mocking internal AIDP class: Aidp::Execute::GuardPolicy
      Pattern: allow().to receive
      Code: allow(Aidp::Execute::GuardPolicy).to receive(:new).and_return(guard_policy)

    Line 155: Mocking internal AIDP class: Aidp::Execute::DeterministicUnits::Runner
      Pattern: allow().to receive
      Code: allow(Aidp::Execute::DeterministicUnits::Runner).to receive(:new).and_return(deterministic_runner)

    Line 156: Mocking internal AIDP class: Aidp::Execute::WorkLoopUnitScheduler
      Pattern: allow().to receive
      Code: allow(Aidp::Execute::WorkLoopUnitScheduler).to receive(:new).and_return(unit_scheduler)

    Line 236: Mocking internal AIDP class: Aidp::Logger
      Pattern: instance_double
      Code: mock_logger = instance_double("Aidp::Logger")

    Line 236: Mocking internal AIDP class: Aidp::Logger
      Pattern: double
      Code: mock_logger = instance_double("Aidp::Logger")

    Line 456: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: state_history = runner.instance_variable_get(:@state_history)

    Line 524: Mocking internal AIDP class: Aidp::Harness::TestRunner
      Pattern: instance_double
      Code: let(:test_runner) { instance_double("Aidp::Harness::TestRunner") }

    Line 524: Mocking internal AIDP class: Aidp::Harness::TestRunner
      Pattern: double
      Code: let(:test_runner) { instance_double("Aidp::Harness::TestRunner") }

    Line 529: Mocking internal AIDP class: Aidp::Execute::PromptManager
      Pattern: allow().to receive
      Code: allow(Aidp::Execute::PromptManager).to receive(:new).and_return(prompt_manager)

    Line 530: Mocking internal AIDP class: Aidp::Harness::TestRunner
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::TestRunner).to receive(:new).and_return(test_runner)

    Line 531: Mocking internal AIDP class: Aidp::Execute::Checkpoint
      Pattern: allow().to receive
      Code: allow(Aidp::Execute::Checkpoint).to receive(:new).and_return(checkpoint)

    Line 532: Mocking internal AIDP class: Aidp::Execute::CheckpointDisplay
      Pattern: allow().to receive
      Code: allow(Aidp::Execute::CheckpointDisplay).to receive(:new).and_return(checkpoint_display)

    Line 641: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: state_history = runner.instance_variable_get(:@state_history)

    Line 687: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: state_history = runner.instance_variable_get(:@state_history)

    Line 696: Mocking internal AIDP class: Aidp::Harness::TestRunner
      Pattern: instance_double
      Code: let(:test_runner) { instance_double("Aidp::Harness::TestRunner") }

    Line 696: Mocking internal AIDP class: Aidp::Harness::TestRunner
      Pattern: double
      Code: let(:test_runner) { instance_double("Aidp::Harness::TestRunner") }

    Line 699: Mocking internal AIDP class: Aidp::Harness::TestRunner
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::TestRunner).to receive(:new).and_return(test_runner)

    Line 758: Mocking internal AIDP class: Aidp::Execute::PromptManager
      Pattern: allow().to receive
      Code: allow(Aidp::Execute::PromptManager).to receive(:new).and_return(prompt_manager)

    Line 760: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@iteration_count, 1)

    Line 839: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@iteration_count, 3)

    Line 840: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@state_history, [

    Line 862: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@iteration_count, 1)

    Line 867: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@iteration_count, 3)

    Line 872: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@iteration_count, 5)

    Line 877: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@iteration_count, 10)

    Line 882: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@iteration_count, 15)

    Line 889: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@iteration_count, 5)

    Line 890: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@step_name, "test_step")

    Line 936: Mocking internal AIDP class: Aidp::Execute::PromptManager
      Pattern: allow().to receive
      Code: allow(Aidp::Execute::PromptManager).to receive(:new).and_return(prompt_manager)

    Line 938: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@iteration_count, 5)

    Line 960: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@iteration_count, 3)

    Line 990: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: prompt_manager = runner_instance.instance_variable_get(:@prompt_manager)

    Line 1020: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@guard_policy, guard_policy)

    Line 1021: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@persistent_tasklist, tasklist)

    Line 1065: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@step_name, "Implement feature")

    Line 1066: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@iteration_count, 2)

    Line 1067: Mocking internal AIDP class: Aidp::Execute::AgentSignalParser
      Pattern: allow().to receive
      Code: allow(Aidp::Execute::AgentSignalParser).to receive(:parse_task_filing).and_return([

    Line 1108: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@options, {automated: true})

    Line 1114: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@options, {})

    Line 1124: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: let(:test_runner) { runner.instance_variable_get(:@test_runner) }

    Line 1125: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: let(:prompt_manager) { runner.instance_variable_get(:@prompt_manager) }


  NEEDS REVIEW (18):
    Line 9: Mocking unknown class (might be internal): ProviderManager
      Pattern: instance_double
      Code: instance_double("ProviderManager", current_provider: "anthropic")

    Line 49: Mocking unknown class (might be internal): CapabilityRegistry
      Pattern: instance_double
      Code: instance_double("CapabilityRegistry",

    Line 75: Mocking unknown class (might be internal): Aidp
      Pattern: allow().to receive
      Code: allow(Aidp).to receive(:logger).and_return(mock_logger)

    Line 141: Mocking unknown class (might be internal): PromptManager
      Pattern: instance_double
      Code: let(:prompt_manager) { instance_double("PromptManager") }

    Line 143: Mocking unknown class (might be internal): Checkpoint
      Pattern: instance_double
      Code: let(:checkpoint) { instance_double("Checkpoint") }

    Line 144: Mocking unknown class (might be internal): CheckpointDisplay
      Pattern: instance_double
      Code: let(:checkpoint_display) { instance_double("CheckpointDisplay") }

    Line 145: Mocking unknown class (might be internal): GuardPolicy
      Pattern: instance_double
      Code: let(:guard_policy) { instance_double("GuardPolicy") }

    Line 146: Mocking unknown class (might be internal): DeterministicUnits::Runner
      Pattern: instance_double
      Code: let(:deterministic_runner) { instance_double("DeterministicUnits::Runner") }

    Line 146: Mocking unknown class (might be internal): DeterministicUnits::Runner
      Pattern: double
      Code: let(:deterministic_runner) { instance_double("DeterministicUnits::Runner") }

    Line 147: Mocking unknown class (might be internal): WorkLoopUnitScheduler
      Pattern: instance_double
      Code: let(:unit_scheduler) { instance_double("WorkLoopUnitScheduler") }

    Line 237: Mocking unknown class (might be internal): Aidp
      Pattern: allow().to receive
      Code: allow(Aidp).to receive(:logger).and_return(mock_logger)

    Line 523: Mocking unknown class (might be internal): PromptManager
      Pattern: instance_double
      Code: let(:prompt_manager) { instance_double("PromptManager") }

    Line 525: Mocking unknown class (might be internal): Checkpoint
      Pattern: instance_double
      Code: let(:checkpoint) { instance_double("Checkpoint") }

    Line 526: Mocking unknown class (might be internal): CheckpointDisplay
      Pattern: instance_double
      Code: let(:checkpoint_display) { instance_double("CheckpointDisplay") }

    Line 755: Mocking unknown class (might be internal): PromptManager
      Pattern: instance_double
      Code: let(:prompt_manager) { instance_double("PromptManager") }

    Line 933: Mocking unknown class (might be internal): PromptManager
      Pattern: instance_double
      Code: let(:prompt_manager) { instance_double("PromptManager") }

    Line 1015: Mocking unknown class (might be internal): PersistentTasklist
      Pattern: instance_double
      Code: let(:tasklist) { instance_double("PersistentTasklist", pending: pending_tasks, create: created_task) }

    Line 1025: Mocking unknown class (might be internal): Aidp
      Pattern: allow().to receive
      Code: allow(Aidp).to receive(:log_info)

--------------------------------------------------------------------------------
File: spec/aidp/execute/workflow_selector_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (5):
    Line 12: Mocking internal AIDP class: Aidp::Workflows::Selector
      Pattern: allow().to receive
      Code: allow(Aidp::Workflows::Selector).to receive(:new).and_return(workflow_selector)

    Line 17: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(selector.instance_variable_get(:@user_input)).to eq({})

    Line 21: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(selector.instance_variable_get(:@prompt)).to eq(prompt)

    Line 25: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(selector.instance_variable_get(:@workflow_selector)).to eq(workflow_selector)

    Line 193: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: user_input = selector.instance_variable_get(:@user_input)

--------------------------------------------------------------------------------
File: spec/aidp/harness/ai_decision_engine_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (1):
    Line 22: Mocking internal AIDP class: Aidp::Harness::ThinkingDepthManager
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::ThinkingDepthManager).to receive(:new)


  NEEDS REVIEW (5):
    Line 31: Mocking unknown class (might be internal): Aidp
      Pattern: allow().to receive
      Code: allow(Aidp).to receive(:log_debug)

    Line 32: Mocking unknown class (might be internal): Aidp
      Pattern: allow().to receive
      Code: allow(Aidp).to receive(:log_error)

    Line 103: Mocking unknown class (might be internal): Aidp
      Pattern: expect().to receive
      Code: expect(Aidp).to receive(:log_debug).with(

    Line 213: Mocking unknown class (might be internal): Aidp
      Pattern: expect().to receive
      Code: expect(Aidp).to receive(:log_debug).with(

    Line 317: Mocking unknown class (might be internal): Aidp
      Pattern: expect().to receive
      Code: expect(Aidp).to receive(:log_error).with(

--------------------------------------------------------------------------------
File: spec/aidp/harness/capability_registry_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (2):
    Line 436: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(registry.instance_variable_get(:@catalog_data)).to be_nil

    Line 438: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(registry.instance_variable_get(:@catalog_data)).not_to be_nil

--------------------------------------------------------------------------------
File: spec/aidp/harness/condition_detector_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (12):
    Line 11: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(detector.instance_variable_get(:@rate_limit_patterns)).to have_key(:common)

    Line 12: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(detector.instance_variable_get(:@rate_limit_patterns)).to have_key(:anthropic)

    Line 13: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(detector.instance_variable_get(:@rate_limit_patterns)).to have_key(:openai)

    Line 14: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(detector.instance_variable_get(:@rate_limit_patterns)).to have_key(:google)

    Line 15: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(detector.instance_variable_get(:@rate_limit_patterns)).to have_key(:cursor)

    Line 19: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: patterns = detector.instance_variable_get(:@user_feedback_patterns)

    Line 26: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: patterns = detector.instance_variable_get(:@question_patterns)

    Line 32: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: patterns = detector.instance_variable_get(:@reset_time_patterns)

    Line 349: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(patterns).to eq(detector.instance_variable_get(:@rate_limit_patterns)[:common])

    Line 354: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: common_patterns = detector.instance_variable_get(:@rate_limit_patterns)[:common]

    Line 355: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: anthropic_patterns = detector.instance_variable_get(:@rate_limit_patterns)[:anthropic]

    Line 362: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(patterns).to eq(detector.instance_variable_get(:@rate_limit_patterns)[:common])

--------------------------------------------------------------------------------
File: spec/aidp/harness/config_loader_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (5):
    Line 467: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: allow(loader.instance_variable_get(:@validator)).to receive(:load_and_validate).and_return({

    Line 472: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: allow(loader.instance_variable_get(:@validator)).to receive(:validated_config).and_return(valid_config)

    Line 493: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: allow(loader.instance_variable_get(:@validator)).to receive(:fix_common_issues).and_return(true)

    Line 515: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: allow(loader.instance_variable_get(:@validator)).to receive(:fix_common_issues).and_return(false)

    Line 528: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: allow(loader.instance_variable_get(:@validator)).to receive(:validate_existing).and_return({


  NEEDS REVIEW (5):
    Line 467: Mocking method call or complex expression: loader.instance_variable_get(:@validator)
      Pattern: allow().to receive
      Code: allow(loader.instance_variable_get(:@validator)).to receive(:load_and_validate).and_return({

    Line 472: Mocking method call or complex expression: loader.instance_variable_get(:@validator)
      Pattern: allow().to receive
      Code: allow(loader.instance_variable_get(:@validator)).to receive(:validated_config).and_return(valid_config)

    Line 493: Mocking method call or complex expression: loader.instance_variable_get(:@validator)
      Pattern: allow().to receive
      Code: allow(loader.instance_variable_get(:@validator)).to receive(:fix_common_issues).and_return(true)

    Line 515: Mocking method call or complex expression: loader.instance_variable_get(:@validator)
      Pattern: allow().to receive
      Code: allow(loader.instance_variable_get(:@validator)).to receive(:fix_common_issues).and_return(false)

    Line 528: Mocking method call or complex expression: loader.instance_variable_get(:@validator)
      Pattern: allow().to receive
      Code: allow(loader.instance_variable_get(:@validator)).to receive(:validate_existing).and_return({

--------------------------------------------------------------------------------
File: spec/aidp/harness/configuration_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (13):
    Line 12: Mocking internal AIDP class: Aidp::Config
      Pattern: allow().to receive
      Code: allow(Aidp::Config).to receive(:load_harness_config).with(project_dir).and_return(mock_config)

    Line 13: Mocking internal AIDP class: Aidp::Config
      Pattern: allow().to receive
      Code: allow(Aidp::Config).to receive(:validate_harness_config).with(mock_config, project_dir).and_return([])

    Line 17: Mocking internal AIDP class: Aidp::Harness::ConfigValidator
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::ConfigValidator).to receive(:new).with(project_dir).and_return(mock_validator)

    Line 163: Mocking internal AIDP class: Aidp::Config
      Pattern: expect().to receive
      Code: expect(Aidp::Config).to receive(:validate_harness_config).with(mock_config, project_dir)

    Line 168: Mocking internal AIDP class: Aidp::Config
      Pattern: allow().to receive
      Code: allow(Aidp::Config).to receive(:validate_harness_config).and_return(["Invalid config"])

    Line 572: Mocking internal AIDP class: Aidp::Config
      Pattern: expect().to receive
      Code: expect(Aidp::Config).to receive(:config_exists?).with(project_dir)

    Line 577: Mocking internal AIDP class: Aidp::Config
      Pattern: expect().to receive
      Code: expect(Aidp::Config).to receive(:create_example_config).with(project_dir)

    Line 592: Mocking internal AIDP class: Aidp::Config
      Pattern: allow().to receive
      Code: allow(Aidp::Config).to receive(:load_harness_config).and_return(invalid_config)

    Line 593: Mocking internal AIDP class: Aidp::Config
      Pattern: allow().to receive
      Code: allow(Aidp::Config).to receive(:validate_harness_config).and_return([])

    Line 603: Mocking internal AIDP class: Aidp::Config
      Pattern: allow().to receive
      Code: allow(Aidp::Config).to receive(:load_harness_config).and_return(invalid_config)

    Line 604: Mocking internal AIDP class: Aidp::Config
      Pattern: allow().to receive
      Code: allow(Aidp::Config).to receive(:validate_harness_config).and_return([])

    Line 614: Mocking internal AIDP class: Aidp::Config
      Pattern: allow().to receive
      Code: allow(Aidp::Config).to receive(:load_harness_config).and_return(invalid_config)

    Line 615: Mocking internal AIDP class: Aidp::Config
      Pattern: allow().to receive
      Code: allow(Aidp::Config).to receive(:validate_harness_config).and_return([])

--------------------------------------------------------------------------------
File: spec/aidp/harness/enhanced_runner_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (111):
    Line 14: Mocking internal AIDP class: Aidp::Harness::UI
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::UI).to receive(:with_processing_spinner).and_yield

    Line 17: Mocking internal AIDP class: Aidp::Harness::Configuration
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::Configuration).to receive(:new).and_return(mock_config)

    Line 18: Mocking internal AIDP class: Aidp::Harness::StateManager
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::StateManager).to receive(:new).and_return(double("StateManager"))

    Line 19: Mocking internal AIDP class: Aidp::Harness::ConditionDetector
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::ConditionDetector).to receive(:new).and_return(double("ConditionDetector",

    Line 23: Mocking internal AIDP class: Aidp::Harness::ProviderManager
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::ProviderManager).to receive(:new).and_return(double("ProviderManager", current_provider: "test"))

    Line 24: Mocking internal AIDP class: Aidp::Harness::ErrorHandler
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::ErrorHandler).to receive(:new).and_return(double("ErrorHandler", execute_with_retry: {status: "completed"}))

    Line 25: Mocking internal AIDP class: Aidp::Harness::CompletionChecker
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::CompletionChecker).to receive(:new).and_return(double("CompletionChecker", completion_status: {all_complete: true}))

    Line 32: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: tui = r.instance_variable_get(:@tui)

    Line 33: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: tui.instance_variable_set(:@jobs, {"main_workflow" => {}})

    Line 47: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: instance.instance_variable_set(:@tui, tui) if tui

    Line 50: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: instance.instance_variable_set(:@provider_manager, provider_manager) if provider_manager || provider_manager.nil?

    Line 53: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: current_tui = instance.instance_variable_get(:@tui)

    Line 54: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: current_tui&.instance_variable_set(:@jobs, {"main_workflow" => {}})

    Line 111: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: instance.instance_variable_set(:@current_provider, "test_provider")

    Line 130: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: instance.instance_variable_set(:@current_step, "step1")

    Line 143: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: instance.instance_variable_set(:@user_input, {key: "value"})

    Line 156: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: instance.instance_variable_set(:@execution_log, ["step1", "step2"])

    Line 207: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: instance.instance_variable_set(:@completion_checker, completion_checker)

    Line 212: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: instance.instance_variable_set(:@workflow_controller, workflow_controller)

    Line 221: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(instance.instance_variable_get(:@state)).to eq("completed")

    Line 222: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(instance.instance_variable_get(:@start_time)).to eq(freeze_time)

    Line 259: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: instance.instance_variable_set(:@completion_checker, completion_checker)

    Line 344: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: paused_instance.instance_variable_set(:@completion_checker, completion_checker)

    Line 349: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: paused_instance.instance_variable_set(:@workflow_controller, workflow_controller)

    Line 370: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: paused_instance.instance_variable_set(:@state, "paused")

    Line 391: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: paused_instance.instance_variable_set(:@state, "waiting_for_user")

    Line 405: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: paused_instance.instance_variable_set(:@state, "waiting_for_rate_limit")

    Line 435: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: thread_tracking_instance.instance_variable_set(:@completion_checker, completion_checker)

    Line 440: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: thread_tracking_instance.instance_variable_set(:@workflow_controller, workflow_controller)

    Line 460: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: allow(mock_tui).to receive(:instance_variable_get).with(:@jobs).and_return(jobs)

    Line 496: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: instance.instance_variable_set(:@error_handler, mock_error_handler)

    Line 497: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: instance.instance_variable_set(:@condition_detector, mock_condition_detector)

    Line 619: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: instance.instance_variable_set(:@project_dir, project_dir)

    Line 673: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: instance.instance_variable_set(:@condition_detector, mock_condition_detector)

    Line 674: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: instance.instance_variable_set(:@workflow_controller, mock_workflow_controller)

    Line 675: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: instance.instance_variable_set(:@state_manager, mock_state_manager)

    Line 676: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: instance.instance_variable_set(:@user_input, {})

    Line 699: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(instance.instance_variable_get(:@state)).to eq("running")

    Line 776: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(instance.instance_variable_get(:@state)).to eq("running")

    Line 805: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: instance.instance_variable_set(:@workflow_type, "test_workflow")

    Line 806: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: instance.instance_variable_set(:@selected_steps, %w[step1 step2])

    Line 824: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: instance.instance_variable_set(:@selected_steps, nil)

    Line 846: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: instance.instance_variable_set(:@current_provider, "test_provider")

    Line 864: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: instance.instance_variable_set(:@current_provider, nil)

    Line 907: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: instance.instance_variable_set(:@workflow_controller, mock_workflow_controller)

    Line 915: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(instance.instance_variable_get(:@state)).to eq("stopped")

    Line 939: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: instance.instance_variable_set(:@state, "running")

    Line 940: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: instance.instance_variable_set(:@mode, "test")

    Line 941: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: instance.instance_variable_set(:@current_step, "step1")

    Line 942: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: instance.instance_variable_set(:@current_provider, "test_provider")

    Line 943: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: instance.instance_variable_set(:@start_time, start_time)

    Line 944: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: instance.instance_variable_set(:@user_input, {key1: "value1", key2: "value2"})

    Line 945: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: instance.instance_variable_set(:@execution_log, ["event1", "event2", "event3"])

    Line 948: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: allow(mock_tui).to receive(:instance_variable_get).with(:@jobs).and_return({"job1" => {}, "job2" => {}})

    Line 968: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: instance.instance_variable_set(:@start_time, nil)

    Line 982: Mocking internal AIDP class: Aidp::Harness::UI
      Pattern: expect().to receive
      Code: expect(Aidp::Harness::UI).to receive(:with_processing_spinner).with("Test message").and_yield

    Line 992: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: instance.instance_variable_set(:@mode, :analyze)

    Line 993: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: instance.instance_variable_set(:@project_dir, "/test/project")

    Line 995: Mocking internal AIDP class: Aidp::Analyze::Runner
      Pattern: expect().to receive
      Code: expect(Aidp::Analyze::Runner).to receive(:new).with("/test/project", instance, prompt: be_a(TTY::Prompt))

    Line 1001: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: instance.instance_variable_set(:@mode, :execute)

    Line 1002: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: instance.instance_variable_set(:@project_dir, "/test/project")

    Line 1004: Mocking internal AIDP class: Aidp::Execute::Runner
      Pattern: expect().to receive
      Code: expect(Aidp::Execute::Runner).to receive(:new).with("/test/project", instance, prompt: be_a(TTY::Prompt))

    Line 1010: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: instance.instance_variable_set(:@mode, :unsupported)

    Line 1030: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: instance.instance_variable_set(:@state, "stopped")

    Line 1035: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: instance.instance_variable_set(:@state, "completed")

    Line 1040: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: instance.instance_variable_set(:@state, "error")

    Line 1045: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: instance.instance_variable_set(:@state, "running")

    Line 1052: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: instance.instance_variable_set(:@state, "paused")

    Line 1057: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: instance.instance_variable_set(:@state, "waiting_for_user")

    Line 1062: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: instance.instance_variable_set(:@state, "waiting_for_rate_limit")

    Line 1067: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: instance.instance_variable_set(:@state, "running")

    Line 1074: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: instance.instance_variable_set(:@state, "paused")

    Line 1075: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: sleeper = instance.instance_variable_get(:@sleeper)

    Line 1082: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: instance.instance_variable_set(:@state, "waiting_for_user")

    Line 1090: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: instance.instance_variable_set(:@state, "waiting_for_rate_limit")

    Line 1150: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: instance.instance_variable_set(:@state_manager, mock_state_manager)

    Line 1151: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: instance.instance_variable_set(:@state, "running")

    Line 1152: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: instance.instance_variable_set(:@current_step, "step1")

    Line 1153: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: instance.instance_variable_set(:@current_provider, "test_provider")

    Line 1154: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: instance.instance_variable_set(:@user_input, {key: "value"})

    Line 1180: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: instance.instance_variable_set(:@state_manager, mock_state_manager)

    Line 1181: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: instance.instance_variable_set(:@user_input, {})

    Line 1225: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: instance.instance_variable_set(:@state_manager, mock_state_manager)

    Line 1226: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: instance.instance_variable_set(:@state, "completed")

    Line 1227: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: instance.instance_variable_set(:@current_step, "final_step")

    Line 1228: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: instance.instance_variable_set(:@current_provider, "test_provider")

    Line 1229: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: instance.instance_variable_set(:@user_input, {key: "value"})

    Line 1260: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: instance.instance_variable_set(:@mode, :analyze)

    Line 1269: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: instance.instance_variable_set(:@mode, :execute)

    Line 1283: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: instance.instance_variable_set(:@execution_log, [])

    Line 1341: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: instance.instance_variable_set(:@workflow_controller, mock_workflow_controller)

    Line 1370: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(instance.instance_variable_get(:@state)).to eq("completed")

    Line 1387: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(instance.instance_variable_get(:@state)).to eq("error")

    Line 1398: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: instance.instance_variable_set(:@current_provider, "current_provider")

    Line 1411: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(instance.instance_variable_get(:@state)).to eq("running")

    Line 1440: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(instance.instance_variable_get(:@current_provider)).to eq("new_provider")

    Line 1441: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(instance.instance_variable_get(:@state)).to eq("running")

    Line 1486: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(instance.instance_variable_get(:@state)).to eq("running")

    Line 1498: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(instance.instance_variable_get(:@state)).to eq("error")

    Line 1509: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: instance.instance_variable_set(:@state, "waiting_for_rate_limit")

    Line 1519: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: sleeper = instance.instance_variable_get(:@sleeper)

    Line 1532: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: allow(mock_tui).to receive(:instance_variable_get).with(:@jobs).and_return(jobs)

    Line 1549: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: instance.instance_variable_set(:@state, "completed")

    Line 1554: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: instance.instance_variable_set(:@state, "stopped")

    Line 1559: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: instance.instance_variable_set(:@state, "error")

    Line 1564: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: instance.instance_variable_set(:@state, "unknown")

    Line 1583: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: allow(mock_tui).to receive(:instance_variable_get).with(:@jobs).and_return({})

    Line 1596: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: instance.instance_variable_set(:@error_handler, mock_error_handler)

    Line 1741: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(instance.instance_variable_get(:@current_provider)).to eq("openai")

    Line 1750: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: instance.instance_variable_set(:@configuration, mock_configuration)

    Line 1860: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: mock_condition_detector = instance.instance_variable_get(:@condition_detector)


  NEEDS REVIEW (7):
    Line 12: Mocking unknown class (might be internal): Aidp.logger
      Pattern: allow().to receive
      Code: allow(Aidp.logger).to receive(:info)

    Line 13: Mocking unknown class (might be internal): Aidp.logger
      Pattern: allow().to receive
      Code: allow(Aidp.logger).to receive(:error)

    Line 507: Mocking unknown class (might be internal): Thread
      Pattern: allow().to receive
      Code: allow(Thread).to receive(:new).and_yield

    Line 659: Mocking unknown class (might be internal): Thread
      Pattern: expect().to receive
      Code: expect(Thread).to receive(:new).once

    Line 1571: Mocking unknown class (might be internal): ModeRunner
      Pattern: instance_double
      Code: let(:mock_runner) { instance_double("ModeRunner") }

    Line 1593: Mocking unknown class (might be internal): Thread
      Pattern: allow().to receive
      Code: allow(Thread).to receive(:new).and_yield

    Line 1747: Mocking unknown class (might be internal): Configuration
      Pattern: instance_double
      Code: let(:mock_configuration) { instance_double("Configuration") }

--------------------------------------------------------------------------------
File: spec/aidp/harness/error_handler_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (13):
    Line 6: Mocking internal AIDP class: Aidp::Harness::ProviderManager
      Pattern: instance_double
      Code: let(:provider_manager) { instance_double("Aidp::Harness::ProviderManager") }

    Line 6: Mocking internal AIDP class: Aidp::Harness::ProviderManager
      Pattern: double
      Code: let(:provider_manager) { instance_double("Aidp::Harness::ProviderManager") }

    Line 7: Mocking internal AIDP class: Aidp::Harness::Configuration
      Pattern: instance_double
      Code: let(:configuration) { instance_double("Aidp::Harness::Configuration") }

    Line 7: Mocking internal AIDP class: Aidp::Harness::Configuration
      Pattern: double
      Code: let(:configuration) { instance_double("Aidp::Harness::Configuration") }

    Line 8: Mocking internal AIDP class: Aidp::Harness::MetricsManager
      Pattern: instance_double
      Code: let(:metrics_manager) { instance_double("Aidp::Harness::MetricsManager") }

    Line 8: Mocking internal AIDP class: Aidp::Harness::MetricsManager
      Pattern: double
      Code: let(:metrics_manager) { instance_double("Aidp::Harness::MetricsManager") }

    Line 31: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: strategies = error_handler.instance_variable_get(:@retry_strategies)

    Line 45: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(error_handler.instance_variable_get(:@backoff_calculator)).to be_a(described_class::BackoffCalculator)

    Line 46: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(error_handler.instance_variable_get(:@error_classifier)).to be_a(described_class::ErrorClassifier)

    Line 47: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(error_handler.instance_variable_get(:@recovery_planner)).to be_a(described_class::RecoveryPlanner)

    Line 65: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: allow(error_handler.instance_variable_get(:@error_classifier)).to receive(:classify_error).and_return({

    Line 83: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: allow(error_handler.instance_variable_get(:@error_classifier)).to receive(:classify_error).and_return({

    Line 104: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: allow(error_handler.instance_variable_get(:@error_classifier)).to receive(:classify_error).and_return({


  NEEDS REVIEW (3):
    Line 65: Mocking method call or complex expression: error_handler.instance_variable_get(:@error_classifier)
      Pattern: allow().to receive
      Code: allow(error_handler.instance_variable_get(:@error_classifier)).to receive(:classify_error).and_return({

    Line 83: Mocking method call or complex expression: error_handler.instance_variable_get(:@error_classifier)
      Pattern: allow().to receive
      Code: allow(error_handler.instance_variable_get(:@error_classifier)).to receive(:classify_error).and_return({

    Line 104: Mocking method call or complex expression: error_handler.instance_variable_get(:@error_classifier)
      Pattern: allow().to receive
      Code: allow(error_handler.instance_variable_get(:@error_classifier)).to receive(:classify_error).and_return({

--------------------------------------------------------------------------------
File: spec/aidp/harness/model_discovery_service_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (19):
    Line 35: Mocking internal AIDP class: Aidp::Providers::Anthropic
      Pattern: allow().to receive
      Code: allow(Aidp::Providers::Anthropic).to receive(:available?).and_return(true)

    Line 36: Mocking internal AIDP class: Aidp::Providers::Anthropic
      Pattern: allow().to receive
      Code: allow(Aidp::Providers::Anthropic).to receive(:discover_models).and_return(sample_models)

    Line 82: Mocking internal AIDP class: Aidp::Providers::Anthropic
      Pattern: allow().to receive
      Code: allow(Aidp::Providers::Anthropic).to receive(:available?).and_return(false)

    Line 95: Mocking internal AIDP class: Aidp::Providers::Anthropic
      Pattern: allow().to receive
      Code: allow(Aidp::Providers::Anthropic).to receive(:discover_models).and_raise(StandardError, "Discovery failed")

    Line 107: Mocking internal AIDP class: Aidp::Providers::Anthropic
      Pattern: allow().to receive
      Code: allow(Aidp::Providers::Anthropic).to receive(:available?).and_return(true)

    Line 108: Mocking internal AIDP class: Aidp::Providers::Cursor
      Pattern: allow().to receive
      Code: allow(Aidp::Providers::Cursor).to receive(:available?).and_return(true)

    Line 109: Mocking internal AIDP class: Aidp::Providers::Gemini
      Pattern: allow().to receive
      Code: allow(Aidp::Providers::Gemini).to receive(:available?).and_return(true)

    Line 110: Mocking internal AIDP class: Aidp::Providers::Anthropic
      Pattern: allow().to receive
      Code: allow(Aidp::Providers::Anthropic).to receive(:discover_models).and_return(sample_models)

    Line 111: Mocking internal AIDP class: Aidp::Providers::Cursor
      Pattern: allow().to receive
      Code: allow(Aidp::Providers::Cursor).to receive(:discover_models).and_return([])

    Line 112: Mocking internal AIDP class: Aidp::Providers::Gemini
      Pattern: allow().to receive
      Code: allow(Aidp::Providers::Gemini).to receive(:discover_models).and_return([])

    Line 133: Mocking internal AIDP class: Aidp::Providers::Anthropic
      Pattern: allow().to receive
      Code: allow(Aidp::Providers::Anthropic).to receive(:supports_model_family?).with("claude-3-5-sonnet").and_return(true)

    Line 134: Mocking internal AIDP class: Aidp::Providers::Cursor
      Pattern: allow().to receive
      Code: allow(Aidp::Providers::Cursor).to receive(:supports_model_family?).with("claude-3-5-sonnet").and_return(true)

    Line 135: Mocking internal AIDP class: Aidp::Providers::Gemini
      Pattern: allow().to receive
      Code: allow(Aidp::Providers::Gemini).to receive(:supports_model_family?).with("claude-3-5-sonnet").and_return(false)

    Line 148: Mocking internal AIDP class: Aidp::Providers::Anthropic
      Pattern: allow().to receive
      Code: allow(Aidp::Providers::Anthropic).to receive(:available?).and_return(true)

    Line 149: Mocking internal AIDP class: Aidp::Providers::Anthropic
      Pattern: allow().to receive
      Code: allow(Aidp::Providers::Anthropic).to receive(:discover_models).and_return(sample_models)

    Line 163: Mocking internal AIDP class: Aidp::Providers::Anthropic
      Pattern: allow().to receive
      Code: allow(Aidp::Providers::Anthropic).to receive(:available?).and_return(true)

    Line 164: Mocking internal AIDP class: Aidp::Providers::Cursor
      Pattern: allow().to receive
      Code: allow(Aidp::Providers::Cursor).to receive(:available?).and_return(false)

    Line 165: Mocking internal AIDP class: Aidp::Providers::Gemini
      Pattern: allow().to receive
      Code: allow(Aidp::Providers::Gemini).to receive(:available?).and_return(false)

    Line 166: Mocking internal AIDP class: Aidp::Providers::Anthropic
      Pattern: allow().to receive
      Code: allow(Aidp::Providers::Anthropic).to receive(:discover_models).and_return(sample_models)

--------------------------------------------------------------------------------
File: spec/aidp/harness/performance_simple_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (4):
    Line 57: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: error_handler.instance_variable_get(:@retry_strategies)

    Line 113: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: error_handler.instance_variable_get(:@error_classifier).classify_error(

    Line 253: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: provider_manager = harness_runner.instance_variable_get(:@provider_manager)

    Line 319: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: error_handler.instance_variable_get(:@error_classifier).classify_error(

--------------------------------------------------------------------------------
File: spec/aidp/harness/provider_config_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (5):
    Line 26: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(provider_config.instance_variable_get(:@provider_name)).to eq("cursor")

    Line 598: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(factory.instance_variable_get(:@provider_instances)).to be_empty

    Line 599: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(factory.instance_variable_get(:@provider_configs)).to be_empty

    Line 605: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(factory.instance_variable_get(:@provider_instances)).to be_empty

    Line 606: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(factory.instance_variable_get(:@provider_configs)).to be_empty

--------------------------------------------------------------------------------
File: spec/aidp/harness/provider_failure_exhausted_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (1):
    Line 52: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: health_after = provider_manager.instance_variable_get(:@provider_health)[start_provider]

--------------------------------------------------------------------------------
File: spec/aidp/harness/provider_info_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (5):
    Line 606: Mocking internal AIDP class: Aidp::Util
      Pattern: allow().to receive
      Code: allow(Aidp::Util).to receive(:which).and_return("/usr/bin/test-binary")

    Line 619: Mocking internal AIDP class: Aidp::Util
      Pattern: allow().to receive
      Code: allow(Aidp::Util).to receive(:which).and_return("/usr/bin/test-binary")

    Line 624: Mocking internal AIDP class: Aidp::Concurrency::Wait
      Pattern: allow().to receive
      Code: allow(Aidp::Concurrency::Wait).to receive(:for_process_exit).and_raise(Aidp::Concurrency::TimeoutError.new("Mocked timeout"))

    Line 636: Mocking internal AIDP class: Aidp::Util
      Pattern: allow().to receive
      Code: allow(Aidp::Util).to receive(:which).and_raise(StandardError.new("Which error"))

    Line 729: Mocking internal AIDP class: Aidp::Util
      Pattern: allow().to receive
      Code: allow(Aidp::Util).to receive(:which).and_return(nil)


  NEEDS REVIEW (4):
    Line 607: Mocking unknown class (might be internal): Process
      Pattern: allow().to receive
      Code: allow(Process).to receive(:spawn).and_raise(StandardError.new("Spawn error"))

    Line 620: Mocking unknown class (might be internal): Process
      Pattern: allow().to receive
      Code: allow(Process).to receive(:spawn).and_return(99_999)

    Line 621: Mocking unknown class (might be internal): Process
      Pattern: allow().to receive
      Code: allow(Process).to receive(:waitpid2).and_return(nil) # Timeout

    Line 622: Mocking unknown class (might be internal): Process
      Pattern: allow().to receive
      Code: allow(Process).to receive(:kill).and_raise(StandardError.new("Kill error"))

--------------------------------------------------------------------------------
File: spec/aidp/harness/provider_manager_model_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (1):
    Line 23: Mocking internal AIDP class: Aidp::Harness::ProviderMetrics
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::ProviderMetrics).to receive(:new).and_return(mock_metrics_persistence)

--------------------------------------------------------------------------------
File: spec/aidp/harness/provider_manager_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (23):
    Line 29: Mocking internal AIDP class: Aidp::Harness::ProviderMetrics
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::ProviderMetrics).to receive(:new).and_return(mock_metrics_persistence)

    Line 666: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: manager.instance_variable_set(:@current_model, "claude-3-opus")

    Line 679: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: manager.instance_variable_set(:@current_model, "claude-3-sonnet")

    Line 1113: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: manager.instance_variable_set(:@sticky_sessions, {})

    Line 1125: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: manager.instance_variable_set(:@sticky_sessions, {})

    Line 1158: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: cache = manager.instance_variable_get(:@binary_check_cache)

    Line 1197: Mocking internal AIDP class: Aidp::Concurrency::Wait
      Pattern: allow().to receive
      Code: allow(Aidp::Concurrency::Wait).to receive(:for_process_exit).with(fake_pid, timeout: 3, interval: 0.05).and_raise(Aidp::Concurrency::TimeoutError)

    Line 1200: Mocking internal AIDP class: Aidp::Concurrency::Wait
      Pattern: allow().to receive
      Code: allow(Aidp::Concurrency::Wait).to receive(:for_process_exit).with(fake_pid, timeout: 0.1, interval: 0.02).and_raise(Aidp::Concurrency::TimeoutError)

    Line 1207: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: cache = manager.instance_variable_get(:@binary_check_cache)

    Line 1223: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: cache = manager.instance_variable_get(:@binary_check_cache)

    Line 1237: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: cache = manager.instance_variable_get(:@binary_check_cache)

    Line 1250: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: ttl = manager.instance_variable_get(:@binary_check_ttl)

    Line 1261: Mocking internal AIDP class: Aidp::Concurrency::Wait
      Pattern: allow().to receive
      Code: allow(Aidp::Concurrency::Wait).to receive(:for_process_exit).with(fake_pid, timeout: 3, interval: 0.05).and_return(true)

    Line 1451: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: metrics = manager.instance_variable_get(:@provider_metrics)

    Line 1487: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: rate_info = manager.instance_variable_get(:@rate_limit_info)

    Line 1527: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: health = manager.instance_variable_get(:@provider_health)

    Line 1542: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: manager.instance_variable_set(:@provider_health, {})

    Line 1543: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: manager.instance_variable_set(:@provider_metrics, {})

    Line 1544: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: manager.instance_variable_set(:@rate_limit_info, {})

    Line 1558: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: manager.instance_variable_get(:@provider_health).delete("anthropic")

    Line 1677: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: initial_sessions = manager.instance_variable_get(:@sticky_sessions).dup

    Line 1681: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(manager.instance_variable_get(:@sticky_sessions)).to eq(initial_sessions)

    Line 2176: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: @large_manager.instance_variable_set(:@load_balancing_enabled, true)


  NEEDS REVIEW (6):
    Line 1193: Mocking unknown class (might be internal): IO
      Pattern: allow().to receive
      Code: allow(IO).to receive(:pipe).and_return([r, w])

    Line 1194: Mocking unknown class (might be internal): Process
      Pattern: allow().to receive
      Code: allow(Process).to receive(:spawn).with("claude", "--version", out: w, err: w).and_return(fake_pid)

    Line 1203: Mocking unknown class (might be internal): Process
      Pattern: expect().to receive
      Code: expect(Process).to receive(:kill).with("TERM", fake_pid).ordered

    Line 1204: Mocking unknown class (might be internal): Process
      Pattern: expect().to receive
      Code: expect(Process).to receive(:kill).with("KILL", fake_pid).ordered

    Line 1258: Mocking unknown class (might be internal): IO
      Pattern: allow().to receive
      Code: allow(IO).to receive(:pipe).and_return([r, w])

    Line 1260: Mocking unknown class (might be internal): Process
      Pattern: allow().to receive
      Code: allow(Process).to receive(:spawn).with("claude", "--version", out: w, err: w).and_return(fake_pid)

--------------------------------------------------------------------------------
File: spec/aidp/harness/provider_metrics_spec.rb
--------------------------------------------------------------------------------

  NEEDS REVIEW (2):
    Line 229: Mocking unknown class (might be internal): YAML
      Pattern: allow().to receive
      Code: allow(YAML).to receive(:safe_load_file).and_raise(Errno::EACCES)

    Line 412: Mocking unknown class (might be internal): YAML
      Pattern: allow().to receive
      Code: allow(YAML).to receive(:safe_load_file).and_raise(StandardError.new("read error"))

--------------------------------------------------------------------------------
File: spec/aidp/harness/runner_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (70):
    Line 65: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(runner.instance_variable_get(:@mode)).to eq(:analyze)

    Line 66: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(runner.instance_variable_get(:@project_dir)).to eq(temp_dir)

    Line 71: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(execute_runner.instance_variable_get(:@mode)).to eq(:execute)

    Line 75: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(runner.instance_variable_get(:@configuration)).to be_a(Aidp::Harness::Configuration)

    Line 76: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(runner.instance_variable_get(:@state_manager)).to be_a(Aidp::Harness::StateManager)

    Line 77: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(runner.instance_variable_get(:@condition_detector)).to be_a(Aidp::Harness::ZfcConditionDetector)

    Line 78: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(runner.instance_variable_get(:@provider_manager)).to be_a(Aidp::Harness::ProviderManager)

    Line 79: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(runner.instance_variable_get(:@user_interface)).to be_a(Aidp::Harness::SimpleUserInterface)

    Line 80: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(runner.instance_variable_get(:@error_handler)).to be_a(Aidp::Harness::ErrorHandler)

    Line 81: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(runner.instance_variable_get(:@status_display)).to be_a(Aidp::Harness::StatusDisplay)

    Line 85: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(runner.instance_variable_get(:@state)).to eq("idle")

    Line 126: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@state, "running")

    Line 128: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(runner.instance_variable_get(:@state)).to eq("paused")

    Line 132: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@state, "idle")

    Line 134: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(runner.instance_variable_get(:@state)).to eq("idle")

    Line 140: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@state, "paused")

    Line 142: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(runner.instance_variable_get(:@state)).to eq("running")

    Line 146: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@state, "idle")

    Line 148: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(runner.instance_variable_get(:@state)).to eq("idle")

    Line 154: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@state, "running")

    Line 156: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(runner.instance_variable_get(:@state)).to eq("stopped")

    Line 173: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@mode, :invalid)

    Line 187: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@state_manager, state_manager)

    Line 188: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@status_display, status_display)

    Line 189: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@provider_manager, provider_manager)

    Line 190: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@error_handler, error_handler)

    Line 191: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@condition_detector, condition_detector)

    Line 211: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@condition_detector, condition_detector)

    Line 212: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@user_interface, user_interface)

    Line 213: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@state_manager, state_manager)

    Line 228: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(runner.instance_variable_get(:@user_input)["question_1"]).to eq("answer")

    Line 238: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@provider_manager, provider_manager)

    Line 239: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@condition_detector, condition_detector)

    Line 240: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@current_provider, "cursor")

    Line 254: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(runner.instance_variable_get(:@current_provider)).to eq("claude")

    Line 255: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(runner.instance_variable_get(:@state)).to eq("running")

    Line 275: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@current_provider, "anthropic")

    Line 285: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(runner.instance_variable_get(:@current_provider)).to eq("codex")

    Line 286: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(runner.instance_variable_get(:@state)).to eq("running")

    Line 311: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@state_manager, state_manager)

    Line 315: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(runner.instance_variable_get(:@current_step)).to eq("test_step")

    Line 316: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(runner.instance_variable_get(:@current_provider)).to eq("cursor")

    Line 317: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(runner.instance_variable_get(:@user_input)["question_1"]).to eq("answer")

    Line 323: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@state_manager, state_manager)

    Line 324: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@state, "running")

    Line 325: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@current_step, "test_step")

    Line 326: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@current_provider, "cursor")

    Line 327: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@user_input, {"test" => "data"})

    Line 345: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@error_handler, error_handler)

    Line 354: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: state_manager = runner.instance_variable_get(:@state_manager)

    Line 374: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: state_manager = runner.instance_variable_get(:@state_manager)

    Line 394: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: state_manager = runner.instance_variable_get(:@state_manager)

    Line 404: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(runner.instance_variable_get(:@last_error)).to eq(save_error)

    Line 414: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@error_handler, error_handler)

    Line 422: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@provider_manager, provider_manager)

    Line 431: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@status_display, status_display)

    Line 437: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@condition_detector, condition_detector)

    Line 448: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@completion_checker, completion_checker)

    Line 466: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@completion_checker, completion_checker)

    Line 471: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@user_interface, ui)

    Line 488: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@completion_checker, completion_checker)

    Line 492: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@user_interface, ui)

    Line 509: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@completion_checker, completion_checker)

    Line 512: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@user_interface, ui)

    Line 513: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@workflow_type, :watch_mode)

    Line 514: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@non_interactive, true)

    Line 535: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: runner.instance_variable_set(:@condition_detector, condition_detector)

    Line 536: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: provider_manager = runner.instance_variable_get(:@provider_manager)

    Line 539: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: allow(runner).to receive(:sleep_until_reset) { runner.instance_variable_set(:@state, "running") }

    Line 565: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: execute_runner.instance_variable_set(:@completion_checker, completion_checker)

--------------------------------------------------------------------------------
File: spec/aidp/harness/state/metrics_spec.rb
--------------------------------------------------------------------------------

  NEEDS REVIEW (2):
    Line 7: Mocking unknown class (might be internal): Persistence
      Pattern: instance_double
      Code: let(:persistence) { instance_double("Persistence") }

    Line 8: Mocking unknown class (might be internal): WorkflowState
      Pattern: instance_double
      Code: let(:workflow_state) { instance_double("WorkflowState") }

--------------------------------------------------------------------------------
File: spec/aidp/harness/state/persistence_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (2):
    Line 26: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(persistence.instance_variable_get(:@state_file)).to eq(state_file)

    Line 31: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(persistence.instance_variable_get(:@lock_file)).to eq(lock_file)

--------------------------------------------------------------------------------
File: spec/aidp/harness/state/provider_state_spec.rb
--------------------------------------------------------------------------------

  NEEDS REVIEW (1):
    Line 7: Mocking unknown class (might be internal): Persistence
      Pattern: instance_double
      Code: let(:persistence) { instance_double("Persistence") }

--------------------------------------------------------------------------------
File: spec/aidp/harness/state/ui_state_spec.rb
--------------------------------------------------------------------------------

  NEEDS REVIEW (1):
    Line 7: Mocking unknown class (might be internal): Persistence
      Pattern: instance_double
      Code: let(:persistence) { instance_double("Persistence") }

--------------------------------------------------------------------------------
File: spec/aidp/harness/state/workflow_state_spec.rb
--------------------------------------------------------------------------------

  NEEDS REVIEW (2):
    Line 7: Mocking unknown class (might be internal): Persistence
      Pattern: instance_double
      Code: let(:persistence) { instance_double("Persistence") }

    Line 10: Mocking unknown class (might be internal): ProgressTracker
      Pattern: instance_double
      Code: let(:progress_tracker) { instance_double("ProgressTracker") }

--------------------------------------------------------------------------------
File: spec/aidp/harness/state_manager_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (3):
    Line 23: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(state_manager.instance_variable_get(:@project_dir)).to eq(project_dir)

    Line 24: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(state_manager.instance_variable_get(:@mode)).to eq(mode)

    Line 392: Mocking internal AIDP class: Aidp::Concurrency::Backoff
      Pattern: allow().to receive
      Code: allow(Aidp::Concurrency::Backoff).to receive(:retry).and_raise(Aidp::Concurrency::MaxAttemptsError, "Max attempts exceeded")


  NEEDS REVIEW (7):
    Line 43: Mocking method call or complex expression: state_manager.progress_tracker
      Pattern: allow().to receive
      Code: allow(state_manager.progress_tracker).to receive(:completed_steps).and_return(["01_REPOSITORY_ANALYSIS"])

    Line 49: Mocking method call or complex expression: state_manager.progress_tracker
      Pattern: allow().to receive
      Code: allow(state_manager.progress_tracker).to receive(:current_step).and_return("02_ARCHITECTURE_ANALYSIS")

    Line 55: Mocking method call or complex expression: state_manager.progress_tracker
      Pattern: allow().to receive
      Code: allow(state_manager.progress_tracker).to receive(:mark_step_completed).with("01_REPOSITORY_ANALYSIS")

    Line 64: Mocking method call or complex expression: state_manager.progress_tracker
      Pattern: allow().to receive
      Code: allow(state_manager.progress_tracker).to receive(:mark_step_in_progress).with("01_REPOSITORY_ANALYSIS")

    Line 89: Mocking method call or complex expression: state_manager.progress_tracker
      Pattern: allow().to receive
      Code: allow(state_manager.progress_tracker).to receive(:started_at).and_return(start_time)

    Line 95: Mocking method call or complex expression: state_manager.progress_tracker
      Pattern: allow().to receive
      Code: allow(state_manager.progress_tracker).to receive(:started_at).and_return(nil)

    Line 343: Mocking method call or complex expression: state_manager.progress_tracker
      Pattern: allow().to receive
      Code: allow(state_manager.progress_tracker).to receive(:started_at).and_return(Time.now - 3600)

--------------------------------------------------------------------------------
File: spec/aidp/harness/status_display_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (64):
    Line 8: Mocking internal AIDP class: Aidp::Harness::ProviderManager
      Pattern: instance_double
      Code: let(:provider_manager) { instance_double("Aidp::Harness::ProviderManager") }

    Line 8: Mocking internal AIDP class: Aidp::Harness::ProviderManager
      Pattern: double
      Code: let(:provider_manager) { instance_double("Aidp::Harness::ProviderManager") }

    Line 9: Mocking internal AIDP class: Aidp::Harness::MetricsManager
      Pattern: instance_double
      Code: let(:metrics_manager) { instance_double("Aidp::Harness::MetricsManager") }

    Line 9: Mocking internal AIDP class: Aidp::Harness::MetricsManager
      Pattern: double
      Code: let(:metrics_manager) { instance_double("Aidp::Harness::MetricsManager") }

    Line 10: Mocking internal AIDP class: Aidp::Harness::CircuitBreakerManager
      Pattern: instance_double
      Code: let(:circuit_breaker_manager) { instance_double("Aidp::Harness::CircuitBreakerManager") }

    Line 10: Mocking internal AIDP class: Aidp::Harness::CircuitBreakerManager
      Pattern: double
      Code: let(:circuit_breaker_manager) { instance_double("Aidp::Harness::CircuitBreakerManager") }

    Line 35: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: status_display.instance_variable_set(:@error_summary, {

    Line 46: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: config = status_display.instance_variable_get(:@display_config)

    Line 61: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(status_display.instance_variable_get(:@status_formatter)).to be_a(described_class::StatusFormatter)

    Line 62: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(status_display.instance_variable_get(:@metrics_calculator)).to be_a(described_class::MetricsCalculator)

    Line 63: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(status_display.instance_variable_get(:@alert_manager)).to be_a(described_class::AlertManager)

    Line 64: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(status_display.instance_variable_get(:@display_animator)).to be_a(described_class::DisplayAnimator)

    Line 72: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(status_display.instance_variable_get(:@current_step)).to eq("Test Step")

    Line 73: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(status_display.instance_variable_get(:@status_data)[:current_step]).to eq("Test Step")

    Line 79: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(status_display.instance_variable_get(:@current_provider)).to eq("claude")

    Line 80: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(status_display.instance_variable_get(:@status_data)[:current_provider]).to eq("claude")

    Line 86: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(status_display.instance_variable_get(:@current_model)).to eq("model1")

    Line 87: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(status_display.instance_variable_get(:@status_data)[:current_model]).to eq("model1")

    Line 93: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: token_usage = status_display.instance_variable_get(:@token_usage)

    Line 108: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: rate_limit_status = status_display.instance_variable_get(:@rate_limit_status)

    Line 116: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: recovery_status = status_display.instance_variable_get(:@recovery_status)

    Line 124: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: user_feedback_status = status_display.instance_variable_get(:@user_feedback_status)

    Line 138: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: work_completion_status = status_display.instance_variable_get(:@work_completion_status)

    Line 147: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: performance_metrics = status_display.instance_variable_get(:@performance_metrics)

    Line 156: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: error_summary_data = status_display.instance_variable_get(:@error_summary)

    Line 166: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(status_display.instance_variable_get(:@display_mode)).to eq(:detailed)

    Line 172: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(status_display.instance_variable_get(:@update_interval)).to eq(5)

    Line 179: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: display_config = status_display.instance_variable_get(:@display_config)

    Line 189: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: provider_status = status_display.instance_variable_get(:@provider_status)

    Line 197: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: circuit_breaker_status = status_display.instance_variable_get(:@circuit_breaker_status)

    Line 204: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: performance_metrics = status_display.instance_variable_get(:@performance_metrics)

    Line 212: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: error_summary = status_display.instance_variable_get(:@error_summary)

    Line 217: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: status_display.instance_variable_set(:@start_time, Time.now - 60)

    Line 220: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: performance_metrics = status_display.instance_variable_get(:@performance_metrics)

    Line 227: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: status_display.instance_variable_set(:@start_time, Time.now - 30)

    Line 228: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: status_display.instance_variable_set(:@current_step, "Test Step")

    Line 229: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: status_display.instance_variable_set(:@current_provider, "claude")

    Line 230: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: status_display.instance_variable_set(:@current_model, "model1")

    Line 231: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: status_display.instance_variable_set(:@running, true)

    Line 257: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: status_display.instance_variable_set(:@start_time, Time.now - 60)

    Line 258: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: status_display.instance_variable_set(:@current_step, "Test Step")

    Line 259: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: status_display.instance_variable_set(:@current_provider, "claude")

    Line 260: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: status_display.instance_variable_set(:@current_model, "model1")

    Line 269: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: status_display.instance_variable_set(:@provider_status, {

    Line 279: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: status_display.instance_variable_set(:@performance_metrics, {

    Line 291: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: status_display.instance_variable_set(:@error_summary, {

    Line 305: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: status_display.instance_variable_set(:@circuit_breaker_status, {

    Line 315: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: status_display.instance_variable_set(:@token_usage, {

    Line 326: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: status_display.instance_variable_set(:@rate_limit_status, {

    Line 343: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: status_display.instance_variable_set(:@recovery_status, {

    Line 352: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: status_display.instance_variable_set(:@user_feedback_status, {

    Line 361: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: status_display.instance_variable_set(:@work_completion_status, {

    Line 372: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: alert_manager = status_display.instance_variable_get(:@alert_manager)

    Line 384: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: status_display.instance_variable_set(:@performance_metrics, {error_rate: 0.15})

    Line 390: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: status_display.instance_variable_set(:@circuit_breaker_status, {

    Line 398: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: status_display.instance_variable_set(:@rate_limit_status, {

    Line 410: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: status_display.instance_variable_set(:@start_time, Time.now - 60)

    Line 411: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: status_display.instance_variable_set(:@current_step, "Test Step")

    Line 412: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: status_display.instance_variable_set(:@current_provider, "claude")

    Line 413: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: status_display.instance_variable_set(:@current_model, "model1")

    Line 548: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: status_display.instance_variable_get(:@running) == true

    Line 551: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(status_display.instance_variable_get(:@running)).to be true

    Line 559: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: status_display.instance_variable_get(:@running) == true

    Line 564: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(status_display.instance_variable_get(:@running)).to be false

--------------------------------------------------------------------------------
File: spec/aidp/harness/test_runner_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (2):
    Line 47: Mocking internal AIDP class: Aidp::ToolingDetector
      Pattern: allow().to receive
      Code: allow(Aidp::ToolingDetector).to receive(:detect).and_return(

    Line 142: Mocking internal AIDP class: Aidp::ToolingDetector
      Pattern: allow().to receive
      Code: allow(Aidp::ToolingDetector).to receive(:detect).and_return(

--------------------------------------------------------------------------------
File: spec/aidp/harness/thinking_depth_manager_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (1):
    Line 560: Mocking internal AIDP class: Aidp::Harness::ModelCache
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::ModelCache).to receive(:new).and_return(cache)


  NEEDS REVIEW (1):
    Line 592: Mocking unknown class (might be internal): Aidp
      Pattern: allow().to receive
      Code: allow(Aidp).to receive(:display_message)

--------------------------------------------------------------------------------
File: spec/aidp/harness/ui/enhanced_tui_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (22):
    Line 88: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: jobs = tui.instance_variable_get(:@jobs)

    Line 101: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: jobs = tui.instance_variable_get(:@jobs)

    Line 114: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: jobs = tui.instance_variable_get(:@jobs)

    Line 131: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: jobs = tui.instance_variable_get(:@jobs)

    Line 171: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(tui.instance_variable_get(:@current_mode)).to eq(:analyze)

    Line 178: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(tui.instance_variable_get(:@workflow_active)).to be true

    Line 179: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(tui.instance_variable_get(:@current_step)).to eq("00_PRD_initial_planning")

    Line 186: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(tui.instance_variable_get(:@current_step)).to eq("some_other_step")

    Line 288: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(instance.instance_variable_get(:@headless)).to be false

    Line 293: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(instance.instance_variable_get(:@headless)).to be true

    Line 297: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(tui.instance_variable_get(:@jobs)).to eq({})

    Line 362: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(tui.instance_variable_get(:@jobs)["job-123"]).to include(

    Line 374: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(tui.instance_variable_get(:@jobs)["job-456"][:name]).to eq("job-456")

    Line 379: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(tui.instance_variable_get(:@jobs)["job-789"][:status]).to eq(:pending)

    Line 384: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(tui.instance_variable_get(:@jobs)["job-000"][:progress]).to eq(0)

    Line 392: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(tui.instance_variable_get(:@jobs)["job-123"]).to include(

    Line 407: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: headless_tui.instance_variable_set(:@headless, false)

    Line 426: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: headless_tui.instance_variable_set(:@headless, true)

    Line 427: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: headless_tui.instance_variable_set(:@current_mode, :analyze)

    Line 438: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: headless_tui.instance_variable_set(:@headless, true)

    Line 450: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: headless_tui.instance_variable_set(:@headless, true)

    Line 462: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: headless_tui.instance_variable_set(:@headless, true)


  NEEDS REVIEW (2):
    Line 21: Mocking unknown class (might be internal): TTY::Screen
      Pattern: allow().to receive
      Code: allow(TTY::Screen).to receive(:height).and_return(24)

    Line 22: Mocking unknown class (might be internal): TTY::Screen
      Pattern: allow().to receive
      Code: allow(TTY::Screen).to receive(:width).and_return(80)

--------------------------------------------------------------------------------
File: spec/aidp/harness/ui/enhanced_workflow_selector_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (25):
    Line 18: Mocking internal AIDP class: Aidp::Harness::UI::EnhancedTUI
      Pattern: instance_double
      Code: instance_double("Aidp::Harness::UI::EnhancedTUI").tap do |tui|

    Line 18: Mocking internal AIDP class: Aidp::Harness::UI::EnhancedTUI
      Pattern: double
      Code: instance_double("Aidp::Harness::UI::EnhancedTUI").tap do |tui|

    Line 27: Mocking internal AIDP class: Aidp::Workflows::Selector
      Pattern: instance_double
      Code: instance_double("Aidp::Workflows::Selector").tap do |selector|

    Line 27: Mocking internal AIDP class: Aidp::Workflows::Selector
      Pattern: double
      Code: instance_double("Aidp::Workflows::Selector").tap do |selector|

    Line 37: Mocking internal AIDP class: Aidp::Workflows::GuidedAgent
      Pattern: instance_double
      Code: instance_double("Aidp::Workflows::GuidedAgent").tap do |agent|

    Line 37: Mocking internal AIDP class: Aidp::Workflows::GuidedAgent
      Pattern: double
      Code: instance_double("Aidp::Workflows::GuidedAgent").tap do |agent|

    Line 53: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: selector.instance_variable_set(:@workflow_selector, mock_workflow_selector)

    Line 54: Mocking internal AIDP class: Aidp::Workflows::GuidedAgent
      Pattern: allow().to receive
      Code: allow(Aidp::Workflows::GuidedAgent).to receive(:new).and_return(mock_guided_agent)

    Line 65: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(selector.instance_variable_get(:@tui)).to eq(mock_tui)

    Line 66: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(selector.instance_variable_get(:@project_dir)).to eq(project_dir)

    Line 67: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(selector.instance_variable_get(:@user_input)).to eq({})

    Line 68: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(selector.instance_variable_get(:@workflow_selector)).to be_a(Aidp::Workflows::Selector)

    Line 73: Mocking internal AIDP class: Aidp::Harness::UI::EnhancedTUI
      Pattern: instance_double
      Code: mock_default_tui = instance_double("Aidp::Harness::UI::EnhancedTUI")

    Line 73: Mocking internal AIDP class: Aidp::Harness::UI::EnhancedTUI
      Pattern: double
      Code: mock_default_tui = instance_double("Aidp::Harness::UI::EnhancedTUI")

    Line 74: Mocking internal AIDP class: Aidp::Harness::UI::EnhancedTUI
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::UI::EnhancedTUI).to receive(:new).and_return(mock_default_tui)

    Line 78: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(selector.instance_variable_get(:@tui)).to eq(mock_default_tui)

    Line 86: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(selector.instance_variable_get(:@project_dir)).to eq("/current/dir")

    Line 140: Mocking the instance under test (subject)
      Pattern: allow().to receive
      Code: allow(subject).to receive(:collect_project_info_interactive)

    Line 176: Mocking the instance under test (subject)
      Pattern: expect().to receive
      Code: expect(subject).to receive(:collect_project_info_interactive)

    Line 190: Mocking the instance under test (subject)
      Pattern: allow().to receive
      Code: allow(subject).to receive(:collect_project_info_interactive)

    Line 191: Mocking the instance under test (subject)
      Pattern: allow().to receive
      Code: allow(subject).to receive(:choose_workflow_type_interactive).and_return(:exploration)

    Line 192: Mocking the instance under test (subject)
      Pattern: allow().to receive
      Code: allow(subject).to receive(:generate_workflow_steps_interactive).with(:exploration).and_return(["00_PRD", "16_IMPLEMENTATION"])

    Line 217: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: user_input = real_subject.instance_variable_get(:@user_input)

    Line 255: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: user_input = real_subject.instance_variable_get(:@user_input)

    Line 376: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: user_input = subject.instance_variable_get(:@user_input)

--------------------------------------------------------------------------------
File: spec/aidp/harness/ui/error_handler_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (1):
    Line 30: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: logger = handler.instance_variable_get(:@logger)

--------------------------------------------------------------------------------
File: spec/aidp/harness/ui/job_monitor_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (5):
    Line 191: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(job_monitor.instance_variable_get(:@monitor_thread)).to be_a(Thread)

    Line 199: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: original_thread = job_monitor.instance_variable_get(:@monitor_thread)

    Line 202: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(job_monitor.instance_variable_get(:@monitor_thread)).to eq(original_thread)

    Line 220: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(job_monitor.instance_variable_get(:@monitor_thread)).to be_nil

    Line 239: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(job_monitor.instance_variable_get(:@update_callbacks)).to include(callback)

--------------------------------------------------------------------------------
File: spec/aidp/harness/ui/navigation/submenu_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (3):
    Line 99: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: submenu.instance_variable_set(:@current_level, 2)

    Line 104: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: submenu.instance_variable_set(:@current_level, 5)

    Line 156: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: submenu.instance_variable_set(:@current_level, 5)

--------------------------------------------------------------------------------
File: spec/aidp/harness/ui/navigation/workflow_selector_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (2):
    Line 29: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(selector.instance_variable_get(:@prompt)).to be_a(TTY::Prompt)

    Line 135: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(formatter.instance_variable_get(:@pastel)).not_to be_nil


  NEEDS REVIEW (1):
    Line 9: Mocking unknown class (might be internal): StateManager
      Pattern: instance_double
      Code: let(:state_manager) { instance_double("StateManager") }

--------------------------------------------------------------------------------
File: spec/aidp/harness/ui/spinner_helper_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (12):
    Line 71: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(helper.instance_variable_get(:@active_spinners)).not_to include(spinner_double)

    Line 172: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: helper.instance_variable_set(:@active_spinners, [spinner_double])

    Line 184: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: helper.instance_variable_set(:@active_spinners, [spinner_double, spinner_double])

    Line 193: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: helper.instance_variable_set(:@active_spinners, [spinner_double])

    Line 198: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(helper.instance_variable_get(:@active_spinners)).to be_empty

    Line 203: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: helper.instance_variable_set(:@active_spinners, [spinner_double])

    Line 214: Mocking internal AIDP class: Aidp::Harness::UI::SPINNER
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::UI::SPINNER).to receive(:with_spinner).and_call_original

    Line 215: Mocking internal AIDP class: Aidp::Harness::UI::SPINNER
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::UI::SPINNER).to receive(:with_loading_spinner).and_call_original

    Line 216: Mocking internal AIDP class: Aidp::Harness::UI::SPINNER
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::UI::SPINNER).to receive(:with_processing_spinner).and_call_original

    Line 217: Mocking internal AIDP class: Aidp::Harness::UI::SPINNER
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::UI::SPINNER).to receive(:with_saving_spinner).and_call_original

    Line 218: Mocking internal AIDP class: Aidp::Harness::UI::SPINNER
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::UI::SPINNER).to receive(:with_analyzing_spinner).and_call_original

    Line 219: Mocking internal AIDP class: Aidp::Harness::UI::SPINNER
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::UI::SPINNER).to receive(:with_building_spinner).and_call_original

--------------------------------------------------------------------------------
File: spec/aidp/harness/ui/workflow_controller_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (5):
    Line 51: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: workflow_controller.instance_variable_set(:@pause_time, Time.now - 60)

    Line 220: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(workflow_controller.instance_variable_get(:@control_thread)).to be_a(Thread)

    Line 228: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: original_thread = workflow_controller.instance_variable_get(:@control_thread)

    Line 231: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(workflow_controller.instance_variable_get(:@control_thread)).to eq(original_thread)

    Line 243: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(workflow_controller.instance_variable_get(:@control_thread)).to be_nil

--------------------------------------------------------------------------------
File: spec/aidp/harness/user_interface_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (4):
    Line 344: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(ui.instance_variable_get(:@auto_confirm_defaults)).to be true

    Line 345: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(ui.instance_variable_get(:@show_help_automatically)).to be false

    Line 346: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(ui.instance_variable_get(:@verbose_mode)).to be false

    Line 347: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(ui.instance_variable_get(:@file_selection_enabled)).to be true

--------------------------------------------------------------------------------
File: spec/aidp/harness/zfc_condition_detector_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (1):
    Line 25: Mocking internal AIDP class: Aidp::Harness::ThinkingDepthManager
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::ThinkingDepthManager).to receive(:new).and_return(


  NEEDS REVIEW (26):
    Line 32: Mocking unknown class (might be internal): Aidp
      Pattern: allow().to receive
      Code: allow(Aidp).to receive(:log_debug)

    Line 33: Mocking unknown class (might be internal): Aidp
      Pattern: allow().to receive
      Code: allow(Aidp).to receive(:log_error)

    Line 61: Mocking method call or complex expression: detector.legacy_detector
      Pattern: expect().to receive
      Code: expect(detector.legacy_detector).to receive(:is_rate_limited?).with(result, "anthropic")

    Line 67: Mocking method call or complex expression: detector.legacy_detector
      Pattern: allow().to receive
      Code: allow(detector.legacy_detector).to receive(:is_rate_limited?).and_return(true)

    Line 93: Mocking method call or complex expression: detector.ai_engine
      Pattern: expect().to receive
      Code: expect(detector.ai_engine).to receive(:decide).with(

    Line 136: Mocking method call or complex expression: detector.legacy_detector
      Pattern: allow().to receive
      Code: allow(detector.legacy_detector).to receive(:is_rate_limited?).and_return(true)

    Line 138: Mocking unknown class (might be internal): Aidp
      Pattern: expect().to receive
      Code: expect(Aidp).to receive(:log_error).with(

    Line 166: Mocking method call or complex expression: detector.legacy_detector
      Pattern: allow().to receive
      Code: allow(detector.legacy_detector).to receive(:is_rate_limited?).and_return(true)

    Line 175: Mocking method call or complex expression: detector.legacy_detector
      Pattern: allow().to receive
      Code: allow(detector.legacy_detector).to receive(:is_rate_limited?).and_return(false)

    Line 177: Mocking unknown class (might be internal): Aidp
      Pattern: expect().to receive
      Code: expect(Aidp).to receive(:log_debug).with(

    Line 200: Mocking method call or complex expression: detector.legacy_detector
      Pattern: expect().to receive
      Code: expect(detector.legacy_detector).to receive(:needs_user_feedback?).with(result)

    Line 256: Mocking method call or complex expression: detector.legacy_detector
      Pattern: expect().to receive
      Code: expect(detector.legacy_detector).to receive(:is_work_complete?).with(result, progress)

    Line 280: Mocking method call or complex expression: detector.ai_engine
      Pattern: expect().to receive
      Code: expect(detector.ai_engine).to receive(:decide).with(

    Line 318: Mocking method call or complex expression: detector.legacy_detector
      Pattern: allow().to receive
      Code: allow(detector.legacy_detector).to receive(:is_work_complete?).and_return(true)

    Line 320: Mocking unknown class (might be internal): Aidp
      Pattern: expect().to receive
      Code: expect(Aidp).to receive(:log_error).with(

    Line 338: Mocking method call or complex expression: detector.legacy_detector
      Pattern: expect().to receive
      Code: expect(detector.legacy_detector).to receive(:extract_questions).with(result)

    Line 348: Mocking method call or complex expression: detector.legacy_detector
      Pattern: expect().to receive
      Code: expect(detector.legacy_detector).to receive(:extract_rate_limit_info).with(result, "anthropic")

    Line 391: Mocking method call or complex expression: detector.legacy_detector
      Pattern: allow().to receive
      Code: allow(detector.legacy_detector).to receive(:is_rate_limited?).and_return(true, true, false)

    Line 450: Mocking method call or complex expression: detector.legacy_detector
      Pattern: expect().to receive
      Code: expect(detector.legacy_detector).to receive(:classify_error).with(test_error)

    Line 476: Mocking method call or complex expression: detector.ai_engine
      Pattern: expect().to receive
      Code: expect(detector.ai_engine).to receive(:decide).with(

    Line 498: Mocking method call or complex expression: detector.legacy_detector
      Pattern: allow().to receive
      Code: allow(detector.legacy_detector).to receive(:classify_error).and_return({error_type: :timeout})

    Line 513: Mocking method call or complex expression: detector.legacy_detector
      Pattern: allow().to receive
      Code: allow(detector.legacy_detector).to receive(:classify_error).and_return({error_type: :rate_limit})

    Line 515: Mocking unknown class (might be internal): Aidp
      Pattern: expect().to receive
      Code: expect(Aidp).to receive(:log_error).with(

    Line 543: Mocking method call or complex expression: detector.legacy_detector
      Pattern: allow().to receive
      Code: allow(detector.legacy_detector).to receive(:classify_error).and_return({error_type: :rate_limit})

    Line 552: Mocking method call or complex expression: detector.legacy_detector
      Pattern: allow().to receive
      Code: allow(detector.legacy_detector).to receive(:classify_error).and_return({error_type: :timeout})

    Line 554: Mocking unknown class (might be internal): Aidp
      Pattern: expect().to receive
      Code: expect(Aidp).to receive(:log_debug).with(

--------------------------------------------------------------------------------
File: spec/aidp/init/runner_spec.rb
--------------------------------------------------------------------------------

  NEEDS REVIEW (2):
    Line 351: Mocking unknown class (might be internal): Object
      Pattern: allow_any_instance_of
      Code: allow_any_instance_of(Object).to receive(:system).and_return(true)

    Line 361: Mocking unknown class (might be internal): Object
      Pattern: allow_any_instance_of
      Code: allow_any_instance_of(Object).to receive(:system).and_return(false)

--------------------------------------------------------------------------------
File: spec/aidp/jobs/background_runner_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (8):
    Line 35: Mocking internal AIDP class: Aidp::Harness::Runner
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::Runner).to receive(:new).and_return(double(run: {status: "completed"}))

    Line 40: Mocking internal AIDP class: Aidp::Concurrency::Wait
      Pattern: allow().to receive
      Code: allow(Aidp::Concurrency::Wait).to receive(:for_file).and_return(true)

    Line 69: Mocking internal AIDP class: Aidp::Harness::Runner
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::Runner).to receive(:new).and_return(double(run: {status: "completed"}))

    Line 73: Mocking internal AIDP class: Aidp::Concurrency::Wait
      Pattern: allow().to receive
      Code: allow(Aidp::Concurrency::Wait).to receive(:for_file).and_return(true)

    Line 96: Mocking internal AIDP class: Aidp::Harness::Runner
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::Runner).to receive(:new).and_return(double(run: {status: "completed"}))

    Line 100: Mocking internal AIDP class: Aidp::Concurrency::Wait
      Pattern: allow().to receive
      Code: allow(Aidp::Concurrency::Wait).to receive(:for_file).and_return(true)

    Line 135: Mocking internal AIDP class: Aidp::Harness::Runner
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::Runner).to receive(:new).and_return(double(run: {status: "completed"}))

    Line 139: Mocking internal AIDP class: Aidp::Concurrency::Wait
      Pattern: allow().to receive
      Code: allow(Aidp::Concurrency::Wait).to receive(:for_file).and_return(true)


  NEEDS REVIEW (9):
    Line 32: Mocking unknown class (might be internal): Process
      Pattern: allow().to receive
      Code: allow(Process).to receive(:daemon)

    Line 33: Mocking unknown class (might be internal): Process
      Pattern: allow().to receive
      Code: allow(Process).to receive(:detach)

    Line 66: Mocking unknown class (might be internal): Process
      Pattern: allow().to receive
      Code: allow(Process).to receive(:daemon)

    Line 67: Mocking unknown class (might be internal): Process
      Pattern: allow().to receive
      Code: allow(Process).to receive(:detach)

    Line 93: Mocking unknown class (might be internal): Process
      Pattern: allow().to receive
      Code: allow(Process).to receive(:daemon)

    Line 94: Mocking unknown class (might be internal): Process
      Pattern: allow().to receive
      Code: allow(Process).to receive(:detach)

    Line 116: Mocking unknown class (might be internal): Process
      Pattern: allow().to receive
      Code: allow(Process).to receive(:kill)

    Line 132: Mocking unknown class (might be internal): Process
      Pattern: allow().to receive
      Code: allow(Process).to receive(:daemon)

    Line 133: Mocking unknown class (might be internal): Process
      Pattern: allow().to receive
      Code: allow(Process).to receive(:detach)

--------------------------------------------------------------------------------
File: spec/aidp/logger_sanitization_spec.rb
--------------------------------------------------------------------------------

  NEEDS REVIEW (1):
    Line 36: Mocking unknown class (might be internal): Kernel
      Pattern: allow().to receive
      Code: allow(Kernel).to receive(:warn) do |msg|

--------------------------------------------------------------------------------
File: spec/aidp/logger_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (3):
    Line 435: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: Aidp.instance_variable_set(:@logger, nil)

    Line 439: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: Aidp.logger.close if Aidp.instance_variable_get(:@logger)

    Line 440: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: Aidp.instance_variable_set(:@logger, nil)


  NEEDS REVIEW (2):
    Line 302: Mocking unknown class (might be internal): Kernel
      Pattern: expect().to receive
      Code: expect(Kernel).to receive(:warn).with(/Failed to create log file/)

    Line 318: Mocking unknown class (might be internal): Kernel
      Pattern: allow().to receive
      Code: allow(Kernel).to receive(:warn) do |msg|

--------------------------------------------------------------------------------
File: spec/aidp/provider_manager_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (29):
    Line 8: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: described_class.instance_variable_set(:@harness_factory, nil)

    Line 52: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:get_harness_factory).and_return(factory)

    Line 105: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:get_harness_factory).and_return(factory)

    Line 126: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:get_harness_factory).and_return(nil)

    Line 139: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:get_harness_factory).and_return(nil)

    Line 148: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:get_harness_factory).and_return(factory)

    Line 158: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:get_harness_factory).and_return(nil)

    Line 167: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:get_harness_factory).and_return(factory)

    Line 177: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:get_harness_factory).and_return(nil)

    Line 187: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:get_harness_factory).and_return(factory)

    Line 198: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:get_harness_factory).and_return(nil)

    Line 206: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:get_harness_factory).and_return(factory)

    Line 216: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:get_harness_factory).and_return(factory)

    Line 226: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:get_harness_factory).and_return(nil)

    Line 234: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:get_harness_factory).and_return(factory)

    Line 244: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:get_harness_factory).and_return(nil)

    Line 253: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:get_harness_factory).and_return(factory)

    Line 263: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:get_harness_factory).and_return(nil)

    Line 271: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:get_harness_factory).and_return(factory)

    Line 281: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:get_harness_factory).and_return(nil)

    Line 290: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:get_harness_factory).and_return(factory)

    Line 300: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:get_harness_factory).and_return(nil)

    Line 309: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:get_harness_factory).and_return(factory)

    Line 319: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:get_harness_factory).and_return(nil)

    Line 328: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:get_harness_factory).and_return(factory)

    Line 341: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: described_class.instance_variable_set(:@harness_factory, factory)

    Line 349: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: described_class.instance_variable_set(:@harness_factory, nil)

    Line 359: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: described_class.instance_variable_set(:@harness_factory, factory)

    Line 367: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: described_class.instance_variable_set(:@harness_factory, nil)

--------------------------------------------------------------------------------
File: spec/aidp/providers/anthropic_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (7):
    Line 10: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:available?).and_return(true)

    Line 11: Mocking internal AIDP class: Aidp::Util
      Pattern: allow().to receive
      Code: allow(Aidp::Util).to receive(:which).with("claude").and_return("/usr/local/bin/claude")

    Line 20: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:available?).and_return(false)

    Line 90: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: provider.instance_variable_set(:@harness_context, harness_context)

    Line 94: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: provider.instance_variable_set(:@harness_context, nil)

    Line 165: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:available?).and_return(false)

    Line 319: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:available?).and_return(false)

--------------------------------------------------------------------------------
File: spec/aidp/providers/base_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (2):
    Line 307: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(provider.instance_variable_get(:@output_count)).to eq(1)

    Line 308: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(provider.instance_variable_get(:@last_output_time)).to be_a(Time)

--------------------------------------------------------------------------------
File: spec/aidp/providers/capability_registry_spec.rb
--------------------------------------------------------------------------------

  NEEDS REVIEW (1):
    Line 46: Mocking unknown class (might be internal): Aidp
      Pattern: expect().to receive
      Code: expect(Aidp).to receive(:log_debug).with(

--------------------------------------------------------------------------------
File: spec/aidp/providers/codex_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (17):
    Line 14: Mocking internal AIDP class: Aidp::Util
      Pattern: allow().to receive
      Code: allow(Aidp::Util).to receive(:which).with("codex").and_return("/usr/local/bin/codex")

    Line 24: Mocking internal AIDP class: Aidp::Util
      Pattern: allow().to receive
      Code: allow(Aidp::Util).to receive(:which).with("codex").and_return(nil)

    Line 42: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:available?).and_return(true)

    Line 44: Mocking internal AIDP class: Aidp::Util
      Pattern: allow().to receive
      Code: allow(Aidp::Util).to receive(:execute_command)

    Line 56: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:available?).and_return(false)

    Line 71: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:available?).and_return(true)

    Line 88: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:available?).and_return(false)

    Line 224: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:available?).and_return(true) # Stub availability

    Line 270: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:available?).and_return(true) # Stub availability

    Line 289: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: provider.instance_variable_set(:@adaptive_timeout, nil)

    Line 316: Mocking internal AIDP class: Aidp::Util
      Pattern: allow().to receive
      Code: allow(Aidp::Util).to receive(:execute_command).and_raise(StandardError.new("Command failed"))

    Line 327: Mocking internal AIDP class: Aidp::Util
      Pattern: allow().to receive
      Code: allow(Aidp::Util).to receive(:execute_command)

    Line 341: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:available?).and_return(false)

    Line 351: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:available?).and_return(true)

    Line 352: Mocking internal AIDP class: Aidp::Util
      Pattern: allow().to receive
      Code: allow(Aidp::Util).to receive(:execute_command).and_raise(StandardError.new("Command failed"))

    Line 362: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:available?).and_return(true)

    Line 364: Mocking internal AIDP class: Aidp::Util
      Pattern: allow().to receive
      Code: allow(Aidp::Util).to receive(:execute_command)


  NEEDS REVIEW (3):
    Line 104: Mocking unknown class (might be internal): Thread
      Pattern: allow().to receive
      Code: allow(Thread).to receive(:new).and_return(thread_mock)

    Line 128: Mocking unknown class (might be internal): Thread
      Pattern: allow().to receive
      Code: allow(Thread).to receive(:new).and_return(thread_mock)

    Line 156: Mocking unknown class (might be internal): Thread
      Pattern: allow().to receive
      Code: allow(Thread).to receive(:new).and_return(thread_mock)

--------------------------------------------------------------------------------
File: spec/aidp/providers/cursor_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (5):
    Line 9: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:available?).and_return(true)

    Line 10: Mocking internal AIDP class: Aidp::Util
      Pattern: allow().to receive
      Code: allow(Aidp::Util).to receive(:which).with("cursor-agent").and_return("/usr/local/bin/cursor-agent")

    Line 15: Mocking internal AIDP class: Aidp::Util
      Pattern: allow().to receive
      Code: allow(Aidp::Util).to receive(:which).with("cursor-agent").and_return("/usr/local/bin/cursor-agent")

    Line 20: Mocking internal AIDP class: Aidp::Util
      Pattern: allow().to receive
      Code: allow(Aidp::Util).to receive(:which).with("cursor-agent").and_return(nil)

    Line 21: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:available?).and_return(false)

--------------------------------------------------------------------------------
File: spec/aidp/providers/gemini_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (4):
    Line 11: Mocking internal AIDP class: Aidp::Util
      Pattern: allow().to receive
      Code: allow(Aidp::Util).to receive(:which).with("gemini").and_return("/usr/local/bin/gemini")

    Line 17: Mocking internal AIDP class: Aidp::Util
      Pattern: allow().to receive
      Code: allow(Aidp::Util).to receive(:which).with("gemini").and_return(nil)

    Line 39: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:available?).and_return(true)

    Line 105: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:available?).and_return(false)

--------------------------------------------------------------------------------
File: spec/aidp/providers/github_copilot_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (17):
    Line 14: Mocking internal AIDP class: Aidp::Util
      Pattern: allow().to receive
      Code: allow(Aidp::Util).to receive(:which).with("copilot").and_return("/usr/local/bin/copilot")

    Line 24: Mocking internal AIDP class: Aidp::Util
      Pattern: allow().to receive
      Code: allow(Aidp::Util).to receive(:which).with("copilot").and_return(nil)

    Line 42: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:available?).and_return(true)

    Line 44: Mocking internal AIDP class: Aidp::Util
      Pattern: allow().to receive
      Code: allow(Aidp::Util).to receive(:execute_command)

    Line 56: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:available?).and_return(false)

    Line 71: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:available?).and_return(true)

    Line 88: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:available?).and_return(false)

    Line 221: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:available?).and_return(true) # Stub availability

    Line 267: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:available?).and_return(true) # Stub availability

    Line 287: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: provider.instance_variable_set(:@adaptive_timeout, nil)

    Line 314: Mocking internal AIDP class: Aidp::Util
      Pattern: allow().to receive
      Code: allow(Aidp::Util).to receive(:execute_command).and_raise(StandardError.new("Command failed"))

    Line 325: Mocking internal AIDP class: Aidp::Util
      Pattern: allow().to receive
      Code: allow(Aidp::Util).to receive(:execute_command)

    Line 339: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:available?).and_return(false)

    Line 349: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:available?).and_return(true)

    Line 350: Mocking internal AIDP class: Aidp::Util
      Pattern: allow().to receive
      Code: allow(Aidp::Util).to receive(:execute_command).and_raise(StandardError.new("Command failed"))

    Line 360: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:available?).and_return(true)

    Line 362: Mocking internal AIDP class: Aidp::Util
      Pattern: allow().to receive
      Code: allow(Aidp::Util).to receive(:execute_command)


  NEEDS REVIEW (3):
    Line 104: Mocking unknown class (might be internal): Thread
      Pattern: allow().to receive
      Code: allow(Thread).to receive(:new).and_return(thread_mock)

    Line 128: Mocking unknown class (might be internal): Thread
      Pattern: allow().to receive
      Code: allow(Thread).to receive(:new).and_return(thread_mock)

    Line 156: Mocking unknown class (might be internal): Thread
      Pattern: allow().to receive
      Code: allow(Thread).to receive(:new).and_return(thread_mock)

--------------------------------------------------------------------------------
File: spec/aidp/providers/kilocode_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (14):
    Line 11: Mocking internal AIDP class: Aidp::Util
      Pattern: allow().to receive
      Code: allow(Aidp::Util).to receive(:which).with("kilocode").and_return(nil)

    Line 16: Mocking internal AIDP class: Aidp::Util
      Pattern: allow().to receive
      Code: allow(Aidp::Util).to receive(:which).with("kilocode").and_return("/usr/local/bin/kilocode")

    Line 96: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(provider.instance_variable_get(:@activity_state)).to eq(:completed)

    Line 103: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(provider.instance_variable_get(:@activity_state)).to eq(:failed)

    Line 165: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:available?).and_return(false)

    Line 173: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:available?).and_return(true)

    Line 190: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:available?).and_return(true)

    Line 205: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:available?).and_return(true)

    Line 223: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:available?).and_return(true)

    Line 240: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:available?).and_return(true)

    Line 251: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:available?).and_return(true)

    Line 258: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(provider.instance_variable_get(:@activity_state)).to eq(:failed)

    Line 262: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:available?).and_return(true)

    Line 277: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:available?).and_return(true)

--------------------------------------------------------------------------------
File: spec/aidp/providers/opencode_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (11):
    Line 11: Mocking internal AIDP class: Aidp::Util
      Pattern: allow().to receive
      Code: allow(Aidp::Util).to receive(:which).with("opencode").and_return(nil)

    Line 16: Mocking internal AIDP class: Aidp::Util
      Pattern: allow().to receive
      Code: allow(Aidp::Util).to receive(:which).with("opencode").and_return("/usr/local/bin/opencode")

    Line 96: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(provider.instance_variable_get(:@activity_state)).to eq(:completed)

    Line 103: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(provider.instance_variable_get(:@activity_state)).to eq(:failed)

    Line 165: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:available?).and_return(false)

    Line 173: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:available?).and_return(true)

    Line 190: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:available?).and_return(true)

    Line 205: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:available?).and_return(true)

    Line 216: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:available?).and_return(true)

    Line 223: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(provider.instance_variable_get(:@activity_state)).to eq(:failed)

    Line 227: Mocking the class under test (described_class)
      Pattern: allow().to receive
      Code: allow(described_class).to receive(:available?).and_return(true)

--------------------------------------------------------------------------------
File: spec/aidp/rescue_logging_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (1):
    Line 28: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: Aidp.instance_variable_set(:@logger, logger)

--------------------------------------------------------------------------------
File: spec/aidp/safe_directory_spec.rb
--------------------------------------------------------------------------------

  NEEDS REVIEW (1):
    Line 87: Mocking unknown class (might be internal): Kernel
      Pattern: expect().to receive
      Code: expect(Kernel).to receive(:warn).with(/TestComponent/).at_least(:once)

--------------------------------------------------------------------------------
File: spec/aidp/setup/wizard_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (61):
    Line 34: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: threads = wizard.instance_variable_get(:@discovery_threads)

    Line 54: Mocking internal AIDP class: Aidp::Util
      Pattern: allow().to receive
      Code: allow(Aidp::Util).to receive(:which).and_return("/usr/bin/fake")

    Line 379: Mocking internal AIDP class: Aidp::Util
      Pattern: allow().to receive
      Code: allow(Aidp::Util).to receive(:which).and_return(nil)

    Line 382: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(wizard.instance_variable_get(:@warnings)).to include(/Command 'nonexistent-command' not found/)

    Line 388: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(wizard.instance_variable_get(:@warnings)).to be_empty

    Line 394: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(wizard.instance_variable_get(:@warnings)).to be_empty

    Line 400: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(wizard.instance_variable_get(:@warnings)).to be_empty

    Line 404: Mocking internal AIDP class: Aidp::Util
      Pattern: allow().to receive
      Code: allow(Aidp::Util).to receive(:which).and_return("/usr/bin/found")

    Line 407: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(wizard.instance_variable_get(:@warnings)).to be_empty

    Line 550: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(wizard.instance_variable_get(:@warnings)).not_to be_empty

    Line 551: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(wizard.instance_variable_get(:@existing_config)).to eq({})

    Line 572: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: wizard.instance_variable_get(:@config)[:providers] = {

    Line 579: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: providers = wizard.instance_variable_get(:@config)[:providers]

    Line 585: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: wizard.instance_variable_get(:@config)[:providers] = {

    Line 589: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: providers = wizard.instance_variable_get(:@config)[:providers]

    Line 595: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: wizard.instance_variable_get(:@config)[:providers] = {

    Line 600: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: providers = wizard.instance_variable_get(:@config)[:providers]

    Line 630: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: providers = wizard.instance_variable_get(:@config)[:providers]

    Line 665: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: providers = wizard.instance_variable_get(:@config)[:providers]

    Line 709: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: providers = wizard.instance_variable_get(:@config)[:providers]

    Line 782: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: providers = wizard.instance_variable_get(:@config)[:providers]

    Line 831: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: providers = wizard.instance_variable_get(:@config)[:providers]

    Line 867: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: providers = wizard.instance_variable_get(:@config)[:providers]

    Line 903: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: harness_config = wizard.instance_variable_get(:@config)[:harness]

    Line 940: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: harness_config = wizard.instance_variable_get(:@config)[:harness]

    Line 975: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: harness_config = wizard.instance_variable_get(:@config)[:harness]

    Line 1005: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: harness_config = wizard.instance_variable_get(:@config)[:harness]

    Line 1075: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: wizard.instance_variable_get(:@config)[:providers] = {

    Line 1079: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: providers = wizard.instance_variable_get(:@config)[:providers]

    Line 1085: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: wizard.instance_variable_get(:@config)[:providers] = {

    Line 1090: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: providers = wizard.instance_variable_get(:@config)[:providers]

    Line 1097: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: wizard.instance_variable_get(:@config)[:providers] = {

    Line 1101: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: providers = wizard.instance_variable_get(:@config)[:providers]

    Line 1141: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: threads = wizard.instance_variable_get(:@discovery_threads)

    Line 1156: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: threads = wizard.instance_variable_get(:@discovery_threads)

    Line 1165: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: threads = wizard.instance_variable_get(:@discovery_threads)

    Line 1170: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: threads = wizard.instance_variable_get(:@discovery_threads)

    Line 1183: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: wizard.instance_variable_set(:@discovery_threads, [{thread: thread, provider: "anthropic"}])

    Line 1187: Mocking internal AIDP class: Aidp::Harness::ModelCache
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::ModelCache).to receive(:new).and_return(cache)

    Line 1200: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: threads = wizard.instance_variable_get(:@discovery_threads)

    Line 1209: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: wizard.instance_variable_set(:@discovery_threads, [{thread: thread, provider: "anthropic"}])

    Line 1214: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: threads = wizard.instance_variable_get(:@discovery_threads)

    Line 1242: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: threads = wizard.instance_variable_get(:@discovery_threads)

    Line 1249: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: wizard.instance_variable_set(:@discovery_threads, nil)

    Line 1258: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: wizard.instance_variable_set(:@discovery_threads, [{thread: thread, provider: "anthropic"}])

    Line 1261: Mocking internal AIDP class: Aidp::Harness::ModelCache
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::ModelCache).to receive(:new).and_raise(StandardError.new("Cache error"))

    Line 1275: Mocking internal AIDP class: Aidp::Providers::Anthropic
      Pattern: class_double
      Code: provider_class = class_double("Aidp::Providers::Anthropic")

    Line 1275: Mocking internal AIDP class: Aidp::Providers::Anthropic
      Pattern: double
      Code: provider_class = class_double("Aidp::Providers::Anthropic")

    Line 1286: Mocking internal AIDP class: Aidp::Providers::Cursor
      Pattern: class_double
      Code: provider_class = class_double("Aidp::Providers::Cursor")

    Line 1286: Mocking internal AIDP class: Aidp::Providers::Cursor
      Pattern: double
      Code: provider_class = class_double("Aidp::Providers::Cursor")

    Line 1309: Mocking internal AIDP class: Aidp::Harness::ModelDiscoveryService
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::ModelDiscoveryService).to receive(:new).and_return(discovery_service)

    Line 1317: Mocking internal AIDP class: Aidp::Harness::ModelDiscoveryService
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::ModelDiscoveryService).to receive(:new).and_return(discovery_service)

    Line 1325: Mocking internal AIDP class: Aidp::Harness::ModelDiscoveryService
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::ModelDiscoveryService).to receive(:new).and_return(discovery_service)

    Line 1333: Mocking internal AIDP class: Aidp::Harness::ModelDiscoveryService
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::ModelDiscoveryService).to receive(:new).and_return(discovery_service)

    Line 1342: Mocking internal AIDP class: Aidp::Harness::ModelDiscoveryService
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::ModelDiscoveryService).to receive(:new).and_return(discovery_service)

    Line 1354: Mocking internal AIDP class: Aidp::Harness::ModelDiscoveryService
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::ModelDiscoveryService).to receive(:new).and_return(discovery_service)

    Line 1364: Mocking internal AIDP class: Aidp::Harness::ModelDiscoveryService
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::ModelDiscoveryService).to receive(:new).and_return(discovery_service)

    Line 1403: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: config = wizard.instance_variable_get(:@config)

    Line 1415: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: config = wizard.instance_variable_get(:@config)

    Line 1457: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: config = wizard.instance_variable_get(:@config)

    Line 1469: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: config = wizard.instance_variable_get(:@config)


  NEEDS REVIEW (2):
    Line 1345: Mocking unknown class (might be internal): Aidp
      Pattern: expect().to receive
      Code: expect(Aidp).to receive(:log_debug).with("setup_wizard", "background discovery failed",

    Line 1367: Mocking unknown class (might be internal): Aidp
      Pattern: expect().to receive
      Code: expect(Aidp).to receive(:log_info).with("setup_wizard", "discovered models in background",

--------------------------------------------------------------------------------
File: spec/aidp/skills/wizard/controller_spec.rb
--------------------------------------------------------------------------------

  NEEDS REVIEW (9):
    Line 46: Mocking method call or complex expression: controller.prompter
      Pattern: allow().to receive
      Code: allow(controller.prompter).to receive(:gather_responses).and_raise(Interrupt)

    Line 51: Mocking method call or complex expression: controller.prompter
      Pattern: allow().to receive
      Code: allow(controller.prompter).to receive(:gather_responses).and_raise(StandardError, "test error")

    Line 68: Mocking method call or complex expression: controller.prompter
      Pattern: allow().to receive
      Code: allow(controller.prompter).to receive(:gather_responses).and_return(responses)

    Line 86: Mocking method call or complex expression: mini_controller.prompter
      Pattern: allow().to receive
      Code: allow(mini_controller.prompter).to receive(:gather_responses).and_return(responses)

    Line 97: Mocking method call or complex expression: yes_controller.prompter
      Pattern: allow().to receive
      Code: allow(yes_controller.prompter).to receive(:gather_responses).and_return(responses)

    Line 107: Mocking method call or complex expression: overwrite_controller.prompter
      Pattern: allow().to receive
      Code: allow(overwrite_controller.prompter).to receive(:gather_responses).and_return(responses)

    Line 112: Mocking method call or complex expression: overwrite_controller.writer
      Pattern: allow().to receive
      Code: allow(overwrite_controller.writer).to receive(:exists?).with("exists").and_return(true)

    Line 120: Mocking method call or complex expression: dry_controller.prompter
      Pattern: allow().to receive
      Code: allow(dry_controller.prompter).to receive(:gather_responses).and_return(responses)

    Line 125: Mocking method call or complex expression: dry_controller.writer
      Pattern: expect().to receive
      Code: expect(dry_controller.writer).to receive(:write).with(instance_of(Aidp::Skills::Skill), hash_including(content: /Dry/, dry_run: true, backup: true)).and_call_original

--------------------------------------------------------------------------------
File: spec/aidp/skills/wizard/prompter_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (1):
    Line 24: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(prompter.instance_variable_get(:@prompt)).to be_a(TTY::Prompt)


  NEEDS REVIEW (24):
    Line 70: Mocking method call or complex expression: prompter.prompt
      Pattern: allow().to receive
      Code: allow(prompter.prompt).to receive(:ask).and_return("Test", "test", "Description", "1.0.0")

    Line 102: Mocking method call or complex expression: prompter.prompt
      Pattern: allow().to receive
      Code: allow(prompter.prompt).to receive(:say)

    Line 103: Mocking method call or complex expression: prompter.prompt
      Pattern: allow().to receive
      Code: allow(prompter.prompt).to receive(:select).and_return(:from_scratch)

    Line 111: Mocking method call or complex expression: prompter.prompt
      Pattern: allow().to receive
      Code: allow(prompter.prompt).to receive(:say)

    Line 112: Mocking method call or complex expression: prompter.prompt
      Pattern: allow().to receive
      Code: allow(prompter.prompt).to receive(:select).and_return(:inherit)

    Line 124: Mocking method call or complex expression: prompter.prompt
      Pattern: allow().to receive
      Code: allow(prompter.prompt).to receive(:warn)

    Line 136: Mocking method call or complex expression: prompter.prompt
      Pattern: allow().to receive
      Code: allow(prompter.prompt).to receive(:select).and_return("skill1")

    Line 146: Mocking method call or complex expression: prompter.prompt
      Pattern: allow().to receive
      Code: allow(prompter.prompt).to receive(:ask).and_return("Test Skill", "test_skill", "A test", "1.0.0")

    Line 159: Mocking method call or complex expression: prompter.prompt
      Pattern: allow().to receive
      Code: allow(prompter.prompt).to receive(:say)

    Line 160: Mocking method call or complex expression: prompter.prompt
      Pattern: allow().to receive
      Code: allow(prompter.prompt).to receive(:ask).and_return("Ruby", "", "rails, testing")

    Line 171: Mocking method call or complex expression: prompter.prompt
      Pattern: allow().to receive
      Code: allow(prompter.prompt).to receive(:say)

    Line 172: Mocking method call or complex expression: prompter.prompt
      Pattern: allow().to receive
      Code: allow(prompter.prompt).to receive(:ask).and_return("Building APIs", "", "Simple scripts", "")

    Line 255: Mocking method call or complex expression: prompter.prompt
      Pattern: allow().to receive
      Code: allow(prompter.prompt).to receive(:say)

    Line 256: Mocking method call or complex expression: prompter.prompt
      Pattern: allow().to receive
      Code: allow(prompter.prompt).to receive(:yes?).and_return(false)

    Line 262: Mocking method call or complex expression: prompter.prompt
      Pattern: allow().to receive
      Code: allow(prompter.prompt).to receive(:say)

    Line 263: Mocking method call or complex expression: prompter.prompt
      Pattern: allow().to receive
      Code: allow(prompter.prompt).to receive(:yes?).and_return(true)

    Line 273: Mocking method call or complex expression: prompter.prompt
      Pattern: allow().to receive
      Code: allow(prompter.prompt).to receive(:say)

    Line 274: Mocking method call or complex expression: prompter.prompt
      Pattern: allow().to receive
      Code: allow(prompter.prompt).to receive(:multiline).and_return(["Line 1", "Line 2"])

    Line 280: Mocking method call or complex expression: prompter.prompt
      Pattern: allow().to receive
      Code: allow(prompter.prompt).to receive(:say)

    Line 281: Mocking method call or complex expression: prompter.prompt
      Pattern: allow().to receive
      Code: allow(prompter.prompt).to receive(:multiline).and_return([])

    Line 290: Mocking method call or complex expression: prompter.prompt
      Pattern: allow().to receive
      Code: allow(prompter.prompt).to receive(:select).and_return([])

    Line 296: Mocking method call or complex expression: prompter.prompt
      Pattern: allow().to receive
      Code: allow(prompter.prompt).to receive(:select).and_return(["anthropic"])

    Line 302: Mocking method call or complex expression: prompter.prompt
      Pattern: allow().to receive
      Code: allow(prompter.prompt).to receive(:select).and_return(:custom)

    Line 303: Mocking method call or complex expression: prompter.prompt
      Pattern: allow().to receive
      Code: allow(prompter.prompt).to receive(:multi_select).and_return(["anthropic", "openai"])

--------------------------------------------------------------------------------
File: spec/aidp/watch/build_processor_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (25):
    Line 184: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: processor.instance_variable_set(:@config, nil) # Force config reload

    Line 269: Mocking internal AIDP class: Aidp::Worktree
      Pattern: allow().to receive
      Code: allow(Aidp::Worktree).to receive(:info).and_return(nil)

    Line 270: Mocking internal AIDP class: Aidp::Worktree
      Pattern: expect().to receive
      Code: expect(Aidp::Worktree).to receive(:create).with(

    Line 293: Mocking internal AIDP class: Aidp::Worktree
      Pattern: allow().to receive
      Code: allow(Aidp::Worktree).to receive(:info).and_return(existing_ws)

    Line 317: Mocking internal AIDP class: Aidp::Worktree
      Pattern: allow().to receive
      Code: allow(Aidp::Worktree).to receive(:info).and_return(nil)

    Line 318: Mocking internal AIDP class: Aidp::Worktree
      Pattern: allow().to receive
      Code: allow(Aidp::Worktree).to receive(:create).and_return({path: "#{tmp_dir}/.worktrees/issue-77-implement-search"})

    Line 330: Mocking internal AIDP class: Aidp::Worktree
      Pattern: allow().to receive
      Code: allow(Aidp::Worktree).to receive(:info).and_return(nil)

    Line 331: Mocking internal AIDP class: Aidp::Worktree
      Pattern: allow().to receive
      Code: allow(Aidp::Worktree).to receive(:create).and_return({path: "#{tmp_dir}/.worktrees/issue-77-implement-search"})

    Line 343: Mocking internal AIDP class: Aidp::Worktree
      Pattern: allow().to receive
      Code: allow(Aidp::Worktree).to receive(:info).and_return(nil)

    Line 344: Mocking internal AIDP class: Aidp::Worktree
      Pattern: allow().to receive
      Code: allow(Aidp::Worktree).to receive(:create).and_return({path: "#{tmp_dir}/.worktrees/issue-77-implement-search"})

    Line 357: Mocking internal AIDP class: Aidp::Worktree
      Pattern: allow().to receive
      Code: allow(Aidp::Worktree).to receive(:info).and_return(nil)

    Line 358: Mocking internal AIDP class: Aidp::Worktree
      Pattern: allow().to receive
      Code: allow(Aidp::Worktree).to receive(:create).and_return({path: "#{tmp_dir}/.worktrees/issue-77-implement-search"})

    Line 373: Mocking internal AIDP class: Aidp::Worktree
      Pattern: allow().to receive
      Code: allow(Aidp::Worktree).to receive(:info).and_return(nil)

    Line 374: Mocking internal AIDP class: Aidp::Worktree
      Pattern: allow().to receive
      Code: allow(Aidp::Worktree).to receive(:create).and_return({path: worktree_path})

    Line 387: Mocking internal AIDP class: Aidp::Worktree
      Pattern: allow().to receive
      Code: allow(Aidp::Worktree).to receive(:info).and_return(nil)

    Line 388: Mocking internal AIDP class: Aidp::Worktree
      Pattern: allow().to receive
      Code: allow(Aidp::Worktree).to receive(:create).and_return({path: workstream_path})

    Line 439: Mocking internal AIDP class: Aidp::Worktree
      Pattern: allow().to receive
      Code: allow(Aidp::Worktree).to receive(:info).and_return(nil)

    Line 440: Mocking internal AIDP class: Aidp::Worktree
      Pattern: allow().to receive
      Code: allow(Aidp::Worktree).to receive(:create).and_return({path: workstream_path})

    Line 466: Mocking internal AIDP class: Aidp::Harness::Runner
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::Runner).to receive(:new).and_return(runner)

    Line 586: Mocking internal AIDP class: Aidp::Harness::Runner
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::Runner).to receive(:new).and_return(runner)

    Line 654: Mocking internal AIDP class: Aidp::Harness::StateManager
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::StateManager).to receive(:new).and_return(state_manager)

    Line 657: Mocking internal AIDP class: Aidp::Execute::Progress
      Pattern: allow().to receive
      Code: allow(Aidp::Execute::Progress).to receive(:new).and_return(progress)

    Line 660: Mocking internal AIDP class: Aidp::Harness::Runner
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::Runner).to receive(:new).and_return(runner)

    Line 688: Mocking internal AIDP class: Aidp::Harness::Runner
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::Runner).to receive(:new).and_return(runner)

    Line 914: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: processor.instance_variable_set(:@config, nil)


  NEEDS REVIEW (5):
    Line 477: Mocking unknown class (might be internal): Aidp
      Pattern: expect().to receive
      Code: expect(Aidp).to receive(:log_error).with(

    Line 485: Mocking unknown class (might be internal): Aidp
      Pattern: expect().to receive
      Code: expect(Aidp).to receive(:log_error).with(

    Line 504: Mocking unknown class (might be internal): Aidp
      Pattern: expect().to receive
      Code: expect(Aidp).to receive(:log_error).with(

    Line 513: Mocking unknown class (might be internal): Aidp
      Pattern: expect().to receive
      Code: expect(Aidp).to receive(:log_error).with(

    Line 595: Mocking unknown class (might be internal): Aidp
      Pattern: allow().to receive
      Code: allow(Aidp).to receive(:log_error)

--------------------------------------------------------------------------------
File: spec/aidp/watch/build_processor_vcs_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (11):
    Line 41: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: processor.instance_variable_set(:@config, nil)

    Line 53: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: processor.instance_variable_set(:@config, nil)

    Line 65: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: processor.instance_variable_set(:@config, nil)

    Line 77: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: processor.instance_variable_set(:@config, nil)

    Line 89: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: processor.instance_variable_set(:@config, nil)

    Line 102: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: processor.instance_variable_set(:@config, nil)

    Line 114: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: processor.instance_variable_set(:@config, nil)

    Line 159: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: processor.instance_variable_set(:@config, nil)

    Line 196: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: processor.instance_variable_set(:@config, nil)

    Line 219: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: processor.instance_variable_set(:@config, nil)

    Line 241: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: processor.instance_variable_set(:@config, nil)

--------------------------------------------------------------------------------
File: spec/aidp/watch/change_request_processor_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (1):
    Line 422: Mocking internal AIDP class: Aidp::Harness::ConfigManager
      Pattern: allow_any_instance_of
      Code: allow_any_instance_of(Aidp::Harness::ConfigManager).to receive(:default_provider).and_raise(StandardError)

--------------------------------------------------------------------------------
File: spec/aidp/watch/ci_fix_processor_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (6):
    Line 84: Mocking internal AIDP class: Aidp::ProviderManager
      Pattern: allow().to receive
      Code: allow(Aidp::ProviderManager).to receive(:get_provider).and_return(provider)

    Line 119: Mocking internal AIDP class: Aidp::ProviderManager
      Pattern: allow().to receive
      Code: allow(Aidp::ProviderManager).to receive(:get_provider).and_return(provider)

    Line 280: Mocking internal AIDP class: Aidp::ProviderManager
      Pattern: allow().to receive
      Code: allow(Aidp::ProviderManager).to receive(:get_provider).and_return(provider)

    Line 294: Mocking internal AIDP class: Aidp::ProviderManager
      Pattern: allow().to receive
      Code: allow(Aidp::ProviderManager).to receive(:get_provider).and_return(provider)

    Line 305: Mocking internal AIDP class: Aidp::ProviderManager
      Pattern: allow().to receive
      Code: allow(Aidp::ProviderManager).to receive(:get_provider).and_raise(StandardError.new("Provider error"))

    Line 316: Mocking internal AIDP class: Aidp::ProviderManager
      Pattern: allow().to receive
      Code: allow(Aidp::ProviderManager).to receive(:get_provider).and_return(provider)


  NEEDS REVIEW (2):
    Line 296: Mocking unknown class (might be internal): Aidp
      Pattern: allow().to receive
      Code: allow(Aidp).to receive(:log_error)

    Line 306: Mocking unknown class (might be internal): Aidp
      Pattern: allow().to receive
      Code: allow(Aidp).to receive(:log_error)

--------------------------------------------------------------------------------
File: spec/aidp/watch/plan_generator_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (6):
    Line 180: Mocking internal AIDP class: Aidp::ProviderManager
      Pattern: allow().to receive
      Code: allow(Aidp::ProviderManager).to receive(:get_provider).and_return(mock_provider)

    Line 189: Mocking internal AIDP class: Aidp::ProviderManager
      Pattern: allow().to receive
      Code: allow(Aidp::ProviderManager).to receive(:get_provider).and_return(mock_provider)

    Line 197: Mocking internal AIDP class: Aidp::ProviderManager
      Pattern: allow().to receive
      Code: allow(Aidp::ProviderManager).to receive(:get_provider).and_raise(StandardError, "Provider error")

    Line 208: Mocking internal AIDP class: Aidp::Harness::ConfigManager
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::ConfigManager).to receive(:new).and_return(mock_config)

    Line 216: Mocking internal AIDP class: Aidp::Harness::ConfigManager
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::ConfigManager).to receive(:new).and_return(mock_config)

    Line 223: Mocking internal AIDP class: Aidp::Harness::ConfigManager
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::ConfigManager).to receive(:new).and_raise(StandardError)


  NEEDS REVIEW (3):
    Line 139: Mocking method call or complex expression: provider1
      Pattern: allow().to receive
      Code: allow(provider1).to receive(:send_message).and_raise(Timeout::Error, "Timeout")

    Line 140: Mocking method call or complex expression: provider2
      Pattern: allow().to receive
      Code: allow(provider2).to receive(:send_message).and_return(provider_response)

    Line 151: Mocking method call or complex expression: provider2
      Pattern: allow().to receive
      Code: allow(provider2).to receive(:send_message).and_return(provider_response)

--------------------------------------------------------------------------------
File: spec/aidp/watch/review_processor_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (12):
    Line 48: Mocking internal AIDP class: Aidp::Watch::Reviewers::SeniorDevReviewer
      Pattern: allow_any_instance_of
      Code: allow_any_instance_of(Aidp::Watch::Reviewers::SeniorDevReviewer).to receive(:review).and_return(

    Line 51: Mocking internal AIDP class: Aidp::Watch::Reviewers::SecurityReviewer
      Pattern: allow_any_instance_of
      Code: allow_any_instance_of(Aidp::Watch::Reviewers::SecurityReviewer).to receive(:review).and_return(

    Line 54: Mocking internal AIDP class: Aidp::Watch::Reviewers::PerformanceReviewer
      Pattern: allow_any_instance_of
      Code: allow_any_instance_of(Aidp::Watch::Reviewers::PerformanceReviewer).to receive(:review).and_return(

    Line 73: Mocking internal AIDP class: Aidp::Watch::Reviewers::SeniorDevReviewer
      Pattern: allow_any_instance_of
      Code: allow_any_instance_of(Aidp::Watch::Reviewers::SeniorDevReviewer).to receive(:review).and_return(

    Line 76: Mocking internal AIDP class: Aidp::Watch::Reviewers::SecurityReviewer
      Pattern: allow_any_instance_of
      Code: allow_any_instance_of(Aidp::Watch::Reviewers::SecurityReviewer).to receive(:review).and_return(

    Line 79: Mocking internal AIDP class: Aidp::Watch::Reviewers::PerformanceReviewer
      Pattern: allow_any_instance_of
      Code: allow_any_instance_of(Aidp::Watch::Reviewers::PerformanceReviewer).to receive(:review).and_return(

    Line 104: Mocking internal AIDP class: Aidp::Watch::Reviewers::SeniorDevReviewer
      Pattern: allow_any_instance_of
      Code: allow_any_instance_of(Aidp::Watch::Reviewers::SeniorDevReviewer).to receive(:review).and_return(

    Line 113: Mocking internal AIDP class: Aidp::Watch::Reviewers::SecurityReviewer
      Pattern: allow_any_instance_of
      Code: allow_any_instance_of(Aidp::Watch::Reviewers::SecurityReviewer).to receive(:review).and_return(

    Line 116: Mocking internal AIDP class: Aidp::Watch::Reviewers::PerformanceReviewer
      Pattern: allow_any_instance_of
      Code: allow_any_instance_of(Aidp::Watch::Reviewers::PerformanceReviewer).to receive(:review).and_return(

    Line 138: Mocking internal AIDP class: Aidp::Watch::Reviewers::SeniorDevReviewer
      Pattern: allow_any_instance_of
      Code: allow_any_instance_of(Aidp::Watch::Reviewers::SeniorDevReviewer).to receive(:review).and_return(

    Line 141: Mocking internal AIDP class: Aidp::Watch::Reviewers::SecurityReviewer
      Pattern: allow_any_instance_of
      Code: allow_any_instance_of(Aidp::Watch::Reviewers::SecurityReviewer).to receive(:review).and_return(

    Line 144: Mocking internal AIDP class: Aidp::Watch::Reviewers::PerformanceReviewer
      Pattern: allow_any_instance_of
      Code: allow_any_instance_of(Aidp::Watch::Reviewers::PerformanceReviewer).to receive(:review).and_return(

--------------------------------------------------------------------------------
File: spec/aidp/watch/reviewers/base_reviewer_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (4):
    Line 23: Mocking internal AIDP class: Aidp::ProviderManager
      Pattern: allow().to receive
      Code: allow(Aidp::ProviderManager).to receive(:get_provider).and_return(provider)

    Line 240: Mocking internal AIDP class: Aidp::Harness::ConfigManager
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::ConfigManager).to receive(:new).and_return(config_manager)

    Line 249: Mocking internal AIDP class: Aidp::Harness::ConfigManager
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::ConfigManager).to receive(:new).and_raise(StandardError)

    Line 258: Mocking internal AIDP class: Aidp::Harness::ConfigManager
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::ConfigManager).to receive(:new).and_return(config_manager)


  NEEDS REVIEW (2):
    Line 201: Mocking unknown class (might be internal): Aidp
      Pattern: allow().to receive
      Code: allow(Aidp).to receive(:log_error)

    Line 215: Mocking unknown class (might be internal): Aidp
      Pattern: allow().to receive
      Code: allow(Aidp).to receive(:log_error)

--------------------------------------------------------------------------------
File: spec/aidp/watch/reviewers/performance_reviewer_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (1):
    Line 11: Mocking internal AIDP class: Aidp::ProviderManager
      Pattern: allow().to receive
      Code: allow(Aidp::ProviderManager).to receive(:get_provider).and_return(provider)

--------------------------------------------------------------------------------
File: spec/aidp/watch/reviewers/security_reviewer_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (1):
    Line 11: Mocking internal AIDP class: Aidp::ProviderManager
      Pattern: allow().to receive
      Code: allow(Aidp::ProviderManager).to receive(:get_provider).and_return(provider)

--------------------------------------------------------------------------------
File: spec/aidp/watch/reviewers/senior_dev_reviewer_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (1):
    Line 24: Mocking internal AIDP class: Aidp::ProviderManager
      Pattern: allow().to receive
      Code: allow(Aidp::ProviderManager).to receive(:get_provider).and_return(provider)


  NEEDS REVIEW (1):
    Line 84: Mocking unknown class (might be internal): Aidp
      Pattern: allow().to receive
      Code: allow(Aidp).to receive(:log_error)

--------------------------------------------------------------------------------
File: spec/aidp/watch/runner_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (12):
    Line 22: Mocking internal AIDP class: Aidp::Watch::RepositoryClient
      Pattern: allow().to receive
      Code: allow(Aidp::Watch::RepositoryClient).to receive(:parse_issues_url).and_return(["owner", "repo"])

    Line 23: Mocking internal AIDP class: Aidp::Watch::RepositoryClient
      Pattern: allow().to receive
      Code: allow(Aidp::Watch::RepositoryClient).to receive(:new).and_return(repository_client)

    Line 24: Mocking internal AIDP class: Aidp::Watch::RepositorySafetyChecker
      Pattern: allow().to receive
      Code: allow(Aidp::Watch::RepositorySafetyChecker).to receive(:new).and_return(safety_checker)

    Line 25: Mocking internal AIDP class: Aidp::Watch::StateStore
      Pattern: allow().to receive
      Code: allow(Aidp::Watch::StateStore).to receive(:new).and_return(state_store)

    Line 26: Mocking internal AIDP class: Aidp::Watch::PlanProcessor
      Pattern: allow().to receive
      Code: allow(Aidp::Watch::PlanProcessor).to receive(:new).and_return(plan_processor)

    Line 27: Mocking internal AIDP class: Aidp::Watch::BuildProcessor
      Pattern: allow().to receive
      Code: allow(Aidp::Watch::BuildProcessor).to receive(:new).and_return(build_processor)

    Line 37: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(runner.instance_variable_get(:@interval)).to eq(30)

    Line 42: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(runner.instance_variable_get(:@interval)).to eq(60)

    Line 47: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(runner.instance_variable_get(:@once)).to be true

    Line 51: Mocking internal AIDP class: Aidp::Watch::RepositoryClient
      Pattern: expect().to receive
      Code: expect(Aidp::Watch::RepositoryClient).to receive(:parse_issues_url).with(issues_url)

    Line 56: Mocking internal AIDP class: Aidp::Watch::RepositoryClient
      Pattern: expect().to receive
      Code: expect(Aidp::Watch::RepositoryClient).to receive(:new).with(

    Line 302: Mocking internal AIDP class: Aidp::Watch::ChangeRequestProcessor
      Pattern: allow().to receive
      Code: allow(Aidp::Watch::ChangeRequestProcessor).to receive(:new).and_return(change_request_processor)


  NEEDS REVIEW (3):
    Line 20: Mocking unknown class (might be internal): Aidp
      Pattern: allow().to receive
      Code: allow(Aidp).to receive(:log_info)

    Line 21: Mocking unknown class (might be internal): Aidp
      Pattern: allow().to receive
      Code: allow(Aidp).to receive(:log_debug)

    Line 370: Mocking unknown class (might be internal): Aidp
      Pattern: allow().to receive
      Code: allow(Aidp).to receive(:log_warn)

--------------------------------------------------------------------------------
File: spec/aidp/workflows/guided_agent_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (36):
    Line 27: Mocking internal AIDP class: Aidp::Harness::ConfigManager
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::ConfigManager).to receive(:new).with(project_dir).and_return(config_manager)

    Line 28: Mocking internal AIDP class: Aidp::Harness::ProviderManager
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::ProviderManager).to receive(:new)

    Line 33: Mocking internal AIDP class: Aidp::Harness::ProviderFactory
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::ProviderFactory).to receive(:new).with(config_manager).and_return(provider_factory)

    Line 53: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(agent.instance_variable_get(:@project_dir)).to eq(project_dir)

    Line 57: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(agent.instance_variable_get(:@conversation_history)).to eq([])

    Line 58: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(agent.instance_variable_get(:@user_input)).to eq({})

    Line 62: Mocking internal AIDP class: Aidp::CLI::EnhancedInput
      Pattern: instance_double
      Code: enhanced_prompt = instance_double("Aidp::CLI::EnhancedInput")

    Line 62: Mocking internal AIDP class: Aidp::CLI::EnhancedInput
      Pattern: double
      Code: enhanced_prompt = instance_double("Aidp::CLI::EnhancedInput")

    Line 63: Mocking internal AIDP class: Aidp::CLI::EnhancedInput
      Pattern: allow().to receive
      Code: allow(Aidp::CLI::EnhancedInput).to receive(:new).and_return(enhanced_prompt)

    Line 66: Mocking internal AIDP class: Aidp::Harness::ProviderManager
      Pattern: instance_double
      Code: enhanced_provider_manager = instance_double("Aidp::Harness::ProviderManager")

    Line 66: Mocking internal AIDP class: Aidp::Harness::ProviderManager
      Pattern: double
      Code: enhanced_provider_manager = instance_double("Aidp::Harness::ProviderManager")

    Line 67: Mocking internal AIDP class: Aidp::Harness::ProviderManager
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::ProviderManager).to receive(:new)

    Line 76: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(agent_with_enhanced.instance_variable_get(:@prompt)).to eq(enhanced_prompt)

    Line 329: Mocking internal AIDP class: Aidp::Logger
      Pattern: instance_double
      Code: logger_double = instance_double("Aidp::Logger")

    Line 329: Mocking internal AIDP class: Aidp::Logger
      Pattern: double
      Code: logger_double = instance_double("Aidp::Logger")

    Line 905: Mocking internal AIDP class: Aidp::Harness::ConfigManager
      Pattern: allow_any_instance_of
      Code: allow_any_instance_of(Aidp::Harness::ConfigManager).to receive(:config).and_return({

    Line 915: Mocking internal AIDP class: Aidp::Providers::Cursor
      Pattern: allow_any_instance_of
      Code: allow_any_instance_of(Aidp::Providers::Cursor).to receive(:send_message) do |instance, prompt:, session: nil|

    Line 925: Mocking internal AIDP class: Aidp::Providers::Anthropic
      Pattern: allow_any_instance_of
      Code: allow_any_instance_of(Aidp::Providers::Anthropic).to receive(:send_message).and_return('{"complete": true, "questions": [], "reasoning": "done"}')

    Line 958: Mocking internal AIDP class: Aidp::Providers::Cursor
      Pattern: allow_any_instance_of
      Code: allow_any_instance_of(Aidp::Providers::Cursor).to receive(:send_message) do |instance, prompt:, session: nil|

    Line 963: Mocking internal AIDP class: Aidp::Providers::Anthropic
      Pattern: allow_any_instance_of
      Code: allow_any_instance_of(Aidp::Providers::Anthropic).to receive(:send_message) do |instance, prompt:, session: nil|

    Line 988: Mocking internal AIDP class: Aidp::Harness::ConfigManager
      Pattern: allow_any_instance_of
      Code: allow_any_instance_of(Aidp::Harness::ConfigManager).to receive(:config).and_return({

    Line 996: Mocking internal AIDP class: Aidp::Providers::Cursor
      Pattern: allow_any_instance_of
      Code: allow_any_instance_of(Aidp::Providers::Cursor).to receive(:send_message).and_return("")

    Line 1034: Mocking internal AIDP class: Aidp::Harness::ConfigManager
      Pattern: allow_any_instance_of
      Code: allow_any_instance_of(Aidp::Harness::ConfigManager).to receive(:config).and_return({

    Line 1044: Mocking internal AIDP class: Aidp::Providers::Cursor
      Pattern: allow_any_instance_of
      Code: allow_any_instance_of(Aidp::Providers::Cursor).to receive(:send_message) do |instance, prompt:, session: nil|

    Line 1054: Mocking internal AIDP class: Aidp::Providers::Anthropic
      Pattern: allow_any_instance_of
      Code: allow_any_instance_of(Aidp::Providers::Anthropic).to receive(:send_message).and_return('{"complete": true, "questions": [], "reasoning": "done"}')

    Line 1078: Mocking internal AIDP class: Aidp::Harness::ConfigManager
      Pattern: allow_any_instance_of
      Code: allow_any_instance_of(Aidp::Harness::ConfigManager).to receive(:config).and_return({

    Line 1086: Mocking internal AIDP class: Aidp::Providers::Cursor
      Pattern: allow_any_instance_of
      Code: allow_any_instance_of(Aidp::Providers::Cursor).to receive(:send_message) do |instance, prompt:, session: nil|

    Line 1127: Mocking internal AIDP class: Aidp::Harness::ConfigManager
      Pattern: instance_double
      Code: let(:config_manager) { instance_double("Aidp::Harness::ConfigManager") }

    Line 1127: Mocking internal AIDP class: Aidp::Harness::ConfigManager
      Pattern: double
      Code: let(:config_manager) { instance_double("Aidp::Harness::ConfigManager") }

    Line 1130: Mocking internal AIDP class: Aidp::Harness::ProviderFactory
      Pattern: instance_double
      Code: let(:provider_factory) { instance_double("Aidp::Harness::ProviderFactory") }

    Line 1130: Mocking internal AIDP class: Aidp::Harness::ProviderFactory
      Pattern: double
      Code: let(:provider_factory) { instance_double("Aidp::Harness::ProviderFactory") }

    Line 1134: Mocking internal AIDP class: Aidp::Harness::ProviderFactory
      Pattern: allow().to receive
      Code: allow(Aidp::Harness::ProviderFactory).to receive(:new).and_return(provider_factory)

    Line 1137: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: allow(agent.instance_variable_get(:@config_manager)).to receive(:respond_to?).and_return(false)

    Line 1138: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: agent.instance_variable_set(:@provider_manager, provider_manager)

    Line 1144: Mocking internal AIDP class: Aidp::Logger
      Pattern: instance_double
      Code: mock_logger = instance_double("Aidp::Logger")

    Line 1144: Mocking internal AIDP class: Aidp::Logger
      Pattern: double
      Code: mock_logger = instance_double("Aidp::Logger")


  NEEDS REVIEW (6):
    Line 330: Mocking unknown class (might be internal): Aidp
      Pattern: allow().to receive
      Code: allow(Aidp).to receive(:logger).and_return(logger_double)

    Line 1126: Mocking unknown class (might be internal): ProviderManager
      Pattern: instance_double
      Code: let(:provider_manager) { instance_double("ProviderManager", current_provider: "cursor") }

    Line 1131: Mocking unknown class (might be internal): Provider
      Pattern: instance_double
      Code: let(:provider) { instance_double("Provider", send_message: nil) }

    Line 1137: Mocking method call or complex expression: agent.instance_variable_get(:@config_manager)
      Pattern: allow().to receive
      Code: allow(agent.instance_variable_get(:@config_manager)).to receive(:respond_to?).and_return(false)

    Line 1149: Mocking unknown class (might be internal): Aidp
      Pattern: allow().to receive
      Code: allow(Aidp).to receive(:logger).and_return(mock_logger)

    Line 1162: Mocking unknown class (might be internal): Aidp.logger
      Pattern: expect().to receive
      Code: expect(Aidp.logger).to receive(:debug).with("guided_agent", "provider_switch_noop", hash_including(provider: "cursor", reason: "resource_exhausted"))

--------------------------------------------------------------------------------
File: spec/aidp/workstream_executor_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (5):
    Line 31: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(executor.instance_variable_get(:@project_dir)).to eq(project_dir)

    Line 32: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(executor.instance_variable_get(:@max_concurrent)).to eq(2)

    Line 37: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: expect(default_executor.instance_variable_get(:@max_concurrent)).to eq(3)

    Line 41: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: results = executor.instance_variable_get(:@results)

    Line 42: Direct instance variable manipulation (code smell)
      Pattern: instance_variable manipulation
      Code: start_times = executor.instance_variable_get(:@start_times)

--------------------------------------------------------------------------------
File: spec/integration/issue_command_integration_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (2):
    Line 54: Mocking internal AIDP class: Aidp::IssueImporter
      Pattern: allow().to receive
      Code: allow(Aidp::IssueImporter).to receive(:new).and_return(mock_importer)

    Line 116: Mocking internal AIDP class: Aidp::CLI
      Pattern: allow().to receive
      Code: allow(Aidp::CLI).to receive(:display_message) do |message, **_options|

--------------------------------------------------------------------------------
File: spec/integration/jobs_command_integration_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (2):
    Line 14: Mocking internal AIDP class: Aidp::Jobs::BackgroundRunner
      Pattern: allow().to receive
      Code: allow(Aidp::Jobs::BackgroundRunner).to receive(:new).and_return(background_runner)

    Line 28: Mocking internal AIDP class: Aidp::Jobs::BackgroundRunner
      Pattern: allow().to receive
      Code: allow(Aidp::Jobs::BackgroundRunner).to receive(:new).and_return(background_runner)

--------------------------------------------------------------------------------
File: spec/system/analyze_mode_workflow_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (1):
    Line 20: Mocking internal AIDP class: Aidp::CLI
      Pattern: allow().to receive
      Code: allow(Aidp::CLI).to receive(:new).and_return(mock_cli)

--------------------------------------------------------------------------------
File: spec/system/guided_workflow_golden_path_spec.rb
--------------------------------------------------------------------------------

  VIOLATIONS (4):
    Line 50: Mocking internal AIDP class: Aidp::Providers::Cursor
      Pattern: allow_any_instance_of
      Code: allow_any_instance_of(Aidp::Providers::Cursor).to receive(:send_message) do |instance, prompt:, session: nil|

    Line 57: Mocking internal AIDP class: Aidp::Providers::Anthropic
      Pattern: allow_any_instance_of
      Code: allow_any_instance_of(Aidp::Providers::Anthropic).to receive(:send_message).and_return(

    Line 126: Mocking internal AIDP class: Aidp::Providers::Cursor
      Pattern: allow_any_instance_of
      Code: allow_any_instance_of(Aidp::Providers::Cursor).to receive(:send_message) do |instance, prompt:, session: nil|

    Line 136: Mocking internal AIDP class: Aidp::Providers::Anthropic
      Pattern: allow_any_instance_of
      Code: allow_any_instance_of(Aidp::Providers::Anthropic).to receive(:send_message).and_return(

================================================================================
Total violations: 1177
Total needing review: 282
================================================================================

Detailed JSON report saved to: mock_audit_report.json
